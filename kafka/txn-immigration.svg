<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: immigration Pages: 1 -->
<svg width="1746pt" height="388pt"
 viewBox="0.00 0.00 1746.38 388.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 384)">
<title>immigration</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-384 1742.3848,-384 1742.3848,4 -4,4"/>
<g id="clust1" class="cluster">
<title>cluster_ReplicaManager</title>
<path fill="none" stroke="#000000" d="M716.6313,-8C716.6313,-8 840.2866,-8 840.2866,-8 846.2866,-8 852.2866,-14 852.2866,-20 852.2866,-20 852.2866,-76 852.2866,-76 852.2866,-82 846.2866,-88 840.2866,-88 840.2866,-88 716.6313,-88 716.6313,-88 710.6313,-88 704.6313,-82 704.6313,-76 704.6313,-76 704.6313,-20 704.6313,-20 704.6313,-14 710.6313,-8 716.6313,-8"/>
<text text-anchor="middle" x="778.459" y="-68" font-family="Times,serif" font-size="20.00" fill="#000000">ReplicaManager</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_TransactionMetadata</title>
<path fill="none" stroke="#000000" d="M1465.624,-79C1465.624,-79 1718.3848,-79 1718.3848,-79 1724.3848,-79 1730.3848,-85 1730.3848,-91 1730.3848,-91 1730.3848,-289 1730.3848,-289 1730.3848,-295 1724.3848,-301 1718.3848,-301 1718.3848,-301 1465.624,-301 1465.624,-301 1459.624,-301 1453.624,-295 1453.624,-289 1453.624,-289 1453.624,-91 1453.624,-91 1453.624,-85 1459.624,-79 1465.624,-79"/>
<text text-anchor="middle" x="1592.0044" y="-281" font-family="Times,serif" font-size="20.00" fill="#000000">TransactionMetadata</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_TransactionStateManager</title>
<path fill="none" stroke="#000000" d="M414.0146,-96C414.0146,-96 1421.624,-96 1421.624,-96 1427.624,-96 1433.624,-102 1433.624,-108 1433.624,-108 1433.624,-272 1433.624,-272 1433.624,-278 1427.624,-284 1421.624,-284 1421.624,-284 414.0146,-284 414.0146,-284 408.0146,-284 402.0146,-278 402.0146,-272 402.0146,-272 402.0146,-108 402.0146,-108 402.0146,-102 408.0146,-96 414.0146,-96"/>
<text text-anchor="middle" x="917.8193" y="-264" font-family="Times,serif" font-size="20.00" fill="#000000">TransactionStateManager</text>
</g>
<g id="clust5" class="cluster">
<title>cluster_TranscationCoordinator</title>
<path fill="none" stroke="#000000" d="M232.1592,-292C232.1592,-292 635.8018,-292 635.8018,-292 641.8018,-292 647.8018,-298 647.8018,-304 647.8018,-304 647.8018,-360 647.8018,-360 647.8018,-366 641.8018,-372 635.8018,-372 635.8018,-372 232.1592,-372 232.1592,-372 226.1592,-372 220.1592,-366 220.1592,-360 220.1592,-360 220.1592,-304 220.1592,-304 220.1592,-298 226.1592,-292 232.1592,-292"/>
<text text-anchor="middle" x="433.9805" y="-352" font-family="Times,serif" font-size="20.00" fill="#000000">TranscationCoordinator</text>
</g>
<g id="clust7" class="cluster">
<title>cluster_KafkaApi</title>
<path fill="none" stroke="#000000" d="M20,-292C20,-292 188.1592,-292 188.1592,-292 194.1592,-292 200.1592,-298 200.1592,-304 200.1592,-304 200.1592,-360 200.1592,-360 200.1592,-366 194.1592,-372 188.1592,-372 188.1592,-372 20,-372 20,-372 14,-372 8,-366 8,-360 8,-360 8,-304 8,-304 8,-298 14,-292 20,-292"/>
<text text-anchor="middle" x="104.0796" y="-352" font-family="Times,serif" font-size="20.00" fill="#000000">KafkaApi</text>
</g>
<!-- getLog -->
<g id="node1" class="node">
<title>getLog</title>
<polygon fill="none" stroke="#000000" points="806.1153,-52 750.8026,-52 750.8026,-16 806.1153,-16 806.1153,-52"/>
<text text-anchor="middle" x="778.459" y="-29.8" font-family="Times,serif" font-size="14.00" fill="#000000">getLog</text>
</g>
<!-- TransactionMetadata -->
<g id="node2" class="node">
<title>TransactionMetadata</title>
<polygon fill="#95e1d3" stroke="#000000" points="1461.624,-88 1461.624,-264 1722.3848,-264 1722.3848,-88 1461.624,-88"/>
<text text-anchor="middle" x="1592.0044" y="-248.8" font-family="Times,serif" font-size="14.00" fill="#000000">TransactionMetadata</text>
<polyline fill="none" stroke="#000000" points="1461.624,-242 1722.3848,-242 "/>
<text text-anchor="start" x="1469.624" y="-226.8" font-family="Times,serif" font-size="14.00" fill="#000000">transactionalId: String </text>
<polyline fill="none" stroke="#000000" points="1461.624,-220 1722.3848,-220 "/>
<text text-anchor="start" x="1469.624" y="-204.8" font-family="Times,serif" font-size="14.00" fill="#000000">producerId: long </text>
<polyline fill="none" stroke="#000000" points="1461.624,-198 1722.3848,-198 "/>
<text text-anchor="start" x="1469.624" y="-182.8" font-family="Times,serif" font-size="14.00" fill="#000000">lastProducerId: Long </text>
<polyline fill="none" stroke="#000000" points="1461.624,-176 1722.3848,-176 "/>
<text text-anchor="start" x="1469.624" y="-160.8" font-family="Times,serif" font-size="14.00" fill="#000000">producerEpoch: short </text>
<polyline fill="none" stroke="#000000" points="1461.624,-154 1722.3848,-154 "/>
<text text-anchor="start" x="1469.624" y="-138.8" font-family="Times,serif" font-size="14.00" fill="#000000">txnTimeoutMs: Int </text>
<polyline fill="none" stroke="#000000" points="1461.624,-132 1722.3848,-132 "/>
<text text-anchor="start" x="1469.624" y="-116.8" font-family="Times,serif" font-size="14.00" fill="#000000">state: TransactionState </text>
<polyline fill="none" stroke="#000000" points="1461.624,-110 1722.3848,-110 "/>
<text text-anchor="start" x="1469.624" y="-94.8" font-family="Times,serif" font-size="14.00" fill="#000000">topicPartitions: mutable.Set[TopicPartition]</text>
</g>
<!-- transactionMetadataCache -->
<g id="node3" class="node">
<title>transactionMetadataCache</title>
<polygon fill="#95e1d3" stroke="#000000" points="913.8555,-180.2 913.8555,-243.8 1176.4619,-243.8 1176.4619,-180.2 913.8555,-180.2"/>
<text text-anchor="middle" x="1045.1587" y="-228.6" font-family="Times,serif" font-size="14.00" fill="#000000">transactionMetadataCache</text>
<polyline fill="none" stroke="#000000" points="913.8555,-221.8 1176.4619,-221.8 "/>
<text text-anchor="start" x="921.8555" y="-206.6" font-family="Times,serif" font-size="14.00" fill="#000000">mutable.Map[Int, TxnMetadataCacheEntry]</text>
<text text-anchor="middle" x="1045.1587" y="-192.6" font-family="Times,serif" font-size="14.00" fill="#000000"> parition 到cacheEntry的映射</text>
</g>
<!-- TxnMetadataCacheEntry -->
<g id="node4" class="node">
<title>TxnMetadataCacheEntry</title>
<polygon fill="#95e1d3" stroke="#000000" points="1212.4619,-148.2 1212.4619,-247.8 1425.624,-247.8 1425.624,-148.2 1212.4619,-148.2"/>
<text text-anchor="middle" x="1319.043" y="-232.6" font-family="Times,serif" font-size="14.00" fill="#000000">TxnMetadataCacheEntry</text>
<polyline fill="none" stroke="#000000" points="1212.4619,-225.8 1425.624,-225.8 "/>
<text text-anchor="start" x="1220.4619" y="-210.6" font-family="Times,serif" font-size="14.00" fill="#000000">coordinatorEpoch Int </text>
<polyline fill="none" stroke="#000000" points="1212.4619,-203.8 1425.624,-203.8 "/>
<text text-anchor="start" x="1220.4619" y="-188.6" font-family="Times,serif" font-size="14.00" fill="#000000">metadataPerTransactionalId </text>
<text text-anchor="start" x="1220.4619" y="-174.6" font-family="Times,serif" font-size="14.00" fill="#000000"> Pool[String, TransactionMetadata]</text>
<text text-anchor="middle" x="1319.043" y="-160.6" font-family="Times,serif" font-size="14.00" fill="#000000"> 事务ID到事务metadata映射</text>
</g>
<!-- transactionMetadataCache&#45;&gt;TxnMetadataCacheEntry -->
<g id="edge1" class="edge">
<title>transactionMetadataCache:entry&#45;&gt;TxnMetadataCacheEntry</title>
<path fill="none" stroke="#000000" d="M1176.1587,-201C1184.5404,-201 1193.1981,-200.9478 1201.913,-200.8571"/>
<polygon fill="#000000" stroke="#000000" points="1202.1995,-204.354 1212.1566,-200.7338 1202.1152,-197.3545 1202.1995,-204.354"/>
</g>
<!-- TxnMetadataCacheEntry&#45;&gt;TransactionMetadata -->
<g id="edge2" class="edge">
<title>TxnMetadataCacheEntry:meta&#45;&gt;TransactionMetadata</title>
<path fill="none" stroke="#000000" d="M1426.043,-176C1434.3266,-176 1442.8429,-176 1451.435,-176"/>
<polygon fill="#000000" stroke="#000000" points="1451.5468,-179.5001 1461.5468,-176 1451.5468,-172.5001 1451.5468,-179.5001"/>
</g>
<!-- loadTransactionsForTxnTopicPartition -->
<g id="node5" class="node">
<title>loadTransactionsForTxnTopicPartition</title>
<polygon fill="none" stroke="#000000" points="410.0146,-161.2 410.0146,-210.8 643.0625,-210.8 643.0625,-161.2 410.0146,-161.2"/>
<text text-anchor="middle" x="526.5386" y="-195.6" font-family="Times,serif" font-size="14.00" fill="#000000">loadTransactionsForTxnTopicPartition</text>
<polyline fill="none" stroke="#000000" points="410.0146,-188.8 643.0625,-188.8 "/>
<text text-anchor="middle" x="526.5386" y="-173.6" font-family="Times,serif" font-size="14.00" fill="#000000">从tp 日志恢复事务metadata内存中</text>
</g>
<!-- loadTransactionsForTxnTopicPartition&#45;&gt;getLog -->
<g id="edge3" class="edge">
<title>loadTransactionsForTxnTopicPartition&#45;&gt;getLog</title>
<path fill="none" stroke="#000000" d="M566.2003,-161.1945C596.8912,-142.0877 640.5177,-115.1188 679.0625,-92 699.6765,-79.6359 722.8685,-66.0827 741.6623,-55.189"/>
<polygon fill="#000000" stroke="#000000" points="743.6026,-58.1101 750.5044,-50.0717 740.0962,-52.0515 743.6026,-58.1101"/>
</g>
<!-- sendTxnMarkers -->
<g id="node6" class="node">
<title>sendTxnMarkers</title>
<polygon fill="#f38181" stroke="#000000" points="687.7271,-104.6001 687.7271,-193.3999 869.1909,-193.3999 869.1909,-104.6001 687.7271,-104.6001"/>
<text text-anchor="middle" x="778.459" y="-178.1999" font-family="Times,serif" font-size="14.00" fill="#000000">sendTxnMarkers</text>
<polyline fill="none" stroke="#000000" points="687.7271,-171.3999 869.1909,-171.3999 "/>
<text text-anchor="start" x="695.7271" y="-156.1999" font-family="Times,serif" font-size="14.00" fill="#000000">将状态为PrepareAbort</text>
<text text-anchor="start" x="695.7271" y="-136.6" font-family="Times,serif" font-size="14.00" fill="#000000"> PrepareCommit的事务</text>
<text text-anchor="start" x="695.7271" y="-117" font-family="Times,serif" font-size="14.00" fill="#000000"> 重新发送WriteMarkers请求</text>
</g>
<!-- loadTransactionsForTxnTopicPartition&#45;&gt;sendTxnMarkers -->
<g id="edge4" class="edge">
<title>loadTransactionsForTxnTopicPartition&#45;&gt;sendTxnMarkers</title>
<path fill="none" stroke="#000000" d="M643.2805,-168.8539C654.6127,-167.1895 666.045,-165.5104 677.2078,-163.8709"/>
<polygon fill="#000000" stroke="#000000" points="677.9877,-167.294 687.3729,-162.378 676.9704,-160.3683 677.9877,-167.294"/>
</g>
<!-- addLoadedTransactionsToCache -->
<g id="node7" class="node">
<title>addLoadedTransactionsToCache</title>
<polygon fill="none" stroke="#000000" points="877.7521,-248 679.1659,-248 679.1659,-212 877.7521,-212 877.7521,-248"/>
<text text-anchor="middle" x="778.459" y="-225.8" font-family="Times,serif" font-size="14.00" fill="#000000">addLoadedTransactionsToCache</text>
</g>
<!-- loadTransactionsForTxnTopicPartition&#45;&gt;addLoadedTransactionsToCache -->
<g id="edge5" class="edge">
<title>loadTransactionsForTxnTopicPartition&#45;&gt;addLoadedTransactionsToCache</title>
<path fill="none" stroke="#000000" d="M643.2805,-206.39C651.8837,-207.8926 660.5446,-209.4053 669.1015,-210.8998"/>
<polygon fill="#000000" stroke="#000000" points="668.6359,-214.3714 679.089,-212.6442 669.8404,-207.4758 668.6359,-214.3714"/>
</g>
<!-- addLoadedTransactionsToCache&#45;&gt;transactionMetadataCache -->
<g id="edge6" class="edge">
<title>addLoadedTransactionsToCache&#45;&gt;transactionMetadataCache</title>
<path fill="none" stroke="#000000" d="M877.7681,-223.2975C886.1773,-222.7299 894.7801,-222.1493 903.4301,-221.5655"/>
<polygon fill="#000000" stroke="#000000" points="903.8558,-225.0448 913.5973,-220.8793 903.3843,-218.0607 903.8558,-225.0448"/>
</g>
<!-- handleTxnImmigration -->
<g id="node8" class="node">
<title>handleTxnImmigration</title>
<polygon fill="none" stroke="#000000" points="373.9425,-336 228.2314,-336 228.2314,-300 373.9425,-300 373.9425,-336"/>
<text text-anchor="middle" x="301.0869" y="-313.8" font-family="Times,serif" font-size="14.00" fill="#000000">handleTxnImmigration</text>
</g>
<!-- handleTxnImmigration&#45;&gt;loadTransactionsForTxnTopicPartition -->
<g id="edge7" class="edge">
<title>handleTxnImmigration&#45;&gt;loadTransactionsForTxnTopicPartition</title>
<path fill="none" stroke="#000000" d="M331.9623,-299.9227C368.8557,-278.322 431.1276,-241.8623 475.2789,-216.0121"/>
<polygon fill="#000000" stroke="#000000" points="477.2705,-218.9018 484.1318,-210.8288 473.7337,-212.8611 477.2705,-218.9018"/>
</g>
<!-- removeMarkersForTxnTopicPartition -->
<g id="node9" class="node">
<title>removeMarkersForTxnTopicPartition</title>
<polygon fill="none" stroke="#000000" points="639.5654,-336 413.5117,-336 413.5117,-300 639.5654,-300 639.5654,-336"/>
<text text-anchor="middle" x="526.5386" y="-313.8" font-family="Times,serif" font-size="14.00" fill="#000000">removeMarkersForTxnTopicPartition</text>
</g>
<!-- handleTxnImmigration&#45;&gt;removeMarkersForTxnTopicPartition -->
<g id="edge8" class="edge">
<title>handleTxnImmigration&#45;&gt;removeMarkersForTxnTopicPartition</title>
<path fill="none" stroke="#000000" d="M373.9733,-318C383.4291,-318 393.3141,-318 403.3102,-318"/>
<polygon fill="#000000" stroke="#000000" points="403.3316,-321.5001 413.3316,-318 403.3315,-314.5001 403.3316,-321.5001"/>
</g>
<!-- handleLeaderAndIsrRequest -->
<g id="node10" class="node">
<title>handleLeaderAndIsrRequest</title>
<polygon fill="none" stroke="#000000" points="192.2388,-336 15.9203,-336 15.9203,-300 192.2388,-300 192.2388,-336"/>
<text text-anchor="middle" x="104.0796" y="-313.8" font-family="Times,serif" font-size="14.00" fill="#000000">handleLeaderAndIsrRequest</text>
</g>
<!-- handleLeaderAndIsrRequest&#45;&gt;handleTxnImmigration -->
<g id="edge9" class="edge">
<title>handleLeaderAndIsrRequest&#45;&gt;handleTxnImmigration</title>
<path fill="none" stroke="#000000" d="M192.2113,-318C200.733,-318 209.3595,-318 217.8317,-318"/>
<polygon fill="#000000" stroke="#000000" points="218.0721,-321.5001 228.072,-318 218.072,-314.5001 218.0721,-321.5001"/>
</g>
</g>
</svg>
