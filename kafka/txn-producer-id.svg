<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: producerId Pages: 1 -->
<svg width="1865pt" height="967pt"
 viewBox="0.00 0.00 1864.83 966.50" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 962.5037)">
<title>producerId</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-962.5037 1860.8311,-962.5037 1860.8311,4 -4,4"/>
<g id="clust1" class="cluster">
<title>cluster_zkClient</title>
<path fill="none" stroke="#000000" d="M1075.6118,-41.5037C1075.6118,-41.5037 1508.748,-41.5037 1508.748,-41.5037 1514.748,-41.5037 1520.748,-47.5037 1520.748,-53.5037 1520.748,-53.5037 1520.748,-197.5037 1520.748,-197.5037 1520.748,-203.5037 1514.748,-209.5037 1508.748,-209.5037 1508.748,-209.5037 1075.6118,-209.5037 1075.6118,-209.5037 1069.6118,-209.5037 1063.6118,-203.5037 1063.6118,-197.5037 1063.6118,-197.5037 1063.6118,-53.5037 1063.6118,-53.5037 1063.6118,-47.5037 1069.6118,-41.5037 1075.6118,-41.5037"/>
<text text-anchor="middle" x="1292.1799" y="-189.5037" font-family="Times,serif" font-size="20.00" fill="#000000">zkClient</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_ReplicaManager</title>
<path fill="none" stroke="#000000" d="M806.106,-489.5037C806.106,-489.5037 929.4097,-489.5037 929.4097,-489.5037 935.4097,-489.5037 941.4097,-495.5037 941.4097,-501.5037 941.4097,-501.5037 941.4097,-611.5037 941.4097,-611.5037 941.4097,-617.5037 935.4097,-623.5037 929.4097,-623.5037 929.4097,-623.5037 806.106,-623.5037 806.106,-623.5037 800.106,-623.5037 794.106,-617.5037 794.106,-611.5037 794.106,-611.5037 794.106,-501.5037 794.106,-501.5037 794.106,-495.5037 800.106,-489.5037 806.106,-489.5037"/>
<text text-anchor="middle" x="867.7578" y="-603.5037" font-family="Times,serif" font-size="20.00" fill="#000000">ReplicaManager</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_TransactionMetadata</title>
<path fill="none" stroke="#000000" d="M1584.0703,-115.5037C1584.0703,-115.5037 1836.8311,-115.5037 1836.8311,-115.5037 1842.8311,-115.5037 1848.8311,-121.5037 1848.8311,-127.5037 1848.8311,-127.5037 1848.8311,-325.5037 1848.8311,-325.5037 1848.8311,-331.5037 1842.8311,-337.5037 1836.8311,-337.5037 1836.8311,-337.5037 1584.0703,-337.5037 1584.0703,-337.5037 1578.0703,-337.5037 1572.0703,-331.5037 1572.0703,-325.5037 1572.0703,-325.5037 1572.0703,-127.5037 1572.0703,-127.5037 1572.0703,-121.5037 1578.0703,-115.5037 1584.0703,-115.5037"/>
<text text-anchor="middle" x="1710.4507" y="-317.5037" font-family="Times,serif" font-size="20.00" fill="#000000">TransactionMetadata</text>
</g>
<g id="clust4" class="cluster">
<title>cluster_TransactionStateManager</title>
<path fill="none" stroke="#000000" d="M473.166,-631.5037C473.166,-631.5037 1540.0703,-631.5037 1540.0703,-631.5037 1546.0703,-631.5037 1552.0703,-637.5037 1552.0703,-643.5037 1552.0703,-643.5037 1552.0703,-938.5037 1552.0703,-938.5037 1552.0703,-944.5037 1546.0703,-950.5037 1540.0703,-950.5037 1540.0703,-950.5037 473.166,-950.5037 473.166,-950.5037 467.166,-950.5037 461.166,-944.5037 461.166,-938.5037 461.166,-938.5037 461.166,-643.5037 461.166,-643.5037 461.166,-637.5037 467.166,-631.5037 473.166,-631.5037"/>
<text text-anchor="middle" x="1006.6182" y="-930.5037" font-family="Times,serif" font-size="20.00" fill="#000000">TransactionStateManager</text>
</g>
<g id="clust8" class="cluster">
<title>cluster_PorudcerIdManager</title>
<path fill="none" stroke="#000000" d="M480.7813,-217.5037C480.7813,-217.5037 1251.5776,-217.5037 1251.5776,-217.5037 1257.5776,-217.5037 1263.5776,-223.5037 1263.5776,-229.5037 1263.5776,-229.5037 1263.5776,-469.5037 1263.5776,-469.5037 1263.5776,-475.5037 1257.5776,-481.5037 1251.5776,-481.5037 1251.5776,-481.5037 480.7813,-481.5037 480.7813,-481.5037 474.7813,-481.5037 468.7813,-475.5037 468.7813,-469.5037 468.7813,-469.5037 468.7813,-229.5037 468.7813,-229.5037 468.7813,-223.5037 474.7813,-217.5037 480.7813,-217.5037"/>
<text text-anchor="middle" x="866.1794" y="-461.5037" font-family="Times,serif" font-size="20.00" fill="#000000">PorudcerIdManager</text>
</g>
<g id="clust11" class="cluster">
<title>cluster_TranscationCoordinator</title>
<path fill="none" stroke="#000000" d="M247.3213,-631.5037C247.3213,-631.5037 429.166,-631.5037 429.166,-631.5037 435.166,-631.5037 441.166,-637.5037 441.166,-643.5037 441.166,-643.5037 441.166,-827.5037 441.166,-827.5037 441.166,-833.5037 435.166,-839.5037 429.166,-839.5037 429.166,-839.5037 247.3213,-839.5037 247.3213,-839.5037 241.3213,-839.5037 235.3213,-833.5037 235.3213,-827.5037 235.3213,-827.5037 235.3213,-643.5037 235.3213,-643.5037 235.3213,-637.5037 241.3213,-631.5037 247.3213,-631.5037"/>
<text text-anchor="middle" x="338.2437" y="-819.5037" font-family="Times,serif" font-size="20.00" fill="#000000">TranscationCoordinator</text>
</g>
<g id="clust13" class="cluster">
<title>cluster_KafkaApi</title>
<path fill="none" stroke="#000000" d="M20,-632.5037C20,-632.5037 203.3213,-632.5037 203.3213,-632.5037 209.3213,-632.5037 215.3213,-638.5037 215.3213,-644.5037 215.3213,-644.5037 215.3213,-822.5037 215.3213,-822.5037 215.3213,-828.5037 209.3213,-834.5037 203.3213,-834.5037 203.3213,-834.5037 20,-834.5037 20,-834.5037 14,-834.5037 8,-828.5037 8,-822.5037 8,-822.5037 8,-644.5037 8,-644.5037 8,-638.5037 14,-632.5037 20,-632.5037"/>
<text text-anchor="middle" x="111.6606" y="-814.5037" font-family="Times,serif" font-size="20.00" fill="#000000">KafkaApi</text>
</g>
<!-- zk_getDataAndVersion -->
<g id="node1" class="node">
<title>zk_getDataAndVersion</title>
<polygon fill="none" stroke="#000000" points="1236.7334,-173.5037 1090.4766,-173.5037 1090.4766,-137.5037 1236.7334,-137.5037 1236.7334,-173.5037"/>
<text text-anchor="middle" x="1163.605" y="-151.3037" font-family="Times,serif" font-size="14.00" fill="#000000">zk_getDataAndVersion</text>
</g>
<!-- ProducerIdBlockZNode -->
<g id="node2" class="node">
<title>ProducerIdBlockZNode</title>
<polygon fill="none" stroke="#000000" points="1512.5076,-173.5037 1362.4709,-173.5037 1362.4709,-137.5037 1512.5076,-137.5037 1512.5076,-173.5037"/>
<text text-anchor="middle" x="1437.4893" y="-151.3037" font-family="Times,serif" font-size="14.00" fill="#000000">ProducerIdBlockZNode</text>
</g>
<!-- zk_getDataAndVersion&#45;&gt;ProducerIdBlockZNode -->
<g id="edge1" class="edge">
<title>zk_getDataAndVersion&#45;&gt;ProducerIdBlockZNode</title>
<path fill="none" stroke="#000000" d="M1237.0009,-155.5037C1272.4857,-155.5037 1315.2849,-155.5037 1352.2112,-155.5037"/>
<polygon fill="#000000" stroke="#000000" points="1352.4596,-159.0038 1362.4596,-155.5037 1352.4596,-152.0038 1352.4596,-159.0038"/>
</g>
<!-- conditionalUpdatePath -->
<g id="node3" class="node">
<title>conditionalUpdatePath</title>
<polygon fill="none" stroke="#000000" points="1071.6118,-49.9038 1071.6118,-119.1036 1255.5981,-119.1036 1255.5981,-49.9038 1071.6118,-49.9038"/>
<text text-anchor="middle" x="1163.605" y="-103.9036" font-family="Times,serif" font-size="14.00" fill="#000000">conditionalUpdatePath</text>
<polyline fill="none" stroke="#000000" points="1071.6118,-97.1036 1255.5981,-97.1036 "/>
<text text-anchor="start" x="1079.6118" y="-81.9036" font-family="Times,serif" font-size="14.00" fill="#000000">更新数据到期望的zkVersion</text>
<text text-anchor="start" x="1079.6118" y="-62.3037" font-family="Times,serif" font-size="14.00" fill="#000000"> 如果zkVersion不对则失败</text>
</g>
<!-- appendRecords -->
<g id="node4" class="node">
<title>appendRecords</title>
<polygon fill="none" stroke="#000000" points="918.562,-587.5037 815.9536,-587.5037 815.9536,-551.5037 918.562,-551.5037 918.562,-587.5037"/>
<text text-anchor="middle" x="867.2578" y="-565.3037" font-family="Times,serif" font-size="14.00" fill="#000000">appendRecords</text>
</g>
<!-- getLog -->
<g id="node5" class="node">
<title>getLog</title>
<polygon fill="none" stroke="#000000" points="894.9141,-533.5037 839.6015,-533.5037 839.6015,-497.5037 894.9141,-497.5037 894.9141,-533.5037"/>
<text text-anchor="middle" x="867.2578" y="-511.3037" font-family="Times,serif" font-size="14.00" fill="#000000">getLog</text>
</g>
<!-- TransactionMetadata -->
<g id="node6" class="node">
<title>TransactionMetadata</title>
<polygon fill="#95e1d3" stroke="#000000" points="1580.0703,-124.5037 1580.0703,-300.5037 1840.8311,-300.5037 1840.8311,-124.5037 1580.0703,-124.5037"/>
<text text-anchor="middle" x="1710.4507" y="-285.3037" font-family="Times,serif" font-size="14.00" fill="#000000">TransactionMetadata</text>
<polyline fill="none" stroke="#000000" points="1580.0703,-278.5037 1840.8311,-278.5037 "/>
<text text-anchor="start" x="1588.0703" y="-263.3037" font-family="Times,serif" font-size="14.00" fill="#000000">transactionalId: String </text>
<polyline fill="none" stroke="#000000" points="1580.0703,-256.5037 1840.8311,-256.5037 "/>
<text text-anchor="start" x="1588.0703" y="-241.3037" font-family="Times,serif" font-size="14.00" fill="#000000">producerId: long </text>
<polyline fill="none" stroke="#000000" points="1580.0703,-234.5037 1840.8311,-234.5037 "/>
<text text-anchor="start" x="1588.0703" y="-219.3037" font-family="Times,serif" font-size="14.00" fill="#000000">lastProducerId: Long </text>
<polyline fill="none" stroke="#000000" points="1580.0703,-212.5037 1840.8311,-212.5037 "/>
<text text-anchor="start" x="1588.0703" y="-197.3037" font-family="Times,serif" font-size="14.00" fill="#000000">producerEpoch: short </text>
<polyline fill="none" stroke="#000000" points="1580.0703,-190.5037 1840.8311,-190.5037 "/>
<text text-anchor="start" x="1588.0703" y="-175.3037" font-family="Times,serif" font-size="14.00" fill="#000000">txnTimeoutMs: Int </text>
<polyline fill="none" stroke="#000000" points="1580.0703,-168.5037 1840.8311,-168.5037 "/>
<text text-anchor="start" x="1588.0703" y="-153.3037" font-family="Times,serif" font-size="14.00" fill="#000000">state: TransactionState </text>
<polyline fill="none" stroke="#000000" points="1580.0703,-146.5037 1840.8311,-146.5037 "/>
<text text-anchor="start" x="1588.0703" y="-131.3037" font-family="Times,serif" font-size="14.00" fill="#000000">topicPartitions: mutable.Set[TopicPartition]</text>
</g>
<!-- appendTransactionToLog -->
<g id="node7" class="node">
<title>appendTransactionToLog</title>
<polygon fill="none" stroke="#000000" points="506.1143,-707.9038 506.1143,-777.1036 665.2656,-777.1036 665.2656,-707.9038 506.1143,-707.9038"/>
<text text-anchor="middle" x="585.6899" y="-761.9036" font-family="Times,serif" font-size="14.00" fill="#000000">appendTransactionToLog</text>
<polyline fill="none" stroke="#000000" points="506.1143,-755.1036 665.2656,-755.1036 "/>
<text text-anchor="start" x="514.1143" y="-739.9036" font-family="Times,serif" font-size="14.00" fill="#000000">将事务日志对应的</text>
<text text-anchor="start" x="514.1143" y="-720.3037" font-family="Times,serif" font-size="14.00" fill="#000000"> 写入topic_partition</text>
</g>
<!-- appendTransactionToLog&#45;&gt;appendRecords -->
<g id="edge11" class="edge">
<title>appendTransactionToLog&#45;&gt;appendRecords</title>
<path fill="none" stroke="#000000" d="M665.418,-721.52C678.7007,-715.5761 691.5911,-708.0349 702.2139,-698.5037 728.5477,-674.8757 712.6171,-651.9282 738.2139,-627.5037 757.2684,-609.3218 783.0001,-596.1956 806.4725,-587.0797"/>
<polygon fill="#000000" stroke="#000000" points="807.8638,-590.2967 816.0224,-583.5374 805.4294,-583.7336 807.8638,-590.2967"/>
</g>
<!-- TRANSACTION_STATE_TOPIC_NAME -->
<g id="node16" class="node">
<title>TRANSACTION_STATE_TOPIC_NAME</title>
<polygon fill="none" stroke="#000000" points="996.3457,-760.5037 738.1699,-760.5037 738.1699,-724.5037 996.3457,-724.5037 996.3457,-760.5037"/>
<text text-anchor="middle" x="867.2578" y="-738.3037" font-family="Times,serif" font-size="14.00" fill="#000000">TRANSACTION_STATE_TOPIC_NAME</text>
</g>
<!-- appendTransactionToLog&#45;&gt;TRANSACTION_STATE_TOPIC_NAME -->
<g id="edge12" class="edge">
<title>appendTransactionToLog&#45;&gt;TRANSACTION_STATE_TOPIC_NAME</title>
<path fill="none" stroke="#000000" d="M665.6228,-742.5037C685.1325,-742.5037 706.5727,-742.5037 727.9669,-742.5037"/>
<polygon fill="#000000" stroke="#000000" points="728.1203,-746.0038 738.1203,-742.5037 728.1202,-739.0038 728.1203,-746.0038"/>
</g>
<!-- getTransactionState -->
<g id="node8" class="node">
<title>getTransactionState</title>
<polygon fill="none" stroke="#000000" points="500.3003,-864.7037 500.3003,-914.3037 671.0796,-914.3037 671.0796,-864.7037 500.3003,-864.7037"/>
<text text-anchor="middle" x="585.6899" y="-899.1037" font-family="Times,serif" font-size="14.00" fill="#000000">getTransactionState</text>
<polyline fill="none" stroke="#000000" points="500.3003,-892.3037 671.0796,-892.3037 "/>
<text text-anchor="middle" x="585.6899" y="-877.1037" font-family="Times,serif" font-size="14.00" fill="#000000">根据tid获取事务对应状态</text>
</g>
<!-- getAndMaybeAddTransactionState -->
<g id="node14" class="node">
<title>getAndMaybeAddTransactionState</title>
<polygon fill="none" stroke="#000000" points="974.0489,-838.5037 760.4667,-838.5037 760.4667,-802.5037 974.0489,-802.5037 974.0489,-838.5037"/>
<text text-anchor="middle" x="867.2578" y="-816.3037" font-family="Times,serif" font-size="14.00" fill="#000000">getAndMaybeAddTransactionState</text>
</g>
<!-- getTransactionState&#45;&gt;getAndMaybeAddTransactionState -->
<g id="edge5" class="edge">
<title>getTransactionState&#45;&gt;getAndMaybeAddTransactionState</title>
<path fill="none" stroke="#000000" d="M671.3164,-868.5204C706.958,-859.7862 748.2019,-849.6791 783.6294,-840.9974"/>
<polygon fill="#000000" stroke="#000000" points="784.5786,-844.3684 793.4581,-838.5888 782.9124,-837.5696 784.5786,-844.3684"/>
</g>
<!-- putTransactionStateIfNotExists -->
<g id="node9" class="node">
<title>putTransactionStateIfNotExists</title>
<polygon fill="none" stroke="#000000" points="489.6738,-795.7037 489.6738,-845.3037 681.7061,-845.3037 681.7061,-795.7037 489.6738,-795.7037"/>
<text text-anchor="middle" x="585.6899" y="-830.1037" font-family="Times,serif" font-size="14.00" fill="#000000">putTransactionStateIfNotExists</text>
<polyline fill="none" stroke="#000000" points="489.6738,-823.3037 681.7061,-823.3037 "/>
<text text-anchor="middle" x="585.6899" y="-808.1037" font-family="Times,serif" font-size="14.00" fill="#000000">保存事务状态</text>
</g>
<!-- putTransactionStateIfNotExists&#45;&gt;getAndMaybeAddTransactionState -->
<g id="edge4" class="edge">
<title>putTransactionStateIfNotExists&#45;&gt;getAndMaybeAddTransactionState</title>
<path fill="none" stroke="#000000" d="M681.8021,-820.5037C703.7288,-820.5037 727.2682,-820.5037 749.969,-820.5037"/>
<polygon fill="#000000" stroke="#000000" points="749.9839,-824.0038 759.9839,-820.5037 749.9838,-817.0038 749.9839,-824.0038"/>
</g>
<!-- transactionMetadataCache -->
<g id="node10" class="node">
<title>transactionMetadataCache</title>
<polygon fill="#95e1d3" stroke="#000000" points="1032.3018,-668.7037 1032.3018,-732.3037 1294.9082,-732.3037 1294.9082,-668.7037 1032.3018,-668.7037"/>
<text text-anchor="middle" x="1163.605" y="-717.1037" font-family="Times,serif" font-size="14.00" fill="#000000">transactionMetadataCache</text>
<polyline fill="none" stroke="#000000" points="1032.3018,-710.3037 1294.9082,-710.3037 "/>
<text text-anchor="start" x="1040.3018" y="-695.1037" font-family="Times,serif" font-size="14.00" fill="#000000">mutable.Map[Int, TxnMetadataCacheEntry]</text>
<text text-anchor="middle" x="1163.605" y="-681.1037" font-family="Times,serif" font-size="14.00" fill="#000000"> parition 到cacheEntry的映射</text>
</g>
<!-- TxnMetadataCacheEntry -->
<g id="node11" class="node">
<title>TxnMetadataCacheEntry</title>
<polygon fill="#95e1d3" stroke="#000000" points="1330.9082,-639.7037 1330.9082,-739.3037 1544.0703,-739.3037 1544.0703,-639.7037 1330.9082,-639.7037"/>
<text text-anchor="middle" x="1437.4893" y="-724.1037" font-family="Times,serif" font-size="14.00" fill="#000000">TxnMetadataCacheEntry</text>
<polyline fill="none" stroke="#000000" points="1330.9082,-717.3037 1544.0703,-717.3037 "/>
<text text-anchor="start" x="1338.9082" y="-702.1037" font-family="Times,serif" font-size="14.00" fill="#000000">coordinatorEpoch Int </text>
<polyline fill="none" stroke="#000000" points="1330.9082,-695.3037 1544.0703,-695.3037 "/>
<text text-anchor="start" x="1338.9082" y="-680.1037" font-family="Times,serif" font-size="14.00" fill="#000000">metadataPerTransactionalId </text>
<text text-anchor="start" x="1338.9082" y="-666.1037" font-family="Times,serif" font-size="14.00" fill="#000000"> Pool[String, TransactionMetadata]</text>
<text text-anchor="middle" x="1437.4893" y="-652.1037" font-family="Times,serif" font-size="14.00" fill="#000000"> 事务ID到事务metadata映射</text>
</g>
<!-- transactionMetadataCache&#45;&gt;TxnMetadataCacheEntry -->
<g id="edge2" class="edge">
<title>transactionMetadataCache:entry&#45;&gt;TxnMetadataCacheEntry</title>
<path fill="none" stroke="#000000" d="M1294.605,-689.5037C1302.9849,-689.5037 1311.6412,-689.5037 1320.3551,-689.5037"/>
<polygon fill="#000000" stroke="#000000" points="1320.5978,-693.0038 1330.5978,-689.5037 1320.5977,-686.0038 1320.5978,-693.0038"/>
</g>
<!-- TxnMetadataCacheEntry&#45;&gt;TransactionMetadata -->
<g id="edge3" class="edge">
<title>TxnMetadataCacheEntry:meta&#45;&gt;TransactionMetadata</title>
<path fill="none" stroke="#000000" d="M1544.4893,-667.5037C1619.8552,-667.5037 1671.0503,-444.3946 1694.9702,-310.6406"/>
<polygon fill="#000000" stroke="#000000" points="1698.4204,-311.2284 1696.7146,-300.7718 1691.5273,-310.0098 1698.4204,-311.2284"/>
</g>
<!-- partitionFor -->
<g id="node12" class="node">
<title>partitionFor</title>
<polygon fill="none" stroke="#000000" points="1049.4668,-781.7037 1049.4668,-859.3037 1277.7432,-859.3037 1277.7432,-781.7037 1049.4668,-781.7037"/>
<text text-anchor="middle" x="1163.605" y="-844.1037" font-family="Times,serif" font-size="14.00" fill="#000000">partitionFor</text>
<polyline fill="none" stroke="#000000" points="1049.4668,-837.3037 1277.7432,-837.3037 "/>
<text text-anchor="start" x="1057.4668" y="-822.1037" font-family="Times,serif" font-size="14.00" fill="#000000">Utils.abs(transactionalId.hashCode)%</text>
<text text-anchor="start" x="1057.4668" y="-808.1037" font-family="Times,serif" font-size="14.00" fill="#000000"> transactionTopicPartitionCount </text>
<text text-anchor="start" x="1057.4668" y="-794.1037" font-family="Times,serif" font-size="14.00" fill="#000000"> 根据事务id获取对应的partition</text>
</g>
<!-- loadTransactionsForTxnTopicPartition -->
<g id="node13" class="node">
<title>loadTransactionsForTxnTopicPartition</title>
<polygon fill="none" stroke="#000000" points="469.166,-639.7037 469.166,-689.3037 702.2139,-689.3037 702.2139,-639.7037 469.166,-639.7037"/>
<text text-anchor="middle" x="585.6899" y="-674.1037" font-family="Times,serif" font-size="14.00" fill="#000000">loadTransactionsForTxnTopicPartition</text>
<polyline fill="none" stroke="#000000" points="469.166,-667.3037 702.2139,-667.3037 "/>
<text text-anchor="middle" x="585.6899" y="-652.1037" font-family="Times,serif" font-size="14.00" fill="#000000">从tp 日志恢复事务metadata内存中</text>
</g>
<!-- loadTransactionsForTxnTopicPartition&#45;&gt;getLog -->
<g id="edge8" class="edge">
<title>loadTransactionsForTxnTopicPartition&#45;&gt;getLog</title>
<path fill="none" stroke="#000000" d="M609.3516,-639.5258C637.396,-611.4754 686.8378,-566.7194 738.2139,-542.5037 767.0927,-528.8919 802.8114,-522.0976 829.343,-518.7326"/>
<polygon fill="#000000" stroke="#000000" points="829.8563,-522.1966 839.3855,-517.5659 829.0484,-515.2433 829.8563,-522.1966"/>
</g>
<!-- addLoadedTransactionsToCache -->
<g id="node15" class="node">
<title>addLoadedTransactionsToCache</title>
<polygon fill="none" stroke="#000000" points="966.5509,-694.5037 767.9647,-694.5037 767.9647,-658.5037 966.5509,-658.5037 966.5509,-694.5037"/>
<text text-anchor="middle" x="867.2578" y="-672.3037" font-family="Times,serif" font-size="14.00" fill="#000000">addLoadedTransactionsToCache</text>
</g>
<!-- loadTransactionsForTxnTopicPartition&#45;&gt;addLoadedTransactionsToCache -->
<g id="edge9" class="edge">
<title>loadTransactionsForTxnTopicPartition&#45;&gt;addLoadedTransactionsToCache</title>
<path fill="none" stroke="#000000" d="M702.2469,-669.4712C720.6287,-670.2546 739.5788,-671.0622 757.7921,-671.8384"/>
<polygon fill="#000000" stroke="#000000" points="757.6866,-675.337 767.8266,-672.2661 757.9847,-668.3434 757.6866,-675.337"/>
</g>
<!-- getAndMaybeAddTransactionState&#45;&gt;transactionMetadataCache -->
<g id="edge6" class="edge">
<title>getAndMaybeAddTransactionState&#45;&gt;transactionMetadataCache</title>
<path fill="none" stroke="#000000" d="M913.3109,-802.4937C937.9638,-792.8046 968.8268,-780.5979 996.3018,-769.5037 1022.7678,-758.8169 1051.518,-747.0259 1077.5985,-736.2601"/>
<polygon fill="#000000" stroke="#000000" points="1079.1713,-739.3973 1087.0772,-732.3441 1076.4984,-732.9277 1079.1713,-739.3973"/>
</g>
<!-- getAndMaybeAddTransactionState&#45;&gt;partitionFor -->
<g id="edge7" class="edge">
<title>getAndMaybeAddTransactionState&#45;&gt;partitionFor</title>
<path fill="none" stroke="#000000" d="M974.2459,-820.5037C995.2852,-820.5037 1017.5279,-820.5037 1039.085,-820.5037"/>
<polygon fill="#000000" stroke="#000000" points="1039.2679,-824.0038 1049.2679,-820.5037 1039.2679,-817.0038 1039.2679,-824.0038"/>
</g>
<!-- addLoadedTransactionsToCache&#45;&gt;transactionMetadataCache -->
<g id="edge10" class="edge">
<title>addLoadedTransactionsToCache&#45;&gt;transactionMetadataCache</title>
<path fill="none" stroke="#000000" d="M966.7615,-684.5621C984.578,-686.005 1003.4506,-687.5334 1022.1792,-689.0502"/>
<polygon fill="#000000" stroke="#000000" points="1022.0062,-692.5475 1032.2561,-689.8663 1022.5713,-685.5704 1022.0062,-692.5475"/>
</g>
<!-- generateProducerId -->
<g id="node17" class="node">
<title>generateProducerId</title>
<polygon fill="none" stroke="#000000" points="476.7813,-354.9038 476.7813,-424.1036 694.5986,-424.1036 694.5986,-354.9038 476.7813,-354.9038"/>
<text text-anchor="middle" x="585.6899" y="-408.9036" font-family="Times,serif" font-size="14.00" fill="#000000">generateProducerId</text>
<polyline fill="none" stroke="#000000" points="476.7813,-402.1036 694.5986,-402.1036 "/>
<text text-anchor="start" x="484.7813" y="-386.9036" font-family="Times,serif" font-size="14.00" fill="#000000">先从本地producerIdBlock中分配</text>
<text text-anchor="start" x="484.7813" y="-367.3037" font-family="Times,serif" font-size="14.00" fill="#000000"> 如果已分配完向zk申请新的block</text>
</g>
<!-- getNewProducerIdBlock -->
<g id="node18" class="node">
<title>getNewProducerIdBlock</title>
<polygon fill="none" stroke="#000000" points="775.6509,-236.1038 775.6509,-338.9036 958.8647,-338.9036 958.8647,-236.1038 775.6509,-236.1038"/>
<text text-anchor="middle" x="867.2578" y="-323.7036" font-family="Times,serif" font-size="14.00" fill="#000000">getNewProducerIdBlock</text>
<polyline fill="none" stroke="#000000" points="775.6509,-316.9036 958.8647,-316.9036 "/>
<text text-anchor="start" x="783.6509" y="-301.7036" font-family="Times,serif" font-size="14.00" fill="#000000">不断的尝试从zk中获取新的</text>
<text text-anchor="start" x="783.6509" y="-282.1037" font-family="Times,serif" font-size="14.00" fill="#000000"> ProducerIdBlock;</text>
<text text-anchor="start" x="783.6509" y="-268.1037" font-family="Times,serif" font-size="14.00" fill="#000000"> 通过zkversion来控制</text>
<text text-anchor="start" x="783.6509" y="-248.5037" font-family="Times,serif" font-size="14.00" fill="#000000"> 分布式的更新</text>
</g>
<!-- generateProducerId&#45;&gt;getNewProducerIdBlock -->
<g id="edge13" class="edge">
<title>generateProducerId&#45;&gt;getNewProducerIdBlock</title>
<path fill="none" stroke="#000000" d="M681.4089,-354.8288C708.648,-344.9613 738.4032,-334.1822 765.962,-324.1989"/>
<polygon fill="#000000" stroke="#000000" points="767.4005,-327.4004 775.6105,-320.7036 765.0163,-320.8189 767.4005,-327.4004"/>
</g>
<!-- currentProducerIdBlock -->
<g id="node19" class="node">
<title>currentProducerIdBlock</title>
<polygon fill="#95e1d3" stroke="#000000" points="1086.5894,-334.5037 1086.5894,-444.5037 1240.6206,-444.5037 1240.6206,-334.5037 1086.5894,-334.5037"/>
<text text-anchor="middle" x="1163.605" y="-429.3037" font-family="Times,serif" font-size="14.00" fill="#000000">currentProducerIdBlock</text>
<polyline fill="none" stroke="#000000" points="1086.5894,-422.5037 1240.6206,-422.5037 "/>
<text text-anchor="start" x="1094.5894" y="-407.3037" font-family="Times,serif" font-size="14.00" fill="#000000">TYPE: ProducerIdBlock</text>
<polyline fill="none" stroke="#000000" points="1086.5894,-400.5037 1240.6206,-400.5037 "/>
<text text-anchor="start" x="1094.5894" y="-385.3037" font-family="Times,serif" font-size="14.00" fill="#000000">brokerId int </text>
<polyline fill="none" stroke="#000000" points="1086.5894,-378.5037 1240.6206,-378.5037 "/>
<text text-anchor="start" x="1094.5894" y="-363.3037" font-family="Times,serif" font-size="14.00" fill="#000000">blockStartProducerId int</text>
<polyline fill="none" stroke="#000000" points="1086.5894,-356.5037 1240.6206,-356.5037 "/>
<text text-anchor="start" x="1094.5894" y="-341.3037" font-family="Times,serif" font-size="14.00" fill="#000000">blockEndProducerId int</text>
</g>
<!-- generateProducerId&#45;&gt;currentProducerIdBlock -->
<g id="edge14" class="edge">
<title>generateProducerId&#45;&gt;currentProducerIdBlock</title>
<path fill="none" stroke="#000000" d="M694.7309,-389.5037C805.2571,-389.5037 974.1112,-389.5037 1076.1678,-389.5037"/>
<polygon fill="#000000" stroke="#000000" points="1076.4413,-393.0038 1086.4413,-389.5037 1076.4412,-386.0038 1076.4413,-393.0038"/>
</g>
<!-- getNewProducerIdBlock&#45;&gt;zk_getDataAndVersion -->
<g id="edge15" class="edge">
<title>getNewProducerIdBlock&#45;&gt;zk_getDataAndVersion</title>
<path fill="none" stroke="#000000" d="M958.8812,-246.3145C982.7695,-235.6053 1008.4899,-224.101 1032.3018,-213.5037 1058.9338,-201.6514 1088.6416,-188.521 1113.0542,-177.7551"/>
<polygon fill="#000000" stroke="#000000" points="1114.7381,-180.8379 1122.4766,-173.6013 1111.9144,-174.4327 1114.7381,-180.8379"/>
</g>
<!-- getNewProducerIdBlock&#45;&gt;conditionalUpdatePath -->
<g id="edge16" class="edge">
<title>getNewProducerIdBlock&#45;&gt;conditionalUpdatePath</title>
<path fill="none" stroke="#000000" d="M909.8683,-235.82C940.7385,-201.2687 985.1812,-157.0733 1032.3018,-128.5037 1041.5882,-122.8733 1051.6856,-117.8599 1062.0186,-113.4211"/>
<polygon fill="#000000" stroke="#000000" points="1063.6363,-116.5405 1071.5579,-109.5049 1060.9779,-110.0649 1063.6363,-116.5405"/>
</g>
<!-- getNewProducerIdBlock&#45;&gt;currentProducerIdBlock -->
<g id="edge19" class="edge">
<title>getNewProducerIdBlock&#45;&gt;currentProducerIdBlock</title>
<path fill="none" stroke="#ff0000" d="M958.9944,-319.0786C996.445,-331.9688 1039.5507,-346.8054 1076.5105,-359.5266"/>
<polygon fill="#ff0000" stroke="#ff0000" points="1075.6686,-362.9383 1086.2633,-362.8834 1077.9468,-356.3193 1075.6686,-362.9383"/>
</g>
<!-- parseProducerIdBlockData -->
<g id="node20" class="node">
<title>parseProducerIdBlockData</title>
<polygon fill="none" stroke="#000000" points="1247.2129,-261.5037 1079.9971,-261.5037 1079.9971,-225.5037 1247.2129,-225.5037 1247.2129,-261.5037"/>
<text text-anchor="middle" x="1163.605" y="-239.3037" font-family="Times,serif" font-size="14.00" fill="#000000">parseProducerIdBlockData</text>
</g>
<!-- getNewProducerIdBlock&#45;&gt;parseProducerIdBlockData -->
<g id="edge17" class="edge">
<title>getNewProducerIdBlock&#45;&gt;parseProducerIdBlockData</title>
<path fill="none" stroke="#000000" d="M958.9944,-273.8832C994.115,-268.6686 1034.2088,-262.7157 1069.5435,-257.4694"/>
<polygon fill="#000000" stroke="#000000" points="1070.4814,-260.8686 1079.8589,-255.9379 1069.4533,-253.9445 1070.4814,-260.8686"/>
</g>
<!-- generateProducerIdBlockJson -->
<g id="node21" class="node">
<title>generateProducerIdBlockJson</title>
<polygon fill="none" stroke="#000000" points="1255.5503,-315.5037 1071.6597,-315.5037 1071.6597,-279.5037 1255.5503,-279.5037 1255.5503,-315.5037"/>
<text text-anchor="middle" x="1163.605" y="-293.3037" font-family="Times,serif" font-size="14.00" fill="#000000">generateProducerIdBlockJson</text>
</g>
<!-- getNewProducerIdBlock&#45;&gt;generateProducerIdBlockJson -->
<g id="edge18" class="edge">
<title>getNewProducerIdBlock&#45;&gt;generateProducerIdBlockJson</title>
<path fill="none" stroke="#000000" d="M958.9944,-290.5993C991.4224,-291.6935 1028.0903,-292.9309 1061.3369,-294.0528"/>
<polygon fill="#000000" stroke="#000000" points="1061.4242,-297.5576 1071.5365,-294.3969 1061.6603,-290.5616 1061.4242,-297.5576"/>
</g>
<!-- handleInitProducerId -->
<g id="node22" class="node">
<title>handleInitProducerId</title>
<polygon fill="none" stroke="#000000" points="246.3213,-694.3039 246.3213,-802.7035 429.166,-802.7035 429.166,-694.3039 246.3213,-694.3039"/>
<text text-anchor="middle" x="337.7437" y="-787.5035" font-family="Times,serif" font-size="14.00" fill="#000000">handleInitProducerId</text>
<polyline fill="none" stroke="#000000" points="246.3213,-780.7035 429.166,-780.7035 "/>
<text text-anchor="start" x="254.3213" y="-765.5035" font-family="Times,serif" font-size="14.00" fill="#000000">生成唯一的producerId</text>
<text text-anchor="start" x="254.3213" y="-745.9036" font-family="Times,serif" font-size="14.00" fill="#000000"> 如果tid对应的</text>
<text text-anchor="start" x="254.3213" y="-726.3037" font-family="Times,serif" font-size="14.00" fill="#000000"> TranscationState不存在的话</text>
<text text-anchor="start" x="254.3213" y="-706.7038" font-family="Times,serif" font-size="14.00" fill="#000000"> 就新建一个</text>
</g>
<!-- handleInitProducerId&#45;&gt;TransactionMetadata -->
<g id="edge20" class="edge">
<title>handleInitProducerId&#45;&gt;TransactionMetadata</title>
<path fill="none" stroke="#000000" d="M429.3211,-700.1834C433.8373,-695.3724 437.8595,-690.1529 441.166,-684.5037 467.6255,-639.2974 432.207,-257.1511 461.166,-213.5037 571.5395,-47.1475 667.6164,-21.5037 867.2578,-21.5037 867.2578,-21.5037 867.2578,-21.5037 1163.605,-21.5037 1336.4026,-21.5037 1395.5981,35.814 1552.0703,-37.5037 1589.3558,-54.9744 1621.7725,-85.6922 1647.398,-116.566"/>
<polygon fill="#000000" stroke="#000000" points="1644.7458,-118.8522 1653.7655,-124.4107 1650.1808,-114.4407 1644.7458,-118.8522"/>
</g>
<!-- handleInitProducerId&#45;&gt;appendTransactionToLog -->
<g id="edge21" class="edge">
<title>handleInitProducerId&#45;&gt;appendTransactionToLog</title>
<path fill="none" stroke="#000000" d="M429.3652,-746.2866C451.0396,-745.7621 474.1325,-745.2033 495.7323,-744.6806"/>
<polygon fill="#000000" stroke="#000000" points="495.9583,-748.1762 505.8707,-744.4352 495.7889,-741.1783 495.9583,-748.1762"/>
</g>
<!-- handleInitProducerId&#45;&gt;getTransactionState -->
<g id="edge22" class="edge">
<title>handleInitProducerId&#45;&gt;getTransactionState</title>
<path fill="none" stroke="#000000" d="M390.7315,-802.9347C411.2608,-821.4998 435.8947,-840.9657 461.166,-854.5037 470.3166,-859.4057 480.2227,-863.6786 490.3132,-867.3897"/>
<polygon fill="#000000" stroke="#000000" points="489.4306,-870.7886 500.0255,-870.7779 491.7364,-864.1793 489.4306,-870.7886"/>
</g>
<!-- handleInitProducerId&#45;&gt;putTransactionStateIfNotExists -->
<g id="edge23" class="edge">
<title>handleInitProducerId&#45;&gt;putTransactionStateIfNotExists</title>
<path fill="none" stroke="#000000" d="M429.3083,-777.0534C440.033,-780.2911 450.8313,-783.5027 461.166,-786.5037 468.5051,-788.6348 476.0985,-790.8015 483.7483,-792.9564"/>
<polygon fill="#000000" stroke="#000000" points="482.8798,-796.3478 493.4533,-795.6762 484.7687,-789.6075 482.8798,-796.3478"/>
</g>
<!-- handleInitProducerId&#45;&gt;generateProducerId -->
<g id="edge24" class="edge">
<title>handleInitProducerId&#45;&gt;generateProducerId</title>
<path fill="none" stroke="#000000" d="M429.3832,-697.1563C433.6255,-693.1654 437.5943,-688.9473 441.166,-684.5037 457.986,-663.5782 450.4705,-652.1288 461.166,-627.5037 491.5341,-557.5848 533.8917,-479.9183 560.5456,-432.9062"/>
<polygon fill="#000000" stroke="#000000" points="563.591,-434.631 565.4959,-424.2088 557.5074,-431.1683 563.591,-434.631"/>
</g>
<!-- handleTxnImmigration -->
<g id="node23" class="node">
<title>handleTxnImmigration</title>
<polygon fill="none" stroke="#000000" points="410.5992,-675.5037 264.8881,-675.5037 264.8881,-639.5037 410.5992,-639.5037 410.5992,-675.5037"/>
<text text-anchor="middle" x="337.7437" y="-653.3037" font-family="Times,serif" font-size="14.00" fill="#000000">handleTxnImmigration</text>
</g>
<!-- handleTxnImmigration&#45;&gt;loadTransactionsForTxnTopicPartition -->
<g id="edge25" class="edge">
<title>handleTxnImmigration&#45;&gt;loadTransactionsForTxnTopicPartition</title>
<path fill="none" stroke="#000000" d="M410.7947,-659.5661C425.9365,-659.9936 442.3051,-660.4557 458.7433,-660.9198"/>
<polygon fill="#000000" stroke="#000000" points="458.8823,-664.425 468.9772,-661.2087 459.0799,-657.4278 458.8823,-664.425"/>
</g>
<!-- handleLeaderAndIsrRequest -->
<g id="node24" class="node">
<title>handleLeaderAndIsrRequest</title>
<polygon fill="none" stroke="#000000" points="199.8199,-676.5037 23.5014,-676.5037 23.5014,-640.5037 199.8199,-640.5037 199.8199,-676.5037"/>
<text text-anchor="middle" x="111.6606" y="-654.3037" font-family="Times,serif" font-size="14.00" fill="#000000">handleLeaderAndIsrRequest</text>
</g>
<!-- handleLeaderAndIsrRequest&#45;&gt;handleTxnImmigration -->
<g id="edge26" class="edge">
<title>handleLeaderAndIsrRequest&#45;&gt;handleTxnImmigration</title>
<path fill="none" stroke="#000000" d="M200.0416,-658.1128C217.952,-658.0336 236.7306,-657.9505 254.4581,-657.8721"/>
<polygon fill="#000000" stroke="#000000" points="254.7755,-661.3708 264.7598,-657.8265 254.7444,-654.3709 254.7755,-661.3708"/>
</g>
<!-- handleInitProducerIdRequest -->
<g id="node25" class="node">
<title>handleInitProducerIdRequest</title>
<polygon fill="none" stroke="#000000" points="16,-695.5037 16,-797.5037 207.3213,-797.5037 207.3213,-695.5037 16,-695.5037"/>
<text text-anchor="middle" x="111.6606" y="-782.3037" font-family="Times,serif" font-size="14.00" fill="#000000">handleInitProducerIdRequest</text>
<polyline fill="none" stroke="#000000" points="16,-775.5037 207.3213,-775.5037 "/>
<text text-anchor="middle" x="111.6606" y="-760.3037" font-family="Times,serif" font-size="14.00" fill="#000000">transactionalId String</text>
<polyline fill="none" stroke="#000000" points="16,-753.5037 207.3213,-753.5037 "/>
<text text-anchor="middle" x="111.6606" y="-738.3037" font-family="Times,serif" font-size="14.00" fill="#000000">transactionTimeoutMs Int</text>
<polyline fill="none" stroke="#000000" points="16,-731.5037 207.3213,-731.5037 "/>
<text text-anchor="start" x="24" y="-716.3037" font-family="Times,serif" font-size="14.00" fill="#000000">expectedProducerIdAndEpoch </text>
<text text-anchor="middle" x="111.6606" y="-702.3037" font-family="Times,serif" font-size="14.00" fill="#000000">Option[ProducerIdAndEpoch]</text>
</g>
<!-- handleInitProducerIdRequest&#45;&gt;handleInitProducerId -->
<g id="edge27" class="edge">
<title>handleInitProducerIdRequest&#45;&gt;handleInitProducerId</title>
<path fill="none" stroke="#000000" d="M207.5402,-747.3519C216.9086,-747.4348 226.4381,-747.5191 235.8631,-747.6024"/>
<polygon fill="#000000" stroke="#000000" points="236.006,-751.1037 246.0366,-747.6924 236.068,-744.104 236.006,-751.1037"/>
</g>
</g>
</svg>
