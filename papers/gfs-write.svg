<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: gfs_write Pages: 1 -->
<svg width="1681pt" height="513pt"
 viewBox="0.00 0.00 1680.64 513.30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 509.2997)">
<title>gfs_write</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-509.2997 1676.6416,-509.2997 1676.6416,4 -4,4"/>
<g id="clust1" class="cluster">
<title>cluster_Client</title>
<polygon fill="none" stroke="#000000" points="8,-306.2997 8,-440.2997 387.7969,-440.2997 387.7969,-306.2997 8,-306.2997"/>
<text text-anchor="middle" x="197.8984" y="-420.2997" font-family="Times,serif" font-size="20.00" fill="#000000">Client</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_ChunkServer1</title>
<polygon fill="none" stroke="#000000" points="667.7974,-221.2997 667.7974,-355.2997 1262.916,-355.2997 1262.916,-221.2997 667.7974,-221.2997"/>
<text text-anchor="middle" x="965.3567" y="-335.2997" font-family="Times,serif" font-size="20.00" fill="#000000">ChunkServer: Primary</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_ChunkServer2</title>
<polygon fill="none" stroke="#000000" points="876.9043,-363.2997 876.9043,-497.2997 1664.6416,-497.2997 1664.6416,-363.2997 876.9043,-363.2997"/>
<text text-anchor="middle" x="1270.7729" y="-477.2997" font-family="Times,serif" font-size="20.00" fill="#000000">ChunkServer: Secondary</text>
</g>
<!-- Client -->
<g id="node1" class="node">
<title>Client</title>
<polygon fill="none" stroke="#000000" points="70,-350.2997 16,-350.2997 16,-314.2997 70,-314.2997 70,-350.2997"/>
<text text-anchor="middle" x="43" y="-328.0997" font-family="Times,serif" font-size="14.00" fill="#000000">Client</text>
</g>
<!-- Cache -->
<g id="node2" class="node">
<title>Cache</title>
<polygon fill="#46cdcf" stroke="#000000" points="106,-314.8999 106,-403.6996 379.7969,-403.6996 379.7969,-314.8999 106,-314.8999"/>
<text text-anchor="middle" x="242.8984" y="-388.4996" font-family="Times,serif" font-size="14.00" fill="#000000">Cache</text>
<polyline fill="none" stroke="#000000" points="106,-381.6996 379.7969,-381.6996 "/>
<text text-anchor="start" x="114" y="-366.4996" font-family="Times,serif" font-size="14.00" fill="#000000">client将元信息缓存起来</text>
<text text-anchor="start" x="114" y="-346.8997" font-family="Times,serif" font-size="14.00" fill="#000000"> 直到超时，或者primary返回lease已经过期</text>
<text text-anchor="start" x="114" y="-327.2998" font-family="Times,serif" font-size="14.00" fill="#000000"> 才会去master重新刷新cache</text>
</g>
<!-- Client&#45;&gt;Cache -->
<g id="edge1" class="edge">
<title>Client&#45;&gt;Cache</title>
<path fill="none" stroke="#666666" d="M70.3759,-335.9974C77.8358,-337.005 86.4659,-338.1706 95.8089,-339.4326"/>
<polygon fill="#666666" stroke="#666666" points="95.4056,-342.9098 105.7841,-340.7799 96.3426,-335.9728 95.4056,-342.9098"/>
</g>
<!-- req1 -->
<g id="node3" class="node">
<title>req1</title>
<polygon fill="#fefdca" stroke="#000000" points="138.1084,-127.0999 138.1084,-257.4996 347.6885,-257.4996 347.6885,-127.0999 138.1084,-127.0999"/>
<text text-anchor="middle" x="242.8984" y="-242.2996" font-family="Times,serif" font-size="14.00" fill="#000000">step 1: Get and cache metadata</text>
<polyline fill="none" stroke="#000000" points="138.1084,-235.4996 347.6885,-235.4996 "/>
<text text-anchor="start" x="146.1084" y="-220.2996" font-family="Times,serif" font-size="14.00" fill="#000000">client向master发送请求</text>
<text text-anchor="start" x="146.1084" y="-200.6997" font-family="Times,serif" font-size="14.00" fill="#000000"> 获取primary chunk sever</text>
<text text-anchor="start" x="146.1084" y="-181.0997" font-family="Times,serif" font-size="14.00" fill="#000000"> 和所有的副本chunk server</text>
<polyline fill="none" stroke="#000000" points="138.1084,-168.6998 347.6885,-168.6998 "/>
<text text-anchor="start" x="146.1084" y="-153.4998" font-family="Times,serif" font-size="14.00" fill="#000000">master返回primary chunk 和</text>
<text text-anchor="start" x="146.1084" y="-133.8999" font-family="Times,serif" font-size="14.00" fill="#000000"> secondary replicas server location</text>
</g>
<!-- Client&#45;&gt;req1 -->
<g id="edge2" class="edge">
<title>Client&#45;&gt;req1</title>
<path fill="none" stroke="#666666" d="M59.9359,-314.0661C72.0907,-301.5249 89.2222,-284.9206 106,-272.2997 113.5104,-266.6501 121.4524,-261.0845 129.5774,-255.6811"/>
<polygon fill="#666666" stroke="#666666" points="131.6433,-258.5121 138.1001,-250.1121 127.8143,-252.6522 131.6433,-258.5121"/>
</g>
<!-- req2 -->
<g id="node12" class="node">
<title>req2</title>
<polygon fill="#fefdca" stroke="#000000" points="444.3027,-229.0999 444.3027,-345.4996 587.1846,-345.4996 587.1846,-229.0999 444.3027,-229.0999"/>
<text text-anchor="middle" x="515.7437" y="-330.2996" font-family="Times,serif" font-size="14.00" fill="#000000">step 2: Push data</text>
<polyline fill="none" stroke="#000000" points="444.3027,-323.4996 587.1846,-323.4996 "/>
<text text-anchor="start" x="452.3027" y="-308.2996" font-family="Times,serif" font-size="14.00" fill="#000000">client向所有的chunk</text>
<text text-anchor="start" x="452.3027" y="-288.6997" font-family="Times,serif" font-size="14.00" fill="#000000"> server push数据</text>
<polyline fill="none" stroke="#000000" points="444.3027,-276.2997 587.1846,-276.2997 "/>
<text text-anchor="start" x="452.3027" y="-261.0997" font-family="Times,serif" font-size="14.00" fill="#000000">chunk server写入</text>
<text text-anchor="start" x="452.3027" y="-241.4998" font-family="Times,serif" font-size="14.00" fill="#000000"> buffer成功后返回ack</text>
</g>
<!-- Client&#45;&gt;req2 -->
<g id="edge10" class="edge">
<title>Client&#45;&gt;req2</title>
<path fill="none" stroke="#666666" d="M70.1846,-318.1021C81.0314,-313.1218 93.8186,-308.08 106,-305.2997 217.4553,-279.8611 350.2749,-279.2508 433.8221,-282.3319"/>
<polygon fill="#666666" stroke="#666666" points="433.8833,-285.8369 444.0139,-282.7351 434.1601,-278.8424 433.8833,-285.8369"/>
</g>
<!-- req3 -->
<g id="node13" class="node">
<title>req3</title>
<polygon fill="#fefdca" stroke="#000000" points="415.7969,-.5 415.7969,-156.0995 615.6904,-156.0995 615.6904,-.5 415.7969,-.5"/>
<text text-anchor="middle" x="515.7437" y="-140.8995" font-family="Times,serif" font-size="14.00" fill="#000000">step 3: Write</text>
<polyline fill="none" stroke="#000000" points="415.7969,-134.0995 615.6904,-134.0995 "/>
<text text-anchor="start" x="423.7969" y="-118.8995" font-family="Times,serif" font-size="14.00" fill="#000000">client 向primeray发送write请求</text>
<polyline fill="none" stroke="#000000" points="415.7969,-106.4996 615.6904,-106.4996 "/>
<text text-anchor="start" x="423.7969" y="-91.2996" font-family="Times,serif" font-size="14.00" fill="#000000">primary写完并且收到所有</text>
<text text-anchor="start" x="423.7969" y="-71.6997" font-family="Times,serif" font-size="14.00" fill="#000000"> secondary的ack之后</text>
<text text-anchor="start" x="423.7969" y="-52.0997" font-family="Times,serif" font-size="14.00" fill="#000000"> 返回信息给client</text>
<text text-anchor="start" x="423.7969" y="-32.4998" font-family="Times,serif" font-size="14.00" fill="#000000"> 如果后续步骤出错，</text>
<text text-anchor="start" x="423.7969" y="-12.8999" font-family="Times,serif" font-size="14.00" fill="#000000"> 就直接返回错误给client</text>
</g>
<!-- Client&#45;&gt;req3 -->
<g id="edge13" class="edge">
<title>Client&#45;&gt;req3</title>
<path fill="none" stroke="#666666" d="M45.6823,-314.1616C53.0331,-267.0833 75.0351,-142.8731 106,-117.2997 188.5795,-49.0989 314.9146,-47.3893 405.4631,-57.691"/>
<polygon fill="#666666" stroke="#666666" points="405.1449,-61.1779 415.4913,-58.8973 405.9809,-54.228 405.1449,-61.1779"/>
</g>
<!-- MasterServer -->
<g id="node4" class="node">
<title>MasterServer</title>
<polygon fill="none" stroke="#000000" points="561.6587,-210.2997 469.8286,-210.2997 469.8286,-174.2997 561.6587,-174.2997 561.6587,-210.2997"/>
<text text-anchor="middle" x="515.7437" y="-188.0997" font-family="Times,serif" font-size="14.00" fill="#000000">MasterServer</text>
</g>
<!-- req1&#45;&gt;MasterServer -->
<g id="edge3" class="edge">
<title>req1&#45;&gt;MasterServer</title>
<path fill="none" stroke="#666666" d="M347.9972,-192.2997C386.0615,-192.2997 427.5651,-192.2997 459.766,-192.2997"/>
<polygon fill="#666666" stroke="#666666" points="459.8778,-195.7998 469.8778,-192.2997 459.8778,-188.7998 459.8778,-195.7998"/>
</g>
<!-- lease -->
<g id="node5" class="node">
<title>lease</title>
<polygon fill="#fefdca" stroke="#000000" points="651.6904,-143.6998 651.6904,-212.8997 799.9043,-212.8997 799.9043,-143.6998 651.6904,-143.6998"/>
<text text-anchor="middle" x="725.7974" y="-197.6997" font-family="Times,serif" font-size="14.00" fill="#000000">lease</text>
<polyline fill="none" stroke="#000000" points="651.6904,-190.8997 799.9043,-190.8997 "/>
<text text-anchor="start" x="659.6904" y="-175.6997" font-family="Times,serif" font-size="14.00" fill="#000000">通过租约机制从chunk</text>
<text text-anchor="start" x="659.6904" y="-156.0997" font-family="Times,serif" font-size="14.00" fill="#000000"> 副本中指定primary</text>
</g>
<!-- MasterServer&#45;&gt;lease -->
<g id="edge4" class="edge">
<title>MasterServer&#45;&gt;lease</title>
<path fill="none" stroke="#666666" d="M561.5813,-189.2447C584.916,-187.6894 614.0386,-185.7484 641.2524,-183.9346"/>
<polygon fill="#666666" stroke="#666666" points="641.8278,-187.4041 651.5729,-183.2468 641.3622,-180.4196 641.8278,-187.4041"/>
</g>
<!-- ChunkServerPrimary -->
<g id="node6" class="node">
<title>ChunkServerPrimary</title>
<polygon fill="none" stroke="#000000" points="835.9043,-229.8999 835.9043,-318.6996 1033.9043,-318.6996 1033.9043,-229.8999 835.9043,-229.8999"/>
<text text-anchor="middle" x="934.9043" y="-303.4996" font-family="Times,serif" font-size="14.00" fill="#000000">ChunkServerPrimary</text>
<polyline fill="none" stroke="#000000" points="835.9043,-296.6996 1033.9043,-296.6996 "/>
<text text-anchor="start" x="843.9043" y="-281.4996" font-family="Times,serif" font-size="14.00" fill="#000000">处理写请求，将客户端对数据</text>
<text text-anchor="start" x="843.9043" y="-261.8997" font-family="Times,serif" font-size="14.00" fill="#000000"> 的修改进行串行化</text>
<text text-anchor="start" x="843.9043" y="-242.2998" font-family="Times,serif" font-size="14.00" fill="#000000"> 然后串行化的修改数据。</text>
</g>
<!-- lease&#45;&gt;ChunkServerPrimary -->
<g id="edge5" class="edge">
<title>lease&#45;&gt;ChunkServerPrimary</title>
<path fill="none" stroke="#666666" d="M800.1094,-212.4161C809.4501,-216.7043 819.1432,-221.1544 828.8535,-225.6123"/>
<polygon fill="#666666" stroke="#666666" points="827.6093,-228.8923 838.1576,-229.8838 830.5299,-222.5307 827.6093,-228.8923"/>
</g>
<!-- ChunkFile1 -->
<g id="node8" class="node">
<title>ChunkFile1</title>
<polygon fill="none" stroke="#000000" points="1113.21,-239.6998 1113.21,-308.8997 1254.916,-308.8997 1254.916,-239.6998 1113.21,-239.6998"/>
<text text-anchor="middle" x="1184.063" y="-293.6997" font-family="Times,serif" font-size="14.00" fill="#000000">ChunkFile</text>
<polyline fill="none" stroke="#000000" points="1113.21,-286.8997 1254.916,-286.8997 "/>
<text text-anchor="start" x="1121.21" y="-271.6997" font-family="Times,serif" font-size="14.00" fill="#000000">将buffer中record串行</text>
<text text-anchor="start" x="1121.21" y="-252.0997" font-family="Times,serif" font-size="14.00" fill="#000000"> 的写入chunk文件</text>
</g>
<!-- ChunkServerPrimary&#45;&gt;ChunkFile1 -->
<g id="edge7" class="edge">
<title>ChunkServerPrimary&#45;&gt;ChunkFile1</title>
<path fill="none" stroke="#666666" d="M1034.0943,-274.2997C1056.8222,-274.2997 1080.7274,-274.2997 1102.608,-274.2997"/>
<polygon fill="#666666" stroke="#666666" points="1102.8387,-277.7998 1112.8387,-274.2997 1102.8387,-270.7998 1102.8387,-277.7998"/>
</g>
<!-- req4 -->
<g id="node14" class="node">
<title>req4</title>
<polygon fill="#fefdca" stroke="#000000" points="1069.9043,-135.6998 1069.9043,-212.8997 1298.2217,-212.8997 1298.2217,-135.6998 1069.9043,-135.6998"/>
<text text-anchor="middle" x="1184.063" y="-197.6997" font-family="Times,serif" font-size="14.00" fill="#000000">step 4: forward write</text>
<polyline fill="none" stroke="#000000" points="1069.9043,-190.8997 1298.2217,-190.8997 "/>
<text text-anchor="start" x="1077.9043" y="-175.6997" font-family="Times,serif" font-size="14.00" fill="#000000">primary将写请求转发给所有的副本</text>
<polyline fill="none" stroke="#000000" points="1069.9043,-163.2997 1298.2217,-163.2997 "/>
<text text-anchor="start" x="1077.9043" y="-148.0997" font-family="Times,serif" font-size="14.00" fill="#000000">副本处理完后返回ack给primary</text>
</g>
<!-- ChunkServerPrimary&#45;&gt;req4 -->
<g id="edge15" class="edge">
<title>ChunkServerPrimary&#45;&gt;req4</title>
<path fill="none" stroke="#666666" d="M1034.2512,-231.832C1046.2356,-226.8634 1058.3269,-221.9222 1069.9043,-217.2997 1070.4728,-217.0727 1071.0431,-216.8454 1071.615,-216.6177"/>
<polygon fill="#666666" stroke="#666666" points="1072.9889,-219.8382 1081.0021,-212.9072 1070.4156,-213.3283 1072.9889,-219.8382"/>
</g>
<!-- ChunkServerBuffer1 -->
<g id="node7" class="node">
<title>ChunkServerBuffer1</title>
<polygon fill="#46cdcf" stroke="#000000" points="675.7974,-244.6998 675.7974,-313.8997 775.7974,-313.8997 775.7974,-244.6998 675.7974,-244.6998"/>
<text text-anchor="middle" x="725.7974" y="-298.6997" font-family="Times,serif" font-size="14.00" fill="#000000">LRU Buffer</text>
<polyline fill="none" stroke="#000000" points="675.7974,-291.8997 775.7974,-291.8997 "/>
<text text-anchor="start" x="683.7974" y="-276.6997" font-family="Times,serif" font-size="14.00" fill="#000000">写请求先缓存</text>
<text text-anchor="start" x="683.7974" y="-257.0997" font-family="Times,serif" font-size="14.00" fill="#000000"> 到buffer中</text>
</g>
<!-- ChunkServerBuffer1&#45;&gt;ChunkServerPrimary -->
<g id="edge6" class="edge">
<title>ChunkServerBuffer1&#45;&gt;ChunkServerPrimary</title>
<path fill="none" stroke="#666666" d="M775.8837,-278.1021C790.933,-277.7423 808.0712,-277.3325 825.3912,-276.9183"/>
<polygon fill="#666666" stroke="#666666" points="825.6822,-280.4125 835.5956,-276.6743 825.5148,-273.4145 825.6822,-280.4125"/>
</g>
<!-- ChunkServerBuffer2 -->
<g id="node9" class="node">
<title>ChunkServerBuffer2</title>
<polygon fill="#46cdcf" stroke="#000000" points="884.9043,-371.6998 884.9043,-440.8997 984.9043,-440.8997 984.9043,-371.6998 884.9043,-371.6998"/>
<text text-anchor="middle" x="934.9043" y="-425.6997" font-family="Times,serif" font-size="14.00" fill="#000000">LRU Buffer</text>
<polyline fill="none" stroke="#000000" points="884.9043,-418.8997 984.9043,-418.8997 "/>
<text text-anchor="start" x="892.9043" y="-403.6997" font-family="Times,serif" font-size="14.00" fill="#000000">写请求先缓存</text>
<text text-anchor="start" x="892.9043" y="-384.0997" font-family="Times,serif" font-size="14.00" fill="#000000"> 到buffer中</text>
</g>
<!-- ChunkServerSecondary -->
<g id="node10" class="node">
<title>ChunkServerSecondary</title>
<polygon fill="none" stroke="#000000" points="1334.2217,-374.4998 1334.2217,-438.0997 1483.1875,-438.0997 1483.1875,-374.4998 1334.2217,-374.4998"/>
<text text-anchor="middle" x="1408.7046" y="-422.8997" font-family="Times,serif" font-size="14.00" fill="#000000">ChunkServerSecondary</text>
<polyline fill="none" stroke="#000000" points="1334.2217,-416.0997 1483.1875,-416.0997 "/>
<text text-anchor="start" x="1342.2217" y="-400.8997" font-family="Times,serif" font-size="14.00" fill="#000000">使用primary相同顺序</text>
<text text-anchor="start" x="1342.2217" y="-381.2998" font-family="Times,serif" font-size="14.00" fill="#000000"> apply mutation</text>
</g>
<!-- ChunkServerBuffer2&#45;&gt;ChunkServerSecondary -->
<g id="edge8" class="edge">
<title>ChunkServerBuffer2&#45;&gt;ChunkServerSecondary</title>
<path fill="none" stroke="#666666" d="M985.1607,-406.2997C1065.8978,-406.2997 1225.4005,-406.2997 1323.9702,-406.2997"/>
<polygon fill="#666666" stroke="#666666" points="1324.2,-409.7998 1334.2,-406.2997 1324.2,-402.7998 1324.2,-409.7998"/>
</g>
<!-- ChunkFile2 -->
<g id="node11" class="node">
<title>ChunkFile2</title>
<polygon fill="none" stroke="#000000" points="1519.1875,-371.8999 1519.1875,-460.6996 1656.6416,-460.6996 1656.6416,-371.8999 1519.1875,-371.8999"/>
<text text-anchor="middle" x="1587.9146" y="-445.4996" font-family="Times,serif" font-size="14.00" fill="#000000">ChunkFile</text>
<polyline fill="none" stroke="#000000" points="1519.1875,-438.6996 1656.6416,-438.6996 "/>
<text text-anchor="start" x="1527.1875" y="-423.4996" font-family="Times,serif" font-size="14.00" fill="#000000">按照primary顺序</text>
<text text-anchor="start" x="1527.1875" y="-403.8997" font-family="Times,serif" font-size="14.00" fill="#000000"> 写入将buffer中内容</text>
<text text-anchor="start" x="1527.1875" y="-384.2998" font-family="Times,serif" font-size="14.00" fill="#000000"> 写入chunk文件</text>
</g>
<!-- ChunkServerSecondary&#45;&gt;ChunkFile2 -->
<g id="edge9" class="edge">
<title>ChunkServerSecondary&#45;&gt;ChunkFile2</title>
<path fill="none" stroke="#666666" d="M1483.4081,-410.4682C1491.8064,-410.9369 1500.3845,-411.4155 1508.8359,-411.8871"/>
<polygon fill="#666666" stroke="#666666" points="1508.8818,-415.395 1519.0613,-412.4577 1509.2719,-408.4059 1508.8818,-415.395"/>
</g>
<!-- req2&#45;&gt;ChunkServerBuffer1 -->
<g id="edge11" class="edge">
<title>req2&#45;&gt;ChunkServerBuffer1</title>
<path fill="none" stroke="#666666" d="M587.4447,-284.569C612.8191,-283.6026 641.0887,-282.5259 665.4269,-281.599"/>
<polygon fill="#666666" stroke="#666666" points="665.7374,-285.0898 675.5969,-281.2117 665.4709,-278.0949 665.7374,-285.0898"/>
</g>
<!-- req2&#45;&gt;ChunkServerBuffer2 -->
<g id="edge12" class="edge">
<title>req2&#45;&gt;ChunkServerBuffer2</title>
<path fill="none" stroke="#666666" d="M587.5377,-330.8458C607.7089,-341.5342 630.0563,-351.9919 651.6904,-359.2997 726.1931,-384.4661 816.4389,-396.4643 874.7228,-401.9666"/>
<polygon fill="#666666" stroke="#666666" points="874.5893,-405.4688 884.8652,-402.8888 875.2232,-398.4975 874.5893,-405.4688"/>
</g>
<!-- req3&#45;&gt;ChunkServerPrimary -->
<g id="edge14" class="edge">
<title>req3&#45;&gt;ChunkServerPrimary</title>
<path fill="none" stroke="#666666" d="M615.7745,-83.2334C672.6308,-89.5501 743.5038,-103.5555 799.9043,-134.2997 838.685,-155.4394 873.0819,-191.5291 897.4494,-221.771"/>
<polygon fill="#666666" stroke="#666666" points="894.7897,-224.0503 903.7377,-229.7235 900.2806,-219.7085 894.7897,-224.0503"/>
</g>
<!-- req4&#45;&gt;ChunkServerSecondary -->
<g id="edge16" class="edge">
<title>req4&#45;&gt;ChunkServerSecondary</title>
<path fill="none" stroke="#666666" d="M1292.7158,-212.9396C1294.6033,-214.3443 1296.4414,-215.7971 1298.2217,-217.2997 1345.377,-257.1002 1377.1575,-322.4343 1394.0985,-364.9078"/>
<polygon fill="#666666" stroke="#666666" points="1390.901,-366.3426 1397.7874,-374.3941 1397.4251,-363.8055 1390.901,-366.3426"/>
</g>
</g>
</svg>
