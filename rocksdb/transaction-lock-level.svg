<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: transaction_lock_level Pages: 1 -->
<svg width="1641pt" height="538pt"
 viewBox="0.00 0.00 1641.00 538.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 534)">
<title>transaction_lock_level</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-534 1637,-534 1637,4 -4,4"/>
<g id="clust1" class="cluster">
<title>cluster_TransactionLockMgr</title>
<polygon fill="none" stroke="#000000" points="8,-8 8,-522 1625,-522 1625,-8 8,-8"/>
<text text-anchor="middle" x="816.5" y="-502" font-family="Times,serif" font-size="20.00" fill="#000000">TransactionLockMgr</text>
</g>
<!-- lock_maps_cache_ -->
<g id="node1" class="node">
<title>lock_maps_cache_</title>
<polygon fill="none" stroke="#000000" points="16,-151 16,-303 226,-303 226,-151 16,-151"/>
<text text-anchor="middle" x="121" y="-287.8" font-family="Times,serif" font-size="14.00" fill="#000000">lock_maps_cache_</text>
<polyline fill="none" stroke="#000000" points="16,-280 226,-280 "/>
<text text-anchor="start" x="24" y="-264.8" font-family="Times,serif" font-size="14.00" fill="#000000">对LockMaps的ThreadLocal Cache</text>
<polyline fill="none" stroke="#000000" points="16,-257 226,-257 "/>
<text text-anchor="start" x="24" y="-241.8" font-family="Times,serif" font-size="14.00" fill="#000000">在cache中找不到的</text>
<text text-anchor="start" x="24" y="-226.8" font-family="Times,serif" font-size="14.00" fill="#000000"> 使用mutex访问</text>
<text text-anchor="start" x="24" y="-211.8" font-family="Times,serif" font-size="14.00" fill="#000000"> 全局LockMaps并</text>
<text text-anchor="start" x="24" y="-196.8" font-family="Times,serif" font-size="14.00" fill="#000000"> 更新线程局部cache</text>
<polyline fill="none" stroke="#000000" points="16,-189 226,-189 "/>
<text text-anchor="start" x="24" y="-173.8" font-family="Times,serif" font-size="14.00" fill="#000000">std::unique_ptr&lt;ThreadLocalPtr&gt;</text>
<text text-anchor="start" x="24" y="-158.8" font-family="Times,serif" font-size="14.00" fill="#000000"> lock_maps_cache_;</text>
</g>
<!-- LockMaps -->
<g id="node2" class="node">
<title>LockMaps</title>
<polygon fill="none" stroke="#000000" points="262,-177.5 262,-276.5 501,-276.5 501,-177.5 262,-177.5"/>
<text text-anchor="middle" x="381.5" y="-261.3" font-family="Times,serif" font-size="14.00" fill="#000000">LockMaps</text>
<polyline fill="none" stroke="#000000" points="262,-253.5 501,-253.5 "/>
<text text-anchor="start" x="270" y="-238.3" font-family="Times,serif" font-size="14.00" fill="#000000">从ColumnFaimlyID到LockMap的映射</text>
<polyline fill="none" stroke="#000000" points="262,-230.5 501,-230.5 "/>
<text text-anchor="start" x="270" y="-215.3" font-family="Times,serif" font-size="14.00" fill="#000000">using LockMaps =</text>
<text text-anchor="start" x="270" y="-200.3" font-family="Times,serif" font-size="14.00" fill="#000000"> std::unordered_map&lt;uint32_t, </text>
<text text-anchor="start" x="270" y="-185.3" font-family="Times,serif" font-size="14.00" fill="#000000"> std::shared_ptr&lt;LockMap&gt;&gt;;</text>
</g>
<!-- lock_maps_cache_&#45;&gt;LockMaps -->
<g id="edge1" class="edge">
<title>lock_maps_cache_&#45;&gt;LockMaps</title>
<path fill="none" stroke="#666666" d="M226.2044,-227C234.6284,-227 243.1975,-227 251.7637,-227"/>
<polygon fill="#666666" stroke="#666666" points="251.8095,-230.5001 261.8095,-227 251.8094,-223.5001 251.8095,-230.5001"/>
</g>
<!-- LockMap -->
<g id="node3" class="node">
<title>LockMap</title>
<polygon fill="none" stroke="#000000" points="537,-169.5 537,-284.5 830,-284.5 830,-169.5 537,-169.5"/>
<text text-anchor="middle" x="683.5" y="-269.3" font-family="Times,serif" font-size="14.00" fill="#000000">LockMap</text>
<polyline fill="none" stroke="#000000" points="537,-261.5 830,-261.5 "/>
<text text-anchor="start" x="545" y="-246.3" font-family="Times,serif" font-size="14.00" fill="#000000">key被划分为不同stripe, 降低锁的粒度</text>
<polyline fill="none" stroke="#000000" points="537,-238.5 830,-238.5 "/>
<text text-anchor="start" x="545" y="-223.3" font-family="Times,serif" font-size="14.00" fill="#000000">const size_t num_stripes_;</text>
<polyline fill="none" stroke="#000000" points="537,-215.5 830,-215.5 "/>
<text text-anchor="start" x="545" y="-200.3" font-family="Times,serif" font-size="14.00" fill="#000000">std::atomic&lt;int64_t&gt; lock_cnt{0};</text>
<polyline fill="none" stroke="#000000" points="537,-192.5 830,-192.5 "/>
<text text-anchor="start" x="545" y="-177.3" font-family="Times,serif" font-size="14.00" fill="#000000">std::vector&lt;LockMapStripe*&gt; lock_map_stripes_;</text>
</g>
<!-- LockMaps&#45;&gt;LockMap -->
<g id="edge2" class="edge">
<title>LockMaps&#45;&gt;LockMap</title>
<path fill="none" stroke="#666666" d="M501.2922,-227C509.696,-227 518.2347,-227 526.7979,-227"/>
<polygon fill="#666666" stroke="#666666" points="526.8551,-230.5001 536.855,-227 526.855,-223.5001 526.8551,-230.5001"/>
</g>
<!-- LockMapStripe -->
<g id="node4" class="node">
<title>LockMapStripe</title>
<polygon fill="none" stroke="#000000" points="866,-162 866,-292 1173,-292 1173,-162 866,-162"/>
<text text-anchor="middle" x="1019.5" y="-276.8" font-family="Times,serif" font-size="14.00" fill="#000000">LockMapStripe</text>
<polyline fill="none" stroke="#000000" points="866,-269 1173,-269 "/>
<text text-anchor="start" x="874" y="-253.8" font-family="Times,serif" font-size="14.00" fill="#000000">mutex用于保护对keys的操作</text>
<text text-anchor="start" x="874" y="-238.8" font-family="Times,serif" font-size="14.00" fill="#000000"> cv用于wait和notify</text>
<polyline fill="none" stroke="#000000" points="866,-231 1173,-231 "/>
<text text-anchor="start" x="874" y="-215.8" font-family="Times,serif" font-size="14.00" fill="#000000">std::shared_ptr&lt;TransactionDBMutex&gt; stripe_mutex</text>
<polyline fill="none" stroke="#000000" points="866,-208 1173,-208 "/>
<text text-anchor="start" x="874" y="-192.8" font-family="Times,serif" font-size="14.00" fill="#000000">std::shared_ptr&lt;TransactionDBCondVar&gt; stripe_cv;</text>
<polyline fill="none" stroke="#000000" points="866,-185 1173,-185 "/>
<text text-anchor="start" x="874" y="-169.8" font-family="Times,serif" font-size="14.00" fill="#000000">std::unordered_map&lt;std::string, LockInfo&gt; keys;</text>
</g>
<!-- LockMap&#45;&gt;LockMapStripe -->
<g id="edge3" class="edge">
<title>LockMap&#45;&gt;LockMapStripe</title>
<path fill="none" stroke="#666666" d="M830.3857,-227C838.7343,-227 847.1535,-227 855.5592,-227"/>
<polygon fill="#666666" stroke="#666666" points="855.7999,-230.5001 865.7999,-227 855.7998,-223.5001 855.7999,-230.5001"/>
</g>
<!-- TransactionDBMutex -->
<g id="node5" class="node">
<title>TransactionDBMutex</title>
<polygon fill="none" stroke="#000000" points="1258.5,-16.5 1258.5,-131.5 1567.5,-131.5 1567.5,-16.5 1258.5,-16.5"/>
<text text-anchor="middle" x="1413" y="-116.3" font-family="Times,serif" font-size="14.00" fill="#000000">TransactionDBMutex</text>
<polyline fill="none" stroke="#000000" points="1258.5,-108.5 1567.5,-108.5 "/>
<text text-anchor="start" x="1266.5" y="-93.3" font-family="Times,serif" font-size="14.00" fill="#000000">对mutex的接口抽象</text>
<polyline fill="none" stroke="#000000" points="1258.5,-85.5 1567.5,-85.5 "/>
<text text-anchor="start" x="1266.5" y="-70.3" font-family="Times,serif" font-size="14.00" fill="#000000">virtual Status Lock() = 0;</text>
<polyline fill="none" stroke="#000000" points="1258.5,-62.5 1567.5,-62.5 "/>
<text text-anchor="start" x="1266.5" y="-47.3" font-family="Times,serif" font-size="14.00" fill="#000000">virtual Status TryLockFor(int64_t timeout_time) = 0;</text>
<polyline fill="none" stroke="#000000" points="1258.5,-39.5 1567.5,-39.5 "/>
<text text-anchor="start" x="1266.5" y="-24.3" font-family="Times,serif" font-size="14.00" fill="#000000">virtual void UnLock() = 0;</text>
</g>
<!-- LockMapStripe&#45;&gt;TransactionDBMutex -->
<g id="edge4" class="edge">
<title>LockMapStripe&#45;&gt;TransactionDBMutex</title>
<path fill="none" stroke="#666666" d="M1158.2181,-161.9691C1175.2083,-154.621 1192.4216,-147.4623 1209,-141 1221.7866,-136.0158 1235.1144,-131.0795 1248.5632,-126.2805"/>
<polygon fill="#666666" stroke="#666666" points="1250.1108,-129.4457 1258.3715,-122.8116 1247.7767,-122.8463 1250.1108,-129.4457"/>
</g>
<!-- TransactionDBCondVar -->
<g id="node6" class="node">
<title>TransactionDBCondVar</title>
<polygon fill="none" stroke="#000000" points="1209,-150.5 1209,-303.5 1617,-303.5 1617,-150.5 1209,-150.5"/>
<text text-anchor="middle" x="1413" y="-288.3" font-family="Times,serif" font-size="14.00" fill="#000000">TransactionDBCondVar</text>
<polyline fill="none" stroke="#000000" points="1209,-280.5 1617,-280.5 "/>
<text text-anchor="start" x="1217" y="-265.3" font-family="Times,serif" font-size="14.00" fill="#000000">对condvar的接口抽象</text>
<polyline fill="none" stroke="#000000" points="1209,-257.5 1617,-257.5 "/>
<text text-anchor="start" x="1217" y="-242.3" font-family="Times,serif" font-size="14.00" fill="#000000">virtual Status Wait(std::shared_ptr&lt;TransactionDBMutex&gt; mutex) = 0;</text>
<polyline fill="none" stroke="#000000" points="1209,-234.5 1617,-234.5 "/>
<text text-anchor="start" x="1217" y="-219.3" font-family="Times,serif" font-size="14.00" fill="#000000">virtual Status WaitFor(std::shared_ptr&lt;TransactionDBMutex&gt; mutex,</text>
<text text-anchor="start" x="1217" y="-204.3" font-family="Times,serif" font-size="14.00" fill="#000000"> int64_t timeout_time) = 0;</text>
<polyline fill="none" stroke="#000000" points="1209,-196.5 1617,-196.5 "/>
<text text-anchor="start" x="1217" y="-181.3" font-family="Times,serif" font-size="14.00" fill="#000000">virtual void Notify() = 0;</text>
<polyline fill="none" stroke="#000000" points="1209,-173.5 1617,-173.5 "/>
<text text-anchor="start" x="1217" y="-158.3" font-family="Times,serif" font-size="14.00" fill="#000000">virtual void NotifyAll() = 0;</text>
</g>
<!-- LockMapStripe&#45;&gt;TransactionDBCondVar -->
<g id="edge5" class="edge">
<title>LockMapStripe&#45;&gt;TransactionDBCondVar</title>
<path fill="none" stroke="#666666" d="M1173.046,-227C1181.4945,-227 1190.0548,-227 1198.6604,-227"/>
<polygon fill="#666666" stroke="#666666" points="1198.7793,-230.5001 1208.7793,-227 1198.7793,-223.5001 1198.7793,-230.5001"/>
</g>
<!-- LockInfo -->
<g id="node7" class="node">
<title>LockInfo</title>
<polygon fill="none" stroke="#000000" points="1305.5,-323 1305.5,-483 1520.5,-483 1520.5,-323 1305.5,-323"/>
<text text-anchor="start" x="1313.5" y="-467.8" font-family="Times,serif" font-size="14.00" fill="#000000">LockInfo</text>
<polyline fill="none" stroke="#000000" points="1305.5,-460 1520.5,-460 "/>
<text text-anchor="start" x="1313.5" y="-444.8" font-family="Times,serif" font-size="14.00" fill="#000000">保存了key对应的lock信息</text>
<text text-anchor="start" x="1313.5" y="-429.8" font-family="Times,serif" font-size="14.00" fill="#000000"> 是否是排他锁</text>
<text text-anchor="start" x="1313.5" y="-414.8" font-family="Times,serif" font-size="14.00" fill="#000000"> 持有该key 的事务id</text>
<text text-anchor="start" x="1313.5" y="-399.8" font-family="Times,serif" font-size="14.00" fill="#000000"> 过期时间</text>
<polyline fill="none" stroke="#000000" points="1305.5,-392 1520.5,-392 "/>
<text text-anchor="start" x="1313.5" y="-376.8" font-family="Times,serif" font-size="14.00" fill="#000000">bool exclusive;</text>
<polyline fill="none" stroke="#000000" points="1305.5,-369 1520.5,-369 "/>
<text text-anchor="start" x="1313.5" y="-353.8" font-family="Times,serif" font-size="14.00" fill="#000000">autovector&lt;TransactionID&gt; txn_ids;</text>
<polyline fill="none" stroke="#000000" points="1305.5,-346 1520.5,-346 "/>
<text text-anchor="start" x="1313.5" y="-330.8" font-family="Times,serif" font-size="14.00" fill="#000000">uint64_t expiration_time;</text>
</g>
<!-- LockMapStripe&#45;&gt;LockInfo -->
<g id="edge6" class="edge">
<title>LockMapStripe&#45;&gt;LockInfo</title>
<path fill="none" stroke="#666666" d="M1162.477,-292.0802C1178.1659,-299.1638 1193.9128,-306.2487 1209,-313 1237.2167,-325.6266 1267.6803,-339.1334 1296.2433,-351.7426"/>
<polygon fill="#666666" stroke="#666666" points="1294.8831,-354.9679 1305.445,-355.8027 1297.7089,-348.5636 1294.8831,-354.9679"/>
</g>
</g>
</svg>
