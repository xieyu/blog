<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: tranaction_lock_mgr Pages: 1 -->
<svg width="2388pt" height="1162pt"
 viewBox="0.00 0.00 2388.00 1162.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 1158)">
<title>tranaction_lock_mgr</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-1158 2384,-1158 2384,4 -4,4"/>
<g id="clust1" class="cluster">
<title>cluster_PessimisticTransaction</title>
<polygon fill="none" stroke="#000000" points="87.5,-956 87.5,-1146 2372,-1146 2372,-956 87.5,-956"/>
<text text-anchor="middle" x="1229.75" y="-1126" font-family="Times,serif" font-size="20.00" fill="#000000">PessimisticTransaction</text>
</g>
<g id="clust4" class="cluster">
<title>cluster_TransactionOptions</title>
<polygon fill="none" stroke="#000000" points="366,-8 366,-144 537,-144 537,-8 366,-8"/>
<text text-anchor="middle" x="451.5" y="-124" font-family="Times,serif" font-size="20.00" fill="#000000">TransactionOptions</text>
</g>
<g id="clust5" class="cluster">
<title>cluster_LockMap</title>
<polygon fill="none" stroke="#000000" points="360,-152 360,-597 2234,-597 2234,-152 360,-152"/>
<text text-anchor="middle" x="1297" y="-577" font-family="Times,serif" font-size="20.00" fill="#000000">LockMap</text>
</g>
<g id="clust6" class="cluster">
<title>cluster_LockMapStripe</title>
<polygon fill="none" stroke="#000000" points="1459,-160 1459,-559 2226,-559 2226,-160 1459,-160"/>
<text text-anchor="middle" x="1842.5" y="-539" font-family="Times,serif" font-size="20.00" fill="#000000">LockMapStripe</text>
</g>
<g id="clust8" class="cluster">
<title>cluster_TransactionLockMgr</title>
<polygon fill="none" stroke="#000000" points="8,-605 8,-948 2081.5,-948 2081.5,-605 8,-605"/>
<text text-anchor="middle" x="1044.75" y="-928" font-family="Times,serif" font-size="20.00" fill="#000000">TransactionLockMgr</text>
</g>
<!-- ClearWaitingTxn -->
<g id="node1" class="node">
<title>ClearWaitingTxn</title>
<polygon fill="none" stroke="#000000" points="2070,-1054 1958,-1054 1958,-1018 2070,-1018 2070,-1054"/>
<text text-anchor="middle" x="2014" y="-1032.3" font-family="Times,serif" font-size="14.00" fill="#000000">ClearWaitingTxn</text>
</g>
<!-- waiting_txn_ids_ -->
<g id="node2" class="node">
<title>waiting_txn_ids_</title>
<polygon fill="none" stroke="#000000" points="2364,-1108 2254,-1108 2254,-1072 2364,-1072 2364,-1108"/>
<text text-anchor="middle" x="2309" y="-1086.3" font-family="Times,serif" font-size="14.00" fill="#000000">waiting_txn_ids_</text>
</g>
<!-- ClearWaitingTxn&#45;&gt;waiting_txn_ids_ -->
<g id="edge1" class="edge">
<title>ClearWaitingTxn&#45;&gt;waiting_txn_ids_</title>
<path fill="none" stroke="#666666" d="M2070.1816,-1046.2841C2119.6277,-1055.3352 2191.6459,-1068.5182 2243.6548,-1078.0385"/>
<polygon fill="#666666" stroke="#666666" points="2243.3103,-1081.5335 2253.7771,-1079.8914 2244.5708,-1074.6479 2243.3103,-1081.5335"/>
</g>
<!-- wait_mutex_ -->
<g id="node3" class="node">
<title>wait_mutex_</title>
<polygon fill="none" stroke="#000000" points="2353,-1054 2265,-1054 2265,-1018 2353,-1018 2353,-1054"/>
<text text-anchor="middle" x="2309" y="-1032.3" font-family="Times,serif" font-size="14.00" fill="#000000">wait_mutex_</text>
</g>
<!-- ClearWaitingTxn&#45;&gt;wait_mutex_ -->
<g id="edge2" class="edge">
<title>ClearWaitingTxn&#45;&gt;wait_mutex_</title>
<path fill="none" stroke="#666666" d="M2070.1816,-1036C2123.1539,-1036 2202.0328,-1036 2254.4611,-1036"/>
<polygon fill="#666666" stroke="#666666" points="2254.5786,-1039.5001 2264.5786,-1036 2254.5785,-1032.5001 2254.5786,-1039.5001"/>
</g>
<!-- SetWaitingTxn -->
<g id="node4" class="node">
<title>SetWaitingTxn</title>
<polygon fill="none" stroke="#000000" points="2064,-1000 1964,-1000 1964,-964 2064,-964 2064,-1000"/>
<text text-anchor="middle" x="2014" y="-978.3" font-family="Times,serif" font-size="14.00" fill="#000000">SetWaitingTxn</text>
</g>
<!-- SetWaitingTxn&#45;&gt;waiting_txn_ids_ -->
<g id="edge3" class="edge">
<title>SetWaitingTxn&#45;&gt;waiting_txn_ids_</title>
<path fill="none" stroke="#666666" d="M2064.1497,-974.3453C2112.7644,-969.8241 2186.008,-971.0481 2234,-1009 2254.0747,-1024.875 2236.8456,-1044.0069 2254,-1063 2254.7486,-1063.8289 2255.5284,-1064.6352 2256.3354,-1065.4193"/>
<polygon fill="#666666" stroke="#666666" points="2254.2802,-1068.2603 2264.2331,-1071.8922 2258.7175,-1062.8463 2254.2802,-1068.2603"/>
</g>
<!-- SetWaitingTxn&#45;&gt;wait_mutex_ -->
<g id="edge4" class="edge">
<title>SetWaitingTxn&#45;&gt;wait_mutex_</title>
<path fill="none" stroke="#666666" d="M2064.3688,-984.97C2109.3302,-988.3781 2176.7264,-995.3578 2234,-1009 2240.9415,-1010.6534 2248.1293,-1012.7361 2255.1827,-1015.0081"/>
<polygon fill="#666666" stroke="#666666" points="2254.0878,-1018.3325 2264.6819,-1018.2011 2256.3182,-1011.6973 2254.0878,-1018.3325"/>
</g>
<!-- waiting_cf_id_ -->
<g id="node5" class="node">
<title>waiting_cf_id_</title>
<polygon fill="none" stroke="#000000" points="2358,-1000 2260,-1000 2260,-964 2358,-964 2358,-1000"/>
<text text-anchor="middle" x="2309" y="-978.3" font-family="Times,serif" font-size="14.00" fill="#000000">waiting_cf_id_</text>
</g>
<!-- SetWaitingTxn&#45;&gt;waiting_cf_id_ -->
<g id="edge5" class="edge">
<title>SetWaitingTxn&#45;&gt;waiting_cf_id_</title>
<path fill="none" stroke="#666666" d="M2064.0427,-982C2115.314,-982 2195.0214,-982 2249.4932,-982"/>
<polygon fill="#666666" stroke="#666666" points="2249.6964,-985.5001 2259.6963,-982 2249.6963,-978.5001 2249.6964,-985.5001"/>
</g>
<!-- GetID -->
<g id="node6" class="node">
<title>GetID</title>
<polygon fill="none" stroke="#000000" points="95.5,-1012 95.5,-1058 183.5,-1058 183.5,-1012 95.5,-1012"/>
<text text-anchor="middle" x="139.5" y="-1042.8" font-family="Times,serif" font-size="14.00" fill="#000000">GetID</text>
<polyline fill="none" stroke="#000000" points="95.5,-1035 183.5,-1035 "/>
<text text-anchor="start" x="103.5" y="-1019.8" font-family="Times,serif" font-size="14.00" fill="#000000">获取事务ID</text>
</g>
<!-- GetExpirationTime -->
<g id="node7" class="node">
<title>GetExpirationTime</title>
<polygon fill="none" stroke="#000000" points="512,-106 390,-106 390,-70 512,-70 512,-106"/>
<text text-anchor="middle" x="451" y="-84.3" font-family="Times,serif" font-size="14.00" fill="#000000">GetExpirationTime</text>
</g>
<!-- GetLockTimeout -->
<g id="node8" class="node">
<title>GetLockTimeout</title>
<polygon fill="none" stroke="#000000" points="506,-52 396,-52 396,-16 506,-16 506,-52"/>
<text text-anchor="middle" x="451" y="-30.3" font-family="Times,serif" font-size="14.00" fill="#000000">GetLockTimeout</text>
</g>
<!-- GetStripe -->
<g id="node9" class="node">
<title>GetStripe</title>
<polygon fill="none" stroke="#000000" points="368,-512 368,-558 534,-558 534,-512 368,-512"/>
<text text-anchor="middle" x="451" y="-542.8" font-family="Times,serif" font-size="14.00" fill="#000000">GetStrip</text>
<polyline fill="none" stroke="#000000" points="368,-535 534,-535 "/>
<text text-anchor="start" x="376" y="-519.8" font-family="Times,serif" font-size="14.00" fill="#000000">根据key获取对应的stripe</text>
</g>
<!-- num_stripes_ -->
<g id="node10" class="node">
<title>num_stripes_</title>
<polygon fill="none" stroke="#000000" points="784,-479 694,-479 694,-443 784,-443 784,-479"/>
<text text-anchor="middle" x="739" y="-457.3" font-family="Times,serif" font-size="14.00" fill="#000000">num_stripes_</text>
</g>
<!-- GetStripe&#45;&gt;num_stripes_ -->
<g id="edge6" class="edge">
<title>GetStripe&#45;&gt;num_stripes_</title>
<path fill="none" stroke="#666666" d="M534.3015,-513.5961C582.4403,-501.2272 641.6564,-486.0119 683.9921,-475.134"/>
<polygon fill="#666666" stroke="#666666" points="685.0199,-478.4837 693.8343,-472.6051 683.2778,-471.7039 685.0199,-478.4837"/>
</g>
<!-- lock_maps_cache_ -->
<g id="node11" class="node">
<title>lock_maps_cache_</title>
<polygon fill="#95e1d3" stroke="#000000" points="639,-497.5 639,-558.5 839,-558.5 839,-497.5 639,-497.5"/>
<text text-anchor="middle" x="739" y="-543.3" font-family="Times,serif" font-size="14.00" fill="#000000">lock_maps_cache_</text>
<polyline fill="none" stroke="#000000" points="639,-535.5 839,-535.5 "/>
<text text-anchor="start" x="647" y="-520.3" font-family="Times,serif" font-size="14.00" fill="#000000">std::unique_ptr&lt;ThreadLocalPtr&gt;</text>
<text text-anchor="start" x="647" y="-505.3" font-family="Times,serif" font-size="14.00" fill="#000000"> lock_maps_cache_;</text>
</g>
<!-- LockMaps -->
<g id="node12" class="node">
<title>LockMaps</title>
<polygon fill="none" stroke="#000000" points="1026,-519 951,-519 951,-483 1026,-483 1026,-519"/>
<text text-anchor="middle" x="988.5" y="-497.3" font-family="Times,serif" font-size="14.00" fill="#000000">LockMaps</text>
</g>
<!-- lock_maps_cache_&#45;&gt;LockMaps -->
<g id="edge7" class="edge">
<title>lock_maps_cache_&#45;&gt;LockMaps</title>
<path fill="none" stroke="#666666" d="M839.0436,-517.1736C874.0593,-513.3844 911.7802,-509.3023 940.5664,-506.1872"/>
<polygon fill="#666666" stroke="#666666" points="941.1807,-509.6412 950.7461,-505.0856 940.4275,-502.6819 941.1807,-509.6412"/>
</g>
<!-- LockMap -->
<g id="node13" class="node">
<title>LockMap</title>
<polygon fill="#95e1d3" stroke="#000000" points="1138,-426 1138,-518 1431,-518 1431,-426 1138,-426"/>
<text text-anchor="middle" x="1284.5" y="-502.8" font-family="Times,serif" font-size="14.00" fill="#000000">LockMap</text>
<polyline fill="none" stroke="#000000" points="1138,-495 1431,-495 "/>
<text text-anchor="start" x="1146" y="-479.8" font-family="Times,serif" font-size="14.00" fill="#000000">const size_t num_stripes_;</text>
<polyline fill="none" stroke="#000000" points="1138,-472 1431,-472 "/>
<text text-anchor="start" x="1146" y="-456.8" font-family="Times,serif" font-size="14.00" fill="#000000">std::atomic&lt;int64_t&gt; lock_cnt{0};</text>
<polyline fill="none" stroke="#000000" points="1138,-449 1431,-449 "/>
<text text-anchor="start" x="1146" y="-433.8" font-family="Times,serif" font-size="14.00" fill="#000000">std::vector&lt;LockMapStripe*&gt; lock_map_stripes_;</text>
</g>
<!-- LockMaps&#45;&gt;LockMap -->
<g id="edge8" class="edge">
<title>LockMaps&#45;&gt;LockMap</title>
<path fill="none" stroke="#666666" d="M1026.2893,-497.2977C1052.6142,-494.7185 1089.6715,-491.0879 1127.515,-487.3803"/>
<polygon fill="#666666" stroke="#666666" points="1128.061,-490.8436 1137.672,-486.3852 1127.3784,-483.877 1128.061,-490.8436"/>
</g>
<!-- LockMapStripe -->
<g id="node14" class="node">
<title>LockMapStripe</title>
<polygon fill="none" stroke="#000000" points="1467,-427 1467,-519 1774,-519 1774,-427 1467,-427"/>
<text text-anchor="middle" x="1620.5" y="-503.8" font-family="Times,serif" font-size="14.00" fill="#000000">LockMapStripe</text>
<polyline fill="none" stroke="#000000" points="1467,-496 1774,-496 "/>
<text text-anchor="start" x="1475" y="-480.8" font-family="Times,serif" font-size="14.00" fill="#000000">std::shared_ptr&lt;TransactionDBMutex&gt; stripe_mutex</text>
<polyline fill="none" stroke="#000000" points="1467,-473 1774,-473 "/>
<text text-anchor="start" x="1475" y="-457.8" font-family="Times,serif" font-size="14.00" fill="#000000">std::shared_ptr&lt;TransactionDBCondVar&gt; stripe_cv;</text>
<polyline fill="none" stroke="#000000" points="1467,-450 1774,-450 "/>
<text text-anchor="start" x="1475" y="-434.8" font-family="Times,serif" font-size="14.00" fill="#000000">std::unordered_map&lt;std::string, LockInfo&gt; keys;</text>
</g>
<!-- LockMap&#45;&gt;LockMapStripe -->
<g id="edge9" class="edge">
<title>LockMap&#45;&gt;LockMapStripe</title>
<path fill="none" stroke="#666666" d="M1431.3857,-472.4372C1439.7343,-472.462 1448.1535,-472.4871 1456.5592,-472.5121"/>
<polygon fill="#666666" stroke="#666666" points="1456.7894,-476.0127 1466.7999,-472.5426 1456.8104,-469.0127 1456.7894,-476.0127"/>
</g>
<!-- TransactionDBMutex -->
<g id="node15" class="node">
<title>TransactionDBMutex</title>
<polygon fill="none" stroke="#000000" points="1859.5,-317 1859.5,-409 2168.5,-409 2168.5,-317 1859.5,-317"/>
<text text-anchor="middle" x="2014" y="-393.8" font-family="Times,serif" font-size="14.00" fill="#000000">TransactionDBMutex</text>
<polyline fill="none" stroke="#000000" points="1859.5,-386 2168.5,-386 "/>
<text text-anchor="start" x="1867.5" y="-370.8" font-family="Times,serif" font-size="14.00" fill="#000000">virtual Status Lock() = 0;</text>
<polyline fill="none" stroke="#000000" points="1859.5,-363 2168.5,-363 "/>
<text text-anchor="start" x="1867.5" y="-347.8" font-family="Times,serif" font-size="14.00" fill="#000000">virtual Status TryLockFor(int64_t timeout_time) = 0;</text>
<polyline fill="none" stroke="#000000" points="1859.5,-340 2168.5,-340 "/>
<text text-anchor="start" x="1867.5" y="-324.8" font-family="Times,serif" font-size="14.00" fill="#000000">virtual void UnLock() = 0;</text>
</g>
<!-- LockMapStripe&#45;&gt;TransactionDBMutex -->
<g id="edge10" class="edge">
<title>LockMapStripe&#45;&gt;TransactionDBMutex</title>
<path fill="none" stroke="#666666" d="M1774.0135,-428.1751C1786.1817,-424.7043 1798.2889,-421.2779 1810,-418 1822.8621,-414.4 1836.1924,-410.7113 1849.5975,-407.0321"/>
<polygon fill="#666666" stroke="#666666" points="1850.6461,-410.3739 1859.3661,-404.3562 1848.7967,-403.6226 1850.6461,-410.3739"/>
</g>
<!-- TransactionDBCondVar -->
<g id="node16" class="node">
<title>TransactionDBCondVar</title>
<polygon fill="none" stroke="#000000" points="1810,-168 1810,-298 2218,-298 2218,-168 1810,-168"/>
<text text-anchor="middle" x="2014" y="-282.8" font-family="Times,serif" font-size="14.00" fill="#000000">TransactionDBCondVar</text>
<polyline fill="none" stroke="#000000" points="1810,-275 2218,-275 "/>
<text text-anchor="start" x="1818" y="-259.8" font-family="Times,serif" font-size="14.00" fill="#000000">virtual Status Wait(std::shared_ptr&lt;TransactionDBMutex&gt; mutex) = 0;</text>
<polyline fill="none" stroke="#000000" points="1810,-252 2218,-252 "/>
<text text-anchor="start" x="1818" y="-236.8" font-family="Times,serif" font-size="14.00" fill="#000000">virtual Status WaitFor(std::shared_ptr&lt;TransactionDBMutex&gt; mutex,</text>
<text text-anchor="start" x="1818" y="-221.8" font-family="Times,serif" font-size="14.00" fill="#000000"> int64_t timeout_time) = 0;</text>
<polyline fill="none" stroke="#000000" points="1810,-214 2218,-214 "/>
<text text-anchor="start" x="1818" y="-198.8" font-family="Times,serif" font-size="14.00" fill="#000000">virtual void Notify() = 0;</text>
<polyline fill="none" stroke="#000000" points="1810,-191 2218,-191 "/>
<text text-anchor="start" x="1818" y="-175.8" font-family="Times,serif" font-size="14.00" fill="#000000">virtual void NotifyAll() = 0;</text>
</g>
<!-- LockMapStripe&#45;&gt;TransactionDBCondVar -->
<g id="edge11" class="edge">
<title>LockMapStripe&#45;&gt;TransactionDBCondVar</title>
<path fill="none" stroke="#666666" d="M1663.4679,-426.8769C1699.6422,-390.266 1754.2709,-339.9292 1810,-307 1812.2705,-305.6584 1814.5694,-304.3349 1816.8933,-303.0294"/>
<polygon fill="#666666" stroke="#666666" points="1818.8667,-305.9401 1825.9748,-298.0835 1815.5187,-299.7926 1818.8667,-305.9401"/>
</g>
<!-- LockInfo -->
<g id="node17" class="node">
<title>LockInfo</title>
<polygon fill="none" stroke="#000000" points="1906.5,-428 1906.5,-520 2121.5,-520 2121.5,-428 1906.5,-428"/>
<text text-anchor="start" x="1914.5" y="-504.8" font-family="Times,serif" font-size="14.00" fill="#000000">LockInfo</text>
<polyline fill="none" stroke="#000000" points="1906.5,-497 2121.5,-497 "/>
<text text-anchor="start" x="1914.5" y="-481.8" font-family="Times,serif" font-size="14.00" fill="#000000">bool exclusive;</text>
<polyline fill="none" stroke="#000000" points="1906.5,-474 2121.5,-474 "/>
<text text-anchor="start" x="1914.5" y="-458.8" font-family="Times,serif" font-size="14.00" fill="#000000">autovector&lt;TransactionID&gt; txn_ids;</text>
<polyline fill="none" stroke="#000000" points="1906.5,-451 2121.5,-451 "/>
<text text-anchor="start" x="1914.5" y="-435.8" font-family="Times,serif" font-size="14.00" fill="#000000">uint64_t expiration_time;</text>
</g>
<!-- LockMapStripe&#45;&gt;LockInfo -->
<g id="edge12" class="edge">
<title>LockMapStripe&#45;&gt;LockInfo</title>
<path fill="none" stroke="#666666" d="M1774.046,-473.3902C1814.633,-473.4933 1857.8002,-473.6031 1896.1681,-473.7006"/>
<polygon fill="#666666" stroke="#666666" points="1896.3248,-477.2009 1906.3337,-473.7264 1896.3426,-470.2009 1896.3248,-477.2009"/>
</g>
<!-- TryLock -->
<g id="node18" class="node">
<title>TryLock</title>
<polygon fill="none" stroke="#000000" points="16,-613.5 16,-674.5 263,-674.5 263,-613.5 16,-613.5"/>
<text text-anchor="middle" x="139.5" y="-659.3" font-family="Times,serif" font-size="14.00" fill="#000000">TryLock</text>
<polyline fill="none" stroke="#000000" points="16,-651.5 263,-651.5 "/>
<text text-anchor="start" x="24" y="-636.3" font-family="Times,serif" font-size="14.00" fill="#000000">获取LockMapStripe</text>
<text text-anchor="start" x="24" y="-621.3" font-family="Times,serif" font-size="14.00" fill="#000000"> 然后调用AcquireWithTimeout获取lock</text>
</g>
<!-- TryLock&#45;&gt;GetExpirationTime -->
<g id="edge13" class="edge">
<title>TryLock&#45;&gt;GetExpirationTime</title>
<path fill="none" stroke="#b83b5e" d="M148.7432,-613.4678C169.6171,-547.0034 224.4558,-385.5136 299,-265 335.6909,-205.6829 391.7936,-146.0814 424.5933,-113.4157"/>
<polygon fill="#b83b5e" stroke="#b83b5e" points="427.3534,-115.6092 432.0106,-106.0928 422.4354,-110.6278 427.3534,-115.6092"/>
</g>
<!-- TryLock&#45;&gt;GetLockTimeout -->
<g id="edge14" class="edge">
<title>TryLock&#45;&gt;GetLockTimeout</title>
<path fill="none" stroke="#b83b5e" d="M143.57,-613.2524C158.6438,-504.1256 214.8078,-137.8398 299,-61 322.1098,-39.9084 355.7498,-32.4381 385.5111,-30.5521"/>
<polygon fill="#b83b5e" stroke="#b83b5e" points="386.0133,-34.0338 395.8527,-30.1048 385.7107,-27.0403 386.0133,-34.0338"/>
</g>
<!-- TryLock&#45;&gt;GetStripe -->
<g id="edge15" class="edge">
<title>TryLock&#45;&gt;GetStripe</title>
<path fill="none" stroke="#b83b5e" d="M226.6843,-613.4925C273.4676,-597.1221 330.5628,-577.1434 375.4422,-561.4392"/>
<polygon fill="#b83b5e" stroke="#b83b5e" points="376.8323,-564.6609 385.1151,-558.0544 374.5203,-558.0537 376.8323,-564.6609"/>
</g>
<!-- GetLockMap -->
<g id="node19" class="node">
<title>GetLockMap</title>
<polygon fill="none" stroke="#000000" points="299,-614 299,-690 603,-690 603,-614 299,-614"/>
<text text-anchor="middle" x="451" y="-674.8" font-family="Times,serif" font-size="14.00" fill="#000000">GetLockMap</text>
<polyline fill="none" stroke="#000000" points="299,-667 603,-667 "/>
<text text-anchor="start" x="307" y="-651.8" font-family="Times,serif" font-size="14.00" fill="#000000">根据column_family_id</text>
<text text-anchor="start" x="307" y="-636.8" font-family="Times,serif" font-size="14.00" fill="#000000"> 从ThreadLocal cache中获取lockmap</text>
<text text-anchor="start" x="307" y="-621.8" font-family="Times,serif" font-size="14.00" fill="#000000"> 失败就用mutex去全局获取lockmap并更新cache</text>
</g>
<!-- TryLock&#45;&gt;GetLockMap -->
<g id="edge16" class="edge">
<title>TryLock&#45;&gt;GetLockMap</title>
<path fill="none" stroke="#b83b5e" d="M263.0604,-647.1733C271.5455,-647.3912 280.1639,-647.6126 288.8088,-647.8346"/>
<polygon fill="#b83b5e" stroke="#b83b5e" points="288.8763,-651.3374 298.9629,-648.0954 289.0561,-644.3397 288.8763,-651.3374"/>
</g>
<!-- AcquireWithTimeout -->
<g id="node20" class="node">
<title>AcquireWithTimeout</title>
<polygon fill="none" stroke="#000000" points="875,-792 875,-906 1102,-906 1102,-792 875,-792"/>
<text text-anchor="middle" x="988.5" y="-890.8" font-family="Times,serif" font-size="14.00" fill="#000000">AcquireWithTimeout</text>
<polyline fill="none" stroke="#000000" points="875,-883 1102,-883 "/>
<text text-anchor="start" x="883" y="-867.8" font-family="Times,serif" font-size="14.00" fill="#000000">获取key对应的lock</text>
<polyline fill="none" stroke="#000000" points="875,-860 1102,-860 "/>
<text text-anchor="start" x="883" y="-844.8" font-family="Times,serif" font-size="14.00" fill="#000000">1.先获取key对应的stripe mutex lock</text>
<text text-anchor="start" x="883" y="-829.8" font-family="Times,serif" font-size="14.00" fill="#000000"> 已方便对stripe操作</text>
<text text-anchor="start" x="883" y="-814.8" font-family="Times,serif" font-size="14.00" fill="#000000"> 2.调用AcquireLocked获取key锁</text>
<text text-anchor="start" x="883" y="-799.8" font-family="Times,serif" font-size="14.00" fill="#000000"> 3.未timeout，循环尝试获取key锁</text>
</g>
<!-- TryLock&#45;&gt;AcquireWithTimeout -->
<g id="edge17" class="edge">
<title>TryLock&#45;&gt;AcquireWithTimeout</title>
<path fill="none" stroke="#b83b5e" d="M236.504,-674.5867C245.4946,-677.6716 254.4383,-680.8358 263,-684 279.2585,-690.0088 282.0725,-695.271 299,-699 416.2787,-724.8357 727.2721,-675.9699 839,-720 874.1249,-733.8421 906.696,-759.648 932.4103,-784.5626"/>
<polygon fill="#b83b5e" stroke="#b83b5e" points="930.2528,-787.3519 939.8207,-791.9023 935.1788,-782.3785 930.2528,-787.3519"/>
</g>
<!-- GetLockMap&#45;&gt;lock_maps_cache_ -->
<g id="edge31" class="edge">
<title>GetLockMap&#45;&gt;lock_maps_cache_</title>
<path fill="none" stroke="#666666" d="M570.7946,-613.938C581.7757,-609.8099 592.6531,-605.4747 603,-601 628.1878,-590.1072 654.9868,-576.2478 678.0774,-563.5382"/>
<polygon fill="#666666" stroke="#666666" points="680.0213,-566.4622 687.0643,-558.5473 676.6227,-560.3426 680.0213,-566.4622"/>
</g>
<!-- GetLockMap&#45;&gt;LockMaps -->
<g id="edge32" class="edge">
<title>GetLockMap&#45;&gt;LockMaps</title>
<path fill="none" stroke="#666666" d="M603.3271,-638.8816C677.8003,-627.6388 766.7213,-606.7626 839,-568 858.6658,-557.4534 855.6683,-544.1473 875,-533 895.1189,-521.3988 919.6937,-513.7957 940.825,-508.9254"/>
<polygon fill="#666666" stroke="#666666" points="941.8536,-512.2839 950.8874,-506.7485 940.3734,-505.4422 941.8536,-512.2839"/>
</g>
<!-- AcquireWithTimeout&#45;&gt;ClearWaitingTxn -->
<g id="edge18" class="edge">
<title>AcquireWithTimeout&#45;&gt;ClearWaitingTxn</title>
<path fill="none" stroke="#3f72af" d="M1063.8414,-906.018C1086.5997,-920.6526 1112.3744,-934.8345 1138,-944 1425.7277,-1046.9115 1798.0197,-1045.2176 1947.5421,-1039.5197"/>
<polygon fill="#3f72af" stroke="#3f72af" points="1948.0667,-1043.0016 1957.9185,-1039.1039 1947.7863,-1036.0072 1948.0667,-1043.0016"/>
</g>
<!-- AcquireWithTimeout&#45;&gt;SetWaitingTxn -->
<g id="edge19" class="edge">
<title>AcquireWithTimeout&#45;&gt;SetWaitingTxn</title>
<path fill="none" stroke="#3f72af" d="M1102.1306,-896.8931C1114.0976,-900.786 1126.2024,-904.2657 1138,-907 1438.2905,-976.5975 1809.9359,-983.0623 1953.4918,-982.6895"/>
<polygon fill="#3f72af" stroke="#3f72af" points="1953.8497,-986.1882 1963.836,-982.6495 1953.8226,-979.1883 1953.8497,-986.1882"/>
</g>
<!-- AcquireWithTimeout&#45;&gt;LockMapStripe -->
<g id="edge20" class="edge">
<title>AcquireWithTimeout&#45;&gt;LockMapStripe</title>
<path fill="none" stroke="#3f72af" d="M1007.0347,-791.9057C1028.8171,-734.5449 1070.7745,-648.4595 1138,-604 1247.7807,-531.3966 1304.8875,-598.6655 1431,-561 1462.8131,-551.4985 1496.1023,-537.5417 1525.7451,-523.5302"/>
<polygon fill="#3f72af" stroke="#3f72af" points="1527.3135,-526.6598 1534.8219,-519.1849 1524.2908,-520.346 1527.3135,-526.6598"/>
</g>
<!-- AcquireLocked -->
<g id="node21" class="node">
<title>AcquireLocked</title>
<polygon fill="none" stroke="#000000" points="1160.5,-614 1160.5,-804 1408.5,-804 1408.5,-614 1160.5,-614"/>
<text text-anchor="middle" x="1284.5" y="-788.8" font-family="Times,serif" font-size="14.00" fill="#000000">AcquireLocked</text>
<polyline fill="none" stroke="#000000" points="1160.5,-781 1408.5,-781 "/>
<text text-anchor="start" x="1168.5" y="-765.8" font-family="Times,serif" font-size="14.00" fill="#000000">获取key锁:</text>
<text text-anchor="start" x="1168.5" y="-750.8" font-family="Times,serif" font-size="14.00" fill="#000000"> 1. 从stripe的keys中查找key</text>
<polyline fill="none" stroke="#000000" points="1160.5,-743 1408.5,-743 "/>
<text text-anchor="start" x="1168.5" y="-727.8" font-family="Times,serif" font-size="14.00" fill="#000000">2. 如果stripe.keys中不存在该key，</text>
<text text-anchor="start" x="1168.5" y="-712.8" font-family="Times,serif" font-size="14.00" fill="#000000"> 就获取了key的lock 将自己插到map中</text>
<polyline fill="none" stroke="#000000" points="1160.5,-705 1408.5,-705 "/>
<text text-anchor="start" x="1168.5" y="-689.8" font-family="Times,serif" font-size="14.00" fill="#000000">3. 如果key被占用，如果是排它锁 </text>
<text text-anchor="start" x="1168.5" y="-674.8" font-family="Times,serif" font-size="14.00" fill="#000000"> 3.1 检查key对应的事务是否是自己</text>
<text text-anchor="start" x="1168.5" y="-659.8" font-family="Times,serif" font-size="14.00" fill="#000000"> 3.2 检查key对应的事务是否过期了</text>
<polyline fill="none" stroke="#000000" points="1160.5,-652 1408.5,-652 "/>
<text text-anchor="start" x="1168.5" y="-636.8" font-family="Times,serif" font-size="14.00" fill="#000000">4.非排它锁，把自己加到keys后面</text>
<text text-anchor="start" x="1168.5" y="-621.8" font-family="Times,serif" font-size="14.00" fill="#000000"> 5.返回等待该key的事务id列表</text>
</g>
<!-- AcquireWithTimeout&#45;&gt;AcquireLocked -->
<g id="edge21" class="edge">
<title>AcquireWithTimeout&#45;&gt;AcquireLocked</title>
<path fill="none" stroke="#3f72af" d="M1102.0948,-795.2727C1118.1893,-787.6605 1134.8585,-779.7764 1151.2825,-772.0083"/>
<polygon fill="#3f72af" stroke="#3f72af" points="1152.8331,-775.1467 1160.3765,-767.7071 1149.8401,-768.8188 1152.8331,-775.1467"/>
</g>
<!-- IsDeadlockDetect -->
<g id="node22" class="node">
<title>IsDeadlockDetect</title>
<polygon fill="none" stroke="#000000" points="1212,-823 1212,-869 1357,-869 1357,-823 1212,-823"/>
<text text-anchor="middle" x="1284.5" y="-853.8" font-family="Times,serif" font-size="14.00" fill="#000000">IsDeadlockDetect</text>
<polyline fill="none" stroke="#000000" points="1212,-846 1357,-846 "/>
<text text-anchor="start" x="1220" y="-830.8" font-family="Times,serif" font-size="14.00" fill="#000000">是否开启了死锁检测</text>
</g>
<!-- AcquireWithTimeout&#45;&gt;IsDeadlockDetect -->
<g id="edge22" class="edge">
<title>AcquireWithTimeout&#45;&gt;IsDeadlockDetect</title>
<path fill="none" stroke="#3f72af" d="M1102.0948,-847.8487C1135.1984,-847.5132 1170.7331,-847.153 1201.5645,-846.8406"/>
<polygon fill="#3f72af" stroke="#3f72af" points="1201.8657,-850.3378 1211.8297,-846.7365 1201.7947,-843.3381 1201.8657,-850.3378"/>
</g>
<!-- IncrementWaiters -->
<g id="node23" class="node">
<title>IncrementWaiters</title>
<polygon fill="none" stroke="#000000" points="1956.5,-800 1956.5,-846 2071.5,-846 2071.5,-800 1956.5,-800"/>
<text text-anchor="middle" x="2014" y="-830.8" font-family="Times,serif" font-size="14.00" fill="#000000">IncrementWaiters</text>
<polyline fill="none" stroke="#000000" points="1956.5,-823 2071.5,-823 "/>
<text text-anchor="middle" x="2014" y="-807.8" font-family="Times,serif" font-size="14.00" fill="#000000">Deadlock检测？</text>
</g>
<!-- AcquireWithTimeout&#45;&gt;IncrementWaiters -->
<g id="edge23" class="edge">
<title>AcquireWithTimeout&#45;&gt;IncrementWaiters</title>
<path fill="none" stroke="#3f72af" d="M1102.0147,-874.211C1114.1131,-876.1693 1126.2775,-877.8354 1138,-879 1202.7922,-885.4367 1374.0826,-910.6208 1431,-879 1451.5913,-867.5604 1438.5231,-845.6431 1459,-834 1479.8242,-822.1595 1803.1666,-822.0766 1946.4897,-822.6296"/>
<polygon fill="#3f72af" stroke="#3f72af" points="1946.477,-826.1295 1956.4913,-822.6704 1946.5056,-819.1295 1946.477,-826.1295"/>
</g>
<!-- DecrementWaiters -->
<g id="node24" class="node">
<title>DecrementWaiters</title>
<polygon fill="none" stroke="#000000" points="2073.5,-905 1954.5,-905 1954.5,-869 2073.5,-869 2073.5,-905"/>
<text text-anchor="middle" x="2014" y="-883.3" font-family="Times,serif" font-size="14.00" fill="#000000">DecrementWaiters</text>
</g>
<!-- AcquireWithTimeout&#45;&gt;DecrementWaiters -->
<g id="edge24" class="edge">
<title>AcquireWithTimeout&#45;&gt;DecrementWaiters</title>
<path fill="none" stroke="#3f72af" d="M1102.1358,-884.0718C1114.1556,-886.835 1126.2699,-889.2344 1138,-891 1417.5402,-933.0759 1491.3992,-906.0606 1774,-899 1831.3107,-897.5681 1896.2475,-894.2158 1944.1099,-891.4174"/>
<polygon fill="#3f72af" stroke="#3f72af" points="1944.5842,-894.8955 1954.3601,-890.8113 1944.1709,-887.9077 1944.5842,-894.8955"/>
</g>
<!-- IsLockExpired -->
<g id="node25" class="node">
<title>IsLockExpired</title>
<polygon fill="none" stroke="#000000" points="1548,-650 1548,-696 1693,-696 1693,-650 1548,-650"/>
<text text-anchor="middle" x="1620.5" y="-680.8" font-family="Times,serif" font-size="14.00" fill="#000000">IsLockExpired</text>
<polyline fill="none" stroke="#000000" points="1548,-673 1693,-673 "/>
<text text-anchor="start" x="1556" y="-657.8" font-family="Times,serif" font-size="14.00" fill="#000000">检查事务是否过期了</text>
</g>
<!-- AcquireLocked&#45;&gt;IsLockExpired -->
<g id="edge25" class="edge">
<title>AcquireLocked&#45;&gt;IsLockExpired</title>
<path fill="none" stroke="#666666" d="M1408.6594,-695.6972C1451.5609,-691.1006 1498.5635,-686.0646 1537.3716,-681.9066"/>
<polygon fill="#666666" stroke="#666666" points="1538.0002,-685.3594 1547.5704,-680.8139 1537.2544,-678.3992 1538.0002,-685.3594"/>
</g>
<!-- wait_ids -->
<g id="node26" class="node">
<title>wait_ids</title>
<polygon fill="#95e1d3" stroke="#000000" points="1561.5,-843 1561.5,-889 1679.5,-889 1679.5,-843 1561.5,-843"/>
<text text-anchor="middle" x="1620.5" y="-873.8" font-family="Times,serif" font-size="14.00" fill="#000000">wait_ids</text>
<polyline fill="none" stroke="#000000" points="1561.5,-866 1679.5,-866 "/>
<text text-anchor="start" x="1569.5" y="-850.8" font-family="Times,serif" font-size="14.00" fill="#000000">等待key的事务id</text>
</g>
<!-- AcquireLocked&#45;&gt;wait_ids -->
<g id="edge26" class="edge">
<title>AcquireLocked&#45;&gt;wait_ids</title>
<path fill="none" stroke="#666666" d="M1408.6594,-767.0149C1460.9722,-791.4587 1519.3828,-818.7518 1561.5987,-838.4777"/>
<polygon fill="#666666" stroke="#666666" points="1560.3481,-841.7565 1570.8896,-842.8189 1563.3115,-835.4147 1560.3481,-841.7565"/>
</g>
<!-- IsDeadlockDetect&#45;&gt;IncrementWaiters -->
<g id="edge33" class="edge">
<title>IsDeadlockDetect&#45;&gt;IncrementWaiters</title>
<path fill="none" stroke="#666666" stroke-dasharray="5,2" d="M1357.204,-831.6834C1388.4064,-826.2289 1425.3558,-820.6821 1459,-818 1634.2256,-804.0311 1841.5475,-812.5096 1946.243,-818.5369"/>
<polygon fill="#666666" stroke="#666666" points="1946.1679,-822.0385 1956.3556,-819.13 1946.5777,-815.0505 1946.1679,-822.0385"/>
</g>
<!-- IsLockExpired&#45;&gt;LockInfo -->
<g id="edge30" class="edge">
<title>IsLockExpired&#45;&gt;LockInfo</title>
<path fill="none" stroke="#666666" d="M1666.0239,-649.9778C1726.217,-619.537 1833.9629,-565.048 1913.6666,-524.7404"/>
<polygon fill="#666666" stroke="#666666" points="1915.4083,-527.7818 1922.7525,-520.1455 1912.2492,-521.5351 1915.4083,-527.7818"/>
</g>
<!-- wait_ids&#45;&gt;SetWaitingTxn -->
<g id="edge27" class="edge">
<title>wait_ids&#45;&gt;SetWaitingTxn</title>
<path fill="none" stroke="#666666" stroke-dasharray="5,2" d="M1670.6628,-889.1842C1724.3269,-913.923 1802.7645,-949.8722 1810,-952 1857.1737,-965.8731 1912.4553,-973.4956 1953.5629,-977.5811"/>
<polygon fill="#666666" stroke="#666666" points="1953.4084,-981.0821 1963.695,-978.5453 1954.0715,-974.1136 1953.4084,-981.0821"/>
</g>
<!-- wait_ids&#45;&gt;IncrementWaiters -->
<g id="edge28" class="edge">
<title>wait_ids&#45;&gt;IncrementWaiters</title>
<path fill="none" stroke="#666666" stroke-dasharray="5,2" d="M1679.837,-859.5159C1751.2997,-851.7068 1871.0702,-838.6188 1946.1388,-830.4156"/>
<polygon fill="#666666" stroke="#666666" points="1946.8644,-833.8572 1956.425,-829.2916 1946.1039,-826.8986 1946.8644,-833.8572"/>
</g>
<!-- wait_ids&#45;&gt;DecrementWaiters -->
<g id="edge29" class="edge">
<title>wait_ids&#45;&gt;DecrementWaiters</title>
<path fill="none" stroke="#666666" stroke-dasharray="5,2" d="M1679.837,-869.1666C1750.582,-872.9421 1868.6693,-879.2441 1943.8637,-883.257"/>
<polygon fill="#666666" stroke="#666666" points="1944.0075,-886.7696 1954.1798,-883.8076 1944.3806,-879.7795 1944.0075,-886.7696"/>
</g>
<!-- Unlock -->
<g id="node27" class="node">
<title>Unlock</title>
<polygon fill="none" stroke="#000000" points="60.5,-694 60.5,-740 218.5,-740 218.5,-694 60.5,-694"/>
<text text-anchor="middle" x="139.5" y="-724.8" font-family="Times,serif" font-size="14.00" fill="#000000">Unlock</text>
<polyline fill="none" stroke="#000000" points="60.5,-717 218.5,-717 "/>
<text text-anchor="start" x="68.5" y="-701.8" font-family="Times,serif" font-size="14.00" fill="#000000">释放掉txn对应的keys锁</text>
</g>
<!-- Unlock&#45;&gt;GetStripe -->
<g id="edge34" class="edge">
<title>Unlock&#45;&gt;GetStripe</title>
<path fill="none" stroke="#17b978" d="M218.5021,-707.1338C234.5708,-702.1983 250.3916,-694.8665 263,-684 293.4584,-657.7497 270.5734,-629.438 299,-601 315.6397,-584.3536 337.1679,-571.6063 358.7607,-561.966"/>
<polygon fill="#17b978" stroke="#17b978" points="360.1802,-565.1657 368.0047,-558.0223 357.4333,-558.7271 360.1802,-565.1657"/>
</g>
<!-- Unlock&#45;&gt;TransactionDBMutex -->
<g id="edge35" class="edge">
<title>Unlock&#45;&gt;TransactionDBMutex</title>
<path fill="none" stroke="#17b978" d="M218.7807,-710.3522C235.5193,-705.3199 251.557,-697.1367 263,-684 348.307,-586.0661 203.0495,-481.532 299,-394 443.5442,-262.1377 543.3455,-380 739,-380 739,-380 739,-380 1284.5,-380 1478.4617,-380 1701.3534,-373.9192 1849.1917,-369.0312"/>
<polygon fill="#17b978" stroke="#17b978" points="1849.3842,-372.5268 1859.2623,-368.6962 1849.1514,-365.5307 1849.3842,-372.5268"/>
</g>
<!-- Unlock&#45;&gt;TransactionDBCondVar -->
<g id="edge36" class="edge">
<title>Unlock&#45;&gt;TransactionDBCondVar</title>
<path fill="none" stroke="#17b978" d="M218.6772,-710.6344C235.5236,-705.6037 251.6351,-697.3504 263,-684 314.5424,-623.4529 243.0601,-384.5092 299,-328 437.4273,-188.1639 542.2356,-279 739,-279 739,-279 739,-279 1284.5,-279 1457.9972,-279 1654.2456,-265.88 1799.4599,-253.6537"/>
<polygon fill="#17b978" stroke="#17b978" points="1800.1574,-257.1072 1809.8261,-252.7751 1799.5662,-250.1322 1800.1574,-257.1072"/>
</g>
<!-- Unlock&#45;&gt;GetLockMap -->
<g id="edge37" class="edge">
<title>Unlock&#45;&gt;GetLockMap</title>
<path fill="none" stroke="#17b978" d="M218.5073,-700.5137C240.2274,-695.9814 264.6022,-690.8952 289.1788,-685.7669"/>
<polygon fill="#17b978" stroke="#17b978" points="289.8967,-689.1925 298.9709,-683.7236 288.4668,-682.3401 289.8967,-689.1925"/>
</g>
<!-- UnLockKey -->
<g id="node28" class="node">
<title>UnLockKey</title>
<polygon fill="none" stroke="#000000" points="655.5,-729.5 655.5,-790.5 822.5,-790.5 822.5,-729.5 655.5,-729.5"/>
<text text-anchor="middle" x="739" y="-775.3" font-family="Times,serif" font-size="14.00" fill="#000000">UnLockKey</text>
<polyline fill="none" stroke="#000000" points="655.5,-767.5 822.5,-767.5 "/>
<text text-anchor="start" x="663.5" y="-752.3" font-family="Times,serif" font-size="14.00" fill="#000000">将事务从key对应的</text>
<text text-anchor="start" x="663.5" y="-737.3" font-family="Times,serif" font-size="14.00" fill="#000000"> LockInfo的txn_ids中去掉</text>
</g>
<!-- Unlock&#45;&gt;UnLockKey -->
<g id="edge38" class="edge">
<title>Unlock&#45;&gt;UnLockKey</title>
<path fill="none" stroke="#17b978" d="M218.7996,-722.6879C328.8808,-730.5836 527.6683,-744.8419 645.0503,-753.2613"/>
<polygon fill="#17b978" stroke="#17b978" points="644.8774,-756.7578 655.1022,-753.9823 645.3783,-749.7758 644.8774,-756.7578"/>
</g>
<!-- UnLockKey&#45;&gt;LockMapStripe -->
<g id="edge39" class="edge">
<title>UnLockKey&#45;&gt;LockMapStripe</title>
<path fill="none" stroke="#666666" d="M785.7934,-729.4537C858.033,-684.0082 1002.563,-599.7929 1138,-561 1263.7585,-524.9793 1302.817,-559.1115 1431,-533 1446.2615,-529.8912 1462.0317,-526.0136 1477.657,-521.735"/>
<polygon fill="#666666" stroke="#666666" points="1478.6728,-525.0853 1487.3614,-519.0224 1476.7883,-518.3437 1478.6728,-525.0853"/>
</g>
</g>
</svg>
