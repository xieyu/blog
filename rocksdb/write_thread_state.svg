<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: WriteThread Pages: 1 -->
<svg width="1379pt" height="450pt"
 viewBox="0.00 0.00 1379.30 450.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 446)">
<title>WriteThread</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-446 1375.3037,-446 1375.3037,4 -4,4"/>
<g id="clust1" class="cluster">
<title>cluster_State</title>
<path fill="none" stroke="#000000" d="M20,-8C20,-8 1351.3037,-8 1351.3037,-8 1357.3037,-8 1363.3037,-14 1363.3037,-20 1363.3037,-20 1363.3037,-422 1363.3037,-422 1363.3037,-428 1357.3037,-434 1351.3037,-434 1351.3037,-434 20,-434 20,-434 14,-434 8,-428 8,-422 8,-422 8,-20 8,-20 8,-14 14,-8 20,-8"/>
<text text-anchor="middle" x="685.6519" y="-414" font-family="Times,serif" font-size="20.00" fill="#000000">State</text>
</g>
<!-- STATE_INIT -->
<g id="node1" class="node">
<title>STATE_INIT</title>
<polygon fill="none" stroke="#000000" points="16,-141.0002 16,-268.9998 279.2832,-268.9998 279.2832,-141.0002 16,-141.0002"/>
<text text-anchor="middle" x="147.6416" y="-253.7998" font-family="Times,serif" font-size="14.00" fill="#000000">STATE_INIT</text>
<polyline fill="none" stroke="#000000" points="16,-246.9998 279.2832,-246.9998 "/>
<text text-anchor="start" x="24" y="-231.7998" font-family="Times,serif" font-size="14.00" fill="#000000">1.JoinBatchGroup: 如果没有</text>
<text text-anchor="start" x="24" y="-212.1999" font-family="Times,serif" font-size="14.00" fill="#000000"> 其他writer在队列中，则成为group leader</text>
<text text-anchor="start" x="24" y="-192.6" font-family="Times,serif" font-size="14.00" fill="#000000"> 2.AwaitState: 等待leader转换自己的状态</text>
<text text-anchor="start" x="24" y="-173" font-family="Times,serif" font-size="14.00" fill="#000000"> 3.轮询后没变化，转入wait阶段</text>
<text text-anchor="start" x="24" y="-153.4001" font-family="Times,serif" font-size="14.00" fill="#000000"> 等待group leader安排</text>
</g>
<!-- STATE_LOCKED_WAITING -->
<g id="node2" class="node">
<title>STATE_LOCKED_WAITING</title>
<polygon fill="none" stroke="#000000" points="315.2832,-96.6001 315.2832,-185.3999 502.8105,-185.3999 502.8105,-96.6001 315.2832,-96.6001"/>
<text text-anchor="middle" x="409.0469" y="-170.1999" font-family="Times,serif" font-size="14.00" fill="#000000">STATE_LOCKED_WAITING</text>
<polyline fill="none" stroke="#000000" points="315.2832,-163.3999 502.8105,-163.3999 "/>
<text text-anchor="start" x="323.2832" y="-148.1999" font-family="Times,serif" font-size="14.00" fill="#000000">使用StateMutext</text>
<text text-anchor="start" x="323.2832" y="-128.6" font-family="Times,serif" font-size="14.00" fill="#000000"> StateCondVar等待</text>
<text text-anchor="start" x="323.2832" y="-109" font-family="Times,serif" font-size="14.00" fill="#000000"> 等待groupleader安排</text>
</g>
<!-- STATE_INIT&#45;&gt;STATE_LOCKED_WAITING -->
<g id="edge1" class="edge">
<title>STATE_INIT&#45;&gt;STATE_LOCKED_WAITING</title>
<path fill="none" stroke="#3f72af" d="M279.493,-172.7188C288.157,-170.5975 296.8143,-168.478 305.3125,-166.3973"/>
<polygon fill="#3f72af" stroke="#3f72af" points="306.3258,-169.7527 315.2065,-163.975 304.6611,-162.9535 306.3258,-169.7527"/>
</g>
<!-- STATE_MEMTABLE_WRITER_LEADER -->
<g id="node3" class="node">
<title>STATE_MEMTABLE_WRITER_LEADER</title>
<polygon fill="none" stroke="#000000" points="565.3955,-16.0002 565.3955,-143.9998 829.5879,-143.9998 829.5879,-16.0002 565.3955,-16.0002"/>
<text text-anchor="middle" x="697.4917" y="-128.7998" font-family="Times,serif" font-size="14.00" fill="#000000">STATE_MEMTABLE_WRITER_LEADER</text>
<polyline fill="none" stroke="#000000" points="565.3955,-121.9998 829.5879,-121.9998 "/>
<text text-anchor="start" x="573.3955" y="-106.7998" font-family="Times,serif" font-size="14.00" fill="#000000">如果enable_pipelined_write为真</text>
<text text-anchor="start" x="573.3955" y="-87.1999" font-family="Times,serif" font-size="14.00" fill="#000000"> 每个写入线程分为写WAL</text>
<text text-anchor="start" x="573.3955" y="-67.6" font-family="Times,serif" font-size="14.00" fill="#000000"> 和写MemTable阶段</text>
<text text-anchor="start" x="573.3955" y="-48" font-family="Times,serif" font-size="14.00" fill="#000000"> Group leader负责WAL阶段</text>
<text text-anchor="start" x="573.3955" y="-28.4001" font-family="Times,serif" font-size="14.00" fill="#000000"> 负责Memtable阶段</text>
</g>
<!-- STATE_INIT&#45;&gt;STATE_MEMTABLE_WRITER_LEADER -->
<g id="edge2" class="edge">
<title>STATE_INIT&#45;&gt;STATE_MEMTABLE_WRITER_LEADER</title>
<path fill="none" stroke="#3f72af" d="M218.7767,-140.8238C246.8229,-119.5051 280.6063,-98.3309 315.2832,-87 391.8014,-61.9972 481.6133,-59.116 554.9437,-63.0066"/>
<polygon fill="#3f72af" stroke="#3f72af" points="554.9929,-66.5152 565.1784,-63.5989 555.3974,-59.5269 554.9929,-66.5152"/>
</g>
<!-- STATE_PARALLEL_MEMTABLE_WRITER -->
<g id="node4" class="node">
<title>STATE_PARALLEL_MEMTABLE_WRITER</title>
<polygon fill="none" stroke="#000000" points="892.1729,-182.4001 892.1729,-251.5999 1171.418,-251.5999 1171.418,-182.4001 892.1729,-182.4001"/>
<text text-anchor="middle" x="1031.7954" y="-236.3999" font-family="Times,serif" font-size="14.00" fill="#000000">STATE_PARALLEL_MEMTABLE_WRITER</text>
<polyline fill="none" stroke="#000000" points="892.1729,-229.5999 1171.418,-229.5999 "/>
<text text-anchor="start" x="900.1729" y="-214.3999" font-family="Times,serif" font-size="14.00" fill="#000000">每个writer并行的</text>
<text text-anchor="start" x="900.1729" y="-194.8" font-family="Times,serif" font-size="14.00" fill="#000000"> 写自己的MemTable</text>
</g>
<!-- STATE_INIT&#45;&gt;STATE_PARALLEL_MEMTABLE_WRITER -->
<g id="edge3" class="edge">
<title>STATE_INIT&#45;&gt;STATE_PARALLEL_MEMTABLE_WRITER</title>
<path fill="none" stroke="#3f72af" d="M279.5391,-206.037C421.8332,-207.2614 655.0697,-209.5746 856.1729,-213 864.5014,-213.1419 873.0518,-213.299 881.6821,-213.4665"/>
<polygon fill="#3f72af" stroke="#3f72af" points="881.774,-216.9689 891.8413,-213.6676 881.9126,-209.9703 881.774,-216.9689"/>
</g>
<!-- STATE_GROUP_LEADER -->
<g id="node5" class="node">
<title>STATE_GROUP_LEADER</title>
<polygon fill="none" stroke="#000000" points="538.8105,-222.2003 538.8105,-377.7997 856.1729,-377.7997 856.1729,-222.2003 538.8105,-222.2003"/>
<text text-anchor="middle" x="697.4917" y="-362.5997" font-family="Times,serif" font-size="14.00" fill="#000000">STATE_GROUP_LEADER</text>
<polyline fill="none" stroke="#000000" points="538.8105,-355.7997 856.1729,-355.7997 "/>
<text text-anchor="start" x="546.8105" y="-340.5997" font-family="Times,serif" font-size="14.00" fill="#000000">1.把writeGroup的合并起来</text>
<text text-anchor="start" x="546.8105" y="-320.9998" font-family="Times,serif" font-size="14.00" fill="#000000"> 一起写入WAL日志</text>
<text text-anchor="start" x="546.8105" y="-301.3999" font-family="Times,serif" font-size="14.00" fill="#000000"> 并把所有writer标记为COMPLETE状态</text>
<text text-anchor="start" x="546.8105" y="-281.8" font-family="Times,serif" font-size="14.00" fill="#000000"> 如果有新的writer进来，把它设为leader</text>
<polyline fill="none" stroke="#000000" points="538.8105,-269.4001 856.1729,-269.4001 "/>
<text text-anchor="start" x="546.8105" y="-254.2001" font-family="Times,serif" font-size="14.00" fill="#000000">2.满足并发写条件，将每个writer状态设置为</text>
<text text-anchor="start" x="546.8105" y="-234.6002" font-family="Times,serif" font-size="14.00" fill="#000000"> 并发写，等在最后一个memtable写完后退出group</text>
</g>
<!-- STATE_INIT&#45;&gt;STATE_GROUP_LEADER -->
<g id="edge4" class="edge">
<title>STATE_INIT&#45;&gt;STATE_GROUP_LEADER</title>
<path fill="none" stroke="#3f72af" d="M279.3444,-227.7549C354.0673,-240.6651 448.374,-256.9589 528.5055,-270.8035"/>
<polygon fill="#3f72af" stroke="#3f72af" points="528.2568,-274.3123 538.7067,-272.566 529.4486,-267.4145 528.2568,-274.3123"/>
</g>
<!-- STATE_COMPLETED -->
<g id="node6" class="node">
<title>STATE_COMPLETED</title>
<polygon fill="none" stroke="#000000" points="1355.2466,-235 1207.4751,-235 1207.4751,-199 1355.2466,-199 1355.2466,-235"/>
<text text-anchor="middle" x="1281.3608" y="-212.8" font-family="Times,serif" font-size="14.00" fill="#000000">STATE_COMPLETED</text>
</g>
<!-- STATE_INIT&#45;&gt;STATE_COMPLETED -->
<g id="edge5" class="edge">
<title>STATE_INIT&#45;&gt;STATE_COMPLETED</title>
<path fill="none" stroke="#3f72af" d="M252.3272,-269.0582C328.6511,-311.8527 436.2408,-364.3066 538.8105,-387 817.0157,-448.5524 912.3826,-401.6906 1171.418,-283 1197.6275,-270.9907 1225.4541,-254.2425 1246.5548,-240.6228"/>
<polygon fill="#3f72af" stroke="#3f72af" points="1248.704,-243.3996 1255.1619,-235.0004 1244.8757,-237.5391 1248.704,-243.3996"/>
</g>
<!-- STATE_LOCKED_WAITING&#45;&gt;STATE_MEMTABLE_WRITER_LEADER -->
<g id="edge8" class="edge">
<title>STATE_LOCKED_WAITING&#45;&gt;STATE_MEMTABLE_WRITER_LEADER</title>
<path fill="none" stroke="#b83b5e" d="M503.0954,-121.1107C519.8798,-117.5612 537.6999,-113.7926 555.4754,-110.0335"/>
<polygon fill="#b83b5e" stroke="#b83b5e" points="556.2797,-113.4408 565.3392,-107.9475 554.8314,-106.5923 556.2797,-113.4408"/>
</g>
<!-- STATE_LOCKED_WAITING&#45;&gt;STATE_PARALLEL_MEMTABLE_WRITER -->
<g id="edge9" class="edge">
<title>STATE_LOCKED_WAITING&#45;&gt;STATE_PARALLEL_MEMTABLE_WRITER</title>
<path fill="none" stroke="#b83b5e" d="M503.0885,-161.8452C515.0754,-164.1253 527.2062,-166.2498 538.8105,-168 678.9048,-189.1297 715.2163,-183.7136 856.1729,-198 864.5063,-198.8446 873.0607,-199.7253 881.6939,-200.6247"/>
<polygon fill="#b83b5e" stroke="#b83b5e" points="881.5463,-204.1283 891.8563,-201.6881 882.2749,-197.1663 881.5463,-204.1283"/>
</g>
<!-- STATE_LOCKED_WAITING&#45;&gt;STATE_COMPLETED -->
<g id="edge10" class="edge">
<title>STATE_LOCKED_WAITING&#45;&gt;STATE_COMPLETED</title>
<path fill="none" stroke="#b83b5e" d="M502.9059,-150.3584C514.9793,-151.3626 527.1812,-152.2791 538.8105,-153 679.1908,-161.7019 1033.7462,-144.2107 1171.418,-173 1193.3812,-177.5929 1216.6003,-186.2669 1236.0123,-194.7075"/>
<polygon fill="#b83b5e" stroke="#b83b5e" points="1234.6555,-197.9347 1245.2138,-198.8134 1237.508,-191.5422 1234.6555,-197.9347"/>
</g>
<!-- STATE_MEMTABLE_WRITER_LEADER&#45;&gt;STATE_PARALLEL_MEMTABLE_WRITER -->
<g id="edge12" class="edge">
<title>STATE_MEMTABLE_WRITER_LEADER&#45;&gt;STATE_PARALLEL_MEMTABLE_WRITER</title>
<path fill="none" stroke="#f08a5d" d="M829.6174,-134.146C865.8179,-148.9813 904.3134,-164.757 937.8925,-178.5179"/>
<polygon fill="#f08a5d" stroke="#f08a5d" points="936.6468,-181.7899 947.2272,-182.3434 939.3013,-175.3127 936.6468,-181.7899"/>
</g>
<!-- STATE_MEMTABLE_WRITER_LEADER&#45;&gt;STATE_COMPLETED -->
<g id="edge13" class="edge">
<title>STATE_MEMTABLE_WRITER_LEADER&#45;&gt;STATE_COMPLETED</title>
<path fill="none" stroke="#f08a5d" d="M829.8096,-90.0261C926.4656,-100.1504 1059.612,-119.9752 1171.418,-158 1197.1433,-166.7491 1224.0545,-181.0896 1244.8131,-193.4414"/>
<polygon fill="#f08a5d" stroke="#f08a5d" points="1243.2352,-196.5778 1253.6008,-198.7698 1246.8646,-190.5921 1243.2352,-196.5778"/>
</g>
<!-- STATE_PARALLEL_MEMTABLE_WRITER&#45;&gt;STATE_COMPLETED -->
<g id="edge11" class="edge">
<title>STATE_PARALLEL_MEMTABLE_WRITER&#45;&gt;STATE_COMPLETED</title>
<path fill="none" stroke="#666666" d="M1171.5346,-217C1180.245,-217 1188.8567,-217 1197.1967,-217"/>
<polygon fill="#666666" stroke="#666666" points="1197.2233,-220.5001 1207.2233,-217 1197.2232,-213.5001 1197.2233,-220.5001"/>
</g>
<!-- STATE_GROUP_LEADER&#45;&gt;STATE_PARALLEL_MEMTABLE_WRITER -->
<g id="edge6" class="edge">
<title>STATE_GROUP_LEADER&#45;&gt;STATE_PARALLEL_MEMTABLE_WRITER</title>
<path fill="none" stroke="#17b978" d="M856.3217,-260.5661C865.0123,-258.4085 873.7329,-256.2433 882.3894,-254.0941"/>
<polygon fill="#17b978" stroke="#17b978" points="883.2685,-257.4822 892.1305,-251.6756 881.5817,-250.6884 883.2685,-257.4822"/>
</g>
<!-- STATE_GROUP_LEADER&#45;&gt;STATE_COMPLETED -->
<g id="edge7" class="edge">
<title>STATE_GROUP_LEADER&#45;&gt;STATE_COMPLETED</title>
<path fill="none" stroke="#17b978" d="M856.2265,-298.719C949.1541,-295.0606 1068.1597,-285.3293 1171.418,-261 1192.8166,-255.9581 1215.5214,-247.4512 1234.7075,-239.2536"/>
<polygon fill="#17b978" stroke="#17b978" points="1236.3472,-242.3567 1244.1073,-235.1434 1233.5427,-235.943 1236.3472,-242.3567"/>
</g>
</g>
</svg>
