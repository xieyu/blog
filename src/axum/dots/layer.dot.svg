<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.50.0 (20211204.2007)
 -->
<!-- Title: Daemon Pages: 1 -->
<svg width="987pt" height="835pt"
 viewBox="0.00 0.00 987.00 835.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 831)">
<title>Daemon</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-831 983,-831 983,4 -4,4"/>
<!-- tower_Layer -->
<g id="node1" class="node">
<title>tower_Layer</title>
<path fill="#c5eb97" stroke="#c5eb97" d="M417.33,-360.62C417.33,-360.62 639.33,-360.62 639.33,-360.62 645.33,-360.62 651.33,-366.62 651.33,-372.62 651.33,-372.62 651.33,-439.62 651.33,-439.62 651.33,-445.62 645.33,-451.62 639.33,-451.62 639.33,-451.62 417.33,-451.62 417.33,-451.62 411.33,-451.62 405.33,-445.62 405.33,-439.62 405.33,-439.62 405.33,-372.62 405.33,-372.62 405.33,-366.62 411.33,-360.62 417.33,-360.62"/>
<text text-anchor="middle" x="528.33" y="-436.42" font-family="Times,serif" font-size="14.00" fill="#374052">tower.Layer</text>
<polyline fill="none" stroke="#c5eb97" points="405.33,-428.62 651.33,-428.62 "/>
<text text-anchor="start" x="413.33" y="-413.42" font-family="Times,serif" font-size="14.00" fill="#374052">pub trait Layer&lt;S&gt; {</text>
<text text-anchor="start" x="413.33" y="-398.42" font-family="Times,serif" font-size="14.00" fill="#374052"> type Service;</text>
<text text-anchor="start" x="413.33" y="-383.42" font-family="Times,serif" font-size="14.00" fill="#374052"> fn layer(&amp;self, inner: S) &#45;&gt; Self::Service;</text>
<text text-anchor="start" x="413.33" y="-368.42" font-family="Times,serif" font-size="14.00" fill="#374052">}</text>
</g>
<!-- MiddlewareFnLayer -->
<g id="node2" class="node">
<title>MiddlewareFnLayer</title>
<path fill="#eeeeee" stroke="#eeeeee" d="M449.73,-220.18C449.73,-220.18 685.73,-220.18 685.73,-220.18 691.73,-220.18 697.73,-226.18 697.73,-232.18 697.73,-232.18 697.73,-330.18 697.73,-330.18 697.73,-336.18 691.73,-342.18 685.73,-342.18 685.73,-342.18 449.73,-342.18 449.73,-342.18 443.73,-342.18 437.73,-336.18 437.73,-330.18 437.73,-330.18 437.73,-232.18 437.73,-232.18 437.73,-226.18 443.73,-220.18 449.73,-220.18"/>
<text text-anchor="middle" x="567.73" y="-326.98" font-family="Times,serif" font-size="14.00" fill="#434b54">MiddlewareFnLayer</text>
<polyline fill="none" stroke="#eeeeee" points="437.73,-319.18 697.73,-319.18 "/>
<text text-anchor="start" x="445.73" y="-303.98" font-family="Times,serif" font-size="14.00" fill="#434b54">#[derive(Clone, Copy)]</text>
<text text-anchor="start" x="445.73" y="-288.98" font-family="Times,serif" font-size="14.00" fill="#434b54">pub struct MiddlewareFnLayer&lt;F&gt; {</text>
<text text-anchor="start" x="445.73" y="-273.98" font-family="Times,serif" font-size="14.00" fill="#434b54"> f: F,</text>
<text text-anchor="start" x="445.73" y="-258.98" font-family="Times,serif" font-size="14.00" fill="#434b54">}</text>
<text text-anchor="start" x="445.73" y="-227.98" font-family="Times,serif" font-size="14.00" fill="#434b54">Create a middleware from an async function</text>
</g>
<!-- tower_Layer&#45;&gt;MiddlewareFnLayer -->
<g id="edge1" class="edge">
<title>tower_Layer&#45;&gt;MiddlewareFnLayer</title>
<path fill="none" stroke="#55606a" d="M542.78,-360.31C543.64,-357.56 544.52,-354.78 545.41,-351.96"/>
<polygon fill="#55606a" stroke="#55606a" points="548.77,-352.94 548.44,-342.35 542.09,-350.84 548.77,-352.94"/>
</g>
<!-- AddExtensionLayer -->
<g id="node3" class="node">
<title>AddExtensionLayer</title>
<path fill="#01a288" stroke="#01a288" d="M70.55,-156.43C70.55,-156.43 308.55,-156.43 308.55,-156.43 314.55,-156.43 320.55,-162.43 320.55,-168.43 320.55,-168.43 320.55,-296.43 320.55,-296.43 320.55,-302.43 314.55,-308.43 308.55,-308.43 308.55,-308.43 70.55,-308.43 70.55,-308.43 64.55,-308.43 58.55,-302.43 58.55,-296.43 58.55,-296.43 58.55,-168.43 58.55,-168.43 58.55,-162.43 64.55,-156.43 70.55,-156.43"/>
<text text-anchor="middle" x="189.55" y="-293.23" font-family="Times,serif" font-size="14.00" fill="#f2f8f7">AddExtensionLayer</text>
<polyline fill="none" stroke="#01a288" points="58.55,-285.43 320.55,-285.43 "/>
<text text-anchor="start" x="66.55" y="-270.23" font-family="Times,serif" font-size="14.00" fill="#f2f8f7">#[derive(Clone, Copy, Debug)]</text>
<text text-anchor="start" x="66.55" y="-255.23" font-family="Times,serif" font-size="14.00" fill="#f2f8f7">pub struct AddExtensionLayer&lt;T&gt; {</text>
<text text-anchor="start" x="66.55" y="-240.23" font-family="Times,serif" font-size="14.00" fill="#f2f8f7"> value: T,</text>
<text text-anchor="start" x="66.55" y="-225.23" font-family="Times,serif" font-size="14.00" fill="#f2f8f7">}</text>
<text text-anchor="start" x="66.55" y="-194.23" font-family="Times,serif" font-size="14.00" fill="#f2f8f7">向req的extentions中插入shared value.clone</text>
<text text-anchor="start" x="66.55" y="-179.23" font-family="Times,serif" font-size="14.00" fill="#f2f8f7">req.extensions_mut()</text>
<text text-anchor="start" x="66.55" y="-164.23" font-family="Times,serif" font-size="14.00" fill="#f2f8f7">.insert(self.value.clone());</text>
</g>
<!-- tower_Layer&#45;&gt;AddExtensionLayer -->
<g id="edge2" class="edge">
<title>tower_Layer&#45;&gt;AddExtensionLayer</title>
<path fill="none" stroke="#55606a" d="M439.32,-360.48C405.89,-343.34 367.01,-323.41 330.03,-304.45"/>
<polygon fill="#55606a" stroke="#55606a" points="331.17,-301.11 320.68,-299.66 327.98,-307.33 331.17,-301.11"/>
</g>
<!-- ExtractorMiddlewareLayer -->
<g id="node4" class="node">
<title>ExtractorMiddlewareLayer</title>
<path fill="#eeeeee" stroke="#eeeeee" d="M522.45,-465.53C522.45,-465.53 720.45,-465.53 720.45,-465.53 726.45,-465.53 732.45,-471.53 732.45,-477.53 732.45,-477.53 732.45,-560.53 732.45,-560.53 732.45,-566.53 726.45,-572.53 720.45,-572.53 720.45,-572.53 522.45,-572.53 522.45,-572.53 516.45,-572.53 510.45,-566.53 510.45,-560.53 510.45,-560.53 510.45,-477.53 510.45,-477.53 510.45,-471.53 516.45,-465.53 522.45,-465.53"/>
<text text-anchor="middle" x="621.45" y="-557.33" font-family="Times,serif" font-size="14.00" fill="#434b54">ExtractorMiddlewareLayer</text>
<polyline fill="none" stroke="#eeeeee" points="510.45,-549.53 732.45,-549.53 "/>
<text text-anchor="start" x="518.45" y="-534.33" font-family="Times,serif" font-size="14.00" fill="#434b54">pub struct ExtractorMiddlewareLayer</text>
<text text-anchor="start" x="518.45" y="-519.33" font-family="Times,serif" font-size="14.00" fill="#434b54">&lt;E&gt;(PhantomData&lt;fn() &#45;&gt; E&gt;);</text>
<text text-anchor="start" x="518.45" y="-488.33" font-family="Times,serif" font-size="14.00" fill="#434b54">将extractor 转成中间件</text>
<text text-anchor="start" x="518.45" y="-473.33" font-family="Times,serif" font-size="14.00" fill="#434b54">如果extractor报错，则返回</text>
</g>
<!-- tower_Layer&#45;&gt;ExtractorMiddlewareLayer -->
<g id="edge3" class="edge">
<title>tower_Layer&#45;&gt;ExtractorMiddlewareLayer</title>
<path fill="none" stroke="#55606a" d="M565.94,-451.72C567.57,-453.7 569.22,-455.7 570.88,-457.71"/>
<polygon fill="#55606a" stroke="#55606a" points="568.22,-459.99 577.28,-465.47 573.62,-455.53 568.22,-459.99"/>
</g>
<!-- tower_Stack -->
<g id="node6" class="node">
<title>tower_Stack</title>
<path fill="#eeeeee" stroke="#eeeeee" d="M292.25,-469.72C292.25,-469.72 480.25,-469.72 480.25,-469.72 486.25,-469.72 492.25,-475.72 492.25,-481.72 492.25,-481.72 492.25,-594.72 492.25,-594.72 492.25,-600.72 486.25,-606.72 480.25,-606.72 480.25,-606.72 292.25,-606.72 292.25,-606.72 286.25,-606.72 280.25,-600.72 280.25,-594.72 280.25,-594.72 280.25,-481.72 280.25,-481.72 280.25,-475.72 286.25,-469.72 292.25,-469.72"/>
<text text-anchor="middle" x="386.25" y="-591.52" font-family="Times,serif" font-size="14.00" fill="#434b54">tower.Stack</text>
<polyline fill="none" stroke="#eeeeee" points="280.25,-583.72 492.25,-583.72 "/>
<text text-anchor="start" x="288.25" y="-568.52" font-family="Times,serif" font-size="14.00" fill="#434b54">#[derive(Clone)]</text>
<text text-anchor="start" x="288.25" y="-553.52" font-family="Times,serif" font-size="14.00" fill="#434b54">pub struct Stack&lt;Inner, Outer&gt; {</text>
<text text-anchor="start" x="288.25" y="-538.52" font-family="Times,serif" font-size="14.00" fill="#434b54"> inner: Inner,</text>
<text text-anchor="start" x="288.25" y="-523.52" font-family="Times,serif" font-size="14.00" fill="#434b54"> outer: Outer,</text>
<text text-anchor="start" x="288.25" y="-508.52" font-family="Times,serif" font-size="14.00" fill="#434b54">}</text>
<text text-anchor="start" x="288.25" y="-477.52" font-family="Times,serif" font-size="14.00" fill="#434b54">Two middlewares chained together.</text>
</g>
<!-- tower_Layer&#45;&gt;tower_Stack -->
<g id="edge4" class="edge">
<title>tower_Layer&#45;&gt;tower_Stack</title>
<path fill="none" stroke="#55606a" d="M479.04,-451.95C475.28,-455.45 471.42,-459.03 467.53,-462.65"/>
<polygon fill="#55606a" stroke="#55606a" points="464.95,-460.27 460.01,-469.64 469.71,-465.4 464.95,-460.27"/>
</g>
<!-- HandleErrorLayer -->
<g id="node7" class="node">
<title>HandleErrorLayer</title>
<path fill="#eeeeee" stroke="#eeeeee" d="M12.39,-400.62C12.39,-400.62 254.39,-400.62 254.39,-400.62 260.39,-400.62 266.39,-406.62 266.39,-412.62 266.39,-412.62 266.39,-632.62 266.39,-632.62 266.39,-638.62 260.39,-644.62 254.39,-644.62 254.39,-644.62 12.39,-644.62 12.39,-644.62 6.39,-644.62 0.39,-638.62 0.39,-632.62 0.39,-632.62 0.39,-412.62 0.39,-412.62 0.39,-406.62 6.39,-400.62 12.39,-400.62"/>
<text text-anchor="middle" x="133.39" y="-629.42" font-family="Times,serif" font-size="14.00" fill="#434b54">HandleErrorLayer</text>
<polyline fill="none" stroke="#eeeeee" points="0.39,-621.62 266.39,-621.62 "/>
<text text-anchor="start" x="8.39" y="-606.42" font-family="Times,serif" font-size="14.00" fill="#434b54">pub struct HandleErrorLayer&lt;F, T&gt; {</text>
<text text-anchor="start" x="8.39" y="-591.42" font-family="Times,serif" font-size="14.00" fill="#434b54"> f: F,</text>
<text text-anchor="start" x="8.39" y="-576.42" font-family="Times,serif" font-size="14.00" fill="#434b54"> _extractor: PhantomData&lt;fn() &#45;&gt; T&gt;,</text>
<text text-anchor="start" x="8.39" y="-561.42" font-family="Times,serif" font-size="14.00" fill="#434b54">}</text>
<text text-anchor="start" x="8.39" y="-530.42" font-family="Times,serif" font-size="14.00" fill="#434b54">handles erros by </text>
<text text-anchor="start" x="8.39" y="-515.42" font-family="Times,serif" font-size="14.00" fill="#434b54">converting them into responses</text>
<text text-anchor="start" x="8.39" y="-484.42" font-family="Times,serif" font-size="14.00" fill="#434b54">调用f处理error。</text>
<text text-anchor="start" x="8.39" y="-469.42" font-family="Times,serif" font-size="14.00" fill="#434b54">f(err).await.into_response()</text>
<text text-anchor="start" x="8.39" y="-438.42" font-family="Times,serif" font-size="14.00" fill="#434b54">有点像python flask里面处理各种Exception</text>
<text text-anchor="start" x="8.39" y="-423.42" font-family="Times,serif" font-size="14.00" fill="#434b54">的catch exception, 对于这些 error返回</text>
<text text-anchor="start" x="8.39" y="-408.42" font-family="Times,serif" font-size="14.00" fill="#434b54">对应的错误resp</text>
</g>
<!-- tower_Layer&#45;&gt;HandleErrorLayer -->
<g id="edge5" class="edge">
<title>tower_Layer&#45;&gt;HandleErrorLayer</title>
<path fill="none" stroke="#55606a" d="M405.26,-442.42C364.42,-454.47 318.59,-467.99 276.37,-480.45"/>
<polygon fill="#55606a" stroke="#55606a" points="275.18,-477.15 266.58,-483.34 277.16,-483.86 275.18,-477.15"/>
</g>
<!-- LayerFn -->
<g id="node8" class="node">
<title>LayerFn</title>
<path fill="#eeeeee" stroke="#eeeeee" d="M779.41,-382.3C779.41,-382.3 965.41,-382.3 965.41,-382.3 971.41,-382.3 977.41,-388.3 977.41,-394.3 977.41,-394.3 977.41,-492.3 977.41,-492.3 977.41,-498.3 971.41,-504.3 965.41,-504.3 965.41,-504.3 779.41,-504.3 779.41,-504.3 773.41,-504.3 767.41,-498.3 767.41,-492.3 767.41,-492.3 767.41,-394.3 767.41,-394.3 767.41,-388.3 773.41,-382.3 779.41,-382.3"/>
<text text-anchor="middle" x="872.41" y="-489.1" font-family="Times,serif" font-size="14.00" fill="#434b54">LayerFn</text>
<polyline fill="none" stroke="#eeeeee" points="767.41,-481.3 977.41,-481.3 "/>
<text text-anchor="start" x="775.41" y="-466.1" font-family="Times,serif" font-size="14.00" fill="#434b54">#[derive(Clone, Copy)]</text>
<text text-anchor="start" x="775.41" y="-451.1" font-family="Times,serif" font-size="14.00" fill="#434b54">pub struct LayerFn&lt;F&gt; {</text>
<text text-anchor="start" x="775.41" y="-436.1" font-family="Times,serif" font-size="14.00" fill="#434b54"> f: F,</text>
<text text-anchor="start" x="775.41" y="-421.1" font-family="Times,serif" font-size="14.00" fill="#434b54">}</text>
<text text-anchor="start" x="775.41" y="-390.1" font-family="Times,serif" font-size="14.00" fill="#434b54">A Layer implemented by a closure.</text>
</g>
<!-- tower_Layer&#45;&gt;LayerFn -->
<g id="edge6" class="edge">
<title>tower_Layer&#45;&gt;LayerFn</title>
<path fill="none" stroke="#55606a" d="M651.58,-419.43C686.07,-423.16 723.4,-427.2 757.4,-430.87"/>
<polygon fill="#55606a" stroke="#55606a" points="757.04,-434.35 767.36,-431.94 757.79,-427.39 757.04,-434.35"/>
</g>
<!-- Next -->
<g id="node9" class="node">
<title>Next</title>
<path fill="#eeeeee" stroke="#eeeeee" d="M358.54,-71.8C358.54,-71.8 711.54,-71.8 711.54,-71.8 717.54,-71.8 723.54,-77.8 723.54,-83.8 723.54,-83.8 723.54,-196.8 723.54,-196.8 723.54,-202.8 717.54,-208.8 711.54,-208.8 711.54,-208.8 358.54,-208.8 358.54,-208.8 352.54,-208.8 346.54,-202.8 346.54,-196.8 346.54,-196.8 346.54,-83.8 346.54,-83.8 346.54,-77.8 352.54,-71.8 358.54,-71.8"/>
<text text-anchor="middle" x="535.04" y="-193.6" font-family="Times,serif" font-size="14.00" fill="#434b54">Next</text>
<polyline fill="none" stroke="#eeeeee" points="346.54,-185.8 723.54,-185.8 "/>
<text text-anchor="start" x="354.54" y="-170.6" font-family="Times,serif" font-size="14.00" fill="#434b54">pub struct Next&lt;ReqBody&gt; {</text>
<text text-anchor="start" x="354.54" y="-155.6" font-family="Times,serif" font-size="14.00" fill="#434b54"> inner: BoxCloneService&lt;</text>
<text text-anchor="start" x="354.54" y="-140.6" font-family="Times,serif" font-size="14.00" fill="#434b54"> Request&lt;ReqBody&gt;, Response, Infallible&gt;,</text>
<text text-anchor="start" x="354.54" y="-125.6" font-family="Times,serif" font-size="14.00" fill="#434b54">}</text>
<text text-anchor="start" x="354.54" y="-94.6" font-family="Times,serif" font-size="14.00" fill="#434b54">/// Execute the remaining middleware stack.</text>
<text text-anchor="start" x="354.54" y="-79.6" font-family="Times,serif" font-size="14.00" fill="#434b54">pub async fn run(mut self, req: Request&lt;ReqBody&gt;) &#45;&gt; Response</text>
</g>
<!-- MiddlewareFnLayer&#45;&gt;Next -->
<g id="edge8" class="edge">
<title>MiddlewareFnLayer&#45;&gt;Next</title>
<path fill="none" stroke="#55606a" d="M553.49,-219.8C553.43,-219.58 553.38,-219.35 553.33,-219.13"/>
<polygon fill="#55606a" stroke="#55606a" points="556.67,-218.02 551,-209.06 549.85,-219.6 556.67,-218.02"/>
</g>
<!-- ResponseFuture_fn -->
<g id="node10" class="node">
<title>ResponseFuture_fn</title>
<path fill="#eeeeee" stroke="#eeeeee" d="M746.35,-0.13C746.35,-0.13 967.35,-0.13 967.35,-0.13 973.35,-0.13 979.35,-6.13 979.35,-12.13 979.35,-12.13 979.35,-94.13 979.35,-94.13 979.35,-100.13 973.35,-106.13 967.35,-106.13 967.35,-106.13 746.35,-106.13 746.35,-106.13 740.35,-106.13 734.35,-100.13 734.35,-94.13 734.35,-94.13 734.35,-12.13 734.35,-12.13 734.35,-6.13 740.35,-0.13 746.35,-0.13"/>
<text text-anchor="middle" x="856.85" y="-90.93" font-family="Times,serif" font-size="14.00" fill="#434b54">ResponseFuture</text>
<polyline fill="none" stroke="#eeeeee" points="734.35,-83.13 979.35,-83.13 "/>
<text text-anchor="start" x="742.35" y="-67.93" font-family="Times,serif" font-size="14.00" fill="#434b54">/// Response future for [`MiddlewareFn`].</text>
<text text-anchor="start" x="742.35" y="-52.93" font-family="Times,serif" font-size="14.00" fill="#434b54">pub struct ResponseFuture&lt;F&gt; {</text>
<text text-anchor="start" x="742.35" y="-37.93" font-family="Times,serif" font-size="14.00" fill="#434b54"> #[pin]</text>
<text text-anchor="start" x="742.35" y="-22.93" font-family="Times,serif" font-size="14.00" fill="#434b54"> inner: F,</text>
<text text-anchor="start" x="742.35" y="-7.93" font-family="Times,serif" font-size="14.00" fill="#434b54">}</text>
</g>
<!-- MiddlewareFnLayer&#45;&gt;ResponseFuture_fn -->
<g id="edge9" class="edge">
<title>MiddlewareFnLayer&#45;&gt;ResponseFuture_fn</title>
<path fill="none" stroke="#55606a" d="M645.21,-220.07C687.48,-186.73 739.58,-145.63 781.51,-112.56"/>
<polygon fill="#55606a" stroke="#55606a" points="783.8,-115.21 789.49,-106.27 779.47,-109.71 783.8,-115.21"/>
</g>
<!-- ResponseFuture -->
<g id="node5" class="node">
<title>ResponseFuture</title>
<path fill="#eeeeee" stroke="#eeeeee" d="M668.79,-765.22C668.79,-765.22 821.79,-765.22 821.79,-765.22 827.79,-765.22 833.79,-771.22 833.79,-777.22 833.79,-777.22 833.79,-814.22 833.79,-814.22 833.79,-820.22 827.79,-826.22 821.79,-826.22 821.79,-826.22 668.79,-826.22 668.79,-826.22 662.79,-826.22 656.79,-820.22 656.79,-814.22 656.79,-814.22 656.79,-777.22 656.79,-777.22 656.79,-771.22 662.79,-765.22 668.79,-765.22"/>
<text text-anchor="middle" x="745.29" y="-811.02" font-family="Times,serif" font-size="14.00" fill="#434b54">ResponseFuture</text>
<polyline fill="none" stroke="#eeeeee" points="656.79,-803.22 833.79,-803.22 "/>
<text text-anchor="start" x="664.79" y="-788.02" font-family="Times,serif" font-size="14.00" fill="#434b54">state: State&lt;ReqBody, S, E&gt;,</text>
<text text-anchor="start" x="664.79" y="-773.02" font-family="Times,serif" font-size="14.00" fill="#434b54"> svc: Option&lt;S&gt;,</text>
</g>
<!-- ExtractorMiddlewareLayer&#45;&gt;ResponseFuture -->
<g id="edge7" class="edge">
<title>ExtractorMiddlewareLayer&#45;&gt;ResponseFuture</title>
<path fill="none" stroke="#55606a" d="M645.47,-572.71C669.47,-626.34 705.82,-707.54 727.4,-755.75"/>
<polygon fill="#55606a" stroke="#55606a" points="724.23,-757.23 731.51,-764.93 730.62,-754.37 724.23,-757.23"/>
</g>
</g>
</svg>
