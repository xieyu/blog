<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.1 (20210417.1919)
 -->
<!-- Title: resolveLocksForWrite_normal Pages: 1 -->
<svg width="1033pt" height="352pt"
 viewBox="0.00 0.00 1033.00 352.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 348)">
<title>resolveLocksForWrite_normal</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-348 1029,-348 1029,4 -4,4"/>
<g id="clust1" class="cluster">
<title>cluster_LockResolver</title>
<path fill="none" stroke="slategrey" stroke-dasharray="5,2" d="M20,-8C20,-8 1005,-8 1005,-8 1011,-8 1017,-14 1017,-20 1017,-20 1017,-324 1017,-324 1017,-330 1011,-336 1005,-336 1005,-336 20,-336 20,-336 14,-336 8,-330 8,-324 8,-324 8,-20 8,-20 8,-14 14,-8 20,-8"/>
<text text-anchor="middle" x="512.5" y="-316" font-family="Times,serif" font-size="20.00">LockResolver</text>
</g>
<!-- resolve -->
<g id="node1" class="node">
<title>resolve</title>
<path fill="none" stroke="#1c2123" d="M28,-174.5C28,-174.5 162,-174.5 162,-174.5 168,-174.5 174,-180.5 174,-186.5 174,-186.5 174,-253.5 174,-253.5 174,-259.5 168,-265.5 162,-265.5 162,-265.5 28,-265.5 28,-265.5 22,-265.5 16,-259.5 16,-253.5 16,-253.5 16,-186.5 16,-186.5 16,-180.5 22,-174.5 28,-174.5"/>
<text text-anchor="middle" x="95" y="-250.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">resolve</text>
<polyline fill="none" stroke="#1c2123" points="16,-242.5 174,-242.5 "/>
<text text-anchor="start" x="24" y="-227.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">1.获取txnStatus</text>
<text text-anchor="start" x="24" y="-212.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 2.如果status.ttl == 0 </text>
<text text-anchor="start" x="24" y="-197.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 根据lock type调用</text>
<text text-anchor="start" x="24" y="-182.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 不同的resolveLock方法</text>
</g>
<!-- getTxnStatusFromLock -->
<g id="node2" class="node">
<title>getTxnStatusFromLock</title>
<path fill="none" stroke="#1c2123" d="M222,-165C222,-165 352,-165 352,-165 358,-165 364,-171 364,-177 364,-177 364,-199 364,-199 364,-205 358,-211 352,-211 352,-211 222,-211 222,-211 216,-211 210,-205 210,-199 210,-199 210,-177 210,-177 210,-171 216,-165 222,-165"/>
<text text-anchor="middle" x="287" y="-195.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">getTxnStatusFromLock</text>
<polyline fill="none" stroke="#1c2123" points="210,-188 364,-188 "/>
<text text-anchor="start" x="218" y="-172.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">获取primay lock的状态</text>
</g>
<!-- resolve&#45;&gt;getTxnStatusFromLock -->
<g id="edge1" class="edge">
<title>resolve&#45;&gt;getTxnStatusFromLock</title>
<path fill="none" stroke="#666666" d="M174.1,-206.85C182.56,-205.42 191.21,-203.97 199.76,-202.53"/>
<polygon fill="#666666" stroke="#666666" points="200.45,-205.96 209.73,-200.85 199.29,-199.05 200.45,-205.96"/>
</g>
<!-- resolveLock -->
<g id="node3" class="node">
<title>resolveLock</title>
<path fill="none" stroke="#1c2123" d="M706.5,-261C706.5,-261 765.5,-261 765.5,-261 771.5,-261 777.5,-267 777.5,-273 777.5,-273 777.5,-285 777.5,-285 777.5,-291 771.5,-297 765.5,-297 765.5,-297 706.5,-297 706.5,-297 700.5,-297 694.5,-291 694.5,-285 694.5,-285 694.5,-273 694.5,-273 694.5,-267 700.5,-261 706.5,-261"/>
<text text-anchor="middle" x="736" y="-275.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">resolveLock</text>
</g>
<!-- resolve&#45;&gt;resolveLock -->
<g id="edge2" class="edge">
<title>resolve&#45;&gt;resolveLock</title>
<path fill="none" stroke="#666666" d="M174,-229.92C235.36,-237.49 323.04,-247.82 400,-255 500.71,-264.4 618.75,-272.08 684.4,-276.06"/>
<polygon fill="#666666" stroke="#666666" points="684.28,-279.56 694.47,-276.66 684.7,-272.57 684.28,-279.56"/>
</g>
<!-- TxnStatus -->
<g id="node4" class="node">
<title>TxnStatus</title>
<path fill="none" stroke="#1c2123" d="M412,-130.5C412,-130.5 585,-130.5 585,-130.5 591,-130.5 597,-136.5 597,-142.5 597,-142.5 597,-233.5 597,-233.5 597,-239.5 591,-245.5 585,-245.5 585,-245.5 412,-245.5 412,-245.5 406,-245.5 400,-239.5 400,-233.5 400,-233.5 400,-142.5 400,-142.5 400,-136.5 406,-130.5 412,-130.5"/>
<text text-anchor="middle" x="498.5" y="-230.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">TxnStatus</text>
<polyline fill="none" stroke="#1c2123" points="400,-222.5 597,-222.5 "/>
<text text-anchor="start" x="408" y="-207.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">ttl uint64</text>
<polyline fill="none" stroke="#1c2123" points="400,-199.5 597,-199.5 "/>
<text text-anchor="start" x="408" y="-184.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">commitTS uint64</text>
<polyline fill="none" stroke="#1c2123" points="400,-176.5 597,-176.5 "/>
<text text-anchor="start" x="408" y="-161.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">action kvrpcpb.Action</text>
<polyline fill="none" stroke="#1c2123" points="400,-153.5 597,-153.5 "/>
<text text-anchor="start" x="408" y="-138.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">primaryLock *kvrpcpb.LockInfo</text>
</g>
<!-- getTxnStatusFromLock&#45;&gt;TxnStatus -->
<g id="edge3" class="edge">
<title>getTxnStatusFromLock&#45;&gt;TxnStatus</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M364.23,-188C372.55,-188 381.14,-188 389.75,-188"/>
<polygon fill="green" stroke="green" points="389.86,-191.5 399.86,-188 389.86,-184.5 389.86,-191.5"/>
</g>
<!-- getTxnStatus -->
<g id="node5" class="node">
<title>getTxnStatus</title>
<path fill="none" stroke="#1c2123" d="M453.5,-27C453.5,-27 543.5,-27 543.5,-27 549.5,-27 555.5,-33 555.5,-39 555.5,-39 555.5,-91 555.5,-91 555.5,-97 549.5,-103 543.5,-103 543.5,-103 453.5,-103 453.5,-103 447.5,-103 441.5,-97 441.5,-91 441.5,-91 441.5,-39 441.5,-39 441.5,-33 447.5,-27 453.5,-27"/>
<text text-anchor="middle" x="498.5" y="-87.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">getTxnStatus</text>
<polyline fill="none" stroke="#1c2123" points="441.5,-80 555.5,-80 "/>
<text text-anchor="start" x="449.5" y="-64.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">根据冲突key的</text>
<text text-anchor="start" x="449.5" y="-49.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> primary key lock</text>
<text text-anchor="start" x="449.5" y="-34.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 获取txn status</text>
</g>
<!-- getTxnStatusFromLock&#45;&gt;getTxnStatus -->
<g id="edge4" class="edge">
<title>getTxnStatusFromLock&#45;&gt;getTxnStatus</title>
<path fill="none" stroke="#666666" d="M326.26,-164.88C347.85,-151.89 375.37,-135.44 400,-121 410.56,-114.81 421.8,-108.29 432.76,-101.97"/>
<polygon fill="#666666" stroke="#666666" points="434.54,-104.98 441.46,-96.96 431.05,-98.92 434.54,-104.98"/>
</g>
<!-- CmdResolveLock -->
<g id="node7" class="node">
<title>CmdResolveLock</title>
<path fill="none" stroke="#1c2123" d="M887,-221C887,-221 997,-221 997,-221 1003,-221 1009,-227 1009,-233 1009,-233 1009,-285 1009,-285 1009,-291 1003,-297 997,-297 997,-297 887,-297 887,-297 881,-297 875,-291 875,-285 875,-285 875,-233 875,-233 875,-227 881,-221 887,-221"/>
<text text-anchor="middle" x="942" y="-281.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">CmdResolveLock</text>
<polyline fill="none" stroke="#1c2123" points="875,-274 1009,-274 "/>
<text text-anchor="start" x="883" y="-258.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">Tikv: 根据txn status</text>
<text text-anchor="start" x="883" y="-243.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 清理lock</text>
<text text-anchor="start" x="883" y="-228.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> commit或者cleanup</text>
</g>
<!-- resolveLock&#45;&gt;CmdResolveLock -->
<g id="edge7" class="edge">
<title>resolveLock&#45;&gt;CmdResolveLock</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M777.79,-275C802.65,-272.56 835.21,-269.37 864.7,-266.48"/>
<polygon fill="green" stroke="green" points="865.37,-269.93 874.98,-265.47 864.69,-262.96 865.37,-269.93"/>
</g>
<!-- TxnStatus&#45;&gt;resolveLock -->
<g id="edge6" class="edge">
<title>TxnStatus&#45;&gt;resolveLock</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M597.1,-236.41C609.06,-241.64 621.22,-246.64 633,-251 649.4,-257.07 667.72,-262.5 684.25,-266.92"/>
<polygon fill="green" stroke="green" points="683.72,-270.4 694.28,-269.54 685.49,-263.63 683.72,-270.4"/>
</g>
<!-- LockInfo -->
<g id="node8" class="node">
<title>LockInfo</title>
<path fill="none" stroke="#1c2123" d="M684,-126.5C684,-126.5 788,-126.5 788,-126.5 794,-126.5 800,-132.5 800,-138.5 800,-138.5 800,-229.5 800,-229.5 800,-235.5 794,-241.5 788,-241.5 788,-241.5 684,-241.5 684,-241.5 678,-241.5 672,-235.5 672,-229.5 672,-229.5 672,-138.5 672,-138.5 672,-132.5 678,-126.5 684,-126.5"/>
<text text-anchor="middle" x="736" y="-226.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">LockInfo</text>
<polyline fill="none" stroke="#1c2123" points="672,-218.5 800,-218.5 "/>
<text text-anchor="start" x="680" y="-203.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">PrimaryLock []byte </text>
<polyline fill="none" stroke="#1c2123" points="672,-195.5 800,-195.5 "/>
<text text-anchor="start" x="680" y="-180.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">LockVersion uint64 </text>
<polyline fill="none" stroke="#1c2123" points="672,-172.5 800,-172.5 "/>
<text text-anchor="start" x="680" y="-157.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Key []byte </text>
<polyline fill="none" stroke="#1c2123" points="672,-149.5 800,-149.5 "/>
<text text-anchor="start" x="680" y="-134.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">LockTtl uint64 </text>
</g>
<!-- TxnStatus&#45;&gt;LockInfo -->
<g id="edge8" class="edge">
<title>TxnStatus&#45;&gt;LockInfo</title>
<path fill="none" stroke="#666666" d="M597.33,-186.34C618.84,-185.97 641.27,-185.59 661.62,-185.25"/>
<polygon fill="#666666" stroke="#666666" points="661.81,-188.74 671.75,-185.07 661.69,-181.74 661.81,-188.74"/>
</g>
<!-- CmdCheckTxnStatus -->
<g id="node6" class="node">
<title>CmdCheckTxnStatus</title>
<path fill="none" stroke="#1c2123" d="M645,-16.5C645,-16.5 827,-16.5 827,-16.5 833,-16.5 839,-22.5 839,-28.5 839,-28.5 839,-95.5 839,-95.5 839,-101.5 833,-107.5 827,-107.5 827,-107.5 645,-107.5 645,-107.5 639,-107.5 633,-101.5 633,-95.5 633,-95.5 633,-28.5 633,-28.5 633,-22.5 639,-16.5 645,-16.5"/>
<text text-anchor="middle" x="736" y="-92.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">CmdCheckTxnStatus</text>
<polyline fill="none" stroke="#1c2123" points="633,-84.5 839,-84.5 "/>
<text text-anchor="start" x="641" y="-69.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">tikv: 如果primay lock expire了</text>
<text text-anchor="start" x="641" y="-54.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 则会rollback the primary lock</text>
<text text-anchor="start" x="641" y="-39.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 并返回commit Version 0</text>
<text text-anchor="start" x="641" y="-24.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 否则返回正常的commit version</text>
</g>
<!-- getTxnStatus&#45;&gt;CmdCheckTxnStatus -->
<g id="edge5" class="edge">
<title>getTxnStatus&#45;&gt;CmdCheckTxnStatus</title>
<path fill="none" stroke="#666666" d="M555.61,-64.29C575.76,-64.03 599.25,-63.73 622.48,-63.43"/>
<polygon fill="#666666" stroke="#666666" points="622.81,-66.93 632.76,-63.3 622.72,-59.93 622.81,-66.93"/>
</g>
</g>
</svg>
