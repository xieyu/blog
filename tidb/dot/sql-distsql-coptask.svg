<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.44.1 (20200629.0846)
 -->
<!-- Title: sql_distsql_coptask Pages: 1 -->
<svg width="2308pt" height="361pt"
 viewBox="0.00 0.00 2308.00 361.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 357)">
<title>sql_distsql_coptask</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-357 2304,-357 2304,4 -4,4"/>
<!-- SQL -->
<g id="node1" class="node">
<title>SQL</title>
<polygon fill="none" stroke="black" points="71,-90 0,-90 0,-54 71,-54 71,-90"/>
<text text-anchor="middle" x="35.5" y="-68.3" font-family="Times,serif" font-size="14.00">SQL语句</text>
</g>
<!-- Datasource -->
<g id="node6" class="node">
<title>Datasource</title>
<polygon fill="none" stroke="black" points="108,-34 108,-110 287,-110 287,-34 108,-34"/>
<text text-anchor="middle" x="197.5" y="-94.8" font-family="Times,serif" font-size="14.00">Datasource</text>
<polyline fill="none" stroke="black" points="108,-87 287,-87 "/>
<text text-anchor="start" x="116" y="-71.8" font-family="Times,serif" font-size="14.00">sql语句中的Datasource部分</text>
<text text-anchor="start" x="116" y="-56.8" font-family="Times,serif" font-size="14.00"> 最终会成为TableReader</text>
<text text-anchor="start" x="116" y="-41.8" font-family="Times,serif" font-size="14.00"> 或者TableIndexReader</text>
</g>
<!-- SQL&#45;&gt;Datasource -->
<g id="edge1" class="edge">
<title>SQL&#45;&gt;Datasource</title>
<path fill="none" stroke="black" d="M71.22,-72C79.25,-72 88.19,-72 97.49,-72"/>
<polygon fill="black" stroke="black" points="97.71,-75.5 107.71,-72 97.71,-68.5 97.71,-75.5"/>
</g>
<!-- copTask1 -->
<g id="node2" class="node">
<title>copTask1</title>
<polygon fill="none" stroke="black" points="1252,-283.5 1252,-352.5 1379,-352.5 1379,-283.5 1252,-283.5"/>
<text text-anchor="middle" x="1315.5" y="-337.3" font-family="Times,serif" font-size="14.00">coptask</text>
<polyline fill="none" stroke="black" points="1252,-329.5 1379,-329.5 "/>
<text text-anchor="start" x="1260" y="-314.3" font-family="Times,serif" font-size="14.00">region RegionVerID</text>
<polyline fill="none" stroke="black" points="1252,-306.5 1379,-306.5 "/>
<text text-anchor="start" x="1260" y="-291.3" font-family="Times,serif" font-size="14.00">ranges *copRanges </text>
</g>
<!-- taskCh -->
<g id="node13" class="node">
<title>taskCh</title>
<polygon fill="#95e1d3" stroke="black" points="1451.5,-207 1451.5,-253 1562.5,-253 1562.5,-207 1451.5,-207"/>
<text text-anchor="middle" x="1507" y="-237.8" font-family="Times,serif" font-size="14.00">taskCh</text>
<polyline fill="none" stroke="black" points="1451.5,-230 1562.5,-230 "/>
<text text-anchor="start" x="1459.5" y="-214.8" font-family="Times,serif" font-size="14.00">copTask Channel</text>
</g>
<!-- copTask1&#45;&gt;taskCh -->
<g id="edge11" class="edge">
<title>copTask1&#45;&gt;taskCh</title>
<path fill="none" stroke="black" d="M1379.07,-288.94C1401.05,-278.73 1425.65,-267.31 1447.3,-257.26"/>
<polygon fill="black" stroke="black" points="1448.79,-260.43 1456.38,-253.04 1445.84,-254.08 1448.79,-260.43"/>
</g>
<!-- copTask2 -->
<g id="node3" class="node">
<title>copTask2</title>
<polygon fill="none" stroke="black" points="1252,-195.5 1252,-264.5 1379,-264.5 1379,-195.5 1252,-195.5"/>
<text text-anchor="middle" x="1315.5" y="-249.3" font-family="Times,serif" font-size="14.00">coptask</text>
<polyline fill="none" stroke="black" points="1252,-241.5 1379,-241.5 "/>
<text text-anchor="start" x="1260" y="-226.3" font-family="Times,serif" font-size="14.00">region RegionVerID</text>
<polyline fill="none" stroke="black" points="1252,-218.5 1379,-218.5 "/>
<text text-anchor="start" x="1260" y="-203.3" font-family="Times,serif" font-size="14.00">ranges *copRanges </text>
</g>
<!-- copTask2&#45;&gt;taskCh -->
<g id="edge12" class="edge">
<title>copTask2&#45;&gt;taskCh</title>
<path fill="none" stroke="black" d="M1379.07,-230C1399.09,-230 1421.27,-230 1441.43,-230"/>
<polygon fill="black" stroke="black" points="1441.45,-233.5 1451.45,-230 1441.45,-226.5 1441.45,-233.5"/>
</g>
<!-- copTaskN -->
<g id="node4" class="node">
<title>copTaskN</title>
<polygon fill="none" stroke="black" points="1252,-107.5 1252,-176.5 1379,-176.5 1379,-107.5 1252,-107.5"/>
<text text-anchor="middle" x="1315.5" y="-161.3" font-family="Times,serif" font-size="14.00">coptask</text>
<polyline fill="none" stroke="black" points="1252,-153.5 1379,-153.5 "/>
<text text-anchor="start" x="1260" y="-138.3" font-family="Times,serif" font-size="14.00">region RegionVerID</text>
<polyline fill="none" stroke="black" points="1252,-130.5 1379,-130.5 "/>
<text text-anchor="start" x="1260" y="-115.3" font-family="Times,serif" font-size="14.00">ranges *copRanges </text>
</g>
<!-- copTaskN&#45;&gt;taskCh -->
<g id="edge13" class="edge">
<title>copTaskN&#45;&gt;taskCh</title>
<path fill="none" stroke="black" d="M1379.07,-171.06C1401.05,-181.27 1425.65,-192.69 1447.3,-202.74"/>
<polygon fill="black" stroke="black" points="1445.84,-205.92 1456.38,-206.96 1448.79,-199.57 1445.84,-205.92"/>
</g>
<!-- RegionRequestSender -->
<g id="node5" class="node">
<title>RegionRequestSender</title>
<polygon fill="none" stroke="black" points="2134.5,-315.5 1994.5,-315.5 1994.5,-262.5 2134.5,-262.5 2134.5,-315.5"/>
<text text-anchor="start" x="2002.5" y="-300.3" font-family="Times,serif" font-size="14.00">RegionRequestSender </text>
<text text-anchor="start" x="2002.5" y="-285.3" font-family="Times,serif" font-size="14.00">向tikv发送grpc请求</text>
<text text-anchor="start" x="2002.5" y="-270.3" font-family="Times,serif" font-size="14.00">处理错误，重试等</text>
</g>
<!-- TiKVServer -->
<g id="node19" class="node">
<title>TiKVServer</title>
<polygon fill="#f38181" stroke="black" points="2217,-271 2217,-307 2300,-307 2300,-271 2217,-271"/>
<text text-anchor="middle" x="2258.5" y="-285.3" font-family="Times,serif" font-size="14.00">TiKVServer</text>
</g>
<!-- RegionRequestSender&#45;&gt;TiKVServer -->
<g id="edge20" class="edge">
<title>RegionRequestSender&#45;&gt;TiKVServer</title>
<path fill="none" stroke="black" d="M2134.55,-289C2158.4,-289 2184.67,-289 2206.78,-289"/>
<polygon fill="black" stroke="black" points="2206.94,-292.5 2216.94,-289 2206.94,-285.5 2206.94,-292.5"/>
</g>
<!-- TableReaderExecutor1 -->
<g id="node8" class="node">
<title>TableReaderExecutor1</title>
<polygon fill="none" stroke="black" points="480.5,-144 339.5,-144 339.5,-108 480.5,-108 480.5,-144"/>
<text text-anchor="middle" x="410" y="-122.3" font-family="Times,serif" font-size="14.00">TableReaderExecutor1</text>
</g>
<!-- Datasource&#45;&gt;TableReaderExecutor1 -->
<g id="edge2" class="edge">
<title>Datasource&#45;&gt;TableReaderExecutor1</title>
<path fill="none" stroke="black" d="M287.16,-94.74C301.18,-98.34 315.59,-102.04 329.38,-105.58"/>
<polygon fill="black" stroke="black" points="328.74,-109.03 339.3,-108.12 330.48,-102.24 328.74,-109.03"/>
</g>
<!-- TableIndexReaderExecutor2 -->
<g id="node9" class="node">
<title>TableIndexReaderExecutor2</title>
<polygon fill="none" stroke="black" points="496,-90 324,-90 324,-54 496,-54 496,-90"/>
<text text-anchor="middle" x="410" y="-68.3" font-family="Times,serif" font-size="14.00">TableIndexReaderExecutor2</text>
</g>
<!-- Datasource&#45;&gt;TableIndexReaderExecutor2 -->
<g id="edge3" class="edge">
<title>Datasource&#45;&gt;TableIndexReaderExecutor2</title>
<path fill="none" stroke="black" d="M287.16,-72C295.88,-72 304.76,-72 313.55,-72"/>
<polygon fill="black" stroke="black" points="313.8,-75.5 323.8,-72 313.8,-68.5 313.8,-75.5"/>
</g>
<!-- TableReaderExecutorN -->
<g id="node10" class="node">
<title>TableReaderExecutorN</title>
<polygon fill="none" stroke="black" points="482,-36 338,-36 338,0 482,0 482,-36"/>
<text text-anchor="middle" x="410" y="-14.3" font-family="Times,serif" font-size="14.00">TableReaderExecutorN</text>
</g>
<!-- Datasource&#45;&gt;TableReaderExecutorN -->
<g id="edge4" class="edge">
<title>Datasource&#45;&gt;TableReaderExecutorN</title>
<path fill="none" stroke="black" d="M287.16,-49.26C300.99,-45.71 315.22,-42.06 328.85,-38.56"/>
<polygon fill="black" stroke="black" points="329.84,-41.92 338.65,-36.05 328.1,-35.14 329.84,-41.92"/>
</g>
<!-- distSQL1 -->
<g id="node7" class="node">
<title>distSQL1</title>
<polygon fill="none" stroke="black" points="662,-135 662,-211 868,-211 868,-135 662,-135"/>
<text text-anchor="middle" x="765" y="-195.8" font-family="Times,serif" font-size="14.00">distSQL1</text>
<polyline fill="none" stroke="black" points="662,-188 868,-188 "/>
<text text-anchor="start" x="670" y="-172.8" font-family="Times,serif" font-size="14.00">对上层提供了简单的Select方法</text>
<text text-anchor="start" x="670" y="-157.8" font-family="Times,serif" font-size="14.00"> 把下层的copprocessor</text>
<text text-anchor="start" x="670" y="-142.8" font-family="Times,serif" font-size="14.00"> 请求封装起来</text>
</g>
<!-- CopClient -->
<g id="node12" class="node">
<title>CopClient</title>
<polygon fill="none" stroke="black" points="905,-135 905,-211 1155,-211 1155,-135 905,-135"/>
<text text-anchor="middle" x="1030" y="-195.8" font-family="Times,serif" font-size="14.00">CopClient</text>
<polyline fill="none" stroke="black" points="905,-188 1155,-188 "/>
<text text-anchor="start" x="913" y="-172.8" font-family="Times,serif" font-size="14.00">将kvRequest请求中的KeyRanges转为为</text>
<text text-anchor="start" x="913" y="-157.8" font-family="Times,serif" font-size="14.00"> region然后构造copprocessor task</text>
<text text-anchor="start" x="913" y="-142.8" font-family="Times,serif" font-size="14.00"> 由copWorker并发的执行这些task</text>
</g>
<!-- distSQL1&#45;&gt;CopClient -->
<g id="edge7" class="edge">
<title>distSQL1&#45;&gt;CopClient</title>
<path fill="none" stroke="black" d="M868.06,-173C876.77,-173 885.66,-173 894.56,-173"/>
<polygon fill="black" stroke="black" points="894.62,-176.5 904.62,-173 894.62,-169.5 894.62,-176.5"/>
</g>
<!-- TableReaderExecutor1&#45;&gt;distSQL1 -->
<g id="edge5" class="edge">
<title>TableReaderExecutor1&#45;&gt;distSQL1</title>
<path fill="none" stroke="black" d="M480.74,-135.29C529.55,-141.78 595.81,-150.61 651.97,-158.08"/>
<polygon fill="black" stroke="black" points="651.59,-161.56 661.97,-159.41 652.52,-154.63 651.59,-161.56"/>
<text text-anchor="middle" x="579" y="-160.8" font-family="Times,serif" font-size="14.00">kv.Request: KeyRanges</text>
</g>
<!-- DAGRequest -->
<g id="node11" class="node">
<title>DAGRequest</title>
<polygon fill="none" stroke="black" points="809.5,-116 720.5,-116 720.5,-80 809.5,-80 809.5,-116"/>
<text text-anchor="middle" x="765" y="-94.3" font-family="Times,serif" font-size="14.00">DAGRequest</text>
</g>
<!-- TableReaderExecutor1&#45;&gt;DAGRequest -->
<g id="edge6" class="edge">
<title>TableReaderExecutor1&#45;&gt;DAGRequest</title>
<path fill="none" stroke="black" d="M480.52,-119.82C491.72,-118.85 503.18,-117.88 514,-117 581.58,-111.48 659.48,-105.64 710.12,-101.92"/>
<polygon fill="black" stroke="black" points="710.47,-105.4 720.18,-101.18 709.95,-98.42 710.47,-105.4"/>
<text text-anchor="middle" x="579" y="-120.8" font-family="Times,serif" font-size="14.00">ToPB</text>
</g>
<!-- CopClient&#45;&gt;copTask1 -->
<g id="edge8" class="edge">
<title>CopClient&#45;&gt;copTask1</title>
<path fill="none" stroke="black" d="M1105.49,-211.1C1147.82,-232.75 1200.58,-259.73 1242.5,-281.17"/>
<polygon fill="black" stroke="black" points="1241.05,-284.36 1251.54,-285.8 1244.23,-278.13 1241.05,-284.36"/>
<text text-anchor="middle" x="1203.5" y="-278.8" font-family="Times,serif" font-size="14.00">Region1</text>
</g>
<!-- CopClient&#45;&gt;copTask2 -->
<g id="edge9" class="edge">
<title>CopClient&#45;&gt;copTask2</title>
<path fill="none" stroke="black" d="M1155.35,-198C1184.9,-203.94 1215.47,-210.09 1241.83,-215.39"/>
<polygon fill="black" stroke="black" points="1241.22,-218.84 1251.71,-217.38 1242.6,-211.97 1241.22,-218.84"/>
<text text-anchor="middle" x="1203.5" y="-216.8" font-family="Times,serif" font-size="14.00">Region2</text>
</g>
<!-- CopClient&#45;&gt;copTaskN -->
<g id="edge10" class="edge">
<title>CopClient&#45;&gt;copTaskN</title>
<path fill="none" stroke="black" d="M1155.35,-159.4C1184.77,-156.19 1215.2,-152.86 1241.48,-149.98"/>
<polygon fill="black" stroke="black" points="1242.15,-153.43 1251.71,-148.87 1241.39,-146.47 1242.15,-153.43"/>
<text text-anchor="middle" x="1203.5" y="-160.8" font-family="Times,serif" font-size="14.00">RegionN...</text>
</g>
<!-- RegionCache -->
<g id="node16" class="node">
<title>RegionCache</title>
<polygon fill="none" stroke="black" points="1360,-89 1271,-89 1271,-53 1360,-53 1360,-89"/>
<text text-anchor="middle" x="1315.5" y="-67.3" font-family="Times,serif" font-size="14.00">RegionCache</text>
</g>
<!-- CopClient&#45;&gt;RegionCache -->
<g id="edge17" class="edge">
<title>CopClient&#45;&gt;RegionCache</title>
<path fill="none" stroke="black" d="M1136.97,-134.87C1179.38,-119.62 1226.36,-102.71 1261.33,-90.13"/>
<polygon fill="black" stroke="black" points="1262.64,-93.38 1270.86,-86.7 1260.27,-86.79 1262.64,-93.38"/>
</g>
<!-- copIteratorWork -->
<g id="node14" class="node">
<title>copIteratorWork</title>
<polygon fill="none" stroke="black" points="1693,-173 1693,-287 1912,-287 1912,-173 1693,-173"/>
<text text-anchor="middle" x="1802.5" y="-271.8" font-family="Times,serif" font-size="14.00">copIteratorWork</text>
<polyline fill="none" stroke="black" points="1693,-264 1912,-264 "/>
<text text-anchor="start" x="1701" y="-248.8" font-family="Times,serif" font-size="14.00">并发执行coprocessortask</text>
<text text-anchor="start" x="1701" y="-233.8" font-family="Times,serif" font-size="14.00"> 并将结果放到respCh</text>
<text text-anchor="start" x="1701" y="-218.8" font-family="Times,serif" font-size="14.00"> 由iterator的Next方法来取</text>
<polyline fill="none" stroke="black" points="1693,-211 1912,-211 "/>
<text text-anchor="start" x="1701" y="-195.8" font-family="Times,serif" font-size="14.00">copIteratorWork 可以多个gorutoine</text>
<text text-anchor="start" x="1701" y="-180.8" font-family="Times,serif" font-size="14.00"> 并发执行</text>
</g>
<!-- taskCh&#45;&gt;copIteratorWork -->
<g id="edge14" class="edge">
<title>taskCh&#45;&gt;copIteratorWork</title>
<path fill="none" stroke="black" d="M1562.52,-230C1596.29,-230 1641.01,-230 1682.64,-230"/>
<polygon fill="black" stroke="black" points="1682.86,-233.5 1692.86,-230 1682.86,-226.5 1682.86,-233.5"/>
<text text-anchor="middle" x="1645.5" y="-233.8" font-family="Times,serif" font-size="14.00">execute by</text>
</g>
<!-- copIteratorWork&#45;&gt;RegionRequestSender -->
<g id="edge15" class="edge">
<title>copIteratorWork&#45;&gt;RegionRequestSender</title>
<path fill="none" stroke="black" d="M1912.26,-254.68C1936.5,-260.18 1961.76,-265.91 1984.53,-271.08"/>
<polygon fill="black" stroke="black" points="1983.94,-274.53 1994.46,-273.33 1985.49,-267.71 1983.94,-274.53"/>
</g>
<!-- respCh -->
<g id="node15" class="node">
<title>respCh</title>
<polygon fill="#95e1d3" stroke="black" points="1949,-160 1949,-244 2180,-244 2180,-160 1949,-160"/>
<text text-anchor="middle" x="2064.5" y="-228.8" font-family="Times,serif" font-size="14.00">respCh</text>
<polyline fill="none" stroke="black" points="1949,-221 2180,-221 "/>
<text text-anchor="start" x="1957" y="-205.8" font-family="Times,serif" font-size="14.00">cannel</text>
<polyline fill="none" stroke="black" points="1949,-198 2180,-198 "/>
<text text-anchor="start" x="1957" y="-182.8" font-family="Times,serif" font-size="14.00">由worker向channel中存放数据</text>
<text text-anchor="start" x="1957" y="-167.8" font-family="Times,serif" font-size="14.00"> 迭代器Next方法从channel中取数据</text>
</g>
<!-- copIteratorWork&#45;&gt;respCh -->
<g id="edge16" class="edge">
<title>copIteratorWork&#45;&gt;respCh</title>
<path fill="none" stroke="black" d="M1912.26,-218.29C1921.05,-217.34 1929.98,-216.38 1938.88,-215.42"/>
<polygon fill="black" stroke="black" points="1939.33,-218.89 1948.9,-214.34 1938.58,-211.93 1939.33,-218.89"/>
</g>
<!-- PdClient -->
<g id="node17" class="node">
<title>PdClient</title>
<polygon fill="none" stroke="black" points="1416,-40.5 1416,-101.5 1598,-101.5 1598,-40.5 1416,-40.5"/>
<text text-anchor="middle" x="1507" y="-86.3" font-family="Times,serif" font-size="14.00">PdClient</text>
<polyline fill="none" stroke="black" points="1416,-78.5 1598,-78.5 "/>
<text text-anchor="start" x="1424" y="-63.3" font-family="Times,serif" font-size="14.00">获取keyRange所在的regions</text>
<text text-anchor="start" x="1424" y="-48.3" font-family="Times,serif" font-size="14.00"> 以及tikv addr</text>
</g>
<!-- RegionCache&#45;&gt;PdClient -->
<g id="edge18" class="edge">
<title>RegionCache&#45;&gt;PdClient</title>
<path fill="none" stroke="black" d="M1360.45,-71C1374.08,-71 1389.71,-71 1405.55,-71"/>
<polygon fill="black" stroke="black" points="1405.97,-74.5 1415.97,-71 1405.97,-67.5 1405.97,-74.5"/>
</g>
<!-- PdServer -->
<g id="node18" class="node">
<title>PdServer</title>
<polygon fill="#f38181" stroke="black" points="1769.5,-53 1769.5,-89 1835.5,-89 1835.5,-53 1769.5,-53"/>
<text text-anchor="middle" x="1802.5" y="-67.3" font-family="Times,serif" font-size="14.00">PdServer</text>
</g>
<!-- PdClient&#45;&gt;PdServer -->
<g id="edge19" class="edge">
<title>PdClient&#45;&gt;PdServer</title>
<path fill="none" stroke="black" d="M1598.05,-71C1651.65,-71 1717.16,-71 1759.11,-71"/>
<polygon fill="black" stroke="black" points="1759.24,-74.5 1769.24,-71 1759.24,-67.5 1759.24,-74.5"/>
</g>
</g>
</svg>
