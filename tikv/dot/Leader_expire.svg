<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.1 (20210417.1919)
 -->
<!-- Title: lease_expire Pages: 1 -->
<svg width="962pt" height="461pt"
 viewBox="0.00 0.00 962.00 461.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 457)">
<title>lease_expire</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-457 958,-457 958,4 -4,4"/>
<!-- Lease__expire -->
<g id="node1" class="node">
<title>Lease__expire</title>
<path fill="none" stroke="#1c2123" d="M631,-270C631,-270 773,-270 773,-270 779,-270 785,-276 785,-282 785,-282 785,-334 785,-334 785,-340 779,-346 773,-346 773,-346 631,-346 631,-346 625,-346 619,-340 619,-334 619,-334 619,-282 619,-282 619,-276 625,-270 631,-270"/>
<text text-anchor="start" x="627" y="-330.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">Lease</text>
<text text-anchor="start" x="627" y="-315.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> expire</text>
<polyline fill="none" stroke="#1c2123" points="619,-308 785,-308 "/>
<text text-anchor="start" x="627" y="-292.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">将bound设置为None</text>
<text text-anchor="start" x="627" y="-277.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 将RemoteLease也清理掉</text>
</g>
<!-- Lease__expire_remote_lease -->
<g id="node2" class="node">
<title>Lease__expire_remote_lease</title>
<path fill="none" stroke="#1c2123" d="M833,-277.5C833,-277.5 942,-277.5 942,-277.5 948,-277.5 954,-283.5 954,-289.5 954,-289.5 954,-326.5 954,-326.5 954,-332.5 948,-338.5 942,-338.5 942,-338.5 833,-338.5 833,-338.5 827,-338.5 821,-332.5 821,-326.5 821,-326.5 821,-289.5 821,-289.5 821,-283.5 827,-277.5 833,-277.5"/>
<text text-anchor="start" x="829" y="-323.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Lease</text>
<text text-anchor="start" x="829" y="-308.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> expire_remote_lease</text>
<polyline fill="none" stroke="#1c2123" points="821,-300.5 954,-300.5 "/>
<text text-anchor="start" x="829" y="-285.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">清理掉remote lease</text>
</g>
<!-- Lease__expire&#45;&gt;Lease__expire_remote_lease -->
<g id="edge1" class="edge">
<title>Lease__expire&#45;&gt;Lease__expire_remote_lease</title>
<path fill="none" stroke="#666666" d="M785.09,-308C793.64,-308 802.3,-308 810.77,-308"/>
<polygon fill="#666666" stroke="#666666" points="810.99,-311.5 820.99,-308 810.99,-304.5 810.99,-311.5"/>
</g>
<!-- Peer__on_role_changed -->
<g id="node3" class="node">
<title>Peer__on_role_changed</title>
<path fill="none" stroke="#1c2123" d="M476,-351.5C476,-351.5 565,-351.5 565,-351.5 571,-351.5 577,-357.5 577,-363.5 577,-363.5 577,-400.5 577,-400.5 577,-406.5 571,-412.5 565,-412.5 565,-412.5 476,-412.5 476,-412.5 470,-412.5 464,-406.5 464,-400.5 464,-400.5 464,-363.5 464,-363.5 464,-357.5 470,-351.5 476,-351.5"/>
<text text-anchor="start" x="472" y="-397.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Peer</text>
<text text-anchor="start" x="472" y="-382.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> on_role_changed</text>
<polyline fill="none" stroke="#1c2123" points="464,-374.5 577,-374.5 "/>
<text text-anchor="start" x="472" y="-359.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">变为了follower</text>
</g>
<!-- Peer__on_role_changed&#45;&gt;Lease__expire -->
<g id="edge2" class="edge">
<title>Peer__on_role_changed&#45;&gt;Lease__expire</title>
<path fill="none" stroke="#666666" d="M577.31,-358.99C587.6,-354.75 598.59,-350.22 609.61,-345.67"/>
<polygon fill="#666666" stroke="#666666" points="610.96,-348.91 618.87,-341.86 608.29,-342.44 610.96,-348.91"/>
</g>
<!-- Peer__inspect_lease -->
<g id="node4" class="node">
<title>Peer__inspect_lease</title>
<path fill="none" stroke="#1c2123" d="M470,-146.5C470,-146.5 571,-146.5 571,-146.5 577,-146.5 583,-152.5 583,-158.5 583,-158.5 583,-225.5 583,-225.5 583,-231.5 577,-237.5 571,-237.5 571,-237.5 470,-237.5 470,-237.5 464,-237.5 458,-231.5 458,-225.5 458,-225.5 458,-158.5 458,-158.5 458,-152.5 464,-146.5 470,-146.5"/>
<text text-anchor="start" x="466" y="-222.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Peer</text>
<text text-anchor="start" x="466" y="-207.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> inspect_lease</text>
<polyline fill="none" stroke="#1c2123" points="458,-199.5 583,-199.5 "/>
<text text-anchor="start" x="466" y="-184.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">当lease返回的state</text>
<text text-anchor="start" x="466" y="-169.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 为Expired时</text>
<text text-anchor="start" x="466" y="-154.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 调用lease.expire</text>
</g>
<!-- Peer__inspect_lease&#45;&gt;Lease__expire -->
<g id="edge3" class="edge">
<title>Peer__inspect_lease&#45;&gt;Lease__expire</title>
<path fill="none" stroke="#666666" d="M583.02,-231.76C599.27,-242.26 616.89,-253.65 633.44,-264.34"/>
<polygon fill="#666666" stroke="#666666" points="631.68,-267.37 641.98,-269.86 635.48,-261.49 631.68,-267.37"/>
</g>
<!-- Lease__inspect -->
<g id="node5" class="node">
<title>Lease__inspect</title>
<path fill="none" stroke="#1c2123" d="M686.5,-169C686.5,-169 717.5,-169 717.5,-169 723.5,-169 729.5,-175 729.5,-181 729.5,-181 729.5,-203 729.5,-203 729.5,-209 723.5,-215 717.5,-215 717.5,-215 686.5,-215 686.5,-215 680.5,-215 674.5,-209 674.5,-203 674.5,-203 674.5,-181 674.5,-181 674.5,-175 680.5,-169 686.5,-169"/>
<text text-anchor="start" x="682.5" y="-199.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">Lease</text>
<polyline fill="none" stroke="#1c2123" points="674.5,-192 729.5,-192 "/>
<text text-anchor="start" x="682.5" y="-176.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">inspect</text>
</g>
<!-- Peer__inspect_lease&#45;&gt;Lease__inspect -->
<g id="edge4" class="edge">
<title>Peer__inspect_lease&#45;&gt;Lease__inspect</title>
<path fill="none" stroke="#666666" d="M583.02,-192C609.95,-192 640.66,-192 663.99,-192"/>
<polygon fill="#666666" stroke="#666666" points="664.16,-195.5 674.16,-192 664.16,-188.5 664.16,-195.5"/>
</g>
<!-- Peer__read_index -->
<g id="node6" class="node">
<title>Peer__read_index</title>
<path fill="none" stroke="#1c2123" d="M208,-236C208,-236 396,-236 396,-236 402,-236 408,-242 408,-248 408,-248 408,-330 408,-330 408,-336 402,-342 396,-342 396,-342 208,-342 208,-342 202,-342 196,-336 196,-330 196,-330 196,-248 196,-248 196,-242 202,-236 208,-236"/>
<text text-anchor="start" x="204" y="-326.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">Peer</text>
<text text-anchor="start" x="204" y="-311.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> read_index</text>
<polyline fill="none" stroke="#1c2123" points="196,-304 408,-304 "/>
<text text-anchor="start" x="204" y="-288.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">对于Valid和Expired的</text>
<text text-anchor="start" x="204" y="-273.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> LeaseState做了特殊处理</text>
<text text-anchor="start" x="204" y="-258.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 使用pending_reads 最后一个read</text>
<text text-anchor="start" x="204" y="-243.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 的renew_lease_time</text>
</g>
<!-- Peer__read_index&#45;&gt;Peer__inspect_lease -->
<g id="edge5" class="edge">
<title>Peer__read_index&#45;&gt;Peer__inspect_lease</title>
<path fill="none" stroke="#666666" d="M408.08,-241.92C421.78,-235.78 435.54,-229.62 448.5,-223.81"/>
<polygon fill="#666666" stroke="#666666" points="450.08,-226.94 457.77,-219.66 447.22,-220.55 450.08,-226.94"/>
</g>
<!-- ReadIndexRequest__renew_lease_time -->
<g id="node11" class="node">
<title>ReadIndexRequest__renew_lease_time</title>
<path fill="#feed9b" stroke="#f7e495" d="M473,-270C473,-270 568,-270 568,-270 574,-270 580,-276 580,-282 580,-282 580,-296 580,-296 580,-302 574,-308 568,-308 568,-308 473,-308 473,-308 467,-308 461,-302 461,-296 461,-296 461,-282 461,-282 461,-276 467,-270 473,-270"/>
<text text-anchor="start" x="469" y="-292.8" font-family="Times,serif" font-size="14.00" fill="#40575d">ReadIndexRequest</text>
<text text-anchor="start" x="469" y="-277.8" font-family="Times,serif" font-size="14.00" fill="#40575d"> renew_lease_time</text>
</g>
<!-- Peer__read_index&#45;&gt;ReadIndexRequest__renew_lease_time -->
<g id="edge10" class="edge">
<title>Peer__read_index&#45;&gt;ReadIndexRequest__renew_lease_time</title>
<path fill="none" stroke="#666666" d="M408.08,-289C422.59,-289 437.17,-289 450.79,-289"/>
<polygon fill="#666666" stroke="#666666" points="451,-292.5 461,-289 451,-285.5 451,-292.5"/>
</g>
<!-- Peer__step__MsgReadIndex -->
<g id="node7" class="node">
<title>Peer__step__MsgReadIndex</title>
<path fill="none" stroke="#1c2123" d="M194,-0.5C194,-0.5 410,-0.5 410,-0.5 416,-0.5 422,-6.5 422,-12.5 422,-12.5 422,-109.5 422,-109.5 422,-115.5 416,-121.5 410,-121.5 410,-121.5 194,-121.5 194,-121.5 188,-121.5 182,-115.5 182,-109.5 182,-109.5 182,-12.5 182,-12.5 182,-6.5 188,-0.5 194,-0.5"/>
<text text-anchor="start" x="190" y="-106.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Peer</text>
<text text-anchor="start" x="190" y="-91.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> step</text>
<text text-anchor="start" x="190" y="-76.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> MsgReadIndex</text>
<polyline fill="none" stroke="#1c2123" points="182,-68.5 422,-68.5 "/>
<text text-anchor="start" x="190" y="-53.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">对于MsgReadIndex消息</text>
<text text-anchor="start" x="190" y="-38.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 如果当前leader在lease内</text>
<text text-anchor="start" x="190" y="-23.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 不用再调底层的raft_group.step了</text>
<text text-anchor="start" x="190" y="-8.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 直接返回了当前store的commit_index</text>
</g>
<!-- Peer__step__MsgReadIndex&#45;&gt;Peer__inspect_lease -->
<g id="edge6" class="edge">
<title>Peer__step__MsgReadIndex&#45;&gt;Peer__inspect_lease</title>
<path fill="none" stroke="#666666" d="M406.3,-121.53C411.62,-124.72 416.88,-127.89 422,-131 430.8,-136.34 440,-142 449.1,-147.63"/>
<polygon fill="#666666" stroke="#666666" points="447.42,-150.72 457.76,-153.02 451.12,-144.77 447.42,-150.72"/>
</g>
<!-- RequestInspector__inspect -->
<g id="node8" class="node">
<title>RequestInspector__inspect</title>
<path fill="none" stroke="#1c2123" d="M259,-141C259,-141 345,-141 345,-141 351,-141 357,-147 357,-153 357,-153 357,-205 357,-205 357,-211 351,-217 345,-217 345,-217 259,-217 259,-217 253,-217 247,-211 247,-205 247,-205 247,-153 247,-153 247,-147 253,-141 259,-141"/>
<text text-anchor="start" x="255" y="-201.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">RequestInspector</text>
<text text-anchor="start" x="255" y="-186.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> inspect</text>
<polyline fill="none" stroke="#1c2123" points="247,-179 357,-179 "/>
<text text-anchor="start" x="255" y="-163.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">inspect raft cmd</text>
<text text-anchor="start" x="255" y="-148.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 的处理policy</text>
</g>
<!-- RequestInspector__inspect&#45;&gt;Peer__inspect_lease -->
<g id="edge7" class="edge">
<title>RequestInspector__inspect&#45;&gt;Peer__inspect_lease</title>
<path fill="none" stroke="#666666" d="M357.07,-182.25C384.41,-183.89 417.96,-185.9 447.45,-187.67"/>
<polygon fill="#666666" stroke="#666666" points="447.51,-191.18 457.7,-188.29 447.93,-184.2 447.51,-191.18"/>
</g>
<!-- Peer__propose -->
<g id="node9" class="node">
<title>Peer__propose</title>
<path fill="none" stroke="#1c2123" d="M30,-196C30,-196 116,-196 116,-196 122,-196 128,-202 128,-208 128,-208 128,-260 128,-260 128,-266 122,-272 116,-272 116,-272 30,-272 30,-272 24,-272 18,-266 18,-260 18,-260 18,-208 18,-208 18,-202 24,-196 30,-196"/>
<text text-anchor="start" x="26" y="-256.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">Peer</text>
<text text-anchor="start" x="26" y="-241.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> propose</text>
<polyline fill="none" stroke="#1c2123" points="18,-234 128,-234 "/>
<text text-anchor="start" x="26" y="-218.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">propose raft cmd</text>
<text text-anchor="start" x="26" y="-203.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 到raft group</text>
</g>
<!-- Peer__propose&#45;&gt;Peer__read_index -->
<g id="edge11" class="edge">
<title>Peer__propose&#45;&gt;Peer__read_index</title>
<path fill="none" stroke="#666666" d="M128.08,-247.1C145.55,-251.34 165.63,-256.2 185.79,-261.09"/>
<polygon fill="#666666" stroke="#666666" points="185.13,-264.53 195.68,-263.48 186.78,-257.72 185.13,-264.53"/>
</g>
<!-- Peer__propose&#45;&gt;RequestInspector__inspect -->
<g id="edge8" class="edge">
<title>Peer__propose&#45;&gt;RequestInspector__inspect</title>
<path fill="none" stroke="#666666" d="M128.08,-220.9C160.79,-212.97 202.66,-202.83 237,-194.51"/>
<polygon fill="#666666" stroke="#666666" points="238.04,-197.86 246.94,-192.1 236.39,-191.05 238.04,-197.86"/>
</g>
<!-- Peer__handle_raft_ready_append -->
<g id="node10" class="node">
<title>Peer__handle_raft_ready_append</title>
<path fill="none" stroke="#1c2123" d="M232,-361.5C232,-361.5 372,-361.5 372,-361.5 378,-361.5 384,-367.5 384,-373.5 384,-373.5 384,-440.5 384,-440.5 384,-446.5 378,-452.5 372,-452.5 372,-452.5 232,-452.5 232,-452.5 226,-452.5 220,-446.5 220,-440.5 220,-440.5 220,-373.5 220,-373.5 220,-367.5 226,-361.5 232,-361.5"/>
<text text-anchor="start" x="228" y="-437.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Peer</text>
<text text-anchor="start" x="228" y="-422.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> handle_raft_ready_append</text>
<polyline fill="none" stroke="#1c2123" points="220,-414.5 384,-414.5 "/>
<text text-anchor="start" x="228" y="-399.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">调用Raft ready</text>
<text text-anchor="start" x="228" y="-384.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 如果ready.ss不为none</text>
<text text-anchor="start" x="228" y="-369.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 自己的角色发生了改变</text>
</g>
<!-- Peer__handle_raft_ready_append&#45;&gt;Peer__on_role_changed -->
<g id="edge9" class="edge">
<title>Peer__handle_raft_ready_append&#45;&gt;Peer__on_role_changed</title>
<path fill="none" stroke="#666666" d="M384.23,-397.62C407.12,-394.98 431.74,-392.13 453.61,-389.61"/>
<polygon fill="#666666" stroke="#666666" points="454.25,-393.06 463.78,-388.43 453.44,-386.1 454.25,-393.06"/>
</g>
<!-- Peer__on_raft_message -->
<g id="node12" class="node">
<title>Peer__on_raft_message</title>
<path fill="none" stroke="#1c2123" d="M134,-79C134,-79 12,-79 12,-79 6,-79 0,-73 0,-67 0,-67 0,-55 0,-55 0,-49 6,-43 12,-43 12,-43 134,-43 134,-43 140,-43 146,-49 146,-55 146,-55 146,-67 146,-67 146,-73 140,-79 134,-79"/>
<text text-anchor="middle" x="73" y="-57.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Peer__on_raft_message</text>
</g>
<!-- Peer__on_raft_message&#45;&gt;Peer__step__MsgReadIndex -->
<g id="edge12" class="edge">
<title>Peer__on_raft_message&#45;&gt;Peer__step__MsgReadIndex</title>
<path fill="none" stroke="#666666" d="M146.14,-61C154.35,-61 162.89,-61 171.57,-61"/>
<polygon fill="#666666" stroke="#666666" points="171.79,-64.5 181.79,-61 171.79,-57.5 171.79,-64.5"/>
</g>
</g>
</svg>
