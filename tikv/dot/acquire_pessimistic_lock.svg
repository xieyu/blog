<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.1 (20210417.1919)
 -->
<!-- Title: tikv_acquire_pessimistic_lock Pages: 1 -->
<svg width="1366pt" height="1008pt"
 viewBox="0.00 0.00 1366.00 1008.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 1004)">
<title>tikv_acquire_pessimistic_lock</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-1004 1362,-1004 1362,4 -4,4"/>
<g id="clust3" class="cluster">
<title>cluster_checklock</title>
<path fill="none" stroke="slategrey" stroke-dasharray="5,2" d="M688,-613C688,-613 1139,-613 1139,-613 1145,-613 1151,-619 1151,-625 1151,-625 1151,-980 1151,-980 1151,-986 1145,-992 1139,-992 1139,-992 688,-992 688,-992 682,-992 676,-986 676,-980 676,-980 676,-625 676,-625 676,-619 682,-613 688,-613"/>
<text text-anchor="middle" x="913.5" y="-972" font-family="Times,serif" font-size="20.00">有lock，检查lock</text>
</g>
<g id="clust5" class="cluster">
<title>cluster_check_write</title>
<path fill="none" stroke="slategrey" stroke-dasharray="5,2" d="M689,-8C689,-8 1161,-8 1161,-8 1167,-8 1173,-14 1173,-20 1173,-20 1173,-497 1173,-497 1173,-503 1167,-509 1161,-509 1161,-509 689,-509 689,-509 683,-509 677,-503 677,-497 677,-497 677,-20 677,-20 677,-14 683,-8 689,-8"/>
<text text-anchor="start" x="854" y="-489" font-family="Times,serif" font-size="20.00">检查是否有更新</text>
<text text-anchor="middle" x="925" y="-467" font-family="Times,serif" font-size="20.00"> 的写入版本</text>
</g>
<!-- AcquirePessimisticLock -->
<g id="node1" class="node">
<title>AcquirePessimisticLock</title>
<path fill="none" stroke="#1c2123" d="M12,-414C12,-414 215,-414 215,-414 221,-414 227,-420 227,-426 227,-426 227,-632 227,-632 227,-638 221,-644 215,-644 215,-644 12,-644 12,-644 6,-644 0,-638 0,-632 0,-632 0,-426 0,-426 0,-420 6,-414 12,-414"/>
<text text-anchor="middle" x="113.5" y="-628.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">AcquirePessimisticLock</text>
<polyline fill="none" stroke="#1c2123" points="0,-621 227,-621 "/>
<text text-anchor="start" x="8" y="-605.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">keys: Vec&lt;(Key, bool)&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="0,-598 227,-598 "/>
<text text-anchor="start" x="8" y="-582.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">primary: Vec&lt;u8&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="0,-575 227,-575 "/>
<text text-anchor="start" x="8" y="-559.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">start_ts: TimeStamp,</text>
<polyline fill="none" stroke="#1c2123" points="0,-552 227,-552 "/>
<text text-anchor="start" x="8" y="-536.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">lock_ttl: u64,</text>
<polyline fill="none" stroke="#1c2123" points="0,-529 227,-529 "/>
<text text-anchor="start" x="8" y="-513.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">is_first_lock: bool,</text>
<polyline fill="none" stroke="#1c2123" points="0,-506 227,-506 "/>
<text text-anchor="start" x="8" y="-490.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">for_update_ts: TimeStamp,</text>
<polyline fill="none" stroke="#1c2123" points="0,-483 227,-483 "/>
<text text-anchor="start" x="8" y="-467.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">wait_timeout: Option&lt;WaitTimeout&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="0,-460 227,-460 "/>
<text text-anchor="start" x="8" y="-444.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">return_values: bool,</text>
<polyline fill="none" stroke="#1c2123" points="0,-437 227,-437 "/>
<text text-anchor="start" x="8" y="-421.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">min_commit_ts: TimeStamp,</text>
</g>
<!-- process_write -->
<g id="node2" class="node">
<title>process_write</title>
<path fill="none" stroke="#1c2123" d="M275,-491C275,-491 409,-491 409,-491 415,-491 421,-497 421,-503 421,-503 421,-555 421,-555 421,-561 415,-567 409,-567 409,-567 275,-567 275,-567 269,-567 263,-561 263,-555 263,-555 263,-503 263,-503 263,-497 269,-491 275,-491"/>
<text text-anchor="middle" x="342" y="-551.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">process_write</text>
<polyline fill="none" stroke="#1c2123" points="263,-544 421,-544 "/>
<text text-anchor="start" x="271" y="-528.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">遍历所有的keys</text>
<text text-anchor="start" x="271" y="-513.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 对于每一个key调用</text>
<text text-anchor="start" x="271" y="-498.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> acquire_pessimistic_lock</text>
</g>
<!-- AcquirePessimisticLock&#45;&gt;process_write -->
<g id="edge1" class="edge">
<title>AcquirePessimisticLock&#45;&gt;process_write</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M227.09,-529C235.69,-529 244.3,-529 252.71,-529"/>
<polygon fill="green" stroke="green" points="252.87,-532.5 262.87,-529 252.87,-525.5 252.87,-532.5"/>
</g>
<!-- acquire_pessimistic_lock -->
<g id="node3" class="node">
<title>acquire_pessimistic_lock</title>
<path fill="none" stroke="#1c2123" d="M615,-585C615,-585 485,-585 485,-585 479,-585 473,-579 473,-573 473,-573 473,-561 473,-561 473,-555 479,-549 485,-549 485,-549 615,-549 615,-549 621,-549 627,-555 627,-561 627,-561 627,-573 627,-573 627,-579 621,-585 615,-585"/>
<text text-anchor="middle" x="550" y="-563.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">acquire_pessimistic_lock</text>
</g>
<!-- process_write&#45;&gt;acquire_pessimistic_lock -->
<g id="edge2" class="edge">
<title>process_write&#45;&gt;acquire_pessimistic_lock</title>
<path fill="none" stroke="#666666" d="M421.17,-543.42C434.82,-545.94 449.09,-548.57 462.93,-551.12"/>
<polygon fill="#666666" stroke="#666666" points="462.45,-554.59 472.92,-552.97 463.72,-547.71 462.45,-554.59"/>
</g>
<!-- update_max_ts -->
<g id="node4" class="node">
<title>update_max_ts</title>
<path fill="none" stroke="#1c2123" d="M469,-454C469,-454 631,-454 631,-454 637,-454 643,-460 643,-466 643,-466 643,-518 643,-518 643,-524 637,-530 631,-530 631,-530 469,-530 469,-530 463,-530 457,-524 457,-518 457,-518 457,-466 457,-466 457,-460 463,-454 469,-454"/>
<text text-anchor="middle" x="550" y="-514.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">update_max_ts</text>
<polyline fill="none" stroke="#1c2123" points="457,-507 643,-507 "/>
<text text-anchor="start" x="465" y="-491.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">使用for_update_ts更新</text>
<text text-anchor="start" x="465" y="-476.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> ConcurrencyManager::max_ts</text>
<text text-anchor="middle" x="550" y="-461.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 这个max_ts的作用是啥？</text>
</g>
<!-- process_write&#45;&gt;update_max_ts -->
<g id="edge3" class="edge">
<title>process_write&#45;&gt;update_max_ts</title>
<path fill="none" stroke="#666666" d="M421.17,-514.96C429.52,-513.46 438.09,-511.92 446.66,-510.38"/>
<polygon fill="#666666" stroke="#666666" points="447.48,-513.79 456.71,-508.58 446.24,-506.9 447.48,-513.79"/>
</g>
<!-- reader_load_lock -->
<g id="node5" class="node">
<title>reader_load_lock</title>
<path fill="none" stroke="#1c2123" d="M696,-728.5C696,-728.5 826,-728.5 826,-728.5 832,-728.5 838,-734.5 838,-740.5 838,-740.5 838,-807.5 838,-807.5 838,-813.5 832,-819.5 826,-819.5 826,-819.5 696,-819.5 696,-819.5 690,-819.5 684,-813.5 684,-807.5 684,-807.5 684,-740.5 684,-740.5 684,-734.5 690,-728.5 696,-728.5"/>
<text text-anchor="middle" x="761" y="-804.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">MvccReader::load_lock</text>
<polyline fill="none" stroke="#1c2123" points="684,-796.5 838,-796.5 "/>
<text text-anchor="start" x="692" y="-781.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">读取lock</text>
<text text-anchor="start" x="692" y="-766.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 然后检查lock的start_ts</text>
<text text-anchor="start" x="692" y="-751.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> lock_type</text>
<text text-anchor="start" x="692" y="-736.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> for_update_ts</text>
</g>
<!-- acquire_pessimistic_lock&#45;&gt;reader_load_lock -->
<g id="edge4" class="edge">
<title>acquire_pessimistic_lock&#45;&gt;reader_load_lock</title>
<path fill="none" stroke="#666666" d="M569.18,-585.01C599.47,-615.01 661.4,-676.34 706.51,-721.02"/>
<polygon fill="#666666" stroke="#666666" points="704.31,-723.77 713.88,-728.32 709.24,-718.8 704.31,-723.77"/>
</g>
<!-- put_lock_update -->
<g id="node6" class="node">
<title>put_lock_update</title>
<path fill="none" stroke="#1c2123" d="M1213,-710C1213,-710 1346,-710 1346,-710 1352,-710 1358,-716 1358,-722 1358,-722 1358,-744 1358,-744 1358,-750 1352,-756 1346,-756 1346,-756 1213,-756 1213,-756 1207,-756 1201,-750 1201,-744 1201,-744 1201,-722 1201,-722 1201,-716 1207,-710 1213,-710"/>
<text text-anchor="middle" x="1279.5" y="-740.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">put_lock</text>
<polyline fill="none" stroke="#1c2123" points="1201,-733 1358,-733 "/>
<text text-anchor="start" x="1209" y="-717.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">更新lock的for_update_ts</text>
</g>
<!-- acquire_pessimistic_lock&#45;&gt;put_lock_update -->
<g id="edge5" class="edge">
<title>acquire_pessimistic_lock&#45;&gt;put_lock_update</title>
<path fill="none" stroke="#666666" d="M627.06,-571.37C790.4,-580.84 1160.96,-602.93 1173,-609 1212.81,-629.05 1243.6,-671.45 1261.38,-701.05"/>
<polygon fill="#666666" stroke="#666666" points="1258.42,-702.92 1266.48,-709.79 1264.47,-699.39 1258.42,-702.92"/>
</g>
<!-- put_lock_new -->
<g id="node7" class="node">
<title>put_lock_new</title>
<path fill="none" stroke="#1c2123" d="M691,-518C691,-518 831,-518 831,-518 837,-518 843,-524 843,-530 843,-530 843,-552 843,-552 843,-558 837,-564 831,-564 831,-564 691,-564 691,-564 685,-564 679,-558 679,-552 679,-552 679,-530 679,-530 679,-524 685,-518 691,-518"/>
<text text-anchor="middle" x="761" y="-548.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">put_lock</text>
<polyline fill="none" stroke="#1c2123" points="679,-541 843,-541 "/>
<text text-anchor="middle" x="761" y="-525.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">当前请求key加上悲观锁</text>
</g>
<!-- acquire_pessimistic_lock&#45;&gt;put_lock_new -->
<g id="edge6" class="edge">
<title>acquire_pessimistic_lock&#45;&gt;put_lock_new</title>
<path fill="none" stroke="#666666" d="M627.05,-557.54C640.57,-555.86 654.78,-554.09 668.68,-552.36"/>
<polygon fill="#666666" stroke="#666666" points="669.24,-555.82 678.73,-551.11 668.37,-548.87 669.24,-555.82"/>
</g>
<!-- seek_write -->
<g id="node8" class="node">
<title>seek_write</title>
<path fill="none" stroke="#1c2123" d="M697,-261C697,-261 825,-261 825,-261 831,-261 837,-267 837,-273 837,-273 837,-295 837,-295 837,-301 831,-307 825,-307 825,-307 697,-307 697,-307 691,-307 685,-301 685,-295 685,-295 685,-273 685,-273 685,-267 691,-261 697,-261"/>
<text text-anchor="middle" x="761" y="-291.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">MvccReader::seek_write</text>
<polyline fill="none" stroke="#1c2123" points="685,-284 837,-284 "/>
<text text-anchor="start" x="693" y="-268.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">读取commit记录</text>
</g>
<!-- acquire_pessimistic_lock&#45;&gt;seek_write -->
<g id="edge7" class="edge">
<title>acquire_pessimistic_lock&#45;&gt;seek_write</title>
<path fill="none" stroke="#666666" d="M627.12,-550.62C632.83,-547.65 638.22,-544.14 643,-540 711.88,-480.34 742.49,-371.76 754.04,-317.18"/>
<polygon fill="#666666" stroke="#666666" points="757.48,-317.83 756.04,-307.33 750.62,-316.44 757.48,-317.83"/>
</g>
<!-- ErrorInner_KeyIsLocked -->
<g id="node9" class="node">
<title>ErrorInner_KeyIsLocked</title>
<path fill="none" stroke="#1c2123" d="M948,-622C948,-622 1096,-622 1096,-622 1102,-622 1108,-628 1108,-634 1108,-634 1108,-686 1108,-686 1108,-692 1102,-698 1096,-698 1096,-698 948,-698 948,-698 942,-698 936,-692 936,-686 936,-686 936,-634 936,-634 936,-628 942,-622 948,-622"/>
<text text-anchor="middle" x="1022" y="-682.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">1.ErrorInner::KeyIsLocked</text>
<polyline fill="none" stroke="#1c2123" points="936,-675 1108,-675 "/>
<text text-anchor="start" x="944" y="-659.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">lock.ts != reader.start_ts</text>
<text text-anchor="start" x="944" y="-644.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 不是当前同一事务的lock</text>
<text text-anchor="start" x="944" y="-629.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 返回KeyIsLocked Error</text>
</g>
<!-- reader_load_lock&#45;&gt;ErrorInner_KeyIsLocked -->
<g id="edge8" class="edge">
<title>reader_load_lock&#45;&gt;ErrorInner_KeyIsLocked</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M838.04,-728.41C851.46,-721.14 865.48,-714.04 879,-708 893.96,-701.32 910.14,-695.03 926.05,-689.33"/>
<polygon fill="green" stroke="green" points="927.63,-692.49 935.9,-685.87 925.31,-685.88 927.63,-692.49"/>
</g>
<!-- ErrorInner_LockTypeNotMatch -->
<g id="node10" class="node">
<title>ErrorInner_LockTypeNotMatch</title>
<path fill="none" stroke="#1c2123" d="M913,-717C913,-717 1131,-717 1131,-717 1137,-717 1143,-723 1143,-729 1143,-729 1143,-819 1143,-819 1143,-825 1137,-831 1131,-831 1131,-831 913,-831 913,-831 907,-831 901,-825 901,-819 901,-819 901,-729 901,-729 901,-723 907,-717 913,-717"/>
<text text-anchor="middle" x="1022" y="-815.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">2. ErrorInner::LockTypeNotMatch</text>
<polyline fill="none" stroke="#1c2123" points="901,-808 1143,-808 "/>
<text text-anchor="start" x="909" y="-792.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">lock.lock_type != LockType::Pessimistic</text>
<text text-anchor="start" x="909" y="-777.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 锁的类型不是悲观锁</text>
<text text-anchor="start" x="909" y="-762.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 返回锁类型不匹配</text>
<polyline fill="none" stroke="#1c2123" points="901,-755 1143,-755 "/>
<text text-anchor="start" x="909" y="-739.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">意味该请求已超时</text>
<text text-anchor="start" x="909" y="-724.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 什么情况会这种情况?</text>
</g>
<!-- reader_load_lock&#45;&gt;ErrorInner_LockTypeNotMatch -->
<g id="edge9" class="edge">
<title>reader_load_lock&#45;&gt;ErrorInner_LockTypeNotMatch</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M838.31,-774C854.65,-774 872.36,-774 890.1,-774"/>
<polygon fill="green" stroke="green" points="890.54,-777.5 900.54,-774 890.54,-770.5 890.54,-777.5"/>
</g>
<!-- update_for_udpate_ts -->
<g id="node11" class="node">
<title>update_for_udpate_ts</title>
<path fill="none" stroke="#1c2123" d="M923,-850C923,-850 1121,-850 1121,-850 1127,-850 1133,-856 1133,-862 1133,-862 1133,-884 1133,-884 1133,-890 1127,-896 1121,-896 1121,-896 923,-896 923,-896 917,-896 911,-890 911,-884 911,-884 911,-862 911,-862 911,-856 917,-850 923,-850"/>
<text text-anchor="start" x="919" y="-880.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">3. for_update_ts &gt; lock.for_update_ts</text>
<polyline fill="none" stroke="#1c2123" points="911,-873 1133,-873 "/>
<text text-anchor="start" x="919" y="-857.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">更新lock的for_update_ts</text>
</g>
<!-- reader_load_lock&#45;&gt;update_for_udpate_ts -->
<g id="edge10" class="edge">
<title>reader_load_lock&#45;&gt;update_for_udpate_ts</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M833.99,-819.65C848.51,-827.58 863.95,-835.15 879,-841 886.12,-843.77 893.54,-846.33 901.09,-848.69"/>
<polygon fill="green" stroke="green" points="900.12,-852.06 910.71,-851.58 902.14,-845.35 900.12,-852.06"/>
</g>
<!-- other_case_dup_lock -->
<g id="node12" class="node">
<title>other_case_dup_lock</title>
<path fill="none" stroke="#1c2123" d="M956.5,-915C956.5,-915 1087.5,-915 1087.5,-915 1093.5,-915 1099.5,-921 1099.5,-927 1099.5,-927 1099.5,-941 1099.5,-941 1099.5,-947 1093.5,-953 1087.5,-953 1087.5,-953 956.5,-953 956.5,-953 950.5,-953 944.5,-947 944.5,-941 944.5,-941 944.5,-927 944.5,-927 944.5,-921 950.5,-915 956.5,-915"/>
<text text-anchor="start" x="952.5" y="-937.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">4.其他情况为重复请求</text>
<text text-anchor="start" x="952.5" y="-922.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 直接返回OK</text>
</g>
<!-- reader_load_lock&#45;&gt;other_case_dup_lock -->
<g id="edge11" class="edge">
<title>reader_load_lock&#45;&gt;other_case_dup_lock</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M790.74,-819.53C811.65,-848.81 842.59,-885.15 879,-906 895.8,-915.62 915.36,-921.99 934.49,-926.19"/>
<polygon fill="green" stroke="green" points="933.94,-929.65 944.43,-928.19 935.32,-922.79 933.94,-929.65"/>
</g>
<!-- ErrorInner_WriteConflict -->
<g id="node13" class="node">
<title>ErrorInner_WriteConflict</title>
<path fill="none" stroke="#1c2123" d="M935,-17C935,-17 1109,-17 1109,-17 1115,-17 1121,-23 1121,-29 1121,-29 1121,-81 1121,-81 1121,-87 1115,-93 1109,-93 1109,-93 935,-93 935,-93 929,-93 923,-87 923,-81 923,-81 923,-29 923,-29 923,-23 929,-17 935,-17"/>
<text text-anchor="start" x="931" y="-77.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">1.commit_ts &gt; for_update_ts</text>
<text text-anchor="start" x="931" y="-62.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 已提交的commit_ts比当前的</text>
<text text-anchor="start" x="931" y="-47.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> for_update_ts 更新存在写冲突</text>
<polyline fill="none" stroke="#1c2123" points="923,-40 1121,-40 "/>
<text text-anchor="middle" x="1022" y="-24.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">返回ErrorInner::WriteConflict</text>
</g>
<!-- seek_write&#45;&gt;ErrorInner_WriteConflict -->
<g id="edge13" class="edge">
<title>seek_write&#45;&gt;ErrorInner_WriteConflict</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M770.82,-260.84C786.65,-222.31 823.49,-145.04 879,-102 889.38,-93.95 901.21,-87.24 913.51,-81.67"/>
<polygon fill="green" stroke="green" points="915.16,-84.77 922.98,-77.62 912.41,-78.33 915.16,-84.77"/>
</g>
<!-- ErrorInner_PessimisticLockRolledBack -->
<g id="node14" class="node">
<title>ErrorInner_PessimisticLockRolledBack</title>
<path fill="none" stroke="#1c2123" d="M902.5,-112C902.5,-112 1141.5,-112 1141.5,-112 1147.5,-112 1153.5,-118 1153.5,-124 1153.5,-124 1153.5,-184 1153.5,-184 1153.5,-190 1147.5,-196 1141.5,-196 1141.5,-196 902.5,-196 902.5,-196 896.5,-196 890.5,-190 890.5,-184 890.5,-184 890.5,-124 890.5,-124 890.5,-118 896.5,-112 902.5,-112"/>
<text text-anchor="start" x="898.5" y="-180.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">2. commit_ts == reader.start_ts</text>
<polyline fill="none" stroke="#1c2123" points="890.5,-173 1153.5,-173 "/>
<text text-anchor="start" x="898.5" y="-157.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">且数据是当前事务的Rollback记录</text>
<text text-anchor="start" x="898.5" y="-142.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 返回PessimisticLockRollbacked错误</text>
<polyline fill="none" stroke="#1c2123" points="890.5,-135 1153.5,-135 "/>
<text text-anchor="middle" x="1022" y="-119.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">返回ErrorInner::PessimisticLockRolledBack</text>
</g>
<!-- seek_write&#45;&gt;ErrorInner_PessimisticLockRolledBack -->
<g id="edge14" class="edge">
<title>seek_write&#45;&gt;ErrorInner_PessimisticLockRolledBack</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M792.55,-260.7C815.47,-243.97 848.09,-221.68 879,-206 882.82,-204.06 886.73,-202.16 890.7,-200.3"/>
<polygon fill="green" stroke="green" points="892.42,-203.36 900.07,-196.02 889.52,-196.99 892.42,-203.36"/>
</g>
<!-- ErrorInner_PessimisticLockRolledBack2 -->
<g id="node15" class="node">
<title>ErrorInner_PessimisticLockRolledBack2</title>
<path fill="none" stroke="#1c2123" d="M891,-215.5C891,-215.5 1153,-215.5 1153,-215.5 1159,-215.5 1165,-221.5 1165,-227.5 1165,-227.5 1165,-340.5 1165,-340.5 1165,-346.5 1159,-352.5 1153,-352.5 1153,-352.5 891,-352.5 891,-352.5 885,-352.5 879,-346.5 879,-340.5 879,-340.5 879,-227.5 879,-227.5 879,-221.5 885,-215.5 891,-215.5"/>
<text text-anchor="start" x="887" y="-337.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">3. commit_ts &gt; reader.start_ts</text>
<polyline fill="none" stroke="#1c2123" points="879,-329.5 1165,-329.5 "/>
<text text-anchor="start" x="887" y="-314.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">commit_ts 比当前事务的 start_ts 更新，</text>
<text text-anchor="start" x="887" y="-299.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 说明在当前事务 begin 后有其他事务提交过</text>
<text text-anchor="start" x="887" y="-284.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 检查历史版本，如果发现当前请求的事务</text>
<text text-anchor="start" x="887" y="-269.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 有没有被 Rollback 过，</text>
<polyline fill="none" stroke="#1c2123" points="879,-261.5 1165,-261.5 "/>
<text text-anchor="middle" x="1022" y="-246.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">返回ErrorInner::PessimisticLockRolledBack</text>
<polyline fill="none" stroke="#1c2123" points="879,-238.5 1165,-238.5 "/>
<text text-anchor="middle" x="1022" y="-223.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> </text>
</g>
<!-- seek_write&#45;&gt;ErrorInner_PessimisticLockRolledBack2 -->
<g id="edge15" class="edge">
<title>seek_write&#45;&gt;ErrorInner_PessimisticLockRolledBack2</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M837.26,-284C847.22,-284 857.7,-284 868.4,-284"/>
<polygon fill="green" stroke="green" points="868.72,-287.5 878.72,-284 868.72,-280.5 868.72,-287.5"/>
</g>
<!-- check_data_constraint -->
<g id="node16" class="node">
<title>check_data_constraint</title>
<path fill="none" stroke="#1c2123" d="M923,-372C923,-372 1121,-372 1121,-372 1127,-372 1133,-378 1133,-384 1133,-384 1133,-436 1133,-436 1133,-442 1127,-448 1121,-448 1121,-448 923,-448 923,-448 917,-448 911,-442 911,-436 911,-436 911,-384 911,-384 911,-378 917,-372 923,-372"/>
<text text-anchor="middle" x="1022" y="-432.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">check_data_constraint</text>
<polyline fill="none" stroke="#1c2123" points="911,-425 1133,-425 "/>
<text text-anchor="start" x="919" y="-409.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">Checks the existence of the key</text>
<text text-anchor="start" x="919" y="-394.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> according to `should_not_exist`</text>
<text text-anchor="start" x="919" y="-379.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> if not, return an `AlreadyExist` Error</text>
</g>
<!-- seek_write&#45;&gt;check_data_constraint -->
<g id="edge16" class="edge">
<title>seek_write&#45;&gt;check_data_constraint</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M791.95,-307.17C814.84,-324.06 847.67,-346.6 879,-362 886.22,-365.55 893.77,-368.94 901.46,-372.17"/>
<polygon fill="green" stroke="green" points="900.32,-375.48 910.91,-376.01 902.96,-369 900.32,-375.48"/>
</g>
<!-- update_for_udpate_ts&#45;&gt;put_lock_update -->
<g id="edge12" class="edge">
<title>update_for_udpate_ts&#45;&gt;put_lock_update</title>
<path fill="none" stroke="#666666" d="M1133.06,-857.4C1146.97,-853.17 1160.64,-847.81 1173,-841 1207.03,-822.25 1237.03,-789 1256.25,-764.33"/>
<polygon fill="#666666" stroke="#666666" points="1259.07,-766.4 1262.34,-756.33 1253.5,-762.16 1259.07,-766.4"/>
</g>
</g>
</svg>
