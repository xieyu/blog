<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.1 (20210417.1919)
 -->
<!-- Title: handleSingleBatch Pages: 1 -->
<svg width="1414pt" height="437pt"
 viewBox="0.00 0.00 1414.00 436.50" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 432.5)">
<title>handleSingleBatch</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-432.5 1410,-432.5 1410,4 -4,4"/>
<!-- ttlManager_run -->
<g id="node1" class="node">
<title>ttlManager_run</title>
<path fill="#a2dbfa" stroke="#8a8898" d="M521,-299C521,-299 749,-299 749,-299 755,-299 761,-305 761,-311 761,-311 761,-416 761,-416 761,-422 755,-428 749,-428 749,-428 521,-428 521,-428 515,-428 509,-422 509,-416 509,-416 509,-311 509,-311 509,-305 515,-299 521,-299"/>
<text text-anchor="middle" x="635" y="-412.8" font-family="Times,serif" font-size="14.00" fill="#5d6179">ttlManager</text>
<polyline fill="none" stroke="#8a8898" points="509,-405 761,-405 "/>
<text text-anchor="middle" x="635" y="-389.8" font-family="Times,serif" font-size="14.00" fill="#5d6179">run</text>
<polyline fill="none" stroke="#8a8898" points="509,-382 761,-382 "/>
<text text-anchor="start" x="517" y="-366.8" font-family="Times,serif" font-size="14.00" fill="#5d6179">prewrite成功</text>
<text text-anchor="start" x="517" y="-351.8" font-family="Times,serif" font-size="14.00" fill="#5d6179"> 如果batch.isPrimary</text>
<text text-anchor="start" x="517" y="-336.8" font-family="Times,serif" font-size="14.00" fill="#5d6179"> 且txn size &gt; 32M(TTLRefreshedTxnSize)</text>
<text text-anchor="start" x="517" y="-321.8" font-family="Times,serif" font-size="14.00" fill="#5d6179"> 则调用ttlManager.run</text>
<text text-anchor="start" x="517" y="-306.8" font-family="Times,serif" font-size="14.00" fill="#5d6179"> 定期发送TxnHeartBea心跳</text>
</g>
<!-- ttlManager_keepAlive -->
<g id="node2" class="node">
<title>ttlManager_keepAlive</title>
<path fill="none" stroke="#1c2123" d="M816,-321.5C816,-321.5 951,-321.5 951,-321.5 957,-321.5 963,-327.5 963,-333.5 963,-333.5 963,-393.5 963,-393.5 963,-399.5 957,-405.5 951,-405.5 951,-405.5 816,-405.5 816,-405.5 810,-405.5 804,-399.5 804,-393.5 804,-393.5 804,-333.5 804,-333.5 804,-327.5 810,-321.5 816,-321.5"/>
<text text-anchor="middle" x="883.5" y="-390.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">ttlManager</text>
<polyline fill="none" stroke="#1c2123" points="804,-382.5 963,-382.5 "/>
<text text-anchor="middle" x="883.5" y="-367.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">keepAlive</text>
<polyline fill="none" stroke="#1c2123" points="804,-359.5 963,-359.5 "/>
<text text-anchor="start" x="812" y="-344.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">每隔ManagedLockTTL/2</text>
<text text-anchor="start" x="812" y="-329.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 发送一次TxnHeartBeat</text>
</g>
<!-- ttlManager_run&#45;&gt;ttlManager_keepAlive -->
<g id="edge1" class="edge">
<title>ttlManager_run&#45;&gt;ttlManager_keepAlive</title>
<path fill="none" stroke="#666666" d="M761.06,-363.5C772.07,-363.5 783.07,-363.5 793.7,-363.5"/>
<polygon fill="#666666" stroke="#666666" points="793.76,-367 803.76,-363.5 793.76,-360 793.76,-367"/>
</g>
<!-- sendTxnHeartBeat -->
<g id="node3" class="node">
<title>sendTxnHeartBeat</title>
<path fill="none" stroke="#1c2123" d="M1018,-333C1018,-333 1221,-333 1221,-333 1227,-333 1233,-339 1233,-345 1233,-345 1233,-382 1233,-382 1233,-388 1227,-394 1221,-394 1221,-394 1018,-394 1018,-394 1012,-394 1006,-388 1006,-382 1006,-382 1006,-345 1006,-345 1006,-339 1012,-333 1018,-333"/>
<text text-anchor="middle" x="1119.5" y="-378.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">sendTxnHeartBeat</text>
<polyline fill="none" stroke="#1c2123" points="1006,-371 1233,-371 "/>
<text text-anchor="start" x="1014" y="-355.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">更新lock的ttl时间</text>
<text text-anchor="start" x="1014" y="-340.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> newttl = uptime + ManagedLockTTL</text>
</g>
<!-- ttlManager_keepAlive&#45;&gt;sendTxnHeartBeat -->
<g id="edge2" class="edge">
<title>ttlManager_keepAlive&#45;&gt;sendTxnHeartBeat</title>
<path fill="none" stroke="#666666" d="M963.07,-363.5C973.54,-363.5 984.47,-363.5 995.48,-363.5"/>
<polygon fill="#666666" stroke="#666666" points="995.59,-367 1005.59,-363.5 995.59,-360 995.59,-367"/>
</g>
<!-- CmdTxnHeartBeat -->
<g id="node4" class="node">
<title>CmdTxnHeartBeat</title>
<path fill="none" stroke="#1c2123" d="M1281,-340.5C1281,-340.5 1394,-340.5 1394,-340.5 1400,-340.5 1406,-346.5 1406,-352.5 1406,-352.5 1406,-374.5 1406,-374.5 1406,-380.5 1400,-386.5 1394,-386.5 1394,-386.5 1281,-386.5 1281,-386.5 1275,-386.5 1269,-380.5 1269,-374.5 1269,-374.5 1269,-352.5 1269,-352.5 1269,-346.5 1275,-340.5 1281,-340.5"/>
<text text-anchor="middle" x="1337.5" y="-371.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">CmdTxnHeartBeat</text>
<polyline fill="none" stroke="#1c2123" points="1269,-363.5 1406,-363.5 "/>
<text text-anchor="start" x="1277" y="-348.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">更新primay lock的ttl</text>
</g>
<!-- sendTxnHeartBeat&#45;&gt;CmdTxnHeartBeat -->
<g id="edge3" class="edge">
<title>sendTxnHeartBeat&#45;&gt;CmdTxnHeartBeat</title>
<path fill="none" stroke="#666666" d="M1233.24,-363.5C1241.9,-363.5 1250.51,-363.5 1258.86,-363.5"/>
<polygon fill="#666666" stroke="#666666" points="1258.9,-367 1268.9,-363.5 1258.9,-360 1258.9,-367"/>
</g>
<!-- handleSingleBatch -->
<g id="node5" class="node">
<title>handleSingleBatch</title>
<path fill="none" stroke="#1c2123" d="M12,-244.5C12,-244.5 107,-244.5 107,-244.5 113,-244.5 119,-250.5 119,-256.5 119,-256.5 119,-278.5 119,-278.5 119,-284.5 113,-290.5 107,-290.5 107,-290.5 12,-290.5 12,-290.5 6,-290.5 0,-284.5 0,-278.5 0,-278.5 0,-256.5 0,-256.5 0,-250.5 6,-244.5 12,-244.5"/>
<text text-anchor="middle" x="59.5" y="-275.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">actionPrewrite</text>
<polyline fill="none" stroke="#1c2123" points="0,-267.5 119,-267.5 "/>
<text text-anchor="start" x="8" y="-252.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">handleSingleBatch</text>
</g>
<!-- handleSingleBatch&#45;&gt;ttlManager_run -->
<g id="edge6" class="edge">
<title>handleSingleBatch&#45;&gt;ttlManager_run</title>
<path fill="none" stroke="#666666" d="M119.2,-285.44C130.99,-288.71 143.34,-291.91 155,-294.5 269.76,-320.03 402.17,-338.26 498.65,-349.55"/>
<polygon fill="#666666" stroke="#666666" points="498.42,-353.05 508.75,-350.72 499.22,-346.09 498.42,-353.05"/>
</g>
<!-- buildPrewriteRequest -->
<g id="node6" class="node">
<title>buildPrewriteRequest</title>
<path fill="none" stroke="#1c2123" d="M167,-114C167,-114 306,-114 306,-114 312,-114 318,-120 318,-126 318,-126 318,-201 318,-201 318,-207 312,-213 306,-213 306,-213 167,-213 167,-213 161,-213 155,-207 155,-201 155,-201 155,-126 155,-126 155,-120 161,-114 167,-114"/>
<text text-anchor="middle" x="236.5" y="-197.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">buildPrewriteRequest</text>
<polyline fill="none" stroke="#1c2123" points="155,-190 318,-190 "/>
<text text-anchor="start" x="163" y="-174.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">将batch mutations </text>
<text text-anchor="start" x="163" y="-159.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 复制到request中</text>
<polyline fill="none" stroke="#1c2123" points="155,-152 318,-152 "/>
<text text-anchor="start" x="163" y="-136.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">并选择mutations[0]的key</text>
<text text-anchor="start" x="163" y="-121.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 作为primary key</text>
</g>
<!-- handleSingleBatch&#45;&gt;buildPrewriteRequest -->
<g id="edge7" class="edge">
<title>handleSingleBatch&#45;&gt;buildPrewriteRequest</title>
<path fill="none" stroke="#666666" d="M99.34,-244.42C113.32,-236.11 129.72,-226.36 146.21,-216.56"/>
<polygon fill="#666666" stroke="#666666" points="148.02,-219.56 154.83,-211.44 144.45,-213.54 148.02,-219.56"/>
</g>
<!-- SendReq -->
<g id="node9" class="node">
<title>SendReq</title>
<path fill="none" stroke="#1c2123" d="M366,-270.5C366,-270.5 461,-270.5 461,-270.5 467,-270.5 473,-276.5 473,-282.5 473,-282.5 473,-304.5 473,-304.5 473,-310.5 467,-316.5 461,-316.5 461,-316.5 366,-316.5 366,-316.5 360,-316.5 354,-310.5 354,-304.5 354,-304.5 354,-282.5 354,-282.5 354,-276.5 360,-270.5 366,-270.5"/>
<text text-anchor="middle" x="413.5" y="-301.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">SendReq</text>
<polyline fill="none" stroke="#1c2123" points="354,-293.5 473,-293.5 "/>
<text text-anchor="start" x="362" y="-278.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">发送请求到TiKV</text>
</g>
<!-- handleSingleBatch&#45;&gt;SendReq -->
<g id="edge8" class="edge">
<title>handleSingleBatch&#45;&gt;SendReq</title>
<path fill="none" stroke="#666666" d="M119.02,-271.82C180.81,-276.39 278.17,-283.58 343.62,-288.41"/>
<polygon fill="#666666" stroke="#666666" points="343.61,-291.92 353.84,-289.17 344.12,-284.94 343.61,-291.92"/>
</g>
<!-- resolveLocksForWrite -->
<g id="node10" class="node">
<title>resolveLocksForWrite</title>
<path fill="none" stroke="#1c2123" d="M565,-203.5C565,-203.5 705,-203.5 705,-203.5 711,-203.5 717,-209.5 717,-215.5 717,-215.5 717,-267.5 717,-267.5 717,-273.5 711,-279.5 705,-279.5 705,-279.5 565,-279.5 565,-279.5 559,-279.5 553,-273.5 553,-267.5 553,-267.5 553,-215.5 553,-215.5 553,-209.5 559,-203.5 565,-203.5"/>
<text text-anchor="middle" x="635" y="-264.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">resolveLocksForWrite</text>
<polyline fill="none" stroke="#1c2123" points="553,-256.5 717,-256.5 "/>
<text text-anchor="start" x="561" y="-241.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">prewrite报错</text>
<text text-anchor="start" x="561" y="-226.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 从err中抽出冲突的locks</text>
<text text-anchor="start" x="561" y="-211.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 尝试resolve这些locks</text>
</g>
<!-- handleSingleBatch&#45;&gt;resolveLocksForWrite -->
<g id="edge9" class="edge">
<title>handleSingleBatch&#45;&gt;resolveLocksForWrite</title>
<path fill="none" stroke="#666666" d="M119.18,-264.84C219.32,-260.3 423.89,-251.03 542.79,-245.63"/>
<polygon fill="#666666" stroke="#666666" points="543.14,-249.12 552.97,-245.17 542.82,-242.13 543.14,-249.12"/>
</g>
<!-- Mutation -->
<g id="node7" class="node">
<title>Mutation</title>
<path fill="none" stroke="#1c2123" d="M384,-82.5C384,-82.5 443,-82.5 443,-82.5 449,-82.5 455,-88.5 455,-94.5 455,-94.5 455,-162.5 455,-162.5 455,-168.5 449,-174.5 443,-174.5 443,-174.5 384,-174.5 384,-174.5 378,-174.5 372,-168.5 372,-162.5 372,-162.5 372,-94.5 372,-94.5 372,-88.5 378,-82.5 384,-82.5"/>
<text text-anchor="middle" x="413.5" y="-159.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Mutation</text>
<polyline fill="none" stroke="#1c2123" points="372,-151.5 455,-151.5 "/>
<text text-anchor="start" x="380" y="-136.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Op Op</text>
<polyline fill="none" stroke="#1c2123" points="372,-128.5 455,-128.5 "/>
<text text-anchor="start" x="380" y="-113.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Key []byte</text>
<polyline fill="none" stroke="#1c2123" points="372,-105.5 455,-105.5 "/>
<text text-anchor="start" x="380" y="-90.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Value []byte</text>
</g>
<!-- buildPrewriteRequest&#45;&gt;Mutation -->
<g id="edge4" class="edge">
<title>buildPrewriteRequest&#45;&gt;Mutation</title>
<path fill="none" stroke="#666666" d="M318.09,-147.38C332.95,-144.41 348.09,-141.38 361.76,-138.65"/>
<polygon fill="#666666" stroke="#666666" points="362.79,-142.01 371.9,-136.62 361.41,-135.15 362.79,-142.01"/>
</g>
<!-- buildPrewriteRequest&#45;&gt;SendReq -->
<g id="edge12" class="edge">
<title>buildPrewriteRequest&#45;&gt;SendReq</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M304.16,-213.02C327.42,-230.3 352.77,-249.13 373.09,-264.23"/>
<polygon fill="green" stroke="green" points="371.08,-267.09 381.19,-270.24 375.25,-261.47 371.08,-267.09"/>
</g>
<!-- Op -->
<g id="node8" class="node">
<title>Op</title>
<path fill="none" stroke="#1c2123" d="M561,-0.5C561,-0.5 709,-0.5 709,-0.5 715,-0.5 721,-6.5 721,-12.5 721,-12.5 721,-172.5 721,-172.5 721,-178.5 715,-184.5 709,-184.5 709,-184.5 561,-184.5 561,-184.5 555,-184.5 549,-178.5 549,-172.5 549,-172.5 549,-12.5 549,-12.5 549,-6.5 555,-0.5 561,-0.5"/>
<text text-anchor="middle" x="635" y="-169.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Op</text>
<polyline fill="none" stroke="#1c2123" points="549,-161.5 721,-161.5 "/>
<text text-anchor="start" x="557" y="-146.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Op_Put Op = 0</text>
<polyline fill="none" stroke="#1c2123" points="549,-138.5 721,-138.5 "/>
<text text-anchor="start" x="557" y="-123.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Op_Del Op = 1</text>
<polyline fill="none" stroke="#1c2123" points="549,-115.5 721,-115.5 "/>
<text text-anchor="start" x="557" y="-100.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Op_Lock Op = 2</text>
<polyline fill="none" stroke="#1c2123" points="549,-92.5 721,-92.5 "/>
<text text-anchor="start" x="557" y="-77.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Op_Rollback Op = 3</text>
<polyline fill="none" stroke="#1c2123" points="549,-69.5 721,-69.5 "/>
<text text-anchor="start" x="557" y="-54.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Op_Insert Op = 4</text>
<polyline fill="none" stroke="#1c2123" points="549,-46.5 721,-46.5 "/>
<text text-anchor="start" x="557" y="-31.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Op_PessimisticLock Op = 5</text>
<polyline fill="none" stroke="#1c2123" points="549,-23.5 721,-23.5 "/>
<text text-anchor="start" x="557" y="-8.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Op_CheckNotExists Op = 6</text>
</g>
<!-- Mutation&#45;&gt;Op -->
<g id="edge5" class="edge">
<title>Mutation&#45;&gt;Op</title>
<path fill="none" stroke="#666666" d="M455.02,-121.86C478.61,-117.99 509.42,-112.93 538.81,-108.11"/>
<polygon fill="#666666" stroke="#666666" points="539.41,-111.56 548.71,-106.49 538.28,-104.65 539.41,-111.56"/>
</g>
<!-- SendReq&#45;&gt;ttlManager_run -->
<g id="edge13" class="edge">
<title>SendReq&#45;&gt;ttlManager_run</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M473.03,-312.17C481.24,-314.78 489.94,-317.56 498.88,-320.41"/>
<polygon fill="green" stroke="green" points="498.07,-323.82 508.66,-323.53 500.19,-317.15 498.07,-323.82"/>
</g>
<!-- SendReq&#45;&gt;resolveLocksForWrite -->
<g id="edge14" class="edge">
<title>SendReq&#45;&gt;resolveLocksForWrite</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M473.03,-279.63C494.48,-274.55 519.29,-268.67 542.91,-263.08"/>
<polygon fill="green" stroke="green" points="544.03,-266.41 552.95,-260.7 542.41,-259.6 544.03,-266.41"/>
</g>
<!-- resolveLocks -->
<g id="node11" class="node">
<title>resolveLocks</title>
<path fill="#a2dbfa" stroke="#8a8898" d="M809,-211C809,-211 958,-211 958,-211 964,-211 970,-217 970,-223 970,-223 970,-260 970,-260 970,-266 964,-272 958,-272 958,-272 809,-272 809,-272 803,-272 797,-266 797,-260 797,-260 797,-223 797,-223 797,-217 803,-211 809,-211"/>
<text text-anchor="middle" x="883.5" y="-256.8" font-family="Times,serif" font-size="14.00" fill="#5d6179">resolveLocks</text>
<polyline fill="none" stroke="#8a8898" points="797,-249 970,-249 "/>
<text text-anchor="start" x="805" y="-233.8" font-family="Times,serif" font-size="14.00" fill="#5d6179">遍历locks，对于每个Lock</text>
<text text-anchor="start" x="805" y="-218.8" font-family="Times,serif" font-size="14.00" fill="#5d6179"> 调用resolve函数</text>
</g>
<!-- resolveLocksForWrite&#45;&gt;resolveLocks -->
<g id="edge10" class="edge">
<title>resolveLocksForWrite&#45;&gt;resolveLocks</title>
<path fill="none" stroke="#666666" d="M717.05,-241.5C739.3,-241.5 763.63,-241.5 786.63,-241.5"/>
<polygon fill="#666666" stroke="#666666" points="786.74,-245 796.74,-241.5 786.74,-238 786.74,-245"/>
</g>
<!-- resolve -->
<g id="node12" class="node">
<title>resolve</title>
<path fill="none" stroke="#1c2123" d="M1135.5,-259.5C1135.5,-259.5 1103.5,-259.5 1103.5,-259.5 1097.5,-259.5 1091.5,-253.5 1091.5,-247.5 1091.5,-247.5 1091.5,-235.5 1091.5,-235.5 1091.5,-229.5 1097.5,-223.5 1103.5,-223.5 1103.5,-223.5 1135.5,-223.5 1135.5,-223.5 1141.5,-223.5 1147.5,-229.5 1147.5,-235.5 1147.5,-235.5 1147.5,-247.5 1147.5,-247.5 1147.5,-253.5 1141.5,-259.5 1135.5,-259.5"/>
<text text-anchor="middle" x="1119.5" y="-237.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">resolve</text>
</g>
<!-- resolveLocks&#45;&gt;resolve -->
<g id="edge11" class="edge">
<title>resolveLocks&#45;&gt;resolve</title>
<path fill="none" stroke="#666666" d="M970.3,-241.5C1008.41,-241.5 1051.27,-241.5 1081.06,-241.5"/>
<polygon fill="#666666" stroke="#666666" points="1081.41,-245 1091.41,-241.5 1081.41,-238 1081.41,-245"/>
</g>
</g>
</svg>
