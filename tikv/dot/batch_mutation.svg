<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.1 (20210417.1919)
 -->
<!-- Title: batch_mutations Pages: 1 -->
<svg width="1776pt" height="434pt"
 viewBox="0.00 0.00 1776.00 434.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 430)">
<title>batch_mutations</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-430 1772,-430 1772,4 -4,4"/>
<!-- KVTxn -->
<g id="node1" class="node">
<title>KVTxn</title>
<path fill="none" stroke="#1c2123" d="M12,-206.5C12,-206.5 164,-206.5 164,-206.5 170,-206.5 176,-212.5 176,-218.5 176,-218.5 176,-278.5 176,-278.5 176,-284.5 170,-290.5 164,-290.5 164,-290.5 12,-290.5 12,-290.5 6,-290.5 0,-284.5 0,-278.5 0,-278.5 0,-218.5 0,-218.5 0,-212.5 6,-206.5 12,-206.5"/>
<text text-anchor="middle" x="88" y="-275.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">KVTxn</text>
<polyline fill="none" stroke="#1c2123" points="0,-267.5 176,-267.5 "/>
<text text-anchor="start" x="8" y="-252.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">write操作先保存在</text>
<text text-anchor="start" x="8" y="-237.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> MemDB中 commit时 转成</text>
<polyline fill="none" stroke="#1c2123" points="0,-229.5 176,-229.5 "/>
<text text-anchor="start" x="8" y="-214.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">memBufferMutations</text>
</g>
<!-- twoPhaseCommitter -->
<g id="node2" class="node">
<title>twoPhaseCommitter</title>
<path fill="none" stroke="#1c2123" d="M400,-295.5C400,-295.5 576,-295.5 576,-295.5 582,-295.5 588,-301.5 588,-307.5 588,-307.5 588,-413.5 588,-413.5 588,-419.5 582,-425.5 576,-425.5 576,-425.5 400,-425.5 400,-425.5 394,-425.5 388,-419.5 388,-413.5 388,-413.5 388,-307.5 388,-307.5 388,-301.5 394,-295.5 400,-295.5"/>
<text text-anchor="middle" x="488" y="-410.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">twoPhaseCommitter</text>
<polyline fill="none" stroke="#1c2123" points="388,-402.5 588,-402.5 "/>
<text text-anchor="start" x="396" y="-387.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">遍历MemDB</text>
<text text-anchor="start" x="396" y="-372.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 转换成memBufferMutations</text>
<polyline fill="none" stroke="#1c2123" points="388,-364.5 588,-364.5 "/>
<text text-anchor="start" x="396" y="-349.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">startTS uint64</text>
<polyline fill="none" stroke="#1c2123" points="388,-341.5 588,-341.5 "/>
<text text-anchor="start" x="396" y="-326.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">mutations *memBufferMutations</text>
<polyline fill="none" stroke="#1c2123" points="388,-318.5 588,-318.5 "/>
<text text-anchor="start" x="396" y="-303.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">...</text>
</g>
<!-- KVTxn&#45;&gt;twoPhaseCommitter -->
<g id="edge1" class="edge">
<title>KVTxn&#45;&gt;twoPhaseCommitter</title>
<path fill="none" stroke="#666666" d="M176.34,-273.08C235.76,-289.8 314.82,-312.05 378.31,-329.91"/>
<polygon fill="#666666" stroke="#666666" points="377.38,-333.29 387.96,-332.63 379.28,-326.55 377.38,-333.29"/>
</g>
<!-- KVUnionStore -->
<g id="node8" class="node">
<title>KVUnionStore</title>
<path fill="#a2dbfa" stroke="#8a8898" d="M224,-189C224,-189 340,-189 340,-189 346,-189 352,-195 352,-201 352,-201 352,-238 352,-238 352,-244 346,-250 340,-250 340,-250 224,-250 224,-250 218,-250 212,-244 212,-238 212,-238 212,-201 212,-201 212,-195 218,-189 224,-189"/>
<text text-anchor="start" x="220" y="-234.8" font-family="Times,serif" font-size="14.00" fill="#5d6179">KVUnionStore</text>
<text text-anchor="start" x="220" y="-219.8" font-family="Times,serif" font-size="14.00" fill="#5d6179">memBuffer *MemDB</text>
<polyline fill="none" stroke="#8a8898" points="212,-212 352,-212 "/>
<text text-anchor="start" x="220" y="-196.8" font-family="Times,serif" font-size="14.00" fill="#5d6179">snapshot uSnapshot</text>
</g>
<!-- KVTxn&#45;&gt;KVUnionStore -->
<g id="edge7" class="edge">
<title>KVTxn&#45;&gt;KVUnionStore</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M176.01,-235.36C184.64,-234.05 193.37,-232.74 201.91,-231.45"/>
<polygon fill="green" stroke="green" points="202.47,-234.9 211.84,-229.95 201.43,-227.98 202.47,-234.9"/>
</g>
<!-- groupMutations -->
<g id="node3" class="node">
<title>groupMutations</title>
<path fill="none" stroke="#1c2123" d="M895,-218C895,-218 993,-218 993,-218 999,-218 1005,-224 1005,-230 1005,-230 1005,-267 1005,-267 1005,-273 999,-279 993,-279 993,-279 895,-279 895,-279 889,-279 883,-273 883,-267 883,-267 883,-230 883,-230 883,-224 889,-218 895,-218"/>
<text text-anchor="middle" x="944" y="-263.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">groupMutations</text>
<polyline fill="none" stroke="#1c2123" points="883,-256 1005,-256 "/>
<text text-anchor="start" x="891" y="-240.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">先对mutation根据</text>
<text text-anchor="start" x="891" y="-225.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> region做分组</text>
</g>
<!-- twoPhaseCommitter&#45;&gt;groupMutations -->
<g id="edge2" class="edge">
<title>twoPhaseCommitter&#45;&gt;groupMutations</title>
<path fill="none" stroke="#666666" d="M588.07,-336.06C674.09,-314.84 796.5,-284.64 872.77,-265.83"/>
<polygon fill="#666666" stroke="#666666" points="873.88,-269.16 882.75,-263.36 872.21,-262.36 873.88,-269.16"/>
</g>
<!-- batchMutations -->
<g id="node4" class="node">
<title>batchMutations</title>
<path fill="none" stroke="#1c2123" d="M1053,-203C1053,-203 1145,-203 1145,-203 1151,-203 1157,-209 1157,-215 1157,-215 1157,-282 1157,-282 1157,-288 1151,-294 1145,-294 1145,-294 1053,-294 1053,-294 1047,-294 1041,-288 1041,-282 1041,-282 1041,-215 1041,-215 1041,-209 1047,-203 1053,-203"/>
<text text-anchor="middle" x="1099" y="-278.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">batchMutations</text>
<polyline fill="none" stroke="#1c2123" points="1041,-271 1157,-271 "/>
<text text-anchor="start" x="1049" y="-255.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">对每个分组内的</text>
<text text-anchor="start" x="1049" y="-240.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> mutations </text>
<text text-anchor="start" x="1049" y="-225.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 按照size limit</text>
<text text-anchor="start" x="1049" y="-210.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 分批batch</text>
</g>
<!-- groupMutations&#45;&gt;batchMutations -->
<g id="edge3" class="edge">
<title>groupMutations&#45;&gt;batchMutations</title>
<path fill="none" stroke="#666666" d="M1005.03,-248.5C1013.36,-248.5 1021.97,-248.5 1030.43,-248.5"/>
<polygon fill="#666666" stroke="#666666" points="1030.64,-252 1040.64,-248.5 1030.64,-245 1030.64,-252"/>
</g>
<!-- batchExecutor -->
<g id="node5" class="node">
<title>batchExecutor</title>
<path fill="none" stroke="#1c2123" d="M1205,-251.5C1205,-251.5 1339,-251.5 1339,-251.5 1345,-251.5 1351,-257.5 1351,-263.5 1351,-263.5 1351,-285.5 1351,-285.5 1351,-291.5 1345,-297.5 1339,-297.5 1339,-297.5 1205,-297.5 1205,-297.5 1199,-297.5 1193,-291.5 1193,-285.5 1193,-285.5 1193,-263.5 1193,-263.5 1193,-257.5 1199,-251.5 1205,-251.5"/>
<text text-anchor="middle" x="1272" y="-282.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">batchExecutor</text>
<polyline fill="none" stroke="#1c2123" points="1193,-274.5 1351,-274.5 "/>
<text text-anchor="start" x="1201" y="-259.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">并发处理batchMutations</text>
</g>
<!-- batchMutations&#45;&gt;batchExecutor -->
<g id="edge4" class="edge">
<title>batchMutations&#45;&gt;batchExecutor</title>
<path fill="none" stroke="#666666" d="M1157.42,-257.23C1165.58,-258.47 1174.12,-259.77 1182.7,-261.07"/>
<polygon fill="#666666" stroke="#666666" points="1182.36,-264.56 1192.77,-262.61 1183.41,-257.64 1182.36,-264.56"/>
</g>
<!-- twoPhaseCommitAction -->
<g id="node6" class="node">
<title>twoPhaseCommitAction</title>
<path fill="#feed9b" stroke="#f7e495" d="M1399,-210.5C1399,-210.5 1565,-210.5 1565,-210.5 1571,-210.5 1577,-216.5 1577,-222.5 1577,-222.5 1577,-274.5 1577,-274.5 1577,-280.5 1571,-286.5 1565,-286.5 1565,-286.5 1399,-286.5 1399,-286.5 1393,-286.5 1387,-280.5 1387,-274.5 1387,-274.5 1387,-222.5 1387,-222.5 1387,-216.5 1393,-210.5 1399,-210.5"/>
<text text-anchor="middle" x="1482" y="-271.3" font-family="Times,serif" font-size="14.00" fill="#40575d">twoPhaseCommitAction</text>
<polyline fill="none" stroke="#f7e495" points="1387,-263.5 1577,-263.5 "/>
<text text-anchor="start" x="1395" y="-248.3" font-family="Times,serif" font-size="14.00" fill="#40575d">handleSingleBatch</text>
<text text-anchor="start" x="1395" y="-233.3" font-family="Times,serif" font-size="14.00" fill="#40575d"> 处理一批mutations</text>
<text text-anchor="start" x="1395" y="-218.3" font-family="Times,serif" font-size="14.00" fill="#40575d"> 会发送一些cmd请求到TiKV</text>
</g>
<!-- batchMutations&#45;&gt;twoPhaseCommitAction -->
<g id="edge11" class="edge">
<title>batchMutations&#45;&gt;twoPhaseCommitAction</title>
<path fill="none" stroke="#666666" d="M1157.02,-244.24C1168.91,-243.51 1181.36,-242.88 1193,-242.5 1263.19,-240.24 1280.8,-240.88 1351,-242.5 1359.36,-242.69 1368.02,-242.96 1376.72,-243.26"/>
<polygon fill="#666666" stroke="#666666" points="1376.81,-246.77 1386.94,-243.64 1377.07,-239.77 1376.81,-246.77"/>
</g>
<!-- batchExecutor&#45;&gt;twoPhaseCommitAction -->
<g id="edge5" class="edge">
<title>batchExecutor&#45;&gt;twoPhaseCommitAction</title>
<path fill="none" stroke="#666666" d="M1351.04,-264.74C1359.41,-263.7 1368.02,-262.62 1376.63,-261.55"/>
<polygon fill="#666666" stroke="#666666" points="1377.24,-265 1386.73,-260.28 1376.37,-258.05 1377.24,-265"/>
</g>
<!-- TiKV -->
<g id="node7" class="node">
<title>TiKV</title>
<path fill="none" stroke="#1c2123" d="M1625,-229.5C1625,-229.5 1756,-229.5 1756,-229.5 1762,-229.5 1768,-235.5 1768,-241.5 1768,-241.5 1768,-255.5 1768,-255.5 1768,-261.5 1762,-267.5 1756,-267.5 1756,-267.5 1625,-267.5 1625,-267.5 1619,-267.5 1613,-261.5 1613,-255.5 1613,-255.5 1613,-241.5 1613,-241.5 1613,-235.5 1619,-229.5 1625,-229.5"/>
<text text-anchor="start" x="1621" y="-252.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">TiKv</text>
<text text-anchor="start" x="1621" y="-237.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 处理TiDB 发来的请求</text>
</g>
<!-- twoPhaseCommitAction&#45;&gt;TiKV -->
<g id="edge6" class="edge">
<title>twoPhaseCommitAction&#45;&gt;TiKV</title>
<path fill="none" stroke="#666666" d="M1577.19,-248.5C1585.66,-248.5 1594.21,-248.5 1602.61,-248.5"/>
<polygon fill="#666666" stroke="#666666" points="1602.77,-252 1612.77,-248.5 1602.77,-245 1602.77,-252"/>
</g>
<!-- MemDB -->
<g id="node9" class="node">
<title>MemDB</title>
<path fill="#a2dbfa" stroke="#8a8898" d="M416.5,-0.5C416.5,-0.5 559.5,-0.5 559.5,-0.5 565.5,-0.5 571.5,-6.5 571.5,-12.5 571.5,-12.5 571.5,-264.5 571.5,-264.5 571.5,-270.5 565.5,-276.5 559.5,-276.5 559.5,-276.5 416.5,-276.5 416.5,-276.5 410.5,-276.5 404.5,-270.5 404.5,-264.5 404.5,-264.5 404.5,-12.5 404.5,-12.5 404.5,-6.5 410.5,-0.5 416.5,-0.5"/>
<text text-anchor="start" x="412.5" y="-261.3" font-family="Times,serif" font-size="14.00" fill="#5d6179">MemDB</text>
<polyline fill="none" stroke="#8a8898" points="404.5,-253.5 571.5,-253.5 "/>
<text text-anchor="start" x="412.5" y="-238.3" font-family="Times,serif" font-size="14.00" fill="#5d6179">sync.RWMutex</text>
<polyline fill="none" stroke="#8a8898" points="404.5,-230.5 571.5,-230.5 "/>
<text text-anchor="start" x="412.5" y="-215.3" font-family="Times,serif" font-size="14.00" fill="#5d6179">root memdbArenaAddr</text>
<polyline fill="none" stroke="#8a8898" points="404.5,-207.5 571.5,-207.5 "/>
<text text-anchor="start" x="412.5" y="-192.3" font-family="Times,serif" font-size="14.00" fill="#5d6179">allocator nodeAllocator</text>
<polyline fill="none" stroke="#8a8898" points="404.5,-184.5 571.5,-184.5 "/>
<text text-anchor="start" x="412.5" y="-169.3" font-family="Times,serif" font-size="14.00" fill="#5d6179">vlog memdbVlog</text>
<polyline fill="none" stroke="#8a8898" points="404.5,-161.5 571.5,-161.5 "/>
<text text-anchor="start" x="412.5" y="-146.3" font-family="Times,serif" font-size="14.00" fill="#5d6179">entrySizeLimit uint64</text>
<polyline fill="none" stroke="#8a8898" points="404.5,-138.5 571.5,-138.5 "/>
<text text-anchor="start" x="412.5" y="-123.3" font-family="Times,serif" font-size="14.00" fill="#5d6179">bufferSizeLimit uint64</text>
<polyline fill="none" stroke="#8a8898" points="404.5,-115.5 571.5,-115.5 "/>
<text text-anchor="start" x="412.5" y="-100.3" font-family="Times,serif" font-size="14.00" fill="#5d6179">count int</text>
<polyline fill="none" stroke="#8a8898" points="404.5,-92.5 571.5,-92.5 "/>
<text text-anchor="start" x="412.5" y="-77.3" font-family="Times,serif" font-size="14.00" fill="#5d6179">size int</text>
<polyline fill="none" stroke="#8a8898" points="404.5,-69.5 571.5,-69.5 "/>
<text text-anchor="start" x="412.5" y="-54.3" font-family="Times,serif" font-size="14.00" fill="#5d6179">vlogInvalid bool</text>
<polyline fill="none" stroke="#8a8898" points="404.5,-46.5 571.5,-46.5 "/>
<text text-anchor="start" x="412.5" y="-31.3" font-family="Times,serif" font-size="14.00" fill="#5d6179">dirty bool</text>
<polyline fill="none" stroke="#8a8898" points="404.5,-23.5 571.5,-23.5 "/>
<text text-anchor="start" x="412.5" y="-8.3" font-family="Times,serif" font-size="14.00" fill="#5d6179">stages []memdbCheckpoint</text>
</g>
<!-- KVUnionStore&#45;&gt;MemDB -->
<g id="edge8" class="edge">
<title>KVUnionStore&#45;&gt;MemDB</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M352.07,-192.08C365.81,-186.62 380.46,-180.8 394.84,-175.09"/>
<polygon fill="green" stroke="green" points="396.23,-178.31 404.24,-171.36 393.65,-171.8 396.23,-178.31"/>
</g>
<!-- memBufferMutations -->
<g id="node10" class="node">
<title>memBufferMutations</title>
<path fill="#a2dbfa" stroke="#8a8898" d="M636,-183C636,-183 835,-183 835,-183 841,-183 847,-189 847,-195 847,-195 847,-240 847,-240 847,-246 841,-252 835,-252 835,-252 636,-252 636,-252 630,-252 624,-246 624,-240 624,-240 624,-195 624,-195 624,-189 630,-183 636,-183"/>
<text text-anchor="start" x="632" y="-236.8" font-family="Times,serif" font-size="14.00" fill="#5d6179">memBufferMutations</text>
<polyline fill="none" stroke="#8a8898" points="624,-229 847,-229 "/>
<text text-anchor="start" x="632" y="-213.8" font-family="Times,serif" font-size="14.00" fill="#5d6179">storage *unionstore.MemDB</text>
<polyline fill="none" stroke="#8a8898" points="624,-206 847,-206 "/>
<text text-anchor="start" x="632" y="-190.8" font-family="Times,serif" font-size="14.00" fill="#5d6179">handles []unionstore.MemKeyHandle</text>
</g>
<!-- MemDB&#45;&gt;memBufferMutations -->
<g id="edge9" class="edge">
<title>MemDB&#45;&gt;memBufferMutations</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M571.77,-165.14C586.53,-169.88 602.15,-174.91 617.64,-179.9"/>
<polygon fill="green" stroke="green" points="616.68,-183.26 627.27,-182.99 618.82,-176.6 616.68,-183.26"/>
</g>
<!-- memBufferMutations&#45;&gt;groupMutations -->
<g id="edge10" class="edge">
<title>memBufferMutations&#45;&gt;groupMutations</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M847,-234.09C855.8,-235.41 864.52,-236.72 872.92,-237.98"/>
<polygon fill="green" stroke="green" points="872.57,-241.47 882.98,-239.49 873.61,-234.54 872.57,-241.47"/>
</g>
</g>
</svg>
