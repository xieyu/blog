<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.1 (20210417.1919)
 -->
<!-- Title: create_resolver Pages: 1 -->
<svg width="1690pt" height="411pt"
 viewBox="0.00 0.00 1690.00 411.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 407)">
<title>create_resolver</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-407 1686,-407 1686,4 -4,4"/>
<!-- TiKVServer_init -->
<g id="node1" class="node">
<title>TiKVServer_init</title>
<path fill="none" stroke="#1c2123" d="M96,-215.5C96,-215.5 12,-215.5 12,-215.5 6,-215.5 0,-209.5 0,-203.5 0,-203.5 0,-191.5 0,-191.5 0,-185.5 6,-179.5 12,-179.5 12,-179.5 96,-179.5 96,-179.5 102,-179.5 108,-185.5 108,-191.5 108,-191.5 108,-203.5 108,-203.5 108,-209.5 102,-215.5 96,-215.5"/>
<text text-anchor="middle" x="54" y="-193.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">TiKVServer_init</text>
</g>
<!-- WorkerBuilder_new_create -->
<g id="node2" class="node">
<title>WorkerBuilder_new_create</title>
<path fill="none" stroke="#1c2123" d="M156,-255.5C156,-255.5 272,-255.5 272,-255.5 278,-255.5 284,-261.5 284,-267.5 284,-267.5 284,-319.5 284,-319.5 284,-325.5 278,-331.5 272,-331.5 272,-331.5 156,-331.5 156,-331.5 150,-331.5 144,-325.5 144,-319.5 144,-319.5 144,-267.5 144,-267.5 144,-261.5 150,-255.5 156,-255.5"/>
<text text-anchor="start" x="152" y="-316.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">WorkerBuilder</text>
<text text-anchor="start" x="152" y="-301.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> ::new(&quot;backgroud&quot;)</text>
<text text-anchor="middle" x="214" y="-286.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> .create()</text>
<polyline fill="none" stroke="#1c2123" points="144,-278.5 284,-278.5 "/>
<text text-anchor="start" x="152" y="-263.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">创建后台worker pool</text>
</g>
<!-- TiKVServer_init&#45;&gt;WorkerBuilder_new_create -->
<g id="edge1" class="edge">
<title>TiKVServer_init&#45;&gt;WorkerBuilder_new_create</title>
<path fill="none" stroke="#666666" d="M84.72,-215.56C100.91,-225.39 121.7,-238.03 141.81,-250.24"/>
<polygon fill="#666666" stroke="#666666" points="140,-253.24 150.37,-255.45 143.64,-247.26 140,-253.24"/>
</g>
<!-- resolve_new_resolver -->
<g id="node3" class="node">
<title>resolve_new_resolver</title>
<path fill="none" stroke="#1c2123" d="M843,-144.5C843,-144.5 983,-144.5 983,-144.5 989,-144.5 995,-150.5 995,-156.5 995,-156.5 995,-238.5 995,-238.5 995,-244.5 989,-250.5 983,-250.5 983,-250.5 843,-250.5 843,-250.5 837,-250.5 831,-244.5 831,-238.5 831,-238.5 831,-156.5 831,-156.5 831,-150.5 837,-144.5 843,-144.5"/>
<text text-anchor="middle" x="913" y="-235.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">resolve::new_resolver</text>
<polyline fill="none" stroke="#1c2123" points="831,-227.5 995,-227.5 "/>
<text text-anchor="start" x="839" y="-212.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">创建PdStoreAddrResolver</text>
<text text-anchor="start" x="839" y="-197.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> backgroup worker 启动</text>
<text text-anchor="start" x="839" y="-182.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> add&#45;resolver runner</text>
<text text-anchor="start" x="839" y="-167.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 并将scheduler放到</text>
<text text-anchor="start" x="839" y="-152.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> PdStoreAddrResolver</text>
</g>
<!-- TiKVServer_init&#45;&gt;resolve_new_resolver -->
<g id="edge2" class="edge">
<title>TiKVServer_init&#45;&gt;resolve_new_resolver</title>
<path fill="none" stroke="#666666" d="M108.29,-197.5C250.79,-197.5 641.95,-197.5 820.71,-197.5"/>
<polygon fill="#666666" stroke="#666666" points="820.87,-201 830.87,-197.5 820.87,-194 820.87,-201"/>
</g>
<!-- TiKVServer_connect_to_pd_cluster -->
<g id="node4" class="node">
<title>TiKVServer_connect_to_pd_cluster</title>
<path fill="none" stroke="#1c2123" d="M343,-92.5C343,-92.5 462,-92.5 462,-92.5 468,-92.5 474,-98.5 474,-104.5 474,-104.5 474,-156.5 474,-156.5 474,-162.5 468,-168.5 462,-168.5 462,-168.5 343,-168.5 343,-168.5 337,-168.5 331,-162.5 331,-156.5 331,-156.5 331,-104.5 331,-104.5 331,-98.5 337,-92.5 343,-92.5"/>
<text text-anchor="start" x="339" y="-153.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">TiKVServer</text>
<text text-anchor="middle" x="402.5" y="-138.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> connect_to_pd_cluster</text>
<polyline fill="none" stroke="#1c2123" points="331,-130.5 474,-130.5 "/>
<text text-anchor="start" x="339" y="-115.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">创建pd&#45;client</text>
<text text-anchor="start" x="339" y="-100.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 传给resolver</text>
</g>
<!-- TiKVServer_init&#45;&gt;TiKVServer_connect_to_pd_cluster -->
<g id="edge3" class="edge">
<title>TiKVServer_init&#45;&gt;TiKVServer_connect_to_pd_cluster</title>
<path fill="none" stroke="#666666" d="M108,-187.25C164.71,-176.29 255.35,-158.76 320.9,-146.08"/>
<polygon fill="#666666" stroke="#666666" points="321.64,-149.51 330.79,-144.17 320.31,-142.63 321.64,-149.51"/>
</g>
<!-- YatpPoolBuilder_new -->
<g id="node5" class="node">
<title>YatpPoolBuilder_new</title>
<path fill="none" stroke="#1c2123" d="M332,-322.5C332,-322.5 473,-322.5 473,-322.5 479,-322.5 485,-328.5 485,-334.5 485,-334.5 485,-386.5 485,-386.5 485,-392.5 479,-398.5 473,-398.5 473,-398.5 332,-398.5 332,-398.5 326,-398.5 320,-392.5 320,-386.5 320,-386.5 320,-334.5 320,-334.5 320,-328.5 326,-322.5 332,-322.5"/>
<text text-anchor="middle" x="402.5" y="-383.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">YatpPoolBuilder_new</text>
<polyline fill="none" stroke="#1c2123" points="320,-375.5 485,-375.5 "/>
<text text-anchor="start" x="328" y="-360.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">创建YatpPool</text>
<text text-anchor="start" x="328" y="-345.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 线程数为config.server</text>
<text text-anchor="start" x="328" y="-330.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> .background_thread_count</text>
</g>
<!-- WorkerBuilder_new_create&#45;&gt;YatpPoolBuilder_new -->
<g id="edge5" class="edge">
<title>WorkerBuilder_new_create&#45;&gt;YatpPoolBuilder_new</title>
<path fill="none" stroke="#666666" d="M284.18,-318.35C292.71,-321.42 301.52,-324.58 310.31,-327.74"/>
<polygon fill="#666666" stroke="#666666" points="309.23,-331.07 319.83,-331.16 311.6,-324.48 309.23,-331.07"/>
</g>
<!-- Worker -->
<g id="node6" class="node">
<title>Worker</title>
<path fill="none" stroke="#1c2123" d="M533,-226.5C533,-226.5 783,-226.5 783,-226.5 789,-226.5 795,-232.5 795,-238.5 795,-238.5 795,-390.5 795,-390.5 795,-396.5 789,-402.5 783,-402.5 783,-402.5 533,-402.5 533,-402.5 527,-402.5 521,-396.5 521,-390.5 521,-390.5 521,-238.5 521,-238.5 521,-232.5 527,-226.5 533,-226.5"/>
<text text-anchor="middle" x="658" y="-387.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Worker</text>
<polyline fill="none" stroke="#1c2123" points="521,-379.5 795,-379.5 "/>
<text text-anchor="start" x="529" y="-364.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">pool: Arc&lt;Mutex&lt;Option&lt;ThreadPool</text>
<text text-anchor="start" x="529" y="-349.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> &lt;yatp::task::future::TaskCell&gt;&gt;&gt;&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="521,-341.5 795,-341.5 "/>
<text text-anchor="start" x="529" y="-326.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">remote: Remote&lt;yatp::task::future::TaskCell&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="521,-318.5 795,-318.5 "/>
<text text-anchor="start" x="529" y="-303.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">pending_capacity: usize,</text>
<polyline fill="none" stroke="#1c2123" points="521,-295.5 795,-295.5 "/>
<text text-anchor="start" x="529" y="-280.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">counter: Arc&lt;AtomicUsize&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="521,-272.5 795,-272.5 "/>
<text text-anchor="start" x="529" y="-257.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">stop: Arc&lt;AtomicBool&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="521,-249.5 795,-249.5 "/>
<text text-anchor="start" x="529" y="-234.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">thread_count: usize,</text>
</g>
<!-- WorkerBuilder_new_create&#45;&gt;Worker -->
<g id="edge6" class="edge">
<title>WorkerBuilder_new_create&#45;&gt;Worker</title>
<path fill="none" stroke="#666666" d="M284.06,-296.78C344.48,-299.65 434.25,-303.92 510.58,-307.54"/>
<polygon fill="#666666" stroke="#666666" points="510.62,-311.05 520.78,-308.03 510.96,-304.06 510.62,-311.05"/>
</g>
<!-- Worker_start -->
<g id="node7" class="node">
<title>Worker_start</title>
<path fill="none" stroke="#1c2123" d="M1095,-226C1095,-226 1234,-226 1234,-226 1240,-226 1246,-232 1246,-238 1246,-238 1246,-381 1246,-381 1246,-387 1240,-393 1234,-393 1234,-393 1095,-393 1095,-393 1089,-393 1083,-387 1083,-381 1083,-381 1083,-238 1083,-238 1083,-232 1089,-226 1095,-226"/>
<text text-anchor="middle" x="1164.5" y="-377.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">Worker_start</text>
<polyline fill="none" stroke="#1c2123" points="1083,-370 1246,-370 "/>
<text text-anchor="start" x="1091" y="-354.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">start(addr&#45;resolver, runner)</text>
<polyline fill="none" stroke="#1c2123" points="1083,-347 1246,-347 "/>
<text text-anchor="start" x="1091" y="-331.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">创建一个channel</text>
<text text-anchor="start" x="1091" y="-316.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 从channel中Poll task</text>
<text text-anchor="start" x="1091" y="-301.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 调用Runner.run(task)</text>
<text text-anchor="start" x="1091" y="-286.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 处理task</text>
<polyline fill="none" stroke="#1c2123" points="1083,-279 1246,-279 "/>
<text text-anchor="start" x="1091" y="-263.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">返回一个scheduler</text>
<text text-anchor="start" x="1091" y="-248.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 用于向该channel</text>
<text text-anchor="start" x="1091" y="-233.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 发送task</text>
</g>
<!-- resolve_new_resolver&#45;&gt;Worker_start -->
<g id="edge9" class="edge">
<title>resolve_new_resolver&#45;&gt;Worker_start</title>
<path fill="none" stroke="#666666" d="M995.01,-233.86C1020.1,-245.13 1047.89,-257.6 1073.55,-269.12"/>
<polygon fill="#666666" stroke="#666666" points="1072.34,-272.42 1082.9,-273.32 1075.21,-266.03 1072.34,-272.42"/>
</g>
<!-- PdStoreAddrResolver_new -->
<g id="node8" class="node">
<title>PdStoreAddrResolver_new</title>
<path fill="none" stroke="#1c2123" d="M1670,-241.5C1670,-241.5 1530,-241.5 1530,-241.5 1524,-241.5 1518,-235.5 1518,-229.5 1518,-229.5 1518,-217.5 1518,-217.5 1518,-211.5 1524,-205.5 1530,-205.5 1530,-205.5 1670,-205.5 1670,-205.5 1676,-205.5 1682,-211.5 1682,-217.5 1682,-217.5 1682,-229.5 1682,-229.5 1682,-235.5 1676,-241.5 1670,-241.5"/>
<text text-anchor="middle" x="1600" y="-219.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">PdStoreAddrResolver_new</text>
</g>
<!-- resolve_new_resolver&#45;&gt;PdStoreAddrResolver_new -->
<g id="edge10" class="edge">
<title>resolve_new_resolver&#45;&gt;PdStoreAddrResolver_new</title>
<path fill="none" stroke="#666666" d="M995.27,-200.58C1123.76,-205.46 1373,-214.92 1507.56,-220.03"/>
<polygon fill="#666666" stroke="#666666" points="1507.71,-223.54 1517.84,-220.42 1507.98,-216.54 1507.71,-223.54"/>
</g>
<!-- Runner -->
<g id="node9" class="node">
<title>Runner</title>
<path fill="none" stroke="#1c2123" d="M1043,-0.5C1043,-0.5 1286,-0.5 1286,-0.5 1292,-0.5 1298,-6.5 1298,-12.5 1298,-12.5 1298,-156.5 1298,-156.5 1298,-162.5 1292,-168.5 1286,-168.5 1286,-168.5 1043,-168.5 1043,-168.5 1037,-168.5 1031,-162.5 1031,-156.5 1031,-156.5 1031,-12.5 1031,-12.5 1031,-6.5 1037,-0.5 1043,-0.5"/>
<text text-anchor="middle" x="1164.5" y="-153.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Runner</text>
<polyline fill="none" stroke="#1c2123" points="1031,-145.5 1298,-145.5 "/>
<text text-anchor="start" x="1039" y="-130.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">pd_client: Arc&lt;T&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="1031,-122.5 1298,-122.5 "/>
<text text-anchor="start" x="1039" y="-107.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">store_addrs: HashMap&lt;u64, StoreAddr&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="1031,-99.5 1298,-99.5 "/>
<text text-anchor="start" x="1039" y="-84.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">state: Arc&lt;Mutex&lt;GlobalReplicationState&gt;&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="1031,-76.5 1298,-76.5 "/>
<text text-anchor="start" x="1039" y="-61.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">router: RR,</text>
<polyline fill="none" stroke="#1c2123" points="1031,-53.5 1298,-53.5 "/>
<text text-anchor="start" x="1039" y="-38.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">使用pd_server</text>
<text text-anchor="start" x="1039" y="-23.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 获取store的addr</text>
<text text-anchor="start" x="1039" y="-8.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 中间加了一道缓存</text>
</g>
<!-- resolve_new_resolver&#45;&gt;Runner -->
<g id="edge11" class="edge">
<title>resolve_new_resolver&#45;&gt;Runner</title>
<path fill="none" stroke="#666666" d="M995.01,-160.81C1003.65,-156.9 1012.61,-152.84 1021.7,-148.72"/>
<polygon fill="#666666" stroke="#666666" points="1023.16,-151.9 1030.82,-144.59 1020.27,-145.53 1023.16,-151.9"/>
</g>
<!-- TiKVServer_connect_to_pd_cluster&#45;&gt;resolve_new_resolver -->
<g id="edge4" class="edge">
<title>TiKVServer_connect_to_pd_cluster&#45;&gt;resolve_new_resolver</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M474.2,-139.82C564.7,-151.74 721.62,-172.42 820.96,-185.5"/>
<polygon fill="green" stroke="green" points="820.62,-188.99 830.99,-186.83 821.53,-182.05 820.62,-188.99"/>
</g>
<!-- YatpPoolBuilder_new&#45;&gt;Worker -->
<g id="edge8" class="edge">
<title>YatpPoolBuilder_new&#45;&gt;Worker:pool</title>
<path fill="none" stroke="#666666" d="M485.04,-360.5C493.61,-360.5 502.29,-360.5 510.78,-360.5"/>
<polygon fill="#666666" stroke="#666666" points="511,-364 521,-360.5 511,-357 511,-364"/>
</g>
<!-- Worker&#45;&gt;resolve_new_resolver -->
<g id="edge7" class="edge">
<title>Worker&#45;&gt;resolve_new_resolver</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M795.13,-251.55C804.06,-247.42 812.93,-243.32 821.55,-239.33"/>
<polygon fill="green" stroke="green" points="823.2,-242.42 830.81,-235.05 820.26,-236.07 823.2,-242.42"/>
</g>
<!-- scheduler -->
<g id="node10" class="node">
<title>scheduler</title>
<path fill="none" stroke="#1c2123" d="M1346,-256.5C1346,-256.5 1470,-256.5 1470,-256.5 1476,-256.5 1482,-262.5 1482,-268.5 1482,-268.5 1482,-290.5 1482,-290.5 1482,-296.5 1476,-302.5 1470,-302.5 1470,-302.5 1346,-302.5 1346,-302.5 1340,-302.5 1334,-296.5 1334,-290.5 1334,-290.5 1334,-268.5 1334,-268.5 1334,-262.5 1340,-256.5 1346,-256.5"/>
<text text-anchor="middle" x="1408" y="-287.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">scheduler</text>
<polyline fill="none" stroke="#1c2123" points="1334,-279.5 1482,-279.5 "/>
<text text-anchor="start" x="1342" y="-264.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">用于向worker发送task</text>
</g>
<!-- Worker_start&#45;&gt;scheduler -->
<g id="edge12" class="edge">
<title>Worker_start&#45;&gt;scheduler</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M1246.25,-299.47C1271.08,-296.38 1298.45,-292.98 1323.46,-289.88"/>
<polygon fill="green" stroke="green" points="1324.15,-293.32 1333.65,-288.61 1323.29,-286.37 1324.15,-293.32"/>
</g>
<!-- scheduler&#45;&gt;PdStoreAddrResolver_new -->
<g id="edge13" class="edge">
<title>scheduler&#45;&gt;PdStoreAddrResolver_new</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M1482.19,-257.93C1497.28,-253.48 1513.15,-248.8 1528.16,-244.38"/>
<polygon fill="green" stroke="green" points="1529.28,-247.7 1537.88,-241.51 1527.3,-240.98 1529.28,-247.7"/>
</g>
</g>
</svg>
