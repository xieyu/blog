<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.1 (20210417.1919)
 -->
<!-- Title: for_update_ts Pages: 1 -->
<svg width="2479pt" height="553pt"
 viewBox="0.00 0.00 2479.00 552.50" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 548.5)">
<title>for_update_ts</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-548.5 2475,-548.5 2475,4 -4,4"/>
<g id="clust2" class="cluster">
<title>cluster_adapter</title>
<path fill="none" stroke="slategrey" stroke-dasharray="5,2" d="M1318.5,-20.5C1318.5,-20.5 1489.5,-20.5 1489.5,-20.5 1495.5,-20.5 1501.5,-26.5 1501.5,-32.5 1501.5,-32.5 1501.5,-200.5 1501.5,-200.5 1501.5,-206.5 1495.5,-212.5 1489.5,-212.5 1489.5,-212.5 1318.5,-212.5 1318.5,-212.5 1312.5,-212.5 1306.5,-206.5 1306.5,-200.5 1306.5,-200.5 1306.5,-32.5 1306.5,-32.5 1306.5,-26.5 1312.5,-20.5 1318.5,-20.5"/>
<text text-anchor="middle" x="1404" y="-192.5" font-family="Times,serif" font-size="20.00">executor/adapter.go</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_tikvStore</title>
<path fill="none" stroke="slategrey" stroke-dasharray="5,2" d="M1581,-101.5C1581,-101.5 2451,-101.5 2451,-101.5 2457,-101.5 2463,-107.5 2463,-113.5 2463,-113.5 2463,-197.5 2463,-197.5 2463,-203.5 2457,-209.5 2451,-209.5 2451,-209.5 1581,-209.5 1581,-209.5 1575,-209.5 1569,-203.5 1569,-197.5 1569,-197.5 1569,-113.5 1569,-113.5 1569,-107.5 1575,-101.5 1581,-101.5"/>
<text text-anchor="middle" x="2016" y="-189.5" font-family="Times,serif" font-size="20.00">tikvStore</text>
</g>
<g id="clust6" class="cluster">
<title>cluster_executorBuilder</title>
<path fill="none" stroke="slategrey" stroke-dasharray="5,2" d="M20,-220.5C20,-220.5 1537,-220.5 1537,-220.5 1543,-220.5 1549,-226.5 1549,-232.5 1549,-232.5 1549,-524.5 1549,-524.5 1549,-530.5 1543,-536.5 1537,-536.5 1537,-536.5 20,-536.5 20,-536.5 14,-536.5 8,-530.5 8,-524.5 8,-524.5 8,-232.5 8,-232.5 8,-226.5 14,-220.5 20,-220.5"/>
<text text-anchor="middle" x="778.5" y="-516.5" font-family="Times,serif" font-size="20.00">executorBuilder</text>
</g>
<!-- TransactionContext -->
<g id="node1" class="node">
<title>TransactionContext</title>
<path fill="none" stroke="#1c2123" d="M1865,-0.5C1865,-0.5 1966,-0.5 1966,-0.5 1972,-0.5 1978,-6.5 1978,-12.5 1978,-12.5 1978,-80.5 1978,-80.5 1978,-86.5 1972,-92.5 1966,-92.5 1966,-92.5 1865,-92.5 1865,-92.5 1859,-92.5 1853,-86.5 1853,-80.5 1853,-80.5 1853,-12.5 1853,-12.5 1853,-6.5 1859,-0.5 1865,-0.5"/>
<text text-anchor="middle" x="1915.5" y="-77.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">TransactionContext</text>
<polyline fill="none" stroke="#1c2123" points="1853,-69.5 1978,-69.5 "/>
<text text-anchor="start" x="1861" y="-54.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">forUpdateTS uint64</text>
<polyline fill="none" stroke="#1c2123" points="1853,-46.5 1978,-46.5 "/>
<text text-anchor="start" x="1861" y="-31.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">StartTS uint64</text>
<polyline fill="none" stroke="#1c2123" points="1853,-23.5 1978,-23.5 "/>
<text text-anchor="middle" x="1915.5" y="-8.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">...</text>
</g>
<!-- newLockCtx -->
<g id="node3" class="node">
<title>newLockCtx</title>
<path fill="none" stroke="#1c2123" d="M2026,-16C2026,-16 2172,-16 2172,-16 2178,-16 2184,-22 2184,-28 2184,-28 2184,-65 2184,-65 2184,-71 2178,-77 2172,-77 2172,-77 2026,-77 2026,-77 2020,-77 2014,-71 2014,-65 2014,-65 2014,-28 2014,-28 2014,-22 2020,-16 2026,-16"/>
<text text-anchor="middle" x="2099" y="-61.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">newLockCtx</text>
<polyline fill="none" stroke="#1c2123" points="2014,-54 2184,-54 "/>
<text text-anchor="start" x="2022" y="-38.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">将TransactionContext的</text>
<text text-anchor="middle" x="2099" y="-23.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> forUpdateTS 传给LockCtx</text>
</g>
<!-- TransactionContext&#45;&gt;newLockCtx -->
<g id="edge1" class="edge">
<title>TransactionContext&#45;&gt;newLockCtx</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M1978.2,-46.5C1986.47,-46.5 1995.11,-46.5 2003.78,-46.5"/>
<polygon fill="green" stroke="green" points="2003.97,-50 2013.97,-46.5 2003.97,-43 2003.97,-50"/>
</g>
<!-- LockCtx -->
<g id="node2" class="node">
<title>LockCtx</title>
<path fill="none" stroke="#1c2123" d="M2270,-0.5C2270,-0.5 2405,-0.5 2405,-0.5 2411,-0.5 2417,-6.5 2417,-12.5 2417,-12.5 2417,-80.5 2417,-80.5 2417,-86.5 2411,-92.5 2405,-92.5 2405,-92.5 2270,-92.5 2270,-92.5 2264,-92.5 2258,-86.5 2258,-80.5 2258,-80.5 2258,-12.5 2258,-12.5 2258,-6.5 2264,-0.5 2270,-0.5"/>
<text text-anchor="middle" x="2337.5" y="-77.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">LockCtx</text>
<polyline fill="none" stroke="#1c2123" points="2258,-69.5 2417,-69.5 "/>
<text text-anchor="start" x="2266" y="-54.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">ForUpdateTS uint64</text>
<polyline fill="none" stroke="#1c2123" points="2258,-46.5 2417,-46.5 "/>
<text text-anchor="start" x="2266" y="-31.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">LockWaitTime int64</text>
<polyline fill="none" stroke="#1c2123" points="2258,-23.5 2417,-23.5 "/>
<text text-anchor="start" x="2266" y="-8.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">WaitStartTime time.Time</text>
</g>
<!-- newLockCtx&#45;&gt;LockCtx -->
<g id="edge2" class="edge">
<title>newLockCtx&#45;&gt;LockCtx</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M2184.05,-46.5C2204.7,-46.5 2226.87,-46.5 2247.74,-46.5"/>
<polygon fill="green" stroke="green" points="2247.86,-50 2257.86,-46.5 2247.86,-43 2247.86,-50"/>
</g>
<!-- UpdateForUpdateTS -->
<g id="node4" class="node">
<title>UpdateForUpdateTS</title>
<path fill="none" stroke="#1c2123" d="M1326.5,-29.5C1326.5,-29.5 1481.5,-29.5 1481.5,-29.5 1487.5,-29.5 1493.5,-35.5 1493.5,-41.5 1493.5,-41.5 1493.5,-161.5 1493.5,-161.5 1493.5,-167.5 1487.5,-173.5 1481.5,-173.5 1481.5,-173.5 1326.5,-173.5 1326.5,-173.5 1320.5,-173.5 1314.5,-167.5 1314.5,-161.5 1314.5,-161.5 1314.5,-41.5 1314.5,-41.5 1314.5,-35.5 1320.5,-29.5 1326.5,-29.5"/>
<text text-anchor="middle" x="1404" y="-158.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">UpdateForUpdateTS</text>
<polyline fill="none" stroke="#1c2123" points="1314.5,-150.5 1493.5,-150.5 "/>
<text text-anchor="start" x="1322.5" y="-135.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">if newForUpdateTS == 0</text>
<text text-anchor="start" x="1322.5" y="-120.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Because the ForUpdateTS is </text>
<text text-anchor="start" x="1322.5" y="-105.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> used for the snapshot for</text>
<text text-anchor="start" x="1322.5" y="-90.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> reading data in DML.</text>
<polyline fill="none" stroke="#1c2123" points="1314.5,-82.5 1493.5,-82.5 "/>
<text text-anchor="start" x="1322.5" y="-67.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">We can avoid allocating</text>
<text text-anchor="start" x="1322.5" y="-52.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> a global TSO here to speed</text>
<text text-anchor="start" x="1322.5" y="-37.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> it up by using the local TSO.</text>
</g>
<!-- SetForUpdateTS -->
<g id="node5" class="node">
<title>SetForUpdateTS</title>
<path fill="none" stroke="#1c2123" d="M1649.5,-39.5C1649.5,-39.5 1744.5,-39.5 1744.5,-39.5 1750.5,-39.5 1756.5,-45.5 1756.5,-51.5 1756.5,-51.5 1756.5,-73.5 1756.5,-73.5 1756.5,-79.5 1750.5,-85.5 1744.5,-85.5 1744.5,-85.5 1649.5,-85.5 1649.5,-85.5 1643.5,-85.5 1637.5,-79.5 1637.5,-73.5 1637.5,-73.5 1637.5,-51.5 1637.5,-51.5 1637.5,-45.5 1643.5,-39.5 1649.5,-39.5"/>
<text text-anchor="middle" x="1697" y="-70.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">SetForUpdateTS</text>
<polyline fill="none" stroke="#1c2123" points="1637.5,-62.5 1756.5,-62.5 "/>
<text text-anchor="middle" x="1697" y="-47.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">设置ForUpdateTS</text>
</g>
<!-- UpdateForUpdateTS&#45;&gt;SetForUpdateTS -->
<g id="edge3" class="edge">
<title>UpdateForUpdateTS&#45;&gt;SetForUpdateTS</title>
<path fill="none" stroke="#666666" d="M1493.89,-89.59C1536.64,-83.86 1587.1,-77.09 1626.91,-71.76"/>
<polygon fill="#666666" stroke="#666666" points="1627.61,-75.2 1637.06,-70.4 1626.68,-68.26 1627.61,-75.2"/>
</g>
<!-- GetStore_CurrentVersion -->
<g id="node6" class="node">
<title>GetStore_CurrentVersion</title>
<path fill="none" stroke="#1c2123" d="M1589,-110C1589,-110 1805,-110 1805,-110 1811,-110 1817,-116 1817,-122 1817,-122 1817,-159 1817,-159 1817,-165 1811,-171 1805,-171 1805,-171 1589,-171 1589,-171 1583,-171 1577,-165 1577,-159 1577,-159 1577,-122 1577,-122 1577,-116 1583,-110 1589,-110"/>
<text text-anchor="middle" x="1697" y="-155.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">Store.CurrentVersion</text>
<polyline fill="none" stroke="#1c2123" points="1577,-148 1817,-148 "/>
<text text-anchor="start" x="1585" y="-132.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">return current max committed version</text>
<text text-anchor="start" x="1585" y="-117.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> with the given txnScope(local or global)</text>
</g>
<!-- UpdateForUpdateTS&#45;&gt;GetStore_CurrentVersion -->
<g id="edge5" class="edge">
<title>UpdateForUpdateTS&#45;&gt;GetStore_CurrentVersion</title>
<path fill="none" stroke="#666666" d="M1493.89,-113.41C1516.88,-116.49 1542.11,-119.87 1566.7,-123.17"/>
<polygon fill="#666666" stroke="#666666" points="1566.45,-126.67 1576.83,-124.53 1567.38,-119.73 1566.45,-126.67"/>
</g>
<!-- SetForUpdateTS&#45;&gt;TransactionContext -->
<g id="edge4" class="edge">
<title>SetForUpdateTS&#45;&gt;TransactionContext:forUpdateTS</title>
<path fill="none" stroke="#666666" d="M1756.51,-60.28C1782.46,-59.45 1813.67,-58.68 1842.8,-58.53"/>
<polygon fill="#666666" stroke="#666666" points="1843.01,-62.03 1853,-58.5 1842.99,-55.03 1843.01,-62.03"/>
</g>
<!-- CurrentTimestamp -->
<g id="node7" class="node">
<title>CurrentTimestamp</title>
<path fill="none" stroke="#1c2123" d="M1963.5,-158.5C1963.5,-158.5 1867.5,-158.5 1867.5,-158.5 1861.5,-158.5 1855.5,-152.5 1855.5,-146.5 1855.5,-146.5 1855.5,-134.5 1855.5,-134.5 1855.5,-128.5 1861.5,-122.5 1867.5,-122.5 1867.5,-122.5 1963.5,-122.5 1963.5,-122.5 1969.5,-122.5 1975.5,-128.5 1975.5,-134.5 1975.5,-134.5 1975.5,-146.5 1975.5,-146.5 1975.5,-152.5 1969.5,-158.5 1963.5,-158.5"/>
<text text-anchor="middle" x="1915.5" y="-136.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">CurrentTimestamp</text>
</g>
<!-- GetStore_CurrentVersion&#45;&gt;CurrentTimestamp -->
<g id="edge6" class="edge">
<title>GetStore_CurrentVersion&#45;&gt;CurrentTimestamp</title>
<path fill="none" stroke="#666666" d="M1817.02,-140.5C1826.65,-140.5 1836.18,-140.5 1845.28,-140.5"/>
<polygon fill="#666666" stroke="#666666" points="1845.35,-144 1855.35,-140.5 1845.35,-137 1845.35,-144"/>
</g>
<!-- getTimestampWithRetry -->
<g id="node8" class="node">
<title>getTimestampWithRetry</title>
<path fill="none" stroke="#1c2123" d="M2163,-158.5C2163,-158.5 2035,-158.5 2035,-158.5 2029,-158.5 2023,-152.5 2023,-146.5 2023,-146.5 2023,-134.5 2023,-134.5 2023,-128.5 2029,-122.5 2035,-122.5 2035,-122.5 2163,-122.5 2163,-122.5 2169,-122.5 2175,-128.5 2175,-134.5 2175,-134.5 2175,-146.5 2175,-146.5 2175,-152.5 2169,-158.5 2163,-158.5"/>
<text text-anchor="middle" x="2099" y="-136.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">getTimestampWithRetry</text>
</g>
<!-- CurrentTimestamp&#45;&gt;getTimestampWithRetry -->
<g id="edge7" class="edge">
<title>CurrentTimestamp&#45;&gt;getTimestampWithRetry</title>
<path fill="none" stroke="#666666" d="M1975.68,-140.5C1987.6,-140.5 2000.34,-140.5 2012.94,-140.5"/>
<polygon fill="#666666" stroke="#666666" points="2013,-144 2023,-140.5 2013,-137 2013,-144"/>
</g>
<!-- GetTimestamp -->
<g id="node9" class="node">
<title>GetTimestamp</title>
<path fill="none" stroke="#1c2123" d="M2232,-117.5C2232,-117.5 2443,-117.5 2443,-117.5 2449,-117.5 2455,-123.5 2455,-129.5 2455,-129.5 2455,-151.5 2455,-151.5 2455,-157.5 2449,-163.5 2443,-163.5 2443,-163.5 2232,-163.5 2232,-163.5 2226,-163.5 2220,-157.5 2220,-151.5 2220,-151.5 2220,-129.5 2220,-129.5 2220,-123.5 2226,-117.5 2232,-117.5"/>
<text text-anchor="middle" x="2337.5" y="-148.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">GetTimestamp</text>
<polyline fill="none" stroke="#1c2123" points="2220,-140.5 2455,-140.5 "/>
<text text-anchor="start" x="2228" y="-125.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">从TimeStamp Oracle服务获取时间戳</text>
</g>
<!-- getTimestampWithRetry&#45;&gt;GetTimestamp -->
<g id="edge8" class="edge">
<title>getTimestampWithRetry&#45;&gt;GetTimestamp</title>
<path fill="none" stroke="#666666" d="M2175.16,-140.5C2186.14,-140.5 2197.7,-140.5 2209.37,-140.5"/>
<polygon fill="#666666" stroke="#666666" points="2209.65,-144 2219.65,-140.5 2209.65,-137 2209.65,-144"/>
</g>
<!-- refreshForUpdateTSForRC -->
<g id="node10" class="node">
<title>refreshForUpdateTSForRC</title>
<path fill="none" stroke="#1c2123" d="M958,-354C958,-354 1219,-354 1219,-354 1225,-354 1231,-360 1231,-366 1231,-366 1231,-403 1231,-403 1231,-409 1225,-415 1219,-415 1219,-415 958,-415 958,-415 952,-415 946,-409 946,-403 946,-403 946,-366 946,-366 946,-360 952,-354 958,-354"/>
<text text-anchor="middle" x="1088.5" y="-399.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">refreshForUpdateTSForRC</text>
<polyline fill="none" stroke="#1c2123" points="946,-392 1231,-392 "/>
<text text-anchor="start" x="954" y="-376.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">it could use the cached tso from</text>
<text text-anchor="start" x="954" y="-361.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> the statement future to avoid get tso many times</text>
</g>
<!-- refreshForUpdateTSForRC&#45;&gt;UpdateForUpdateTS -->
<g id="edge9" class="edge">
<title>refreshForUpdateTSForRC&#45;&gt;UpdateForUpdateTS</title>
<path fill="none" stroke="#666666" d="M1120.74,-353.91C1155.82,-319.82 1214.67,-263.32 1267,-216.5 1280.22,-204.67 1294.35,-192.37 1308.31,-180.4"/>
<polygon fill="#666666" stroke="#666666" points="1310.71,-182.94 1316.04,-173.78 1306.17,-177.62 1310.71,-182.94"/>
</g>
<!-- GetSessionVars_TxnCtx_GetStmtFutureForRC -->
<g id="node11" class="node">
<title>GetSessionVars_TxnCtx_GetStmtFutureForRC</title>
<path fill="none" stroke="#1c2123" d="M1529,-402.5C1529,-402.5 1279,-402.5 1279,-402.5 1273,-402.5 1267,-396.5 1267,-390.5 1267,-390.5 1267,-378.5 1267,-378.5 1267,-372.5 1273,-366.5 1279,-366.5 1279,-366.5 1529,-366.5 1529,-366.5 1535,-366.5 1541,-372.5 1541,-378.5 1541,-378.5 1541,-390.5 1541,-390.5 1541,-396.5 1535,-402.5 1529,-402.5"/>
<text text-anchor="middle" x="1404" y="-380.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">GetSessionVars_TxnCtx_GetStmtFutureForRC</text>
</g>
<!-- refreshForUpdateTSForRC&#45;&gt;GetSessionVars_TxnCtx_GetStmtFutureForRC -->
<g id="edge10" class="edge">
<title>refreshForUpdateTSForRC&#45;&gt;GetSessionVars_TxnCtx_GetStmtFutureForRC</title>
<path fill="none" stroke="#666666" d="M1231.12,-384.5C1239.54,-384.5 1248.02,-384.5 1256.46,-384.5"/>
<polygon fill="#666666" stroke="#666666" points="1256.73,-388 1266.73,-384.5 1256.73,-381 1256.73,-388"/>
</g>
<!-- updateForUpdateTSIfNeeded -->
<g id="node12" class="node">
<title>updateForUpdateTSIfNeeded</title>
<path fill="none" stroke="#1c2123" d="M319,-326.5C319,-326.5 607,-326.5 607,-326.5 613,-326.5 619,-332.5 619,-338.5 619,-338.5 619,-390.5 619,-390.5 619,-396.5 613,-402.5 607,-402.5 607,-402.5 319,-402.5 319,-402.5 313,-402.5 307,-396.5 307,-390.5 307,-390.5 307,-338.5 307,-338.5 307,-332.5 313,-326.5 319,-326.5"/>
<text text-anchor="middle" x="463" y="-387.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">updateForUpdateTSIfNeeded</text>
<polyline fill="none" stroke="#1c2123" points="307,-379.5 619,-379.5 "/>
<text text-anchor="start" x="315" y="-364.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">更新悲观事务的ForUpdateTS if needed</text>
<text text-anchor="start" x="315" y="-349.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> PointGet executor will get conflict error</text>
<text text-anchor="start" x="315" y="-334.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> if the ForUpdateTS is older than the latest commitTS</text>
</g>
<!-- updateForUpdateTSIfNeeded&#45;&gt;UpdateForUpdateTS -->
<g id="edge11" class="edge">
<title>updateForUpdateTSIfNeeded&#45;&gt;UpdateForUpdateTS</title>
<path fill="none" stroke="#666666" d="M599.79,-326.47C791.2,-272.86 1135.82,-176.33 1304.53,-129.08"/>
<polygon fill="#666666" stroke="#666666" points="1305.72,-132.38 1314.4,-126.32 1303.83,-125.64 1305.72,-132.38"/>
</g>
<!-- updateForUpdateTSIfNeeded&#45;&gt;refreshForUpdateTSForRC -->
<g id="edge12" class="edge">
<title>updateForUpdateTSIfNeeded&#45;&gt;refreshForUpdateTSForRC</title>
<path fill="none" stroke="#666666" d="M619.14,-363.46C704.93,-363.58 813.41,-364.88 910,-369.5 918.33,-369.9 926.87,-370.38 935.48,-370.92"/>
<polygon fill="#666666" stroke="#666666" points="935.42,-374.42 945.63,-371.58 935.88,-367.44 935.42,-374.42"/>
</g>
<!-- IsPessimisticReadConsistency -->
<g id="node13" class="node">
<title>IsPessimisticReadConsistency</title>
<path fill="none" stroke="#1c2123" d="M667,-379C667,-379 898,-379 898,-379 904,-379 910,-385 910,-391 910,-391 910,-428 910,-428 910,-434 904,-440 898,-440 898,-440 667,-440 667,-440 661,-440 655,-434 655,-428 655,-428 655,-391 655,-391 655,-385 661,-379 667,-379"/>
<text text-anchor="middle" x="782.5" y="-424.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">IsPessimisticReadConsistency</text>
<polyline fill="none" stroke="#1c2123" points="655,-417 910,-417 "/>
<text text-anchor="start" x="663" y="-401.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">The Repeatable read transaction used Read </text>
<text text-anchor="start" x="663" y="-386.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> Committed level to read data for writting</text>
</g>
<!-- updateForUpdateTSIfNeeded&#45;&gt;IsPessimisticReadConsistency -->
<g id="edge13" class="edge">
<title>updateForUpdateTSIfNeeded&#45;&gt;IsPessimisticReadConsistency</title>
<path fill="none" stroke="#666666" d="M619.03,-386.47C627.63,-387.69 636.24,-388.91 644.77,-390.12"/>
<polygon fill="#666666" stroke="#666666" points="644.34,-393.59 654.73,-391.53 645.32,-386.66 644.34,-393.59"/>
</g>
<!-- IsPessimisticReadConsistency&#45;&gt;refreshForUpdateTSForRC -->
<g id="edge14" class="edge">
<title>IsPessimisticReadConsistency&#45;&gt;refreshForUpdateTSForRC</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M910.22,-399.08C918.65,-398.39 927.19,-397.68 935.73,-396.98"/>
<polygon fill="green" stroke="green" points="936.06,-400.47 945.74,-396.16 935.49,-393.49 936.06,-400.47"/>
</g>
<!-- getSnapshotTS -->
<g id="node14" class="node">
<title>getSnapshotTS</title>
<path fill="none" stroke="#1c2123" d="M397.5,-421.5C397.5,-421.5 528.5,-421.5 528.5,-421.5 534.5,-421.5 540.5,-427.5 540.5,-433.5 540.5,-433.5 540.5,-485.5 540.5,-485.5 540.5,-491.5 534.5,-497.5 528.5,-497.5 528.5,-497.5 397.5,-497.5 397.5,-497.5 391.5,-497.5 385.5,-491.5 385.5,-485.5 385.5,-485.5 385.5,-433.5 385.5,-433.5 385.5,-427.5 391.5,-421.5 397.5,-421.5"/>
<text text-anchor="middle" x="463" y="-482.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">getSnapshotTS</text>
<polyline fill="none" stroke="#1c2123" points="385.5,-474.5 540.5,-474.5 "/>
<text text-anchor="start" x="393.5" y="-459.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">returns the timestamp</text>
<text text-anchor="start" x="393.5" y="-444.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> of the snapshot</text>
<text text-anchor="start" x="393.5" y="-429.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> that a reader should read</text>
</g>
<!-- getSnapshotTS&#45;&gt;refreshForUpdateTSForRC -->
<g id="edge15" class="edge">
<title>getSnapshotTS&#45;&gt;refreshForUpdateTSForRC</title>
<path fill="none" stroke="#666666" d="M540.55,-465.33C630.02,-470.41 782.15,-473.65 910,-449.5 944.05,-443.07 980.2,-430.89 1010.93,-418.79"/>
<polygon fill="#666666" stroke="#666666" points="1012.3,-422.01 1020.29,-415.05 1009.7,-415.51 1012.3,-422.01"/>
</g>
<!-- getSnapshotTS&#45;&gt;IsPessimisticReadConsistency -->
<g id="edge16" class="edge">
<title>getSnapshotTS&#45;&gt;IsPessimisticReadConsistency</title>
<path fill="none" stroke="#666666" d="M540.86,-447.4C572.14,-442.47 609.27,-436.62 644.89,-431.01"/>
<polygon fill="#666666" stroke="#666666" points="645.55,-434.45 654.89,-429.44 644.46,-427.54 645.55,-434.45"/>
</g>
<!-- buildSelectLock -->
<g id="node15" class="node">
<title>buildSelectLock</title>
<path fill="none" stroke="#1c2123" d="M184,-498.5C184,-498.5 103,-498.5 103,-498.5 97,-498.5 91,-492.5 91,-486.5 91,-486.5 91,-474.5 91,-474.5 91,-468.5 97,-462.5 103,-462.5 103,-462.5 184,-462.5 184,-462.5 190,-462.5 196,-468.5 196,-474.5 196,-474.5 196,-486.5 196,-486.5 196,-492.5 190,-498.5 184,-498.5"/>
<text text-anchor="middle" x="143.5" y="-476.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">buildSelectLock</text>
</g>
<!-- buildSelectLock&#45;&gt;updateForUpdateTSIfNeeded -->
<g id="edge17" class="edge">
<title>buildSelectLock&#45;&gt;updateForUpdateTSIfNeeded</title>
<path fill="none" stroke="#666666" d="M196.15,-476.97C220.21,-473.51 248.43,-466.73 271,-453.5 291.92,-441.24 286.65,-425.69 307,-412.5 309.63,-410.79 312.33,-409.14 315.08,-407.55"/>
<polygon fill="#666666" stroke="#666666" points="316.95,-410.52 324.04,-402.65 313.59,-404.38 316.95,-410.52"/>
</g>
<!-- buildSelectLock&#45;&gt;getSnapshotTS -->
<g id="edge18" class="edge">
<title>buildSelectLock&#45;&gt;getSnapshotTS</title>
<path fill="none" stroke="#666666" d="M196.22,-477.08C244.62,-473.88 317.87,-469.03 375.23,-465.24"/>
<polygon fill="#666666" stroke="#666666" points="375.63,-468.72 385.38,-464.57 375.17,-461.74 375.63,-468.72"/>
</g>
<!-- buildDelete -->
<g id="node16" class="node">
<title>buildDelete</title>
<path fill="none" stroke="#1c2123" d="M171.5,-444.5C171.5,-444.5 115.5,-444.5 115.5,-444.5 109.5,-444.5 103.5,-438.5 103.5,-432.5 103.5,-432.5 103.5,-420.5 103.5,-420.5 103.5,-414.5 109.5,-408.5 115.5,-408.5 115.5,-408.5 171.5,-408.5 171.5,-408.5 177.5,-408.5 183.5,-414.5 183.5,-420.5 183.5,-420.5 183.5,-432.5 183.5,-432.5 183.5,-438.5 177.5,-444.5 171.5,-444.5"/>
<text text-anchor="middle" x="143.5" y="-422.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">buildDelete</text>
</g>
<!-- buildDelete&#45;&gt;updateForUpdateTSIfNeeded -->
<g id="edge19" class="edge">
<title>buildDelete&#45;&gt;updateForUpdateTSIfNeeded</title>
<path fill="none" stroke="#666666" d="M183.75,-418.84C212.84,-413.15 254.64,-404.99 297.03,-396.71"/>
<polygon fill="#666666" stroke="#666666" points="297.8,-400.13 306.94,-394.78 296.46,-393.26 297.8,-400.13"/>
</g>
<!-- buildUpdate -->
<g id="node17" class="node">
<title>buildUpdate</title>
<path fill="none" stroke="#1c2123" d="M173,-390.5C173,-390.5 114,-390.5 114,-390.5 108,-390.5 102,-384.5 102,-378.5 102,-378.5 102,-366.5 102,-366.5 102,-360.5 108,-354.5 114,-354.5 114,-354.5 173,-354.5 173,-354.5 179,-354.5 185,-360.5 185,-366.5 185,-366.5 185,-378.5 185,-378.5 185,-384.5 179,-390.5 173,-390.5"/>
<text text-anchor="middle" x="143.5" y="-368.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">buildUpdate</text>
</g>
<!-- buildUpdate&#45;&gt;updateForUpdateTSIfNeeded -->
<g id="edge20" class="edge">
<title>buildUpdate&#45;&gt;updateForUpdateTSIfNeeded</title>
<path fill="none" stroke="#666666" d="M185.03,-371.48C213.98,-370.75 255.01,-369.72 296.65,-368.67"/>
<polygon fill="#666666" stroke="#666666" points="296.76,-372.16 306.67,-368.41 296.59,-365.17 296.76,-372.16"/>
</g>
<!-- buildInsert -->
<g id="node18" class="node">
<title>buildInsert</title>
<path fill="none" stroke="#1c2123" d="M28,-229.5C28,-229.5 259,-229.5 259,-229.5 265,-229.5 271,-235.5 271,-241.5 271,-241.5 271,-323.5 271,-323.5 271,-329.5 265,-335.5 259,-335.5 259,-335.5 28,-335.5 28,-335.5 22,-335.5 16,-329.5 16,-323.5 16,-323.5 16,-241.5 16,-241.5 16,-235.5 22,-229.5 28,-229.5"/>
<text text-anchor="middle" x="143.5" y="-320.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">buildInsert</text>
<polyline fill="none" stroke="#1c2123" points="16,-312.5 271,-312.5 "/>
<text text-anchor="start" x="24" y="-297.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">if v.SelectPlan != nil</text>
<text text-anchor="start" x="24" y="-282.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> Try to update the forUpdateTS for</text>
<text text-anchor="start" x="24" y="-267.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> insert/replace into select statements.</text>
<text text-anchor="start" x="24" y="-252.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> Set the selectPlan parameter to nil</text>
<text text-anchor="start" x="24" y="-237.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> to make it always update the forUpdateTS.</text>
</g>
<!-- buildInsert&#45;&gt;updateForUpdateTSIfNeeded -->
<g id="edge21" class="edge">
<title>buildInsert&#45;&gt;updateForUpdateTSIfNeeded</title>
<path fill="none" stroke="#666666" d="M271.35,-315.26C282.37,-318.11 293.61,-321.01 304.83,-323.91"/>
<polygon fill="#666666" stroke="#666666" points="304.13,-327.34 314.69,-326.45 305.88,-320.57 304.13,-327.34"/>
</g>
</g>
</svg>
