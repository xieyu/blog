<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.44.1 (20200629.0846)
 -->
<!-- Title: on_check_merge Pages: 1 -->
<svg width="1354pt" height="455pt"
 viewBox="0.00 0.00 1354.00 455.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 451)">
<title>on_check_merge</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-451 1350,-451 1350,4 -4,4"/>
<!-- SignificantMsg_CatchUpLogs -->
<g id="node1" class="node">
<title>SignificantMsg_CatchUpLogs</title>
<path fill="none" stroke="#1c2123" d="M12,-332.5C12,-332.5 175,-332.5 175,-332.5 181,-332.5 187,-338.5 187,-344.5 187,-344.5 187,-419.5 187,-419.5 187,-425.5 181,-431.5 175,-431.5 175,-431.5 12,-431.5 12,-431.5 6,-431.5 0,-425.5 0,-419.5 0,-419.5 0,-344.5 0,-344.5 0,-338.5 6,-332.5 12,-332.5"/>
<text text-anchor="middle" x="93.5" y="-416.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">SignificantMsg::CatchUpLogs</text>
<polyline fill="none" stroke="#1c2123" points="0,-408.5 187,-408.5 "/>
<text text-anchor="start" x="8" y="-393.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">由本地target region</text>
<text text-anchor="start" x="8" y="-378.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 在执行commit merge消息时</text>
<text text-anchor="start" x="8" y="-363.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 发的消息</text>
<polyline fill="none" stroke="#1c2123" points="0,-355.5 187,-355.5 "/>
<text text-anchor="middle" x="93.5" y="-340.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> </text>
</g>
<!-- on_catch_up_logs_for_merge -->
<g id="node2" class="node">
<title>on_catch_up_logs_for_merge</title>
<path fill="none" stroke="#1c2123" d="M268,-317.5C268,-317.5 432,-317.5 432,-317.5 438,-317.5 444,-323.5 444,-329.5 444,-329.5 444,-434.5 444,-434.5 444,-440.5 438,-446.5 432,-446.5 432,-446.5 268,-446.5 268,-446.5 262,-446.5 256,-440.5 256,-434.5 256,-434.5 256,-329.5 256,-329.5 256,-323.5 262,-317.5 268,-317.5"/>
<text text-anchor="middle" x="350" y="-431.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">on_catch_up_logs_for_merge</text>
<polyline fill="none" stroke="#1c2123" points="256,-423.5 444,-423.5 "/>
<text text-anchor="start" x="264" y="-408.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">此时本地的source region</text>
<text text-anchor="start" x="264" y="-393.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 可能还没commit </text>
<text text-anchor="start" x="264" y="-378.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 到PrepareMerge这个消息</text>
<text text-anchor="start" x="264" y="-363.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 但source region 的leader已经</text>
<text text-anchor="start" x="264" y="-348.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> apply该消息了</text>
<polyline fill="none" stroke="#1c2123" points="256,-340.5 444,-340.5 "/>
<text text-anchor="start" x="264" y="-325.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">先设置下catch_up_logs变量</text>
</g>
<!-- SignificantMsg_CatchUpLogs&#45;&gt;on_catch_up_logs_for_merge -->
<g id="edge1" class="edge">
<title>SignificantMsg_CatchUpLogs&#45;&gt;on_catch_up_logs_for_merge</title>
<path fill="none" stroke="#666666" d="M187.1,-382C206.1,-382 226.22,-382 245.57,-382"/>
<polygon fill="#666666" stroke="#666666" points="245.62,-385.5 255.62,-382 245.62,-378.5 245.62,-385.5"/>
</g>
<!-- catch_up_logs -->
<g id="node7" class="node">
<title>catch_up_logs</title>
<path fill="#feed9b" stroke="#f7e495" d="M525,-323.5C525,-323.5 743,-323.5 743,-323.5 749,-323.5 755,-329.5 755,-335.5 755,-335.5 755,-418.5 755,-418.5 755,-424.5 749,-430.5 743,-430.5 743,-430.5 525,-430.5 525,-430.5 519,-430.5 513,-424.5 513,-418.5 513,-418.5 513,-335.5 513,-335.5 513,-329.5 519,-323.5 525,-323.5"/>
<text text-anchor="middle" x="634" y="-415.3" font-family="Times,serif" font-size="14.00" fill="#40575d">catch_up_logs</text>
<polyline fill="none" stroke="#f7e495" points="513,-407.5 755,-407.5 "/>
<text text-anchor="start" x="521" y="-392.3" font-family="Times,serif" font-size="14.00" fill="#40575d">Option&lt;CatchUpLogs&gt;</text>
<text text-anchor="start" x="521" y="-377.3" font-family="Times,serif" font-size="14.00" fill="#40575d"> pub target_region_id: u64,</text>
<polyline fill="none" stroke="#f7e495" points="513,-369.5 755,-369.5 "/>
<text text-anchor="start" x="521" y="-354.3" font-family="Times,serif" font-size="14.00" fill="#40575d">pub merge: CommitMergeRequest,</text>
<polyline fill="none" stroke="#f7e495" points="513,-346.5 755,-346.5 "/>
<text text-anchor="start" x="521" y="-331.3" font-family="Times,serif" font-size="14.00" fill="#40575d">pub logs_up_to_date: Arc&lt;AtomicU64&gt;,</text>
</g>
<!-- on_catch_up_logs_for_merge&#45;&gt;catch_up_logs -->
<g id="edge11" class="edge">
<title>on_catch_up_logs_for_merge&#45;&gt;catch_up_logs</title>
<path fill="none" stroke="#666666" d="M444.12,-380.35C462.92,-380.02 483.01,-379.66 502.82,-379.31"/>
<polygon fill="#666666" stroke="#666666" points="502.89,-382.81 512.82,-379.13 502.76,-375.81 502.89,-382.81"/>
</g>
<!-- pending_merge_state -->
<g id="node3" class="node">
<title>pending_merge_state</title>
<path fill="#feed9b" stroke="#f7e495" d="M531,-52C531,-52 737,-52 737,-52 743,-52 749,-58 749,-64 749,-64 749,-162 749,-162 749,-168 743,-174 737,-174 737,-174 531,-174 531,-174 525,-174 519,-168 519,-162 519,-162 519,-64 519,-64 519,-58 525,-52 531,-52"/>
<text text-anchor="middle" x="634" y="-158.8" font-family="Times,serif" font-size="14.00" fill="#40575d">pending_merge_state</text>
<polyline fill="none" stroke="#f7e495" points="519,-151 749,-151 "/>
<text text-anchor="start" x="527" y="-135.8" font-family="Times,serif" font-size="14.00" fill="#40575d">Option&lt;MergeState&gt;</text>
<text text-anchor="start" x="527" y="-120.8" font-family="Times,serif" font-size="14.00" fill="#40575d"> pub min_index: u64,</text>
<polyline fill="none" stroke="#f7e495" points="519,-113 749,-113 "/>
<text text-anchor="start" x="527" y="-97.8" font-family="Times,serif" font-size="14.00" fill="#40575d">pub target: ::protobuf::SingularPtrField</text>
<text text-anchor="start" x="527" y="-82.8" font-family="Times,serif" font-size="14.00" fill="#40575d"> &lt;super::metapb::Region&gt;,</text>
<polyline fill="none" stroke="#f7e495" points="519,-75 749,-75 "/>
<text text-anchor="start" x="527" y="-59.8" font-family="Times,serif" font-size="14.00" fill="#40575d">pub commit: u64,</text>
</g>
<!-- on_check_merge -->
<g id="node5" class="node">
<title>on_check_merge</title>
<path fill="none" stroke="#1c2123" d="M975.5,-229C975.5,-229 889.5,-229 889.5,-229 883.5,-229 877.5,-223 877.5,-217 877.5,-217 877.5,-205 877.5,-205 877.5,-199 883.5,-193 889.5,-193 889.5,-193 975.5,-193 975.5,-193 981.5,-193 987.5,-199 987.5,-205 987.5,-205 987.5,-217 987.5,-217 987.5,-223 981.5,-229 975.5,-229"/>
<text text-anchor="middle" x="932.5" y="-207.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">on_check_merge</text>
</g>
<!-- pending_merge_state&#45;&gt;on_check_merge -->
<g id="edge2" class="edge">
<title>pending_merge_state&#45;&gt;on_check_merge</title>
<path fill="none" stroke="#666666" d="M749.21,-150.75C789.47,-164.06 833.27,-178.53 867.85,-189.96"/>
<polygon fill="#666666" stroke="#666666" points="866.75,-193.29 877.35,-193.1 868.95,-186.64 866.75,-193.29"/>
</g>
<!-- pending_remove -->
<g id="node4" class="node">
<title>pending_remove</title>
<path fill="none" stroke="#1c2123" d="M676,-229C676,-229 592,-229 592,-229 586,-229 580,-223 580,-217 580,-217 580,-205 580,-205 580,-199 586,-193 592,-193 592,-193 676,-193 676,-193 682,-193 688,-199 688,-205 688,-205 688,-217 688,-217 688,-223 682,-229 676,-229"/>
<text text-anchor="middle" x="634" y="-207.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">pending_remove</text>
</g>
<!-- pending_remove&#45;&gt;on_check_merge -->
<g id="edge3" class="edge">
<title>pending_remove&#45;&gt;on_check_merge</title>
<path fill="none" stroke="#666666" d="M688.01,-211C738.24,-211 813.77,-211 867.37,-211"/>
<polygon fill="#666666" stroke="#666666" points="867.45,-214.5 877.45,-211 867.45,-207.5 867.45,-214.5"/>
</g>
<!-- router_force_send -->
<g id="node11" class="node">
<title>router_force_send</title>
<path fill="none" stroke="#1c2123" d="M1122,-158C1122,-158 1334,-158 1334,-158 1340,-158 1346,-164 1346,-170 1346,-170 1346,-252 1346,-252 1346,-258 1340,-264 1334,-264 1334,-264 1122,-264 1122,-264 1116,-264 1110,-258 1110,-252 1110,-252 1110,-170 1110,-170 1110,-164 1116,-158 1122,-158"/>
<text text-anchor="middle" x="1228" y="-248.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">router_force_send</text>
<polyline fill="none" stroke="#1c2123" points="1110,-241 1346,-241 "/>
<text text-anchor="start" x="1118" y="-225.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">向本地的target_id</text>
<text text-anchor="start" x="1118" y="-210.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 发送RaftCommand </text>
<text text-anchor="start" x="1118" y="-195.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 非leader的peer会丢弃该消息</text>
<text text-anchor="start" x="1118" y="-180.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> leader处理完该epoch后会将epcho +1</text>
<text text-anchor="start" x="1118" y="-165.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 避免多次重复提交</text>
</g>
<!-- on_check_merge&#45;&gt;router_force_send -->
<g id="edge13" class="edge">
<title>on_check_merge&#45;&gt;router_force_send</title>
<path fill="none" stroke="#666666" d="M987.67,-211C1019.22,-211 1060.4,-211 1099.69,-211"/>
<polygon fill="#666666" stroke="#666666" points="1099.9,-214.5 1109.9,-211 1099.9,-207.5 1099.9,-214.5"/>
</g>
<!-- on_ready_prepare_merge -->
<g id="node6" class="node">
<title>on_ready_prepare_merge</title>
<path fill="none" stroke="#1c2123" d="M245.5,-207.5C245.5,-207.5 454.5,-207.5 454.5,-207.5 460.5,-207.5 466.5,-213.5 466.5,-219.5 466.5,-219.5 466.5,-286.5 466.5,-286.5 466.5,-292.5 460.5,-298.5 454.5,-298.5 454.5,-298.5 245.5,-298.5 245.5,-298.5 239.5,-298.5 233.5,-292.5 233.5,-286.5 233.5,-286.5 233.5,-219.5 233.5,-219.5 233.5,-213.5 239.5,-207.5 245.5,-207.5"/>
<text text-anchor="middle" x="350" y="-283.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">on_ready_prepare_merge</text>
<polyline fill="none" stroke="#1c2123" points="233.5,-275.5 466.5,-275.5 "/>
<text text-anchor="start" x="241.5" y="-260.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">设置了pending_merge_state</text>
<text text-anchor="start" x="241.5" y="-245.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 如果有catch_up_logs</text>
<text text-anchor="start" x="241.5" y="-230.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 则先让ApplyFsm执行LogsUpToDate</text>
<text text-anchor="start" x="241.5" y="-215.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 否则就直接执行on_check_merge</text>
</g>
<!-- on_ready_prepare_merge&#45;&gt;pending_merge_state -->
<g id="edge4" class="edge">
<title>on_ready_prepare_merge&#45;&gt;pending_merge_state</title>
<path fill="none" stroke="#666666" d="M442.95,-207.35C464.28,-196.76 487.32,-185.32 509.75,-174.19"/>
<polygon fill="#666666" stroke="#666666" points="511.58,-177.18 518.98,-169.6 508.47,-170.92 511.58,-177.18"/>
</g>
<!-- on_ready_prepare_merge&#45;&gt;pending_remove -->
<g id="edge5" class="edge">
<title>on_ready_prepare_merge&#45;&gt;pending_remove</title>
<path fill="none" stroke="#666666" d="M466.51,-235.8C501.77,-230.54 539.23,-224.97 569.67,-220.43"/>
<polygon fill="#666666" stroke="#666666" points="570.33,-223.87 579.71,-218.94 569.3,-216.95 570.33,-223.87"/>
</g>
<!-- on_ready_prepare_merge&#45;&gt;on_check_merge -->
<g id="edge7" class="edge">
<title>on_ready_prepare_merge&#45;&gt;on_check_merge</title>
<path fill="none" stroke="#666666" d="M466.6,-252.22C547.51,-250.82 658.05,-247.18 755,-238 792.34,-234.46 833.8,-228.24 867.16,-222.66"/>
<polygon fill="#666666" stroke="#666666" points="867.96,-226.07 877.24,-220.95 866.79,-219.17 867.96,-226.07"/>
</g>
<!-- on_ready_prepare_merge&#45;&gt;catch_up_logs -->
<g id="edge6" class="edge">
<title>on_ready_prepare_merge&#45;&gt;catch_up_logs</title>
<path fill="none" stroke="#666666" d="M455.52,-298.58C462.79,-301.76 470.01,-304.93 477,-308 485.65,-311.8 494.57,-315.73 503.56,-319.69"/>
<polygon fill="#666666" stroke="#666666" points="502.38,-322.99 512.94,-323.83 505.2,-316.59 502.38,-322.99"/>
</g>
<!-- schedule_task -->
<g id="node8" class="node">
<title>schedule_task</title>
<path fill="none" stroke="#1c2123" d="M803,-305.5C803,-305.5 1062,-305.5 1062,-305.5 1068,-305.5 1074,-311.5 1074,-317.5 1074,-317.5 1074,-354.5 1074,-354.5 1074,-360.5 1068,-366.5 1062,-366.5 1062,-366.5 803,-366.5 803,-366.5 797,-366.5 791,-360.5 791,-354.5 791,-354.5 791,-317.5 791,-317.5 791,-311.5 797,-305.5 803,-305.5"/>
<text text-anchor="middle" x="932.5" y="-351.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">schedule_task</text>
<polyline fill="none" stroke="#1c2123" points="791,-343.5 1074,-343.5 "/>
<text text-anchor="start" x="799" y="-328.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">发送LogsUpToDate消息给source 的ApplyFsm</text>
<text text-anchor="start" x="799" y="-313.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> destroy source ApplyFsm</text>
</g>
<!-- on_ready_prepare_merge&#45;&gt;schedule_task -->
<g id="edge8" class="edge">
<title>on_ready_prepare_merge&#45;&gt;schedule_task</title>
<path fill="none" stroke="#666666" d="M466.73,-269.55C556.91,-282.44 682.83,-300.45 780.86,-314.46"/>
<polygon fill="#666666" stroke="#666666" points="780.47,-317.94 790.86,-315.89 781.46,-311.01 780.47,-317.94"/>
</g>
<!-- catch_up_logs&#45;&gt;schedule_task -->
<g id="edge12" class="edge">
<title>catch_up_logs&#45;&gt;schedule_task</title>
<path fill="none" stroke="#666666" d="M755.17,-360.38C763.59,-359.22 772.14,-358.04 780.7,-356.85"/>
<polygon fill="#666666" stroke="#666666" points="781.32,-360.3 790.75,-355.46 780.36,-353.37 781.32,-360.3"/>
</g>
<!-- propose_normal -->
<g id="node9" class="node">
<title>propose_normal</title>
<path fill="none" stroke="#1c2123" d="M235,-80.5C235,-80.5 465,-80.5 465,-80.5 471,-80.5 477,-86.5 477,-92.5 477,-92.5 477,-159.5 477,-159.5 477,-165.5 471,-171.5 465,-171.5 465,-171.5 235,-171.5 235,-171.5 229,-171.5 223,-165.5 223,-159.5 223,-159.5 223,-92.5 223,-92.5 223,-86.5 229,-80.5 235,-80.5"/>
<text text-anchor="middle" x="350" y="-156.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">propose_normal</text>
<polyline fill="none" stroke="#1c2123" points="223,-148.5 477,-148.5 "/>
<text text-anchor="start" x="231" y="-133.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">在设置完pending_merge_state 之后</text>
<text text-anchor="start" x="231" y="-118.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> propose_normal 对于非RollbackMerge的</text>
<text text-anchor="start" x="231" y="-103.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> propose会返回错误</text>
<text text-anchor="start" x="231" y="-88.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> Error::ProposalInMergingMode</text>
</g>
<!-- propose_normal&#45;&gt;pending_merge_state -->
<g id="edge9" class="edge">
<title>propose_normal&#45;&gt;pending_merge_state</title>
<path fill="none" stroke="#666666" d="M477.15,-120.18C487.71,-119.7 498.38,-119.21 508.92,-118.72"/>
<polygon fill="#666666" stroke="#666666" points="509.15,-122.21 518.98,-118.26 508.83,-115.22 509.15,-122.21"/>
</g>
<!-- propose_conf_change -->
<g id="node10" class="node">
<title>propose_conf_change</title>
<path fill="none" stroke="#1c2123" d="M243.5,-0.5C243.5,-0.5 456.5,-0.5 456.5,-0.5 462.5,-0.5 468.5,-6.5 468.5,-12.5 468.5,-12.5 468.5,-49.5 468.5,-49.5 468.5,-55.5 462.5,-61.5 456.5,-61.5 456.5,-61.5 243.5,-61.5 243.5,-61.5 237.5,-61.5 231.5,-55.5 231.5,-49.5 231.5,-49.5 231.5,-12.5 231.5,-12.5 231.5,-6.5 237.5,-0.5 243.5,-0.5"/>
<text text-anchor="middle" x="350" y="-46.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">propose_conf_change</text>
<polyline fill="none" stroke="#1c2123" points="231.5,-38.5 468.5,-38.5 "/>
<text text-anchor="start" x="239.5" y="-23.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">在pending_merge_state不为None时候</text>
<text text-anchor="start" x="239.5" y="-8.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 会返回Error::ProposalInMergingMode</text>
</g>
<!-- propose_conf_change&#45;&gt;pending_merge_state -->
<g id="edge10" class="edge">
<title>propose_conf_change&#45;&gt;pending_merge_state</title>
<path fill="none" stroke="#666666" d="M456.01,-61.53C473.32,-66.57 491.4,-71.83 509.12,-76.98"/>
<polygon fill="#666666" stroke="#666666" points="508.34,-80.4 518.92,-79.83 510.29,-73.67 508.34,-80.4"/>
</g>
</g>
</svg>
