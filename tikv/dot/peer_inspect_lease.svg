<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.1 (20210417.1919)
 -->
<!-- Title: lease_expire Pages: 1 -->
<svg width="1018pt" height="351pt"
 viewBox="0.00 0.00 1018.00 350.50" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 346.5)">
<title>lease_expire</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-346.5 1014,-346.5 1014,4 -4,4"/>
<!-- Peer__inspect_lease -->
<g id="node1" class="node">
<title>Peer__inspect_lease</title>
<path fill="none" stroke="#1c2123" d="M604,-133.5C604,-133.5 705,-133.5 705,-133.5 711,-133.5 717,-139.5 717,-145.5 717,-145.5 717,-212.5 717,-212.5 717,-218.5 711,-224.5 705,-224.5 705,-224.5 604,-224.5 604,-224.5 598,-224.5 592,-218.5 592,-212.5 592,-212.5 592,-145.5 592,-145.5 592,-139.5 598,-133.5 604,-133.5"/>
<text text-anchor="start" x="600" y="-209.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Peer</text>
<text text-anchor="start" x="600" y="-194.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> inspect_lease</text>
<polyline fill="none" stroke="#1c2123" points="592,-186.5 717,-186.5 "/>
<text text-anchor="start" x="600" y="-171.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">当lease返回的state</text>
<text text-anchor="start" x="600" y="-156.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 为Expired时</text>
<text text-anchor="start" x="600" y="-141.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 调用lease.expire</text>
</g>
<!-- Lease__expire -->
<g id="node2" class="node">
<title>Lease__expire</title>
<path fill="none" stroke="#1c2123" d="M856,-141C856,-141 998,-141 998,-141 1004,-141 1010,-147 1010,-153 1010,-153 1010,-205 1010,-205 1010,-211 1004,-217 998,-217 998,-217 856,-217 856,-217 850,-217 844,-211 844,-205 844,-205 844,-153 844,-153 844,-147 850,-141 856,-141"/>
<text text-anchor="start" x="852" y="-201.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">Lease</text>
<text text-anchor="start" x="852" y="-186.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> expire</text>
<polyline fill="none" stroke="#1c2123" points="844,-179 1010,-179 "/>
<text text-anchor="start" x="852" y="-163.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">将bound设置为None</text>
<text text-anchor="start" x="852" y="-148.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 将RemoteLease也清理掉</text>
</g>
<!-- Peer__inspect_lease&#45;&gt;Lease__expire -->
<g id="edge1" class="edge">
<title>Peer__inspect_lease&#45;&gt;Lease__expire</title>
<path fill="none" stroke="#666666" d="M717.1,-184.09C729,-184.89 741.38,-185.58 753,-186 779.12,-186.94 807.46,-186.43 833.49,-185.35"/>
<polygon fill="#666666" stroke="#666666" points="833.89,-188.84 843.73,-184.89 833.58,-181.84 833.89,-188.84"/>
</g>
<!-- Lease__inspect -->
<g id="node3" class="node">
<title>Lease__inspect</title>
<path fill="none" stroke="#1c2123" d="M765,-130C765,-130 796,-130 796,-130 802,-130 808,-136 808,-142 808,-142 808,-164 808,-164 808,-170 802,-176 796,-176 796,-176 765,-176 765,-176 759,-176 753,-170 753,-164 753,-164 753,-142 753,-142 753,-136 759,-130 765,-130"/>
<text text-anchor="start" x="761" y="-160.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">Lease</text>
<polyline fill="none" stroke="#1c2123" points="753,-153 808,-153 "/>
<text text-anchor="start" x="761" y="-137.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">inspect</text>
</g>
<!-- Peer__inspect_lease&#45;&gt;Lease__inspect -->
<g id="edge2" class="edge">
<title>Peer__inspect_lease&#45;&gt;Lease__inspect</title>
<path fill="none" stroke="#666666" d="M717.14,-166.08C725.94,-164.23 734.75,-162.38 742.87,-160.68"/>
<polygon fill="#666666" stroke="#666666" points="743.65,-164.09 752.72,-158.62 742.21,-157.24 743.65,-164.09"/>
</g>
<!-- Lease__inspect&#45;&gt;Lease__expire -->
<g id="edge12" class="edge">
<title>Lease__inspect&#45;&gt;Lease__expire</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M808,-157.77C815.68,-159.15 824.53,-160.74 833.87,-162.42"/>
<polygon fill="green" stroke="green" points="833.27,-165.87 843.73,-164.2 834.51,-158.98 833.27,-165.87"/>
</g>
<!-- Peer__read_index -->
<g id="node4" class="node">
<title>Peer__read_index</title>
<path fill="none" stroke="#1c2123" d="M342,-236C342,-236 530,-236 530,-236 536,-236 542,-242 542,-248 542,-248 542,-330 542,-330 542,-336 536,-342 530,-342 530,-342 342,-342 342,-342 336,-342 330,-336 330,-330 330,-330 330,-248 330,-248 330,-242 336,-236 342,-236"/>
<text text-anchor="start" x="338" y="-326.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">Peer</text>
<text text-anchor="start" x="338" y="-311.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> read_index</text>
<polyline fill="none" stroke="#1c2123" points="330,-304 542,-304 "/>
<text text-anchor="start" x="338" y="-288.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">对于Valid和Expired的</text>
<text text-anchor="start" x="338" y="-273.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> LeaseState做了特殊处理</text>
<text text-anchor="start" x="338" y="-258.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 使用pending_reads 最后一个read</text>
<text text-anchor="start" x="338" y="-243.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 的renew_lease_time</text>
</g>
<!-- Peer__read_index&#45;&gt;Peer__inspect_lease -->
<g id="edge3" class="edge">
<title>Peer__read_index&#45;&gt;Peer__inspect_lease</title>
<path fill="none" stroke="#666666" d="M541.45,-235.93C555.5,-228.79 569.64,-221.61 582.92,-214.86"/>
<polygon fill="#666666" stroke="#666666" points="584.64,-217.91 591.97,-210.26 581.47,-211.67 584.64,-217.91"/>
</g>
<!-- ReadIndexRequest__renew_lease_time -->
<g id="node8" class="node">
<title>ReadIndexRequest__renew_lease_time</title>
<path fill="#feed9b" stroke="#f7e495" d="M607,-270C607,-270 702,-270 702,-270 708,-270 714,-276 714,-282 714,-282 714,-296 714,-296 714,-302 708,-308 702,-308 702,-308 607,-308 607,-308 601,-308 595,-302 595,-296 595,-296 595,-282 595,-282 595,-276 601,-270 607,-270"/>
<text text-anchor="start" x="603" y="-292.8" font-family="Times,serif" font-size="14.00" fill="#40575d">ReadIndexRequest</text>
<text text-anchor="start" x="603" y="-277.8" font-family="Times,serif" font-size="14.00" fill="#40575d"> renew_lease_time</text>
</g>
<!-- Peer__read_index&#45;&gt;ReadIndexRequest__renew_lease_time -->
<g id="edge7" class="edge">
<title>Peer__read_index&#45;&gt;ReadIndexRequest__renew_lease_time</title>
<path fill="none" stroke="#666666" d="M542.08,-289C556.59,-289 571.17,-289 584.79,-289"/>
<polygon fill="#666666" stroke="#666666" points="585,-292.5 595,-289 585,-285.5 585,-292.5"/>
</g>
<!-- Peer__step__MsgReadIndex -->
<g id="node5" class="node">
<title>Peer__step__MsgReadIndex</title>
<path fill="none" stroke="#1c2123" d="M328,-0.5C328,-0.5 544,-0.5 544,-0.5 550,-0.5 556,-6.5 556,-12.5 556,-12.5 556,-109.5 556,-109.5 556,-115.5 550,-121.5 544,-121.5 544,-121.5 328,-121.5 328,-121.5 322,-121.5 316,-115.5 316,-109.5 316,-109.5 316,-12.5 316,-12.5 316,-6.5 322,-0.5 328,-0.5"/>
<text text-anchor="start" x="324" y="-106.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Peer</text>
<text text-anchor="start" x="324" y="-91.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> step</text>
<text text-anchor="start" x="324" y="-76.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> MsgReadIndex</text>
<polyline fill="none" stroke="#1c2123" points="316,-68.5 556,-68.5 "/>
<text text-anchor="start" x="324" y="-53.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">对于MsgReadIndex消息</text>
<text text-anchor="start" x="324" y="-38.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 如果当前leader在lease内</text>
<text text-anchor="start" x="324" y="-23.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 不用再调底层的raft_group.step了</text>
<text text-anchor="start" x="324" y="-8.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 直接返回了当前store的commit_index</text>
</g>
<!-- Peer__step__MsgReadIndex&#45;&gt;Peer__inspect_lease -->
<g id="edge4" class="edge">
<title>Peer__step__MsgReadIndex&#45;&gt;Peer__inspect_lease</title>
<path fill="none" stroke="#666666" d="M548.1,-121.56C559.98,-128.03 571.82,-134.48 583.03,-140.59"/>
<polygon fill="#666666" stroke="#666666" points="581.42,-143.7 591.88,-145.42 584.77,-137.56 581.42,-143.7"/>
</g>
<!-- RequestInspector__inspect -->
<g id="node6" class="node">
<title>RequestInspector__inspect</title>
<path fill="none" stroke="#1c2123" d="M393,-141C393,-141 479,-141 479,-141 485,-141 491,-147 491,-153 491,-153 491,-205 491,-205 491,-211 485,-217 479,-217 479,-217 393,-217 393,-217 387,-217 381,-211 381,-205 381,-205 381,-153 381,-153 381,-147 387,-141 393,-141"/>
<text text-anchor="start" x="389" y="-201.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">RequestInspector</text>
<text text-anchor="start" x="389" y="-186.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> inspect</text>
<polyline fill="none" stroke="#1c2123" points="381,-179 491,-179 "/>
<text text-anchor="start" x="389" y="-163.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">inspect raft cmd</text>
<text text-anchor="start" x="389" y="-148.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 的处理policy</text>
</g>
<!-- RequestInspector__inspect&#45;&gt;Peer__inspect_lease -->
<g id="edge5" class="edge">
<title>RequestInspector__inspect&#45;&gt;Peer__inspect_lease</title>
<path fill="none" stroke="#666666" d="M491.07,-179C518.41,-179 551.96,-179 581.45,-179"/>
<polygon fill="#666666" stroke="#666666" points="581.7,-182.5 591.7,-179 581.7,-175.5 581.7,-182.5"/>
</g>
<!-- Peer__propose -->
<g id="node7" class="node">
<title>Peer__propose</title>
<path fill="none" stroke="#1c2123" d="M171.5,-141C171.5,-141 257.5,-141 257.5,-141 263.5,-141 269.5,-147 269.5,-153 269.5,-153 269.5,-205 269.5,-205 269.5,-211 263.5,-217 257.5,-217 257.5,-217 171.5,-217 171.5,-217 165.5,-217 159.5,-211 159.5,-205 159.5,-205 159.5,-153 159.5,-153 159.5,-147 165.5,-141 171.5,-141"/>
<text text-anchor="start" x="167.5" y="-201.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">Peer</text>
<text text-anchor="start" x="167.5" y="-186.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> propose</text>
<polyline fill="none" stroke="#1c2123" points="159.5,-179 269.5,-179 "/>
<text text-anchor="start" x="167.5" y="-163.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">propose raft cmd</text>
<text text-anchor="start" x="167.5" y="-148.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 到raft group</text>
</g>
<!-- Peer__propose&#45;&gt;Peer__read_index -->
<g id="edge8" class="edge">
<title>Peer__propose&#45;&gt;Peer__read_index</title>
<path fill="none" stroke="#666666" d="M269.76,-206.19C285.33,-213.99 302.92,-222.81 320.66,-231.7"/>
<polygon fill="#666666" stroke="#666666" points="319.44,-235 329.95,-236.36 322.58,-228.75 319.44,-235"/>
</g>
<!-- Peer__propose&#45;&gt;RequestInspector__inspect -->
<g id="edge6" class="edge">
<title>Peer__propose&#45;&gt;RequestInspector__inspect</title>
<path fill="none" stroke="#666666" d="M269.76,-179C300.34,-179 338.73,-179 370.81,-179"/>
<polygon fill="#666666" stroke="#666666" points="370.99,-182.5 380.99,-179 370.99,-175.5 370.99,-182.5"/>
</g>
<!-- Peer__on_raft_message -->
<g id="node9" class="node">
<title>Peer__on_raft_message</title>
<path fill="none" stroke="#1c2123" d="M161,-35C161,-35 268,-35 268,-35 274,-35 280,-41 280,-47 280,-47 280,-99 280,-99 280,-105 274,-111 268,-111 268,-111 161,-111 161,-111 155,-111 149,-105 149,-99 149,-99 149,-47 149,-47 149,-41 155,-35 161,-35"/>
<text text-anchor="start" x="157" y="-95.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">Peer</text>
<text text-anchor="start" x="157" y="-80.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> on_raft_message</text>
<polyline fill="none" stroke="#1c2123" points="149,-73 280,-73 "/>
<text text-anchor="start" x="157" y="-57.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">处理其他节发来的</text>
<text text-anchor="start" x="157" y="-42.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> raft message</text>
</g>
<!-- Peer__on_raft_message&#45;&gt;Peer__step__MsgReadIndex -->
<g id="edge9" class="edge">
<title>Peer__on_raft_message&#45;&gt;Peer__step__MsgReadIndex</title>
<path fill="none" stroke="#666666" d="M280.17,-69.46C288.26,-69.02 296.74,-68.56 305.4,-68.09"/>
<polygon fill="#666666" stroke="#666666" points="305.83,-71.57 315.63,-67.53 305.45,-64.58 305.83,-71.57"/>
</g>
<!-- PeerFsmDelegate__handle_msgs -->
<g id="node10" class="node">
<title>PeerFsmDelegate__handle_msgs</title>
<path fill="none" stroke="#1c2123" d="M12,-101C12,-101 101,-101 101,-101 107,-101 113,-107 113,-113 113,-113 113,-127 113,-127 113,-133 107,-139 101,-139 101,-139 12,-139 12,-139 6,-139 0,-133 0,-127 0,-127 0,-113 0,-113 0,-107 6,-101 12,-101"/>
<text text-anchor="start" x="8" y="-123.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">PeerFsmDelegate</text>
<text text-anchor="start" x="8" y="-108.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> handle_msgs</text>
</g>
<!-- PeerFsmDelegate__handle_msgs&#45;&gt;Peer__propose -->
<g id="edge11" class="edge">
<title>PeerFsmDelegate__handle_msgs&#45;&gt;Peer__propose</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M108.15,-139.16C121.45,-144.19 135.96,-149.68 149.85,-154.93"/>
<polygon fill="green" stroke="green" points="148.75,-158.25 159.34,-158.52 151.23,-151.71 148.75,-158.25"/>
</g>
<!-- PeerFsmDelegate__handle_msgs&#45;&gt;Peer__on_raft_message -->
<g id="edge10" class="edge">
<title>PeerFsmDelegate__handle_msgs&#45;&gt;Peer__on_raft_message</title>
<path fill="none" stroke="#666666" d="M113.38,-103.16C121.76,-100.64 130.52,-98 139.22,-95.38"/>
<polygon fill="#666666" stroke="#666666" points="140.42,-98.67 148.98,-92.44 138.4,-91.97 140.42,-98.67"/>
</g>
</g>
</svg>
