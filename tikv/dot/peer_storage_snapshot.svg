<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.0 (20210316.0004)
 -->
<!-- Title: Storage Pages: 1 -->
<svg width="1184pt" height="593pt"
 viewBox="0.00 0.00 1184.00 592.99" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 588.99)">
<title>Storage</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-588.99 1180,-588.99 1180,4 -4,4"/>
<g id="clust3" class="cluster">
<title>cluster_Peer</title>
<path fill="none" stroke="slategrey" stroke-dasharray="5,2" d="M298,-8C298,-8 737,-8 737,-8 743,-8 749,-14 749,-20 749,-20 749,-104 749,-104 749,-110 743,-116 737,-116 737,-116 298,-116 298,-116 292,-116 286,-110 286,-104 286,-104 286,-20 286,-20 286,-14 292,-8 298,-8"/>
<text text-anchor="middle" x="517.5" y="-96" font-family="Times,serif" font-size="20.00">Peer</text>
</g>
<!-- snapshot -->
<g id="node1" class="node">
<title>snapshot</title>
<path fill="none" stroke="#1c2123" d="M52,-336C52,-336 12,-336 12,-336 6,-336 0,-330 0,-324 0,-324 0,-312 0,-312 0,-306 6,-300 12,-300 12,-300 52,-300 52,-300 58,-300 64,-306 64,-312 64,-312 64,-324 64,-324 64,-330 58,-336 52,-336"/>
<text text-anchor="middle" x="32" y="-314.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">snapshot</text>
</g>
<!-- snap_state -->
<g id="node2" class="node">
<title>snap_state</title>
<path fill="#feed9b" stroke="#f7e495" d="M798.5,-495C798.5,-495 971.5,-495 971.5,-495 977.5,-495 983.5,-501 983.5,-507 983.5,-507 983.5,-529 983.5,-529 983.5,-535 977.5,-541 971.5,-541 971.5,-541 798.5,-541 798.5,-541 792.5,-541 786.5,-535 786.5,-529 786.5,-529 786.5,-507 786.5,-507 786.5,-501 792.5,-495 798.5,-495"/>
<text text-anchor="middle" x="885" y="-525.8" font-family="Times,serif" font-size="14.00" fill="#40575d">snap_state</text>
<polyline fill="none" stroke="#f7e495" points="786.5,-518 983.5,-518 "/>
<text text-anchor="start" x="794.5" y="-502.8" font-family="Times,serif" font-size="14.00" fill="#40575d">snap_state: RefCell&lt;SnapState&gt;,</text>
</g>
<!-- snapshot&#45;&gt;snap_state -->
<g id="edge1" class="edge">
<title>snapshot&#45;&gt;snap_state</title>
<path fill="none" stroke="#666666" d="M34.56,-336.05C38.6,-370.52 52.65,-445.46 100,-481 305.8,-635.5 634.62,-582.18 792.96,-543.59"/>
<polygon fill="#666666" stroke="#666666" points="794.27,-546.87 803.14,-541.07 792.59,-540.07 794.27,-546.87"/>
</g>
<!-- snap_tried_cnt -->
<g id="node3" class="node">
<title>snap_tried_cnt</title>
<path fill="none" stroke="#1c2123" d="M215,-160C215,-160 143,-160 143,-160 137,-160 131,-154 131,-148 131,-148 131,-136 131,-136 131,-130 137,-124 143,-124 143,-124 215,-124 215,-124 221,-124 227,-130 227,-136 227,-136 227,-148 227,-148 227,-154 221,-160 215,-160"/>
<text text-anchor="middle" x="179" y="-138.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">snap_tried_cnt</text>
</g>
<!-- snapshot&#45;&gt;snap_tried_cnt -->
<g id="edge2" class="edge">
<title>snapshot&#45;&gt;snap_tried_cnt</title>
<path fill="none" stroke="#666666" d="M36.97,-299.53C44.35,-269.39 62.91,-209.42 100,-174 106.24,-168.04 113.74,-163.13 121.59,-159.1"/>
<polygon fill="#666666" stroke="#666666" points="123.32,-162.16 130.91,-154.77 120.37,-155.81 123.32,-162.16"/>
</g>
<!-- try_recv -->
<g id="node4" class="node">
<title>try_recv</title>
<path fill="none" stroke="#1c2123" d="M904,-460C904,-460 866,-460 866,-460 860,-460 854,-454 854,-448 854,-448 854,-436 854,-436 854,-430 860,-424 866,-424 866,-424 904,-424 904,-424 910,-424 916,-430 916,-436 916,-436 916,-448 916,-448 916,-454 910,-460 904,-460"/>
<text text-anchor="middle" x="885" y="-438.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">try_recv</text>
</g>
<!-- snapshot&#45;&gt;try_recv -->
<g id="edge3" class="edge">
<title>snapshot&#45;&gt;try_recv</title>
<path fill="none" stroke="#666666" d="M59.94,-336.02C71.87,-343.49 86.29,-351.83 100,-358 179.09,-393.58 200.59,-401.95 286,-417 493.13,-453.51 746.56,-447.91 843.59,-443.97"/>
<polygon fill="#666666" stroke="#666666" points="843.99,-447.46 853.83,-443.54 843.69,-440.46 843.99,-447.46"/>
</g>
<!-- validate_snap -->
<g id="node5" class="node">
<title>validate_snap</title>
<path fill="none" stroke="#1c2123" d="M1039,-366C1039,-366 1164,-366 1164,-366 1170,-366 1176,-372 1176,-378 1176,-378 1176,-400 1176,-400 1176,-406 1170,-412 1164,-412 1164,-412 1039,-412 1039,-412 1033,-412 1027,-406 1027,-400 1027,-400 1027,-378 1027,-378 1027,-372 1033,-366 1039,-366"/>
<text text-anchor="middle" x="1101.5" y="-396.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">validate_snap</text>
<polyline fill="none" stroke="#1c2123" points="1027,-389 1176,-389 "/>
<text text-anchor="start" x="1035" y="-373.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">验证snapshot是否有效</text>
</g>
<!-- snapshot&#45;&gt;validate_snap -->
<g id="edge4" class="edge">
<title>snapshot&#45;&gt;validate_snap</title>
<path fill="none" stroke="#666666" d="M64.39,-322.01C124.35,-329.3 259.37,-344 373.5,-344 373.5,-344 373.5,-344 618,-344 758.37,-344 920.72,-363.11 1016.77,-376.43"/>
<polygon fill="#666666" stroke="#666666" points="1016.33,-379.9 1026.72,-377.82 1017.3,-372.97 1016.33,-379.9"/>
</g>
<!-- SnapState_Generating -->
<g id="node6" class="node">
<title>SnapState_Generating</title>
<path fill="none" stroke="#1c2123" d="M673.5,-498C673.5,-498 560.5,-498 560.5,-498 554.5,-498 548.5,-492 548.5,-486 548.5,-486 548.5,-474 548.5,-474 548.5,-468 554.5,-462 560.5,-462 560.5,-462 673.5,-462 673.5,-462 679.5,-462 685.5,-468 685.5,-474 685.5,-474 685.5,-486 685.5,-486 685.5,-492 679.5,-498 673.5,-498"/>
<text text-anchor="middle" x="617" y="-476.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">SnapState_Generating</text>
</g>
<!-- snapshot&#45;&gt;SnapState_Generating -->
<g id="edge5" class="edge">
<title>snapshot&#45;&gt;SnapState_Generating</title>
<path fill="none" stroke="#666666" d="M36.32,-336.34C42.76,-366 60.01,-423.82 100,-450 170.01,-495.83 411.89,-490.81 538.05,-484.7"/>
<polygon fill="#666666" stroke="#666666" points="538.6,-488.18 548.41,-484.18 538.25,-481.19 538.6,-488.18"/>
</g>
<!-- GenSnapTask -->
<g id="node7" class="node">
<title>GenSnapTask</title>
<path fill="#79d8ce" stroke="#60b5ac" d="M503,-217C503,-217 731,-217 731,-217 737,-217 743,-223 743,-229 743,-229 743,-297 743,-297 743,-303 737,-309 731,-309 731,-309 503,-309 503,-309 497,-309 491,-303 491,-297 491,-297 491,-229 491,-229 491,-223 497,-217 503,-217"/>
<text text-anchor="middle" x="617" y="-293.8" font-family="Times,serif" font-size="14.00" fill="#5d6179">GenSnapTask</text>
<polyline fill="none" stroke="#60b5ac" points="491,-286 743,-286 "/>
<text text-anchor="start" x="499" y="-270.8" font-family="Times,serif" font-size="14.00" fill="#5d6179">pub(crate) region_id: u64,</text>
<polyline fill="none" stroke="#60b5ac" points="491,-263 743,-263 "/>
<text text-anchor="start" x="499" y="-247.8" font-family="Times,serif" font-size="14.00" fill="#5d6179">snap_notifier: SyncSender&lt;RaftSnapshot&gt;,</text>
<polyline fill="none" stroke="#60b5ac" points="491,-240 743,-240 "/>
<text text-anchor="start" x="499" y="-224.8" font-family="Times,serif" font-size="14.00" fill="#5d6179">for_balance: bool,</text>
</g>
<!-- snapshot&#45;&gt;GenSnapTask -->
<g id="edge6" class="edge">
<title>snapshot&#45;&gt;GenSnapTask</title>
<path fill="none" stroke="#666666" d="M48.01,-299.89C60.41,-286.33 79.28,-268.68 100,-260 245.64,-198.94 297.33,-236.21 455,-245 463.38,-245.47 471.99,-246.07 480.66,-246.77"/>
<polygon fill="#666666" stroke="#666666" points="480.61,-250.28 490.87,-247.63 481.2,-243.3 480.61,-250.28"/>
</g>
<!-- gen_snap_task -->
<g id="node8" class="node">
<title>gen_snap_task</title>
<path fill="#feed9b" stroke="#f7e495" d="M791,-157.5C791,-157.5 979,-157.5 979,-157.5 985,-157.5 991,-163.5 991,-169.5 991,-169.5 991,-206.5 991,-206.5 991,-212.5 985,-218.5 979,-218.5 979,-218.5 791,-218.5 791,-218.5 785,-218.5 779,-212.5 779,-206.5 779,-206.5 779,-169.5 779,-169.5 779,-163.5 785,-157.5 791,-157.5"/>
<text text-anchor="middle" x="885" y="-203.3" font-family="Times,serif" font-size="14.00" fill="#40575d">gen_snap_task</text>
<polyline fill="none" stroke="#f7e495" points="779,-195.5 991,-195.5 "/>
<text text-anchor="start" x="787" y="-180.3" font-family="Times,serif" font-size="14.00" fill="#40575d">成员变量gen_snap_task:</text>
<text text-anchor="start" x="787" y="-165.3" font-family="Times,serif" font-size="14.00" fill="#40575d"> RefCell&lt;Option&lt;GenSnapTask&gt;&gt;,</text>
</g>
<!-- snapshot&#45;&gt;gen_snap_task -->
<g id="edge7" class="edge">
<title>snapshot&#45;&gt;gen_snap_task</title>
<path fill="none" stroke="#666666" d="M39.62,-299.81C49.07,-276.83 68.82,-238.2 100,-221 211.69,-159.37 579.53,-170.25 768.98,-180.53"/>
<polygon fill="#666666" stroke="#666666" points="768.79,-184.03 778.97,-181.08 769.18,-177.04 768.79,-184.03"/>
</g>
<!-- sync_channel -->
<g id="node9" class="node">
<title>sync_channel</title>
<path fill="none" stroke="#1c2123" d="M112,-269C112,-269 246,-269 246,-269 252,-269 258,-275 258,-281 258,-281 258,-303 258,-303 258,-309 252,-315 246,-315 246,-315 112,-315 112,-315 106,-315 100,-309 100,-303 100,-303 100,-281 100,-281 100,-275 106,-269 112,-269"/>
<text text-anchor="middle" x="179" y="-299.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">sync_channel</text>
<polyline fill="none" stroke="#1c2123" points="100,-292 258,-292 "/>
<text text-anchor="middle" x="179" y="-276.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">使用一个同步的channel</text>
</g>
<!-- snapshot&#45;&gt;sync_channel -->
<g id="edge8" class="edge">
<title>snapshot&#45;&gt;sync_channel</title>
<path fill="none" stroke="#666666" d="M64.11,-312.42C71.93,-311.02 80.72,-309.44 89.85,-307.81"/>
<polygon fill="#666666" stroke="#666666" points="90.65,-311.22 99.88,-306.01 89.42,-304.33 90.65,-311.22"/>
</g>
<!-- try_recv&#45;&gt;validate_snap -->
<g id="edge17" class="edge">
<title>try_recv&#45;&gt;validate_snap</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M916.28,-434.52C942.46,-428.05 981.57,-418.39 1017.03,-409.63"/>
<polygon fill="green" stroke="green" points="1018.05,-412.98 1026.92,-407.18 1016.37,-406.18 1018.05,-412.98"/>
</g>
<!-- SnapState_Generating&#45;&gt;snap_state -->
<g id="edge9" class="edge">
<title>SnapState_Generating&#45;&gt;snap_state</title>
<path fill="none" stroke="#666666" d="M685.81,-489.69C713.26,-493.61 745.64,-498.23 776.17,-502.6"/>
<polygon fill="#666666" stroke="#666666" points="776.05,-506.11 786.45,-504.06 777.04,-499.18 776.05,-506.11"/>
</g>
<!-- SnapState_Generating&#45;&gt;try_recv -->
<g id="edge12" class="edge">
<title>SnapState_Generating&#45;&gt;try_recv</title>
<path fill="none" stroke="#666666" d="M685.81,-464.34C735.76,-455.91 802,-446.77 843.83,-442.74"/>
<polygon fill="#666666" stroke="#666666" points="844.26,-446.22 853.91,-441.83 843.63,-439.24 844.26,-446.22"/>
</g>
<!-- SnapState_Generating&#45;&gt;try_recv -->
<g id="edge16" class="edge">
<title>SnapState_Generating&#45;&gt;try_recv</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M685.81,-476.28C735.87,-470.43 802.29,-460.62 844.09,-452.69"/>
<polygon fill="green" stroke="green" points="844.76,-456.12 853.91,-450.77 843.42,-449.25 844.76,-456.12"/>
</g>
<!-- GenSnapTask&#45;&gt;gen_snap_task -->
<g id="edge15" class="edge">
<title>GenSnapTask&#45;&gt;gen_snap_task</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M743.21,-227.7C751.73,-225.29 760.3,-222.88 768.77,-220.49"/>
<polygon fill="green" stroke="green" points="769.98,-223.79 778.65,-217.7 768.08,-217.05 769.98,-223.79"/>
</g>
<!-- tx -->
<g id="node10" class="node">
<title>tx</title>
<path fill="none" stroke="#1c2123" d="M321,-254.5C321,-254.5 428,-254.5 428,-254.5 434,-254.5 440,-260.5 440,-266.5 440,-266.5 440,-303.5 440,-303.5 440,-309.5 434,-315.5 428,-315.5 428,-315.5 321,-315.5 321,-315.5 315,-315.5 309,-309.5 309,-303.5 309,-303.5 309,-266.5 309,-266.5 309,-260.5 315,-254.5 321,-254.5"/>
<text text-anchor="middle" x="374.5" y="-300.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">tx</text>
<polyline fill="none" stroke="#1c2123" points="309,-292.5 440,-292.5 "/>
<text text-anchor="start" x="317" y="-277.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">发送端，用来触发</text>
<text text-anchor="middle" x="374.5" y="-262.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> snapshot已准备好</text>
</g>
<!-- sync_channel&#45;&gt;tx -->
<g id="edge10" class="edge">
<title>sync_channel&#45;&gt;tx</title>
<path fill="none" stroke="#666666" d="M258.15,-289.17C271.52,-288.69 285.39,-288.19 298.67,-287.71"/>
<polygon fill="#666666" stroke="#666666" points="298.83,-291.2 308.7,-287.34 298.58,-284.21 298.83,-291.2"/>
</g>
<!-- rx -->
<g id="node11" class="node">
<title>rx</title>
<path fill="none" stroke="#1c2123" d="M389.5,-408C389.5,-408 359.5,-408 359.5,-408 353.5,-408 347.5,-402 347.5,-396 347.5,-396 347.5,-384 347.5,-384 347.5,-378 353.5,-372 359.5,-372 359.5,-372 389.5,-372 389.5,-372 395.5,-372 401.5,-378 401.5,-384 401.5,-384 401.5,-396 401.5,-396 401.5,-402 395.5,-408 389.5,-408"/>
<text text-anchor="middle" x="374.5" y="-386.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">rx</text>
</g>
<!-- sync_channel&#45;&gt;rx -->
<g id="edge11" class="edge">
<title>sync_channel&#45;&gt;rx</title>
<path fill="none" stroke="#666666" d="M225.86,-315.22C260.19,-332.61 306.48,-356.06 338.01,-372.03"/>
<polygon fill="#666666" stroke="#666666" points="336.8,-375.33 347.3,-376.73 339.96,-369.09 336.8,-375.33"/>
</g>
<!-- tx&#45;&gt;GenSnapTask -->
<g id="edge14" class="edge">
<title>tx&#45;&gt;GenSnapTask</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M440.27,-279.08C452.92,-277.92 466.62,-276.67 480.59,-275.39"/>
<polygon fill="green" stroke="green" points="481.17,-278.85 490.81,-274.45 480.53,-271.88 481.17,-278.85"/>
</g>
<!-- rx&#45;&gt;SnapState_Generating -->
<g id="edge13" class="edge">
<title>rx&#45;&gt;SnapState_Generating</title>
<path fill="none" stroke="#666666" d="M401.7,-399.8C439.02,-413.77 508.48,-439.76 558.21,-458.37"/>
<polygon fill="#666666" stroke="#666666" points="557.28,-461.76 567.87,-461.99 559.74,-455.21 557.28,-461.76"/>
</g>
<!-- take_gen_snap_task -->
<g id="node12" class="node">
<title>take_gen_snap_task</title>
<path fill="none" stroke="#1c2123" d="M667.5,-160C667.5,-160 566.5,-160 566.5,-160 560.5,-160 554.5,-154 554.5,-148 554.5,-148 554.5,-136 554.5,-136 554.5,-130 560.5,-124 566.5,-124 566.5,-124 667.5,-124 667.5,-124 673.5,-124 679.5,-130 679.5,-136 679.5,-136 679.5,-148 679.5,-148 679.5,-154 673.5,-160 667.5,-160"/>
<text text-anchor="middle" x="617" y="-138.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">take_gen_snap_task</text>
</g>
<!-- take_gen_snap_task&#45;&gt;gen_snap_task -->
<g id="edge18" class="edge">
<title>take_gen_snap_task&#45;&gt;gen_snap_task</title>
<path fill="none" stroke="#666666" d="M679.69,-152.67C706.28,-157.27 738.27,-162.8 768.96,-168.11"/>
<polygon fill="#666666" stroke="#666666" points="768.42,-171.56 778.87,-169.82 769.61,-164.67 768.42,-171.56"/>
</g>
<!-- handle_raft_ready_append -->
<g id="node13" class="node">
<title>handle_raft_ready_append</title>
<path fill="none" stroke="#1c2123" d="M443,-71C443,-71 306,-71 306,-71 300,-71 294,-65 294,-59 294,-59 294,-47 294,-47 294,-41 300,-35 306,-35 306,-35 443,-35 443,-35 449,-35 455,-41 455,-47 455,-47 455,-59 455,-59 455,-65 449,-71 443,-71"/>
<text text-anchor="middle" x="374.5" y="-49.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">handle_raft_ready_append</text>
</g>
<!-- handle_raft_ready_append&#45;&gt;take_gen_snap_task -->
<g id="edge19" class="edge">
<title>handle_raft_ready_append&#45;&gt;take_gen_snap_task</title>
<path fill="none" stroke="#666666" d="M400.81,-71.21C423.39,-86.56 457.9,-107.92 491,-120 507.78,-126.13 526.48,-130.58 544.18,-133.8"/>
<polygon fill="#666666" stroke="#666666" points="544.03,-137.33 554.48,-135.56 545.21,-130.43 544.03,-137.33"/>
</g>
<!-- schedule_task_ApplyTask -->
<g id="node14" class="node">
<title>schedule_task_ApplyTask</title>
<path fill="none" stroke="#1c2123" d="M505,-16.5C505,-16.5 729,-16.5 729,-16.5 735,-16.5 741,-22.5 741,-28.5 741,-28.5 741,-65.5 741,-65.5 741,-71.5 735,-77.5 729,-77.5 729,-77.5 505,-77.5 505,-77.5 499,-77.5 493,-71.5 493,-65.5 493,-65.5 493,-28.5 493,-28.5 493,-22.5 499,-16.5 505,-16.5"/>
<text text-anchor="start" x="501" y="-62.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">让apply线程生成snapshot</text>
<text text-anchor="start" x="501" y="-47.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> ApplyTask::Snapshot</text>
<polyline fill="none" stroke="#1c2123" points="493,-39.5 741,-39.5 "/>
<text text-anchor="start" x="501" y="-24.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">apply_router.schedule_task(self.region_id,</text>
</g>
<!-- handle_raft_ready_append&#45;&gt;schedule_task_ApplyTask -->
<g id="edge20" class="edge">
<title>handle_raft_ready_append&#45;&gt;schedule_task_ApplyTask</title>
<path fill="none" stroke="#666666" d="M455.25,-51.01C464.09,-50.79 473.25,-50.56 482.53,-50.33"/>
<polygon fill="#666666" stroke="#666666" points="482.71,-53.83 492.62,-50.08 482.53,-46.83 482.71,-53.83"/>
</g>
</g>
</svg>
