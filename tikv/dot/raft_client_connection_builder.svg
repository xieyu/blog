<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.1 (20210417.1919)
 -->
<!-- Title: connection_builder Pages: 1 -->
<svg width="1110pt" height="358pt"
 viewBox="0.00 0.00 1110.00 357.50" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 353.5)">
<title>connection_builder</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-353.5 1106,-353.5 1106,4 -4,4"/>
<!-- RaftClient -->
<g id="node1" class="node">
<title>RaftClient</title>
<path fill="none" stroke="#1c2123" d="M12,-150C12,-150 264,-150 264,-150 270,-150 276,-156 276,-162 276,-162 276,-337 276,-337 276,-343 270,-349 264,-349 264,-349 12,-349 12,-349 6,-349 0,-343 0,-337 0,-337 0,-162 0,-162 0,-156 6,-150 12,-150"/>
<text text-anchor="middle" x="138" y="-333.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">RaftClient</text>
<polyline fill="none" stroke="#1c2123" points="0,-326 276,-326 "/>
<text text-anchor="start" x="8" y="-310.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">管理connection</text>
<text text-anchor="start" x="8" y="-295.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 发消息时，先调用send，最后flush</text>
<polyline fill="none" stroke="#1c2123" points="0,-288 276,-288 "/>
<text text-anchor="start" x="8" y="-272.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">pool: Arc&lt;Mutex&lt;ConnectionPool&gt;&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="0,-265 276,-265 "/>
<text text-anchor="start" x="8" y="-249.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">cache: LruCache&lt;(u64, usize), CachedQueue&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="0,-242 276,-242 "/>
<text text-anchor="start" x="8" y="-226.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">need_flush: Vec&lt;(u64, usize)&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="0,-219 276,-219 "/>
<text text-anchor="start" x="8" y="-203.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">full_stores: Vec&lt;(u64, usize)&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="0,-196 276,-196 "/>
<text text-anchor="start" x="8" y="-180.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">future_pool: Arc&lt;ThreadPool&lt;TaskCell&gt;&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="0,-173 276,-173 "/>
<text text-anchor="start" x="8" y="-157.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">builder: ConnectionBuilder&lt;S, R&gt;,</text>
</g>
<!-- ConnectionBuilder -->
<g id="node2" class="node">
<title>ConnectionBuilder</title>
<path fill="none" stroke="#1c2123" d="M324,-42.5C324,-42.5 535,-42.5 535,-42.5 541,-42.5 547,-48.5 547,-54.5 547,-54.5 547,-244.5 547,-244.5 547,-250.5 541,-256.5 535,-256.5 535,-256.5 324,-256.5 324,-256.5 318,-256.5 312,-250.5 312,-244.5 312,-244.5 312,-54.5 312,-54.5 312,-48.5 318,-42.5 324,-42.5"/>
<text text-anchor="middle" x="429.5" y="-241.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">ConnectionBuilder</text>
<polyline fill="none" stroke="#1c2123" points="312,-233.5 547,-233.5 "/>
<text text-anchor="start" x="320" y="-218.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">resolve store addr</text>
<text text-anchor="start" x="320" y="-203.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 用于创建connection</text>
<text text-anchor="start" x="320" y="-188.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 创建grpc channel</text>
<polyline fill="none" stroke="#1c2123" points="312,-180.5 547,-180.5 "/>
<text text-anchor="start" x="320" y="-165.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">env: Arc&lt;Environment&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="312,-157.5 547,-157.5 "/>
<text text-anchor="start" x="320" y="-142.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">cfg: Arc&lt;Config&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="312,-134.5 547,-134.5 "/>
<text text-anchor="start" x="320" y="-119.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">security_mgr: Arc&lt;SecurityManager&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="312,-111.5 547,-111.5 "/>
<text text-anchor="start" x="320" y="-96.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">resolver: S,</text>
<polyline fill="none" stroke="#1c2123" points="312,-88.5 547,-88.5 "/>
<text text-anchor="start" x="320" y="-73.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">router: R,</text>
<polyline fill="none" stroke="#1c2123" points="312,-65.5 547,-65.5 "/>
<text text-anchor="start" x="320" y="-50.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">snap_scheduler: Scheduler&lt;SnapTask&gt;,</text>
</g>
<!-- RaftClient&#45;&gt;ConnectionBuilder -->
<g id="edge1" class="edge">
<title>RaftClient&#45;&gt;ConnectionBuilder</title>
<path fill="none" stroke="#666666" d="M276.12,-202.14C284.83,-199.13 293.57,-196.11 302.23,-193.12"/>
<polygon fill="#666666" stroke="#666666" points="303.64,-196.33 311.95,-189.76 301.36,-189.72 303.64,-196.33"/>
</g>
<!-- StoreAddrResolver -->
<g id="node3" class="node">
<title>StoreAddrResolver</title>
<path fill="none" stroke="#1c2123" d="M617.5,-206.5C617.5,-206.5 748.5,-206.5 748.5,-206.5 754.5,-206.5 760.5,-212.5 760.5,-218.5 760.5,-218.5 760.5,-240.5 760.5,-240.5 760.5,-246.5 754.5,-252.5 748.5,-252.5 748.5,-252.5 617.5,-252.5 617.5,-252.5 611.5,-252.5 605.5,-246.5 605.5,-240.5 605.5,-240.5 605.5,-218.5 605.5,-218.5 605.5,-212.5 611.5,-206.5 617.5,-206.5"/>
<text text-anchor="middle" x="683" y="-237.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">StoreAddrResolver</text>
<polyline fill="none" stroke="#1c2123" points="605.5,-229.5 760.5,-229.5 "/>
<text text-anchor="middle" x="683" y="-214.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">解析store_id对应的addr</text>
</g>
<!-- ConnectionBuilder&#45;&gt;StoreAddrResolver -->
<g id="edge2" class="edge">
<title>ConnectionBuilder&#45;&gt;StoreAddrResolver</title>
<path fill="none" stroke="#666666" d="M547.05,-186.57C564.88,-192.24 582.96,-197.99 599.84,-203.36"/>
<polygon fill="#666666" stroke="#666666" points="599.04,-206.78 609.63,-206.48 601.16,-200.11 599.04,-206.78"/>
</g>
<!-- Scheduler_SnapTask -->
<g id="node4" class="node">
<title>Scheduler_SnapTask</title>
<path fill="none" stroke="#1c2123" d="M639,-111.5C639,-111.5 727,-111.5 727,-111.5 733,-111.5 739,-117.5 739,-123.5 739,-123.5 739,-175.5 739,-175.5 739,-181.5 733,-187.5 727,-187.5 727,-187.5 639,-187.5 639,-187.5 633,-187.5 627,-181.5 627,-175.5 627,-175.5 627,-123.5 627,-123.5 627,-117.5 633,-111.5 639,-111.5"/>
<text text-anchor="middle" x="683" y="-172.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Scheduler</text>
<text text-anchor="middle" x="683" y="-157.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">SnapTask</text>
<polyline fill="none" stroke="#1c2123" points="627,-149.5 739,-149.5 "/>
<text text-anchor="start" x="635" y="-134.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">使用snap worker</text>
<text text-anchor="start" x="635" y="-119.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 发送SnapTask</text>
</g>
<!-- ConnectionBuilder&#45;&gt;Scheduler_SnapTask -->
<g id="edge3" class="edge">
<title>ConnectionBuilder&#45;&gt;Scheduler_SnapTask</title>
<path fill="none" stroke="#666666" d="M547.05,-149.5C571.01,-149.5 595.42,-149.5 616.77,-149.5"/>
<polygon fill="#666666" stroke="#666666" points="616.99,-153 626.99,-149.5 616.99,-146 616.99,-153"/>
</g>
<!-- Environment -->
<g id="node7" class="node">
<title>Environment</title>
<path fill="none" stroke="#1c2123" d="M595,-0.5C595,-0.5 771,-0.5 771,-0.5 777,-0.5 783,-6.5 783,-12.5 783,-12.5 783,-80.5 783,-80.5 783,-86.5 777,-92.5 771,-92.5 771,-92.5 595,-92.5 595,-92.5 589,-92.5 583,-86.5 583,-80.5 583,-80.5 583,-12.5 583,-12.5 583,-6.5 589,-0.5 595,-0.5"/>
<text text-anchor="middle" x="683" y="-77.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Environment</text>
<polyline fill="none" stroke="#1c2123" points="583,-69.5 783,-69.5 "/>
<text text-anchor="start" x="591" y="-54.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">cqs: Vec&lt;CompletionQueue&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="583,-46.5 783,-46.5 "/>
<text text-anchor="start" x="591" y="-31.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">idx: AtomicUsize,</text>
<polyline fill="none" stroke="#1c2123" points="583,-23.5 783,-23.5 "/>
<text text-anchor="start" x="591" y="-8.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">_handles: Vec&lt;JoinHandle&lt;()&gt;&gt;,</text>
</g>
<!-- ConnectionBuilder&#45;&gt;Environment -->
<g id="edge6" class="edge">
<title>ConnectionBuilder&#45;&gt;Environment</title>
<path fill="none" stroke="#666666" d="M547.05,-101.77C555.82,-98.17 564.66,-94.56 573.38,-90.98"/>
<polygon fill="#666666" stroke="#666666" points="574.87,-94.16 582.8,-87.13 572.22,-87.68 574.87,-94.16"/>
</g>
<!-- PdStoreAddrResolver -->
<g id="node5" class="node">
<title>PdStoreAddrResolver</title>
<path fill="none" stroke="#1c2123" d="M831,-180C831,-180 962,-180 962,-180 968,-180 974,-186 974,-192 974,-192 974,-267 974,-267 974,-273 968,-279 962,-279 962,-279 831,-279 831,-279 825,-279 819,-273 819,-267 819,-267 819,-192 819,-192 819,-186 825,-180 831,-180"/>
<text text-anchor="middle" x="896.5" y="-263.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">PdStoreAddrResolver</text>
<polyline fill="none" stroke="#1c2123" points="819,-256 974,-256 "/>
<text text-anchor="start" x="827" y="-240.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">sched: Scheduler&lt;Task&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="819,-233 974,-233 "/>
<text text-anchor="start" x="827" y="-217.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">发送请求给Pd worker</text>
<text text-anchor="start" x="827" y="-202.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 去Pd服务请求store_id</text>
<text text-anchor="start" x="827" y="-187.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 对应的store addr</text>
</g>
<!-- StoreAddrResolver&#45;&gt;PdStoreAddrResolver -->
<g id="edge4" class="edge">
<title>StoreAddrResolver&#45;&gt;PdStoreAddrResolver</title>
<path fill="none" stroke="#666666" d="M760.66,-229.5C776.17,-229.5 792.59,-229.5 808.44,-229.5"/>
<polygon fill="#666666" stroke="#666666" points="808.75,-233 818.75,-229.5 808.75,-226 808.75,-233"/>
</g>
<!-- resolve_Task -->
<g id="node6" class="node">
<title>resolve_Task</title>
<path fill="none" stroke="#1c2123" d="M1022,-195C1022,-195 1090,-195 1090,-195 1096,-195 1102,-201 1102,-207 1102,-207 1102,-252 1102,-252 1102,-258 1096,-264 1090,-264 1090,-264 1022,-264 1022,-264 1016,-264 1010,-258 1010,-252 1010,-252 1010,-207 1010,-207 1010,-201 1016,-195 1022,-195"/>
<text text-anchor="middle" x="1056" y="-248.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">resolve/Task</text>
<polyline fill="none" stroke="#1c2123" points="1010,-241 1102,-241 "/>
<text text-anchor="start" x="1018" y="-225.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">store_id: u64,</text>
<polyline fill="none" stroke="#1c2123" points="1010,-218 1102,-218 "/>
<text text-anchor="start" x="1018" y="-202.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">cb: Callback,</text>
</g>
<!-- PdStoreAddrResolver&#45;&gt;resolve_Task -->
<g id="edge5" class="edge">
<title>PdStoreAddrResolver&#45;&gt;resolve_Task</title>
<path fill="none" stroke="#666666" d="M974.4,-229.5C982.97,-229.5 991.56,-229.5 999.78,-229.5"/>
<polygon fill="#666666" stroke="#666666" points="999.96,-233 1009.96,-229.5 999.96,-226 999.96,-233"/>
</g>
<!-- StreamBackEnd -->
<g id="node8" class="node">
<title>StreamBackEnd</title>
<path fill="none" stroke="#1c2123" d="M45.5,-0.5C45.5,-0.5 230.5,-0.5 230.5,-0.5 236.5,-0.5 242.5,-6.5 242.5,-12.5 242.5,-12.5 242.5,-118.5 242.5,-118.5 242.5,-124.5 236.5,-130.5 230.5,-130.5 230.5,-130.5 45.5,-130.5 45.5,-130.5 39.5,-130.5 33.5,-124.5 33.5,-118.5 33.5,-118.5 33.5,-12.5 33.5,-12.5 33.5,-6.5 39.5,-0.5 45.5,-0.5"/>
<text text-anchor="middle" x="138" y="-115.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">StreamBackEnd</text>
<polyline fill="none" stroke="#1c2123" points="33.5,-107.5 242.5,-107.5 "/>
<text text-anchor="start" x="41.5" y="-92.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">store_id: u64,</text>
<polyline fill="none" stroke="#1c2123" points="33.5,-84.5 242.5,-84.5 "/>
<text text-anchor="start" x="41.5" y="-69.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">queue: Arc&lt;Queue&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="33.5,-61.5 242.5,-61.5 "/>
<text text-anchor="start" x="41.5" y="-46.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">builder: ConnectionBuilder&lt;S, R&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="33.5,-38.5 242.5,-38.5 "/>
<text text-anchor="start" x="41.5" y="-23.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">watches lifetime of a conection</text>
<text text-anchor="start" x="41.5" y="-8.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> and handle reconnecting</text>
</g>
<!-- StreamBackEnd&#45;&gt;ConnectionBuilder -->
<g id="edge7" class="edge">
<title>StreamBackEnd:builder&#45;&gt;ConnectionBuilder</title>
<path fill="none" stroke="#666666" d="M244,-49.5C263.87,-49.5 283.65,-54.04 302.47,-61.18"/>
<polygon fill="#666666" stroke="#666666" points="301.34,-64.5 311.92,-65.02 303.97,-58.01 301.34,-64.5"/>
</g>
</g>
</svg>
