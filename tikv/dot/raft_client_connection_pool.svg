<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.1 (20210417.1919)
 -->
<!-- Title: raft_client_connection_pool Pages: 1 -->
<svg width="1274pt" height="465pt"
 viewBox="0.00 0.00 1274.00 464.50" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 460.5)">
<title>raft_client_connection_pool</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-460.5 1270,-460.5 1270,4 -4,4"/>
<!-- RaftClient -->
<g id="node1" class="node">
<title>RaftClient</title>
<path fill="none" stroke="#1c2123" d="M12,-127C12,-127 264,-127 264,-127 270,-127 276,-133 276,-139 276,-139 276,-314 276,-314 276,-320 270,-326 264,-326 264,-326 12,-326 12,-326 6,-326 0,-320 0,-314 0,-314 0,-139 0,-139 0,-133 6,-127 12,-127"/>
<text text-anchor="middle" x="138" y="-310.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">RaftClient</text>
<polyline fill="none" stroke="#1c2123" points="0,-303 276,-303 "/>
<text text-anchor="start" x="8" y="-287.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">管理connection</text>
<text text-anchor="start" x="8" y="-272.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 发消息时，先调用send，最后flush</text>
<polyline fill="none" stroke="#1c2123" points="0,-265 276,-265 "/>
<text text-anchor="start" x="8" y="-249.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">pool: Arc&lt;Mutex&lt;ConnectionPool&gt;&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="0,-242 276,-242 "/>
<text text-anchor="start" x="8" y="-226.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">cache: LruCache&lt;(u64, usize), CachedQueue&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="0,-219 276,-219 "/>
<text text-anchor="start" x="8" y="-203.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">need_flush: Vec&lt;(u64, usize)&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="0,-196 276,-196 "/>
<text text-anchor="start" x="8" y="-180.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">full_stores: Vec&lt;(u64, usize)&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="0,-173 276,-173 "/>
<text text-anchor="start" x="8" y="-157.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">future_pool: Arc&lt;ThreadPool&lt;TaskCell&gt;&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="0,-150 276,-150 "/>
<text text-anchor="start" x="8" y="-134.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">builder: ConnectionBuilder&lt;S, R&gt;,</text>
</g>
<!-- ConnectionPool -->
<g id="node2" class="node">
<title>ConnectionPool</title>
<path fill="none" stroke="#1c2123" d="M324,-349C324,-349 605,-349 605,-349 611,-349 617,-355 617,-361 617,-361 617,-444 617,-444 617,-450 611,-456 605,-456 605,-456 324,-456 324,-456 318,-456 312,-450 312,-444 312,-444 312,-361 312,-361 312,-355 318,-349 324,-349"/>
<text text-anchor="middle" x="464.5" y="-440.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">ConnectionPool</text>
<polyline fill="none" stroke="#1c2123" points="312,-433 617,-433 "/>
<text text-anchor="start" x="320" y="-417.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">管理连接池</text>
<text text-anchor="start" x="320" y="-402.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> key为store_id, conn_id</text>
<polyline fill="none" stroke="#1c2123" points="312,-395 617,-395 "/>
<text text-anchor="start" x="320" y="-379.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">connections: HashMap&lt;(u64, usize), Arc&lt;Queue&gt;&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="312,-372 617,-372 "/>
<text text-anchor="start" x="320" y="-356.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">tombstone_stores: HashSet&lt;u64&gt;,</text>
</g>
<!-- RaftClient&#45;&gt;ConnectionPool -->
<g id="edge1" class="edge">
<title>RaftClient&#45;&gt;ConnectionPool</title>
<path fill="none" stroke="#666666" d="M276.44,-319.48C288.31,-326.52 300.27,-333.3 312,-339.5 315.12,-341.15 318.29,-342.78 321.49,-344.4"/>
<polygon fill="#666666" stroke="#666666" points="320.12,-347.63 330.64,-348.93 323.23,-341.36 320.12,-347.63"/>
</g>
<!-- LruCache -->
<g id="node3" class="node">
<title>LruCache</title>
<path fill="none" stroke="#1c2123" d="M355,-123.5C355,-123.5 574,-123.5 574,-123.5 580,-123.5 586,-129.5 586,-135.5 586,-135.5 586,-317.5 586,-317.5 586,-323.5 580,-329.5 574,-329.5 574,-329.5 355,-329.5 355,-329.5 349,-329.5 343,-323.5 343,-317.5 343,-317.5 343,-135.5 343,-135.5 343,-129.5 349,-123.5 355,-123.5"/>
<text text-anchor="middle" x="464.5" y="-314.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">LruCache</text>
<polyline fill="none" stroke="#1c2123" points="343,-306.5 586,-306.5 "/>
<text text-anchor="start" x="351" y="-291.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">map: HashMap&lt;K, ValueEntry&lt;K, V&gt;&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="343,-283.5 586,-283.5 "/>
<text text-anchor="start" x="351" y="-268.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">trace: Trace&lt;K&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="343,-260.5 586,-260.5 "/>
<text text-anchor="start" x="351" y="-245.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">capacity: usize,</text>
<polyline fill="none" stroke="#1c2123" points="343,-237.5 586,-237.5 "/>
<text text-anchor="start" x="351" y="-222.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">key为store_id, conn_id</text>
<text text-anchor="start" x="351" y="-207.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> value为cached queue</text>
<polyline fill="none" stroke="#1c2123" points="343,-199.5 586,-199.5 "/>
<text text-anchor="start" x="351" y="-184.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">在发消息时先从cache中获取</text>
<text text-anchor="start" x="351" y="-169.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> store_id, conn_id对应的queue</text>
<text text-anchor="start" x="351" y="-154.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 成功话，就把消息push到queue中</text>
<polyline fill="none" stroke="#1c2123" points="343,-146.5 586,-146.5 "/>
<text text-anchor="middle" x="464.5" y="-131.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> </text>
</g>
<!-- RaftClient&#45;&gt;LruCache -->
<g id="edge2" class="edge">
<title>RaftClient&#45;&gt;LruCache</title>
<path fill="none" stroke="#666666" d="M276.15,-226.5C294.83,-226.5 313.96,-226.5 332.53,-226.5"/>
<polygon fill="#666666" stroke="#666666" points="332.78,-230 342.78,-226.5 332.78,-223 332.78,-230"/>
</g>
<!-- CachedQueue -->
<g id="node4" class="node">
<title>CachedQueue</title>
<path fill="#a2dbfa" stroke="#8a8898" d="M704,-150C704,-150 811,-150 811,-150 817,-150 823,-156 823,-162 823,-162 823,-291 823,-291 823,-297 817,-303 811,-303 811,-303 704,-303 704,-303 698,-303 692,-297 692,-291 692,-291 692,-162 692,-162 692,-156 698,-150 704,-150"/>
<text text-anchor="middle" x="757.5" y="-287.8" font-family="Times,serif" font-size="14.00" fill="#5d6179">CachedQueue</text>
<polyline fill="none" stroke="#8a8898" points="692,-280 823,-280 "/>
<text text-anchor="start" x="700" y="-264.8" font-family="Times,serif" font-size="14.00" fill="#5d6179">queue: Arc&lt;Queue&gt;,</text>
<polyline fill="none" stroke="#8a8898" points="692,-257 823,-257 "/>
<text text-anchor="start" x="700" y="-241.8" font-family="Times,serif" font-size="14.00" fill="#5d6179">dirty: bool,</text>
<polyline fill="none" stroke="#8a8898" points="692,-234 823,-234 "/>
<text text-anchor="start" x="700" y="-218.8" font-family="Times,serif" font-size="14.00" fill="#5d6179">full: bool,</text>
<polyline fill="none" stroke="#8a8898" points="692,-211 823,-211 "/>
<text text-anchor="start" x="700" y="-195.8" font-family="Times,serif" font-size="14.00" fill="#5d6179">如果dirty/full会</text>
<text text-anchor="start" x="700" y="-180.8" font-family="Times,serif" font-size="14.00" fill="#5d6179"> 调用queue的notify</text>
<polyline fill="none" stroke="#8a8898" points="692,-173 823,-173 "/>
<text text-anchor="middle" x="757.5" y="-157.8" font-family="Times,serif" font-size="14.00" fill="#5d6179"> </text>
</g>
<!-- RaftClient&#45;&gt;CachedQueue -->
<g id="edge3" class="edge">
<title>RaftClient&#45;&gt;CachedQueue</title>
<path fill="none" stroke="#666666" d="M276.03,-127.38C287.82,-121.86 299.88,-117.11 312,-113.5 441.92,-74.83 489.22,-68.24 617,-113.5 621.4,-115.06 652.25,-139.92 683.83,-165.93"/>
<polygon fill="#666666" stroke="#666666" points="681.91,-168.89 691.85,-172.55 686.37,-163.49 681.91,-168.89"/>
</g>
<!-- Queue -->
<g id="node5" class="node">
<title>Queue</title>
<path fill="#a2dbfa" stroke="#8a8898" d="M910,-123.5C910,-123.5 1089,-123.5 1089,-123.5 1095,-123.5 1101,-129.5 1101,-135.5 1101,-135.5 1101,-317.5 1101,-317.5 1101,-323.5 1095,-329.5 1089,-329.5 1089,-329.5 910,-329.5 910,-329.5 904,-329.5 898,-323.5 898,-317.5 898,-317.5 898,-135.5 898,-135.5 898,-129.5 904,-123.5 910,-123.5"/>
<text text-anchor="middle" x="999.5" y="-314.3" font-family="Times,serif" font-size="14.00" fill="#5d6179">Queue</text>
<polyline fill="none" stroke="#8a8898" points="898,-306.5 1101,-306.5 "/>
<text text-anchor="start" x="906" y="-291.3" font-family="Times,serif" font-size="14.00" fill="#5d6179">buf: ArrayQueue&lt;RaftMessage&gt;,</text>
<polyline fill="none" stroke="#8a8898" points="898,-283.5 1101,-283.5 "/>
<text text-anchor="start" x="906" y="-268.3" font-family="Times,serif" font-size="14.00" fill="#5d6179">connected: AtomicBool,</text>
<polyline fill="none" stroke="#8a8898" points="898,-260.5 1101,-260.5 "/>
<text text-anchor="start" x="906" y="-245.3" font-family="Times,serif" font-size="14.00" fill="#5d6179">waker: Mutex&lt;Option&lt;Waker&gt;&gt;,</text>
<polyline fill="none" stroke="#8a8898" points="898,-237.5 1101,-237.5 "/>
<text text-anchor="start" x="906" y="-222.3" font-family="Times,serif" font-size="14.00" fill="#5d6179">store_id, conn_id的</text>
<text text-anchor="start" x="906" y="-207.3" font-family="Times,serif" font-size="14.00" fill="#5d6179"> 消息发送队列</text>
<polyline fill="none" stroke="#8a8898" points="898,-199.5 1101,-199.5 "/>
<text text-anchor="start" x="906" y="-184.3" font-family="Times,serif" font-size="14.00" fill="#5d6179">消息先放入buf</text>
<text text-anchor="start" x="906" y="-169.3" font-family="Times,serif" font-size="14.00" fill="#5d6179"> 等队列满或者flush时</text>
<text text-anchor="start" x="906" y="-154.3" font-family="Times,serif" font-size="14.00" fill="#5d6179"> notify waker pop处理消息</text>
<polyline fill="none" stroke="#8a8898" points="898,-146.5 1101,-146.5 "/>
<text text-anchor="middle" x="999.5" y="-131.3" font-family="Times,serif" font-size="14.00" fill="#5d6179"> </text>
</g>
<!-- ConnectionPool&#45;&gt;Queue -->
<g id="edge4" class="edge">
<title>ConnectionPool&#45;&gt;Queue</title>
<path fill="none" stroke="#666666" d="M617.47,-380.47C692.88,-366.44 784.23,-344.71 862,-312.5 870.93,-308.8 879.93,-304.54 888.82,-299.93"/>
<polygon fill="#666666" stroke="#666666" points="890.49,-303.01 897.67,-295.21 887.2,-296.83 890.49,-303.01"/>
</g>
<!-- LruCache&#45;&gt;CachedQueue -->
<g id="edge6" class="edge">
<title>LruCache&#45;&gt;CachedQueue</title>
<path fill="none" stroke="#666666" d="M586.38,-226.5C618.65,-226.5 652.58,-226.5 681.58,-226.5"/>
<polygon fill="#666666" stroke="#666666" points="681.62,-230 691.62,-226.5 681.62,-223 681.62,-230"/>
</g>
<!-- CachedQueue&#45;&gt;Queue -->
<g id="edge5" class="edge">
<title>CachedQueue&#45;&gt;Queue</title>
<path fill="none" stroke="#666666" d="M823.13,-226.5C843,-226.5 865.46,-226.5 887.51,-226.5"/>
<polygon fill="#666666" stroke="#666666" points="887.6,-230 897.6,-226.5 887.6,-223 887.6,-230"/>
</g>
<!-- RaftMessage -->
<g id="node6" class="node">
<title>RaftMessage</title>
<path fill="none" stroke="#1c2123" d="M1233.5,-285.5C1233.5,-285.5 1169.5,-285.5 1169.5,-285.5 1163.5,-285.5 1157.5,-279.5 1157.5,-273.5 1157.5,-273.5 1157.5,-261.5 1157.5,-261.5 1157.5,-255.5 1163.5,-249.5 1169.5,-249.5 1169.5,-249.5 1233.5,-249.5 1233.5,-249.5 1239.5,-249.5 1245.5,-255.5 1245.5,-261.5 1245.5,-261.5 1245.5,-273.5 1245.5,-273.5 1245.5,-279.5 1239.5,-285.5 1233.5,-285.5"/>
<text text-anchor="middle" x="1201.5" y="-263.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">RaftMessage</text>
</g>
<!-- Queue&#45;&gt;RaftMessage -->
<g id="edge7" class="edge">
<title>Queue&#45;&gt;RaftMessage</title>
<path fill="none" stroke="#666666" d="M1101.09,-247.12C1117.05,-250.39 1133,-253.66 1147.3,-256.59"/>
<polygon fill="#666666" stroke="#666666" points="1146.9,-260.08 1157.4,-258.66 1148.31,-253.23 1146.9,-260.08"/>
</g>
<!-- Waker -->
<g id="node7" class="node">
<title>Waker</title>
<path fill="none" stroke="#1c2123" d="M1149,-140C1149,-140 1254,-140 1254,-140 1260,-140 1266,-146 1266,-152 1266,-152 1266,-219 1266,-219 1266,-225 1260,-231 1254,-231 1254,-231 1149,-231 1149,-231 1143,-231 1137,-225 1137,-219 1137,-219 1137,-152 1137,-152 1137,-146 1143,-140 1149,-140"/>
<text text-anchor="middle" x="1201.5" y="-215.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">Waker</text>
<polyline fill="none" stroke="#1c2123" points="1137,-208 1266,-208 "/>
<text text-anchor="start" x="1145" y="-192.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">a Waker is a handler</text>
<text text-anchor="start" x="1145" y="-177.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> for waking up </text>
<text text-anchor="start" x="1145" y="-162.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> a task by notifying</text>
<text text-anchor="start" x="1145" y="-147.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> its executor</text>
</g>
<!-- Queue&#45;&gt;Waker -->
<g id="edge8" class="edge">
<title>Queue&#45;&gt;Waker</title>
<path fill="none" stroke="#666666" d="M1101.09,-205.88C1109.73,-204.11 1118.37,-202.34 1126.74,-200.62"/>
<polygon fill="#666666" stroke="#666666" points="1127.72,-203.99 1136.81,-198.56 1126.31,-197.14 1127.72,-203.99"/>
</g>
<!-- StreamBackEnd -->
<g id="node8" class="node">
<title>StreamBackEnd</title>
<path fill="none" stroke="#1c2123" d="M665,-0.5C665,-0.5 850,-0.5 850,-0.5 856,-0.5 862,-6.5 862,-12.5 862,-12.5 862,-118.5 862,-118.5 862,-124.5 856,-130.5 850,-130.5 850,-130.5 665,-130.5 665,-130.5 659,-130.5 653,-124.5 653,-118.5 653,-118.5 653,-12.5 653,-12.5 653,-6.5 659,-0.5 665,-0.5"/>
<text text-anchor="middle" x="757.5" y="-115.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">StreamBackEnd</text>
<polyline fill="none" stroke="#1c2123" points="653,-107.5 862,-107.5 "/>
<text text-anchor="start" x="661" y="-92.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">store_id: u64,</text>
<polyline fill="none" stroke="#1c2123" points="653,-84.5 862,-84.5 "/>
<text text-anchor="start" x="661" y="-69.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">queue: Arc&lt;Queue&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="653,-61.5 862,-61.5 "/>
<text text-anchor="start" x="661" y="-46.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">builder: ConnectionBuilder&lt;S, R&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="653,-38.5 862,-38.5 "/>
<text text-anchor="start" x="661" y="-23.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">watches lifetime of a conection</text>
<text text-anchor="start" x="661" y="-8.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> and handle reconnecting</text>
</g>
<!-- StreamBackEnd&#45;&gt;Queue -->
<g id="edge9" class="edge">
<title>StreamBackEnd&#45;&gt;Queue</title>
<path fill="none" stroke="#666666" d="M855.43,-130.52C866.52,-137.96 877.88,-145.59 889.12,-153.13"/>
<polygon fill="#666666" stroke="#666666" points="887.44,-156.21 897.69,-158.87 891.33,-150.4 887.44,-156.21"/>
</g>
</g>
</svg>
