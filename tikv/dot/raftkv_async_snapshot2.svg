<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.1 (20210417.1919)
 -->
<!-- Title: raftkv_async_snapshot2 Pages: 1 -->
<svg width="1050pt" height="248pt"
 viewBox="0.00 0.00 1050.00 247.50" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 243.5)">
<title>raftkv_async_snapshot2</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-243.5 1046,-243.5 1046,4 -4,4"/>
<!-- with_tls_engine -->
<g id="node1" class="node">
<title>with_tls_engine</title>
<path fill="none" stroke="#1c2123" d="M12,-62.5C12,-62.5 134,-62.5 134,-62.5 140,-62.5 146,-68.5 146,-74.5 146,-74.5 146,-111.5 146,-111.5 146,-117.5 140,-123.5 134,-123.5 134,-123.5 12,-123.5 12,-123.5 6,-123.5 0,-117.5 0,-111.5 0,-111.5 0,-74.5 0,-74.5 0,-68.5 6,-62.5 12,-62.5"/>
<text text-anchor="middle" x="73" y="-108.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">with_tls_engine</text>
<polyline fill="none" stroke="#1c2123" points="0,-100.5 146,-100.5 "/>
<text text-anchor="start" x="8" y="-85.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">使用线程自己clone的</text>
<text text-anchor="start" x="8" y="-70.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> tls RaftKv</text>
</g>
<!-- RaftKv__async_snapshot -->
<g id="node2" class="node">
<title>RaftKv__async_snapshot</title>
<path fill="none" stroke="#1c2123" d="M194,-59C194,-59 280,-59 280,-59 286,-59 292,-65 292,-71 292,-71 292,-115 292,-115 292,-121 286,-127 280,-127 280,-127 194,-127 194,-127 188,-127 182,-121 182,-115 182,-115 182,-71 182,-71 182,-65 188,-59 194,-59"/>
<text text-anchor="start" x="190" y="-111.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">RaftKv</text>
<text text-anchor="start" x="190" y="-96.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> async_snapshot</text>
<text text-anchor="start" x="190" y="-81.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 设置req类型为</text>
<text text-anchor="start" x="190" y="-66.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> CmdType::Snap</text>
</g>
<!-- with_tls_engine&#45;&gt;RaftKv__async_snapshot -->
<g id="edge1" class="edge">
<title>with_tls_engine&#45;&gt;RaftKv__async_snapshot</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M146.47,-93C154.76,-93 163.18,-93 171.36,-93"/>
<polygon fill="green" stroke="green" points="171.57,-96.5 181.57,-93 171.57,-89.5 171.57,-96.5"/>
</g>
<!-- RaftKv__exec_snapshot -->
<g id="node3" class="node">
<title>RaftKv__exec_snapshot</title>
<path fill="none" stroke="#1c2123" d="M382,-110.5C382,-110.5 457,-110.5 457,-110.5 463,-110.5 469,-116.5 469,-122.5 469,-122.5 469,-159.5 469,-159.5 469,-165.5 463,-171.5 457,-171.5 457,-171.5 382,-171.5 382,-171.5 376,-171.5 370,-165.5 370,-159.5 370,-159.5 370,-122.5 370,-122.5 370,-116.5 376,-110.5 382,-110.5"/>
<text text-anchor="start" x="378" y="-156.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">RaftKv</text>
<text text-anchor="start" x="378" y="-141.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> exec_snapshot</text>
<polyline fill="none" stroke="#1c2123" points="370,-133.5 469,-133.5 "/>
<text text-anchor="middle" x="419.5" y="-118.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> </text>
</g>
<!-- RaftKv__async_snapshot&#45;&gt;RaftKv__exec_snapshot -->
<g id="edge2" class="edge">
<title>RaftKv__async_snapshot&#45;&gt;RaftKv__exec_snapshot</title>
<path fill="none" stroke="#666666" d="M292.16,-107.4C313.59,-113.1 338.27,-119.67 360.1,-125.47"/>
<polygon fill="#666666" stroke="#666666" points="359.35,-128.89 369.91,-128.08 361.15,-122.13 359.35,-128.89"/>
</g>
<!-- Box_new_cb -->
<g id="node4" class="node">
<title>Box_new_cb</title>
<path fill="none" stroke="#1c2123" d="M340,-0.5C340,-0.5 499,-0.5 499,-0.5 505,-0.5 511,-6.5 511,-12.5 511,-12.5 511,-79.5 511,-79.5 511,-85.5 505,-91.5 499,-91.5 499,-91.5 340,-91.5 340,-91.5 334,-91.5 328,-85.5 328,-79.5 328,-79.5 328,-12.5 328,-12.5 328,-6.5 334,-0.5 340,-0.5"/>
<text text-anchor="start" x="336" y="-76.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Box</text>
<text text-anchor="start" x="336" y="-61.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">new_cb</text>
<polyline fill="none" stroke="#1c2123" points="328,-53.5 511,-53.5 "/>
<text text-anchor="start" x="336" y="-38.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">处理exec_snapshot的callback</text>
<text text-anchor="start" x="336" y="-23.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 处理Cmd::Resp(mut r)</text>
<text text-anchor="start" x="336" y="-8.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 转换为对应的error</text>
</g>
<!-- RaftKv__async_snapshot&#45;&gt;Box_new_cb -->
<g id="edge3" class="edge">
<title>RaftKv__async_snapshot&#45;&gt;Box_new_cb</title>
<path fill="none" stroke="#666666" d="M292.16,-78.9C300.47,-76.73 309.27,-74.44 318.2,-72.12"/>
<polygon fill="#666666" stroke="#666666" points="319.14,-75.49 327.93,-69.58 317.37,-68.72 319.14,-75.49"/>
</g>
<!-- SnapContext__read_id -->
<g id="node5" class="node">
<title>SnapContext__read_id</title>
<path fill="none" stroke="#1c2123" d="M559,-133C559,-133 691,-133 691,-133 697,-133 703,-139 703,-145 703,-145 703,-227 703,-227 703,-233 697,-239 691,-239 691,-239 559,-239 559,-239 553,-239 547,-233 547,-227 547,-227 547,-145 547,-145 547,-139 553,-133 559,-133"/>
<text text-anchor="start" x="555" y="-223.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">SnapContext</text>
<text text-anchor="start" x="555" y="-208.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> read_id</text>
<polyline fill="none" stroke="#1c2123" points="547,-201 703,-201 "/>
<text text-anchor="start" x="555" y="-185.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">SnapContext 会往下传</text>
<text text-anchor="start" x="555" y="-170.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 主要变量为read_id</text>
<text text-anchor="start" x="555" y="-155.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 标识是否是从同一个</text>
<text text-anchor="start" x="555" y="-140.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> grpc stream中读的请求</text>
</g>
<!-- RaftKv__exec_snapshot&#45;&gt;SnapContext__read_id -->
<g id="edge4" class="edge">
<title>RaftKv__exec_snapshot&#45;&gt;SnapContext__read_id</title>
<path fill="none" stroke="#666666" d="M469.24,-151.78C489.51,-156.26 513.67,-161.6 536.81,-166.72"/>
<polygon fill="#666666" stroke="#666666" points="536.13,-170.15 546.65,-168.9 537.64,-163.32 536.13,-170.15"/>
</g>
<!-- ServerRaftStoreRouter__read -->
<g id="node6" class="node">
<title>ServerRaftStoreRouter__read</title>
<path fill="none" stroke="#1c2123" d="M567,-76C567,-76 683,-76 683,-76 689,-76 695,-82 695,-88 695,-88 695,-102 695,-102 695,-108 689,-114 683,-114 683,-114 567,-114 567,-114 561,-114 555,-108 555,-102 555,-102 555,-88 555,-88 555,-82 561,-76 567,-76"/>
<text text-anchor="start" x="563" y="-98.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">ServerRaftStoreRouter</text>
<text text-anchor="start" x="563" y="-83.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> read</text>
</g>
<!-- RaftKv__exec_snapshot&#45;&gt;ServerRaftStoreRouter__read -->
<g id="edge5" class="edge">
<title>RaftKv__exec_snapshot&#45;&gt;ServerRaftStoreRouter__read</title>
<path fill="none" stroke="#666666" d="M469.24,-129.98C491.87,-124.87 519.36,-118.65 544.85,-112.89"/>
<polygon fill="#666666" stroke="#666666" points="545.89,-116.24 554.88,-110.63 544.35,-109.42 545.89,-116.24"/>
</g>
<!-- LocalReader__read -->
<g id="node7" class="node">
<title>LocalReader__read</title>
<path fill="none" stroke="#1c2123" d="M751,-76C751,-76 813,-76 813,-76 819,-76 825,-82 825,-88 825,-88 825,-102 825,-102 825,-108 819,-114 813,-114 813,-114 751,-114 751,-114 745,-114 739,-108 739,-102 739,-102 739,-88 739,-88 739,-82 745,-76 751,-76"/>
<text text-anchor="start" x="747" y="-98.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">LocalReader</text>
<text text-anchor="start" x="747" y="-83.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> read</text>
</g>
<!-- ServerRaftStoreRouter__read&#45;&gt;LocalReader__read -->
<g id="edge6" class="edge">
<title>ServerRaftStoreRouter__read&#45;&gt;LocalReader__read</title>
<path fill="none" stroke="#666666" d="M695.34,-95C706.58,-95 718.05,-95 728.79,-95"/>
<polygon fill="#666666" stroke="#666666" points="728.84,-98.5 738.84,-95 728.84,-91.5 728.84,-98.5"/>
</g>
<!-- LocalReader__get_snapshot -->
<g id="node8" class="node">
<title>LocalReader__get_snapshot</title>
<path fill="none" stroke="#1c2123" d="M883,-101.5C883,-101.5 1020,-101.5 1020,-101.5 1026,-101.5 1032,-107.5 1032,-113.5 1032,-113.5 1032,-180.5 1032,-180.5 1032,-186.5 1026,-192.5 1020,-192.5 1020,-192.5 883,-192.5 883,-192.5 877,-192.5 871,-186.5 871,-180.5 871,-180.5 871,-113.5 871,-113.5 871,-107.5 877,-101.5 883,-101.5"/>
<text text-anchor="start" x="879" y="-177.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">LocalReader</text>
<text text-anchor="start" x="879" y="-162.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> get_snapshot</text>
<polyline fill="none" stroke="#1c2123" points="871,-154.5 1032,-154.5 "/>
<text text-anchor="start" x="879" y="-139.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">可以直接读leader的local</text>
<text text-anchor="start" x="879" y="-124.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 直接调用kv engine</text>
<text text-anchor="start" x="879" y="-109.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 的snapshot</text>
</g>
<!-- LocalReader__read&#45;&gt;LocalReader__get_snapshot -->
<g id="edge7" class="edge">
<title>LocalReader__read&#45;&gt;LocalReader__get_snapshot</title>
<path fill="none" stroke="#666666" d="M825.27,-108.12C836.31,-111.55 848.64,-115.38 861.14,-119.26"/>
<polygon fill="#666666" stroke="#666666" points="860.12,-122.61 870.71,-122.23 862.2,-115.92 860.12,-122.61"/>
</g>
<!-- LocalReader__redirect -->
<g id="node9" class="node">
<title>LocalReader__redirect</title>
<path fill="none" stroke="#1c2123" d="M873,-6C873,-6 1030,-6 1030,-6 1036,-6 1042,-12 1042,-18 1042,-18 1042,-70 1042,-70 1042,-76 1036,-82 1030,-82 1030,-82 873,-82 873,-82 867,-82 861,-76 861,-70 861,-70 861,-18 861,-18 861,-12 867,-6 873,-6"/>
<text text-anchor="middle" x="951.5" y="-66.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">LocalReader__redirect</text>
<polyline fill="none" stroke="#1c2123" points="861,-59 1042,-59 "/>
<text text-anchor="start" x="869" y="-43.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">需要走一次readindex</text>
<text text-anchor="start" x="869" y="-28.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 使用router将请求propose给</text>
<text text-anchor="start" x="869" y="-13.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> region对应的peer</text>
</g>
<!-- LocalReader__read&#45;&gt;LocalReader__redirect -->
<g id="edge8" class="edge">
<title>LocalReader__read&#45;&gt;LocalReader__redirect</title>
<path fill="none" stroke="#666666" d="M825.27,-82.13C833.31,-79.68 842.03,-77.03 851.01,-74.29"/>
<polygon fill="#666666" stroke="#666666" points="852.28,-77.56 860.83,-71.3 850.24,-70.87 852.28,-77.56"/>
</g>
</g>
</svg>
