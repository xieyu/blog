<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.1 (20210417.1919)
 -->
<!-- Title: resolveLocksForWriteAsyncCommit Pages: 1 -->
<svg width="1910pt" height="423pt"
 viewBox="0.00 0.00 1910.00 422.50" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 418.5)">
<title>resolveLocksForWriteAsyncCommit</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-418.5 1906,-418.5 1906,4 -4,4"/>
<!-- resolveLockAsync -->
<g id="node1" class="node">
<title>resolveLockAsync</title>
<path fill="none" stroke="#1c2123" d="M12,-247C12,-247 341,-247 341,-247 347,-247 353,-253 353,-259 353,-259 353,-296 353,-296 353,-302 347,-308 341,-308 341,-308 12,-308 12,-308 6,-308 0,-302 0,-296 0,-296 0,-259 0,-259 0,-253 6,-247 12,-247"/>
<text text-anchor="middle" x="176.5" y="-292.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">resolveLockAsync</text>
<polyline fill="none" stroke="#1c2123" points="0,-285 353,-285 "/>
<text text-anchor="start" x="8" y="-269.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">1. 调用checkAllSecondaries 获取TxnStatus</text>
<text text-anchor="start" x="8" y="-254.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 2. 对于每个region启动goroutine, 调用resolveRegionLocks</text>
</g>
<!-- resolve_force_sync -->
<g id="node2" class="node">
<title>resolve_force_sync</title>
<path fill="none" stroke="#1c2123" d="M419.5,-353C419.5,-353 595.5,-353 595.5,-353 601.5,-353 607.5,-359 607.5,-365 607.5,-365 607.5,-402 607.5,-402 607.5,-408 601.5,-414 595.5,-414 595.5,-414 419.5,-414 419.5,-414 413.5,-414 407.5,-408 407.5,-402 407.5,-402 407.5,-365 407.5,-365 407.5,-359 413.5,-353 419.5,-353"/>
<text text-anchor="middle" x="507.5" y="-398.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">resolve</text>
<polyline fill="none" stroke="#1c2123" points="407.5,-391 607.5,-391 "/>
<text text-anchor="start" x="415.5" y="-375.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">如果有报错使用</text>
<text text-anchor="start" x="415.5" y="-360.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> force sync形式重新resolve lock</text>
</g>
<!-- resolveLockAsync&#45;&gt;resolve_force_sync -->
<g id="edge1" class="edge">
<title>resolveLockAsync&#45;&gt;resolve_force_sync</title>
<path fill="none" stroke="#666666" d="M272.22,-308.02C312.81,-321.1 360.37,-336.42 401.98,-349.83"/>
<polygon fill="#666666" stroke="#666666" points="401,-353.19 411.6,-352.92 403.15,-346.52 401,-353.19"/>
</g>
<!-- GroupKeysByRegion -->
<g id="node5" class="node">
<title>GroupKeysByRegion</title>
<path fill="none" stroke="#1c2123" d="M1560,-71C1560,-71 1682,-71 1682,-71 1688,-71 1694,-77 1694,-83 1694,-83 1694,-120 1694,-120 1694,-126 1688,-132 1682,-132 1682,-132 1560,-132 1560,-132 1554,-132 1548,-126 1548,-120 1548,-120 1548,-83 1548,-83 1548,-77 1554,-71 1560,-71"/>
<text text-anchor="middle" x="1621" y="-116.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">GroupKeysByRegion</text>
<polyline fill="none" stroke="#1c2123" points="1548,-109 1694,-109 "/>
<text text-anchor="start" x="1556" y="-93.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">按照key的region</text>
<text text-anchor="start" x="1556" y="-78.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 将secondary keys分区</text>
</g>
<!-- resolveLockAsync&#45;&gt;GroupKeysByRegion -->
<g id="edge5" class="edge">
<title>resolveLockAsync&#45;&gt;GroupKeysByRegion</title>
<path fill="none" stroke="#666666" d="M353.09,-301.85C365.23,-303.2 377.29,-304.43 389,-305.5 555.85,-320.73 597.95,-324.5 765.5,-324.5 765.5,-324.5 765.5,-324.5 1211,-324.5 1345.04,-324.5 1399.4,-378.23 1512,-305.5 1569.51,-268.35 1598.36,-189.93 1611.19,-141.87"/>
<polygon fill="#666666" stroke="#666666" points="1614.6,-142.65 1613.69,-132.1 1607.82,-140.92 1614.6,-142.65"/>
</g>
<!-- checkAllSecondaries -->
<g id="node8" class="node">
<title>checkAllSecondaries</title>
<path fill="none" stroke="#1c2123" d="M401,-167C401,-167 614,-167 614,-167 620,-167 626,-173 626,-179 626,-179 626,-284 626,-284 626,-290 620,-296 614,-296 614,-296 401,-296 401,-296 395,-296 389,-290 389,-284 389,-284 389,-179 389,-179 389,-173 395,-167 401,-167"/>
<text text-anchor="middle" x="507.5" y="-280.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">checkAllSecondaries</text>
<polyline fill="none" stroke="#1c2123" points="389,-273 626,-273 "/>
<text text-anchor="start" x="397" y="-257.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">checks the Secondaries locks of</text>
<text text-anchor="start" x="397" y="-242.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> an async commit transaction to find out</text>
<text text-anchor="start" x="397" y="-227.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> the final status of the transaction</text>
<polyline fill="none" stroke="#1c2123" points="389,-220 626,-220 "/>
<text text-anchor="start" x="397" y="-204.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">对于每个region启动</text>
<text text-anchor="start" x="397" y="-189.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 一个goroutine</text>
<text text-anchor="start" x="397" y="-174.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 执行checkSecondaries</text>
</g>
<!-- resolveLockAsync&#45;&gt;checkAllSecondaries -->
<g id="edge6" class="edge">
<title>resolveLockAsync&#45;&gt;checkAllSecondaries</title>
<path fill="none" stroke="#666666" d="M353.08,-252.95C361.77,-251.74 370.42,-250.53 378.94,-249.34"/>
<polygon fill="#666666" stroke="#666666" points="379.44,-252.8 388.86,-247.95 378.47,-245.87 379.44,-252.8"/>
</g>
<!-- resolveRegionLocks -->
<g id="node9" class="node">
<title>resolveRegionLocks</title>
<path fill="none" stroke="#1c2123" d="M1742,-0.5C1742,-0.5 1890,-0.5 1890,-0.5 1896,-0.5 1902,-6.5 1902,-12.5 1902,-12.5 1902,-102.5 1902,-102.5 1902,-108.5 1896,-114.5 1890,-114.5 1890,-114.5 1742,-114.5 1742,-114.5 1736,-114.5 1730,-108.5 1730,-102.5 1730,-102.5 1730,-12.5 1730,-12.5 1730,-6.5 1736,-0.5 1742,-0.5"/>
<text text-anchor="middle" x="1816" y="-99.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">resolveRegionLocks</text>
<polyline fill="none" stroke="#1c2123" points="1730,-91.5 1902,-91.5 "/>
<text text-anchor="start" x="1738" y="-76.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">启动go routine</text>
<text text-anchor="start" x="1738" y="-61.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 并发的调用</text>
<text text-anchor="start" x="1738" y="-46.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> resolveRegionLocks</text>
<polyline fill="none" stroke="#1c2123" points="1730,-38.5 1902,-38.5 "/>
<text text-anchor="start" x="1738" y="-23.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">resolve all keys in the same </text>
<text text-anchor="start" x="1738" y="-8.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> region at same time;</text>
</g>
<!-- resolveLockAsync&#45;&gt;resolveRegionLocks -->
<g id="edge7" class="edge">
<title>resolveLockAsync&#45;&gt;resolveRegionLocks</title>
<path fill="none" stroke="#666666" d="M215.46,-246.82C305.27,-177.44 540.16,-14.5 765.5,-14.5 765.5,-14.5 765.5,-14.5 1428.5,-14.5 1528.17,-14.5 1641.41,-28.8 1719.43,-40.91"/>
<polygon fill="#666666" stroke="#666666" points="1719.3,-44.43 1729.72,-42.52 1720.38,-37.51 1719.3,-44.43"/>
</g>
<!-- CmdCheckSecondaryLocks -->
<g id="node3" class="node">
<title>CmdCheckSecondaryLocks</title>
<path fill="none" stroke="#1c2123" d="M1125,-95C1125,-95 1295,-95 1295,-95 1301,-95 1307,-101 1307,-107 1307,-107 1307,-204 1307,-204 1307,-210 1301,-216 1295,-216 1295,-216 1125,-216 1125,-216 1119,-216 1113,-210 1113,-204 1113,-204 1113,-107 1113,-107 1113,-101 1119,-95 1125,-95"/>
<text text-anchor="middle" x="1210" y="-200.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">CmdCheckSecondaryLocks</text>
<polyline fill="none" stroke="#1c2123" points="1113,-193 1307,-193 "/>
<text text-anchor="start" x="1121" y="-177.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">Check secondary locks of an</text>
<text text-anchor="start" x="1121" y="-162.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> async commit transaction</text>
<text text-anchor="start" x="1121" y="-147.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> if all prewritten locks exist</text>
<text text-anchor="start" x="1121" y="-132.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> the lock information is returned</text>
<text text-anchor="start" x="1121" y="-117.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> Otherwise it return the commit</text>
<text text-anchor="start" x="1121" y="-102.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> timestamp of the transaction</text>
</g>
<!-- RegionErr -->
<g id="node4" class="node">
<title>RegionErr</title>
<path fill="none" stroke="#1c2123" d="M1355,-71C1355,-71 1500,-71 1500,-71 1506,-71 1512,-77 1512,-83 1512,-83 1512,-120 1512,-120 1512,-126 1506,-132 1500,-132 1500,-132 1355,-132 1355,-132 1349,-132 1343,-126 1343,-120 1343,-120 1343,-83 1343,-83 1343,-77 1349,-71 1355,-71"/>
<text text-anchor="middle" x="1427.5" y="-116.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">RegionErr</text>
<polyline fill="none" stroke="#1c2123" points="1343,-109 1512,-109 "/>
<text text-anchor="start" x="1351" y="-93.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">region信息发生了变动</text>
<text text-anchor="start" x="1351" y="-78.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 需要重新赞找region分组</text>
</g>
<!-- CmdCheckSecondaryLocks&#45;&gt;RegionErr -->
<g id="edge2" class="edge">
<title>CmdCheckSecondaryLocks&#45;&gt;RegionErr</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M1307.09,-131.42C1315.64,-129.28 1324.29,-127.11 1332.82,-124.97"/>
<polygon fill="green" stroke="green" points="1333.92,-128.31 1342.77,-122.48 1332.22,-121.52 1333.92,-128.31"/>
</g>
<!-- RegionErr&#45;&gt;GroupKeysByRegion -->
<g id="edge3" class="edge">
<title>RegionErr&#45;&gt;GroupKeysByRegion</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M1512.22,-101.5C1520.66,-101.5 1529.23,-101.5 1537.66,-101.5"/>
<polygon fill="green" stroke="green" points="1537.85,-105 1547.85,-101.5 1537.85,-98 1537.85,-105"/>
</g>
<!-- checkSecondaries_recursive -->
<g id="node6" class="node">
<title>checkSecondaries_recursive</title>
<path fill="none" stroke="#1c2123" d="M919,-43.5C919,-43.5 1065,-43.5 1065,-43.5 1071,-43.5 1077,-49.5 1077,-55.5 1077,-55.5 1077,-107.5 1077,-107.5 1077,-113.5 1071,-119.5 1065,-119.5 1065,-119.5 919,-119.5 919,-119.5 913,-119.5 907,-113.5 907,-107.5 907,-107.5 907,-55.5 907,-55.5 907,-49.5 913,-43.5 919,-43.5"/>
<text text-anchor="middle" x="992" y="-104.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">checkSecondaries_recursive</text>
<polyline fill="none" stroke="#1c2123" points="907,-96.5 1077,-96.5 "/>
<text text-anchor="start" x="915" y="-81.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">递归调用checkSecondaries</text>
<text text-anchor="start" x="915" y="-66.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 在新的按region分组的</text>
<text text-anchor="start" x="915" y="-51.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 重新check一遍</text>
</g>
<!-- RegionErr&#45;&gt;checkSecondaries_recursive -->
<g id="edge4" class="edge">
<title>RegionErr&#45;&gt;checkSecondaries_recursive</title>
<path fill="none" stroke="#666666" d="M1342.74,-88.99C1330.77,-87.58 1318.59,-86.35 1307,-85.5 1233.35,-80.12 1149.72,-79.31 1087.3,-79.75"/>
<polygon fill="#666666" stroke="#666666" points="1087.05,-76.25 1077.08,-79.83 1087.11,-83.25 1087.05,-76.25"/>
</g>
<!-- GroupKeysByRegion&#45;&gt;resolveRegionLocks -->
<g id="edge8" class="edge">
<title>GroupKeysByRegion&#45;&gt;resolveRegionLocks</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M1694.14,-85.05C1702.62,-83.12 1711.37,-81.13 1720.1,-79.14"/>
<polygon fill="green" stroke="green" points="1720.96,-82.53 1729.93,-76.89 1719.4,-75.7 1720.96,-82.53"/>
</g>
<!-- checkSecondaries -->
<g id="node7" class="node">
<title>checkSecondaries</title>
<path fill="none" stroke="#1c2123" d="M920.5,-225.5C920.5,-225.5 1063.5,-225.5 1063.5,-225.5 1069.5,-225.5 1075.5,-231.5 1075.5,-237.5 1075.5,-237.5 1075.5,-259.5 1075.5,-259.5 1075.5,-265.5 1069.5,-271.5 1063.5,-271.5 1063.5,-271.5 920.5,-271.5 920.5,-271.5 914.5,-271.5 908.5,-265.5 908.5,-259.5 908.5,-259.5 908.5,-237.5 908.5,-237.5 908.5,-231.5 914.5,-225.5 920.5,-225.5"/>
<text text-anchor="middle" x="992" y="-256.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">checkSecondaries</text>
<polyline fill="none" stroke="#1c2123" points="908.5,-248.5 1075.5,-248.5 "/>
<text text-anchor="start" x="916.5" y="-233.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">将结果放入resolveData中</text>
</g>
<!-- checkSecondaries&#45;&gt;CmdCheckSecondaryLocks -->
<g id="edge14" class="edge">
<title>checkSecondaries&#45;&gt;CmdCheckSecondaryLocks</title>
<path fill="none" stroke="#666666" d="M1046.67,-225.39C1063.93,-217.96 1083.69,-209.45 1103.35,-200.99"/>
<polygon fill="#666666" stroke="#666666" points="1104.87,-204.15 1112.67,-196.98 1102.1,-197.72 1104.87,-204.15"/>
</g>
<!-- addKeys -->
<g id="node12" class="node">
<title>addKeys</title>
<path fill="none" stroke="#1c2123" d="M1158,-235C1158,-235 1262,-235 1262,-235 1268,-235 1274,-241 1274,-247 1274,-247 1274,-284 1274,-284 1274,-290 1268,-296 1262,-296 1262,-296 1158,-296 1158,-296 1152,-296 1146,-290 1146,-284 1146,-284 1146,-247 1146,-247 1146,-241 1152,-235 1158,-235"/>
<text text-anchor="middle" x="1210" y="-280.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">addKeys</text>
<polyline fill="none" stroke="#1c2123" points="1146,-273 1274,-273 "/>
<text text-anchor="start" x="1154" y="-257.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">将resp中lock信息</text>
<text text-anchor="start" x="1154" y="-242.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 放入resolveData中</text>
</g>
<!-- checkSecondaries&#45;&gt;addKeys -->
<g id="edge11" class="edge">
<title>checkSecondaries&#45;&gt;addKeys</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M1075.58,-255C1095.46,-256.56 1116.56,-258.22 1135.97,-259.75"/>
<polygon fill="green" stroke="green" points="1135.7,-263.24 1145.95,-260.54 1136.25,-256.26 1135.7,-263.24"/>
</g>
<!-- checkAllSecondaries&#45;&gt;checkSecondaries -->
<g id="edge13" class="edge">
<title>checkAllSecondaries&#45;&gt;checkSecondaries</title>
<path fill="none" stroke="#666666" d="M626.17,-244.1C638.26,-245.07 650.37,-245.9 662,-246.5 741.59,-250.62 832.16,-250.84 898.1,-250.19"/>
<polygon fill="#666666" stroke="#666666" points="898.5,-253.69 908.46,-250.08 898.43,-246.69 898.5,-253.69"/>
</g>
<!-- secondary_GroupKeysByRegion -->
<g id="node11" class="node">
<title>secondary_GroupKeysByRegion</title>
<path fill="none" stroke="#1c2123" d="M674,-190.5C674,-190.5 859,-190.5 859,-190.5 865,-190.5 871,-196.5 871,-202.5 871,-202.5 871,-224.5 871,-224.5 871,-230.5 865,-236.5 859,-236.5 859,-236.5 674,-236.5 674,-236.5 668,-236.5 662,-230.5 662,-224.5 662,-224.5 662,-202.5 662,-202.5 662,-196.5 668,-190.5 674,-190.5"/>
<text text-anchor="middle" x="766.5" y="-221.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">GroupKeysByRegion</text>
<polyline fill="none" stroke="#1c2123" points="662,-213.5 871,-213.5 "/>
<text text-anchor="start" x="670" y="-198.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">把secondary keys 按照region分组</text>
</g>
<!-- checkAllSecondaries&#45;&gt;secondary_GroupKeysByRegion -->
<g id="edge10" class="edge">
<title>checkAllSecondaries&#45;&gt;secondary_GroupKeysByRegion</title>
<path fill="none" stroke="#666666" d="M626.09,-223.26C634.55,-222.67 643.07,-222.07 651.51,-221.48"/>
<polygon fill="#666666" stroke="#666666" points="652.01,-224.96 661.75,-220.77 651.53,-217.97 652.01,-224.96"/>
</g>
<!-- resolveData -->
<g id="node10" class="node">
<title>resolveData</title>
<path fill="none" stroke="#1c2123" d="M1380,-165.5C1380,-165.5 1475,-165.5 1475,-165.5 1481,-165.5 1487,-171.5 1487,-177.5 1487,-177.5 1487,-283.5 1487,-283.5 1487,-289.5 1481,-295.5 1475,-295.5 1475,-295.5 1380,-295.5 1380,-295.5 1374,-295.5 1368,-289.5 1368,-283.5 1368,-283.5 1368,-177.5 1368,-177.5 1368,-171.5 1374,-165.5 1380,-165.5"/>
<text text-anchor="middle" x="1427.5" y="-280.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">resolveData</text>
<polyline fill="none" stroke="#1c2123" points="1368,-272.5 1487,-272.5 "/>
<text text-anchor="start" x="1376" y="-257.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">asyncResolveData</text>
<polyline fill="none" stroke="#1c2123" points="1368,-249.5 1487,-249.5 "/>
<text text-anchor="start" x="1376" y="-234.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">mutex sync.Mutex</text>
<text text-anchor="start" x="1376" y="-219.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> commitTs uint64</text>
<polyline fill="none" stroke="#1c2123" points="1368,-211.5 1487,-211.5 "/>
<text text-anchor="start" x="1376" y="-196.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">keys [][]byte</text>
<polyline fill="none" stroke="#1c2123" points="1368,-188.5 1487,-188.5 "/>
<text text-anchor="start" x="1376" y="-173.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">missingLock bool</text>
</g>
<!-- secondary_GroupKeysByRegion&#45;&gt;checkSecondaries -->
<g id="edge9" class="edge">
<title>secondary_GroupKeysByRegion&#45;&gt;checkSecondaries</title>
<path fill="none" stroke="#666666" d="M871.07,-229.72C880.11,-231.14 889.23,-232.56 898.18,-233.96"/>
<polygon fill="#666666" stroke="#666666" points="897.78,-237.44 908.2,-235.53 898.86,-230.53 897.78,-237.44"/>
</g>
<!-- addKeys&#45;&gt;resolveData -->
<g id="edge12" class="edge">
<title>addKeys&#45;&gt;resolveData</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M1274.2,-255.24C1300.41,-250.98 1330.89,-246.03 1357.66,-241.68"/>
<polygon fill="green" stroke="green" points="1358.42,-245.1 1367.73,-240.05 1357.3,-238.19 1358.42,-245.1"/>
</g>
</g>
</svg>
