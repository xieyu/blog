<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.1 (20210417.1919)
 -->
<!-- Title: async_commit_recovery Pages: 1 -->
<svg width="1491pt" height="274pt"
 viewBox="0.00 0.00 1491.00 274.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 270)">
<title>async_commit_recovery</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-270 1487,-270 1487,4 -4,4"/>
<g id="clust2" class="cluster">
<title>cluster_TiKV</title>
<path fill="none" stroke="slategrey" stroke-dasharray="5,2" d="M648.5,-176C648.5,-176 1463,-176 1463,-176 1469,-176 1475,-182 1475,-188 1475,-188 1475,-246 1475,-246 1475,-252 1469,-258 1463,-258 1463,-258 648.5,-258 648.5,-258 642.5,-258 636.5,-252 636.5,-246 636.5,-246 636.5,-188 636.5,-188 636.5,-182 642.5,-176 648.5,-176"/>
<text text-anchor="middle" x="1055.75" y="-238" font-family="Times,serif" font-size="20.00">TiKV</text>
</g>
<!-- asyncResolveData -->
<g id="node1" class="node">
<title>asyncResolveData</title>
<path fill="none" stroke="#1c2123" d="M878,-68C878,-68 970,-68 970,-68 976,-68 982,-74 982,-80 982,-80 982,-148 982,-148 982,-154 976,-160 970,-160 970,-160 878,-160 878,-160 872,-160 866,-154 866,-148 866,-148 866,-80 866,-80 866,-74 872,-68 878,-68"/>
<text text-anchor="middle" x="924" y="-144.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">asyncResolveData</text>
<polyline fill="none" stroke="#1c2123" points="866,-137 982,-137 "/>
<text text-anchor="start" x="874" y="-121.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">commitTs uint64</text>
<polyline fill="none" stroke="#1c2123" points="866,-114 982,-114 "/>
<text text-anchor="start" x="874" y="-98.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">keys [][]byte</text>
<polyline fill="none" stroke="#1c2123" points="866,-91 982,-91 "/>
<text text-anchor="start" x="874" y="-75.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">missingLock bool</text>
</g>
<!-- GroupKeysByRegion -->
<g id="node4" class="node">
<title>GroupKeysByRegion</title>
<path fill="none" stroke="#1c2123" d="M1140,-97C1140,-97 1030,-97 1030,-97 1024,-97 1018,-91 1018,-85 1018,-85 1018,-73 1018,-73 1018,-67 1024,-61 1030,-61 1030,-61 1140,-61 1140,-61 1146,-61 1152,-67 1152,-73 1152,-73 1152,-85 1152,-85 1152,-91 1146,-97 1140,-97"/>
<text text-anchor="middle" x="1085" y="-75.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">GroupKeysByRegion</text>
</g>
<!-- asyncResolveData&#45;&gt;GroupKeysByRegion -->
<g id="edge9" class="edge">
<title>asyncResolveData&#45;&gt;GroupKeysByRegion</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M982.4,-101.36C990.65,-99.55 999.24,-97.66 1007.78,-95.78"/>
<polygon fill="green" stroke="green" points="1008.75,-99.15 1017.76,-93.58 1007.25,-92.31 1008.75,-99.15"/>
</g>
<!-- resolveLockAsync -->
<g id="node2" class="node">
<title>resolveLockAsync</title>
<path fill="none" stroke="#1c2123" d="M116,-56C116,-56 22,-56 22,-56 16,-56 10,-50 10,-44 10,-44 10,-32 10,-32 10,-26 16,-20 22,-20 22,-20 116,-20 116,-20 122,-20 128,-26 128,-32 128,-32 128,-44 128,-44 128,-50 122,-56 116,-56"/>
<text text-anchor="middle" x="69" y="-34.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">resolveLockAsync</text>
</g>
<!-- checkAllSecondaries -->
<g id="node3" class="node">
<title>checkAllSecondaries</title>
<path fill="none" stroke="#1c2123" d="M186,-68.5C186,-68.5 430,-68.5 430,-68.5 436,-68.5 442,-74.5 442,-80.5 442,-80.5 442,-147.5 442,-147.5 442,-153.5 436,-159.5 430,-159.5 430,-159.5 186,-159.5 186,-159.5 180,-159.5 174,-153.5 174,-147.5 174,-147.5 174,-80.5 174,-80.5 174,-74.5 180,-68.5 186,-68.5"/>
<text text-anchor="middle" x="308" y="-144.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">1. checkAllSecondaries</text>
<polyline fill="none" stroke="#1c2123" points="174,-136.5 442,-136.5 "/>
<text text-anchor="start" x="182" y="-121.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">检查所有secondaries keys的lock info</text>
<text text-anchor="start" x="182" y="-106.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 先对secondaries keys 根据regio分组</text>
<text text-anchor="start" x="182" y="-91.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 对每个group调用checkSecondaries</text>
<text text-anchor="start" x="182" y="-76.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 然后将key状态添加到asyncResolveData中</text>
</g>
<!-- resolveLockAsync&#45;&gt;checkAllSecondaries -->
<g id="edge1" class="edge">
<title>resolveLockAsync&#45;&gt;checkAllSecondaries</title>
<path fill="none" stroke="#666666" d="M126.17,-56.01C137.84,-59.76 150.65,-63.86 163.88,-68.1"/>
<polygon fill="#666666" stroke="#666666" points="162.99,-71.49 173.58,-71.22 165.13,-64.83 162.99,-71.49"/>
</g>
<!-- resolveLockAsync&#45;&gt;GroupKeysByRegion -->
<g id="edge2" class="edge">
<title>resolveLockAsync&#45;&gt;GroupKeysByRegion</title>
<path fill="none" stroke="#666666" d="M128.17,-38C215.99,-38 387.65,-38 533.5,-38 533.5,-38 533.5,-38 729.5,-38 842.07,-38 870.54,-42.17 982,-58 990.36,-59.19 999.07,-60.64 1007.72,-62.22"/>
<polygon fill="#666666" stroke="#666666" points="1007.34,-65.71 1017.82,-64.13 1008.64,-58.84 1007.34,-65.71"/>
</g>
<!-- resolveRegionLocks -->
<g id="node5" class="node">
<title>resolveRegionLocks</title>
<path fill="none" stroke="#1c2123" d="M1304,-97C1304,-97 1200,-97 1200,-97 1194,-97 1188,-91 1188,-85 1188,-85 1188,-73 1188,-73 1188,-67 1194,-61 1200,-61 1200,-61 1304,-61 1304,-61 1310,-61 1316,-67 1316,-73 1316,-73 1316,-85 1316,-85 1316,-91 1310,-97 1304,-97"/>
<text text-anchor="middle" x="1252" y="-75.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">resolveRegionLocks</text>
</g>
<!-- resolveLockAsync&#45;&gt;resolveRegionLocks -->
<g id="edge3" class="edge">
<title>resolveLockAsync&#45;&gt;resolveRegionLocks</title>
<path fill="none" stroke="#666666" d="M128.05,-30.17C215.7,-19.05 387.16,0 533.5,0 533.5,0 533.5,0 925,0 1022.91,0 1132.81,-34.07 1196.74,-57.46"/>
<polygon fill="#666666" stroke="#666666" points="1195.62,-60.78 1206.21,-60.97 1198.05,-54.22 1195.62,-60.78"/>
</g>
<!-- checkSecondaries -->
<g id="node6" class="node">
<title>checkSecondaries</title>
<path fill="none" stroke="#1c2123" d="M579,-134C579,-134 490,-134 490,-134 484,-134 478,-128 478,-122 478,-122 478,-110 478,-110 478,-104 484,-98 490,-98 490,-98 579,-98 579,-98 585,-98 591,-104 591,-110 591,-110 591,-122 591,-122 591,-128 585,-134 579,-134"/>
<text text-anchor="middle" x="534.5" y="-112.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">checkSecondaries</text>
</g>
<!-- checkAllSecondaries&#45;&gt;checkSecondaries -->
<g id="edge4" class="edge">
<title>checkAllSecondaries&#45;&gt;checkSecondaries</title>
<path fill="none" stroke="#666666" d="M442.19,-115.19C450.95,-115.26 459.54,-115.34 467.72,-115.41"/>
<polygon fill="#666666" stroke="#666666" points="467.83,-118.92 477.86,-115.5 467.89,-111.92 467.83,-118.92"/>
</g>
<!-- GroupKeysByRegion&#45;&gt;resolveRegionLocks -->
<g id="edge10" class="edge">
<title>GroupKeysByRegion&#45;&gt;resolveRegionLocks</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M1152.16,-79C1160.51,-79 1169.09,-79 1177.55,-79"/>
<polygon fill="green" stroke="green" points="1177.77,-82.5 1187.77,-79 1177.77,-75.5 1177.77,-82.5"/>
</g>
<!-- CmdResolveLock -->
<g id="node8" class="node">
<title>CmdResolveLock</title>
<path fill="none" stroke="#1c2123" d="M1455,-220C1455,-220 1364,-220 1364,-220 1358,-220 1352,-214 1352,-208 1352,-208 1352,-196 1352,-196 1352,-190 1358,-184 1364,-184 1364,-184 1455,-184 1455,-184 1461,-184 1467,-190 1467,-196 1467,-196 1467,-208 1467,-208 1467,-214 1461,-220 1455,-220"/>
<text text-anchor="middle" x="1409.5" y="-198.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">CmdResolveLock</text>
</g>
<!-- resolveRegionLocks&#45;&gt;CmdResolveLock -->
<g id="edge7" class="edge">
<title>resolveRegionLocks&#45;&gt;CmdResolveLock</title>
<path fill="none" stroke="#666666" d="M1275.94,-97.15C1302.9,-118.47 1347.72,-153.92 1377.68,-177.63"/>
<polygon fill="#666666" stroke="#666666" points="1375.7,-180.52 1385.71,-183.98 1380.04,-175.03 1375.7,-180.52"/>
</g>
<!-- addKeys -->
<g id="node7" class="node">
<title>addKeys</title>
<path fill="none" stroke="#1c2123" d="M639,-66.5C639,-66.5 818,-66.5 818,-66.5 824,-66.5 830,-72.5 830,-78.5 830,-78.5 830,-153.5 830,-153.5 830,-159.5 824,-165.5 818,-165.5 818,-165.5 639,-165.5 639,-165.5 633,-165.5 627,-159.5 627,-153.5 627,-153.5 627,-78.5 627,-78.5 627,-72.5 633,-66.5 639,-66.5"/>
<text text-anchor="middle" x="728.5" y="-150.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">2.addKeys</text>
<polyline fill="none" stroke="#1c2123" points="627,-142.5 830,-142.5 "/>
<text text-anchor="start" x="635" y="-127.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">将checkSecondaries 结果加入到</text>
<text text-anchor="start" x="635" y="-112.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> asyncResolveData中</text>
<text text-anchor="start" x="635" y="-97.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 计算事务的min_commit_ts</text>
<polyline fill="none" stroke="#1c2123" points="627,-89.5 830,-89.5 "/>
<text text-anchor="start" x="635" y="-74.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">注意这块对missingLock的处理</text>
</g>
<!-- checkSecondaries&#45;&gt;addKeys -->
<g id="edge5" class="edge">
<title>checkSecondaries&#45;&gt;addKeys</title>
<path fill="none" stroke="#666666" d="M591.03,-116C599.24,-116 607.93,-116 616.79,-116"/>
<polygon fill="#666666" stroke="#666666" points="616.86,-119.5 626.86,-116 616.86,-112.5 616.86,-119.5"/>
</g>
<!-- CmdCheckSecondaryLocks -->
<g id="node9" class="node">
<title>CmdCheckSecondaryLocks</title>
<path fill="none" stroke="#1c2123" d="M800.5,-220C800.5,-220 656.5,-220 656.5,-220 650.5,-220 644.5,-214 644.5,-208 644.5,-208 644.5,-196 644.5,-196 644.5,-190 650.5,-184 656.5,-184 656.5,-184 800.5,-184 800.5,-184 806.5,-184 812.5,-190 812.5,-196 812.5,-196 812.5,-208 812.5,-208 812.5,-214 806.5,-220 800.5,-220"/>
<text text-anchor="middle" x="728.5" y="-198.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">CmdCheckSecondaryLocks</text>
</g>
<!-- checkSecondaries&#45;&gt;CmdCheckSecondaryLocks -->
<g id="edge8" class="edge">
<title>checkSecondaries&#45;&gt;CmdCheckSecondaryLocks</title>
<path fill="none" stroke="#666666" d="M559.18,-134.2C577,-147.15 602.47,-164.11 627,-175 631.41,-176.96 636,-178.8 640.67,-180.53"/>
<polygon fill="#666666" stroke="#666666" points="639.77,-183.93 650.37,-183.93 642.09,-177.32 639.77,-183.93"/>
</g>
<!-- addKeys&#45;&gt;asyncResolveData -->
<g id="edge6" class="edge">
<title>addKeys&#45;&gt;asyncResolveData</title>
<path fill="none" stroke="#666666" d="M830.22,-114.96C838.8,-114.87 847.35,-114.78 855.58,-114.7"/>
<polygon fill="#666666" stroke="#666666" points="855.86,-118.19 865.82,-114.59 855.79,-111.19 855.86,-118.19"/>
</g>
<!-- resolveRegionLocksLock -->
<g id="node10" class="node">
<title>resolveRegionLocksLock</title>
<path fill="none" stroke="#1c2123" d="M12,-75C12,-75 126,-75 126,-75 132,-75 138,-81 138,-87 138,-87 138,-99 138,-99 138,-105 132,-111 126,-111 126,-111 12,-111 12,-111 6,-111 0,-105 0,-99 0,-99 0,-87 0,-87 0,-81 6,-75 12,-75"/>
<text text-anchor="middle" x="69" y="-89.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">3.resolveRegionLocks</text>
</g>
</g>
</svg>
