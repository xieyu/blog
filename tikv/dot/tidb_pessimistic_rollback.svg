<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.1 (20210417.1919)
 -->
<!-- Title: pessimistic_rollback Pages: 1 -->
<svg width="1549pt" height="273pt"
 viewBox="0.00 0.00 1549.00 273.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 269)">
<title>pessimistic_rollback</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-269 1545,-269 1545,4 -4,4"/>
<!-- SimpleExec_executeRollback -->
<g id="node1" class="node">
<title>SimpleExec_executeRollback</title>
<path fill="none" stroke="#1c2123" d="M12,-91.5C12,-91.5 168,-91.5 168,-91.5 174,-91.5 180,-97.5 180,-103.5 180,-103.5 180,-125.5 180,-125.5 180,-131.5 174,-137.5 168,-137.5 168,-137.5 12,-137.5 12,-137.5 6,-137.5 0,-131.5 0,-125.5 0,-125.5 0,-103.5 0,-103.5 0,-97.5 6,-91.5 12,-91.5"/>
<text text-anchor="middle" x="90" y="-122.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">SimpleExec::executeRollback</text>
<polyline fill="none" stroke="#1c2123" points="0,-114.5 180,-114.5 "/>
<text text-anchor="start" x="8" y="-99.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">执行Rollback语句</text>
</g>
<!-- KVTxn_Rollback -->
<g id="node2" class="node">
<title>KVTxn_Rollback</title>
<path fill="none" stroke="#1c2123" d="M228,-91.5C228,-91.5 318,-91.5 318,-91.5 324,-91.5 330,-97.5 330,-103.5 330,-103.5 330,-125.5 330,-125.5 330,-131.5 324,-137.5 318,-137.5 318,-137.5 228,-137.5 228,-137.5 222,-137.5 216,-131.5 216,-125.5 216,-125.5 216,-103.5 216,-103.5 216,-97.5 222,-91.5 228,-91.5"/>
<text text-anchor="start" x="224" y="-122.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">KVTxn::Rollback</text>
<polyline fill="none" stroke="#1c2123" points="216,-114.5 330,-114.5 "/>
<text text-anchor="start" x="224" y="-99.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">回滚事务</text>
</g>
<!-- SimpleExec_executeRollback&#45;&gt;KVTxn_Rollback -->
<g id="edge1" class="edge">
<title>SimpleExec_executeRollback&#45;&gt;KVTxn_Rollback</title>
<path fill="none" stroke="#666666" d="M180.17,-114.5C188.8,-114.5 197.45,-114.5 205.79,-114.5"/>
<polygon fill="#666666" stroke="#666666" points="205.8,-118 215.8,-114.5 205.8,-111 205.8,-118"/>
</g>
<!-- KVTxn_rollbackPessimisticLocks -->
<g id="node3" class="node">
<title>KVTxn_rollbackPessimisticLocks</title>
<path fill="none" stroke="#1c2123" d="M378,-91.5C378,-91.5 558,-91.5 558,-91.5 564,-91.5 570,-97.5 570,-103.5 570,-103.5 570,-125.5 570,-125.5 570,-131.5 564,-137.5 558,-137.5 558,-137.5 378,-137.5 378,-137.5 372,-137.5 366,-131.5 366,-125.5 366,-125.5 366,-103.5 366,-103.5 366,-97.5 372,-91.5 378,-91.5"/>
<text text-anchor="start" x="374" y="-122.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">KVTxn::rollbackPessimisticLocks</text>
<polyline fill="none" stroke="#1c2123" points="366,-114.5 570,-114.5 "/>
<text text-anchor="start" x="374" y="-99.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">释放掉获取的悲观锁</text>
</g>
<!-- KVTxn_Rollback&#45;&gt;KVTxn_rollbackPessimisticLocks -->
<g id="edge2" class="edge">
<title>KVTxn_Rollback&#45;&gt;KVTxn_rollbackPessimisticLocks</title>
<path fill="none" stroke="#666666" d="M330.08,-114.5C338.16,-114.5 346.7,-114.5 355.41,-114.5"/>
<polygon fill="#666666" stroke="#666666" points="355.7,-118 365.7,-114.5 355.7,-111 355.7,-118"/>
</g>
<!-- KVTxn_collectLockedKeys -->
<g id="node4" class="node">
<title>KVTxn_collectLockedKeys</title>
<path fill="none" stroke="#1c2123" d="M618,-98.5C618,-98.5 774,-98.5 774,-98.5 780,-98.5 786,-104.5 786,-110.5 786,-110.5 786,-170.5 786,-170.5 786,-176.5 780,-182.5 774,-182.5 774,-182.5 618,-182.5 618,-182.5 612,-182.5 606,-176.5 606,-170.5 606,-170.5 606,-110.5 606,-110.5 606,-104.5 612,-98.5 618,-98.5"/>
<text text-anchor="middle" x="696" y="-167.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">KVTxn::collectLockedKeys</text>
<polyline fill="none" stroke="#1c2123" points="606,-159.5 786,-159.5 "/>
<text text-anchor="start" x="614" y="-144.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">收集Locked keys</text>
<polyline fill="none" stroke="#1c2123" points="606,-136.5 786,-136.5 "/>
<text text-anchor="start" x="614" y="-121.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">1.遍历MemBuffer</text>
<text text-anchor="start" x="614" y="-106.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 检查key flags 为locked keys</text>
</g>
<!-- KVTxn_rollbackPessimisticLocks&#45;&gt;KVTxn_collectLockedKeys -->
<g id="edge3" class="edge">
<title>KVTxn_rollbackPessimisticLocks&#45;&gt;KVTxn_collectLockedKeys</title>
<path fill="none" stroke="#666666" d="M570.1,-126.13C578.63,-127.11 587.26,-128.1 595.77,-129.08"/>
<polygon fill="#666666" stroke="#666666" points="595.38,-132.56 605.71,-130.23 596.18,-125.61 595.38,-132.56"/>
</g>
<!-- txn_committer_pessimisticRollbackMutations -->
<g id="node5" class="node">
<title>txn_committer_pessimisticRollbackMutations</title>
<path fill="none" stroke="#1c2123" d="M834,-23.5C834,-23.5 992,-23.5 992,-23.5 998,-23.5 1004,-29.5 1004,-35.5 1004,-35.5 1004,-57.5 1004,-57.5 1004,-63.5 998,-69.5 992,-69.5 992,-69.5 834,-69.5 834,-69.5 828,-69.5 822,-63.5 822,-57.5 822,-57.5 822,-35.5 822,-35.5 822,-29.5 828,-23.5 834,-23.5"/>
<text text-anchor="start" x="830" y="-54.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">twoPhaseCommitter</text>
<polyline fill="none" stroke="#1c2123" points="822,-46.5 1004,-46.5 "/>
<text text-anchor="start" x="830" y="-31.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">pessimisticRollbackMutations</text>
</g>
<!-- KVTxn_rollbackPessimisticLocks&#45;&gt;txn_committer_pessimisticRollbackMutations -->
<g id="edge4" class="edge">
<title>KVTxn_rollbackPessimisticLocks&#45;&gt;txn_committer_pessimisticRollbackMutations</title>
<path fill="none" stroke="#666666" d="M570.27,-94.68C582.3,-92.5 594.41,-90.39 606,-88.5 674.41,-77.32 751.76,-66.72 811.57,-58.97"/>
<polygon fill="#666666" stroke="#666666" points="812.3,-62.4 821.77,-57.65 811.41,-55.46 812.3,-62.4"/>
</g>
<!-- KVTxn_collectLockedKeys&#45;&gt;txn_committer_pessimisticRollbackMutations -->
<g id="edge8" class="edge">
<title>KVTxn_collectLockedKeys&#45;&gt;txn_committer_pessimisticRollbackMutations</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M778.38,-98.4C792.78,-91.45 807.73,-84.55 822,-78.5 826.15,-76.74 830.43,-74.99 834.77,-73.28"/>
<polygon fill="green" stroke="green" points="836.27,-76.45 844.34,-69.58 833.75,-69.92 836.27,-76.45"/>
</g>
<!-- txn_GetMemBuffer -->
<g id="node6" class="node">
<title>txn_GetMemBuffer</title>
<path fill="none" stroke="#1c2123" d="M844.5,-153.5C844.5,-153.5 981.5,-153.5 981.5,-153.5 987.5,-153.5 993.5,-159.5 993.5,-165.5 993.5,-165.5 993.5,-187.5 993.5,-187.5 993.5,-193.5 987.5,-199.5 981.5,-199.5 981.5,-199.5 844.5,-199.5 844.5,-199.5 838.5,-199.5 832.5,-193.5 832.5,-187.5 832.5,-187.5 832.5,-165.5 832.5,-165.5 832.5,-159.5 838.5,-153.5 844.5,-153.5"/>
<text text-anchor="middle" x="913" y="-184.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">1.KVTxn::GetMemBuffer</text>
<polyline fill="none" stroke="#1c2123" points="832.5,-176.5 993.5,-176.5 "/>
<text text-anchor="start" x="840.5" y="-161.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">获取事务的MemBuffer</text>
</g>
<!-- KVTxn_collectLockedKeys&#45;&gt;txn_GetMemBuffer -->
<g id="edge5" class="edge">
<title>KVTxn_collectLockedKeys&#45;&gt;txn_GetMemBuffer</title>
<path fill="none" stroke="#666666" d="M786,-155.4C798,-157.41 810.33,-159.48 822.34,-161.49"/>
<polygon fill="#666666" stroke="#666666" points="821.91,-164.96 832.35,-163.16 823.06,-158.06 821.91,-164.96"/>
</g>
<!-- IterWithFlags -->
<g id="node7" class="node">
<title>IterWithFlags</title>
<path fill="none" stroke="#1c2123" d="M846,-88.5C846,-88.5 980,-88.5 980,-88.5 986,-88.5 992,-94.5 992,-100.5 992,-100.5 992,-122.5 992,-122.5 992,-128.5 986,-134.5 980,-134.5 980,-134.5 846,-134.5 846,-134.5 840,-134.5 834,-128.5 834,-122.5 834,-122.5 834,-100.5 834,-100.5 834,-94.5 840,-88.5 846,-88.5"/>
<text text-anchor="middle" x="913" y="-119.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">2.MemDB::IterWithFlags</text>
<polyline fill="none" stroke="#1c2123" points="834,-111.5 992,-111.5 "/>
<text text-anchor="start" x="842" y="-96.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">遍历事务的MemBuffer</text>
</g>
<!-- KVTxn_collectLockedKeys&#45;&gt;IterWithFlags -->
<g id="edge6" class="edge">
<title>KVTxn_collectLockedKeys&#45;&gt;IterWithFlags</title>
<path fill="none" stroke="#666666" d="M786,-128.5C798.49,-126.81 811.32,-125.08 823.79,-123.4"/>
<polygon fill="#666666" stroke="#666666" points="824.26,-126.87 833.71,-122.06 823.33,-119.93 824.26,-126.87"/>
</g>
<!-- HasLocked -->
<g id="node8" class="node">
<title>HasLocked</title>
<path fill="none" stroke="#1c2123" d="M836.5,-218.5C836.5,-218.5 989.5,-218.5 989.5,-218.5 995.5,-218.5 1001.5,-224.5 1001.5,-230.5 1001.5,-230.5 1001.5,-252.5 1001.5,-252.5 1001.5,-258.5 995.5,-264.5 989.5,-264.5 989.5,-264.5 836.5,-264.5 836.5,-264.5 830.5,-264.5 824.5,-258.5 824.5,-252.5 824.5,-252.5 824.5,-230.5 824.5,-230.5 824.5,-224.5 830.5,-218.5 836.5,-218.5"/>
<text text-anchor="middle" x="913" y="-249.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">3.KeyFlags::HasLocked</text>
<polyline fill="none" stroke="#1c2123" points="824.5,-241.5 1001.5,-241.5 "/>
<text text-anchor="start" x="832.5" y="-226.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">检查key是否有Locked flags</text>
</g>
<!-- KVTxn_collectLockedKeys&#45;&gt;HasLocked -->
<g id="edge7" class="edge">
<title>KVTxn_collectLockedKeys&#45;&gt;HasLocked</title>
<path fill="none" stroke="#666666" d="M768.69,-182.68C785.88,-192.06 804.37,-201.56 822,-209.5 825.83,-211.22 829.78,-212.92 833.79,-214.57"/>
<polygon fill="#666666" stroke="#666666" points="832.65,-217.89 843.23,-218.36 835.25,-211.39 832.65,-217.89"/>
</g>
<!-- doActionOnMutations -->
<g id="node9" class="node">
<title>doActionOnMutations</title>
<path fill="none" stroke="#1c2123" d="M1052,-8.5C1052,-8.5 1263,-8.5 1263,-8.5 1269,-8.5 1275,-14.5 1275,-20.5 1275,-20.5 1275,-72.5 1275,-72.5 1275,-78.5 1269,-84.5 1263,-84.5 1263,-84.5 1052,-84.5 1052,-84.5 1046,-84.5 1040,-78.5 1040,-72.5 1040,-72.5 1040,-20.5 1040,-20.5 1040,-14.5 1046,-8.5 1052,-8.5"/>
<text text-anchor="middle" x="1157.5" y="-69.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">doActionOnMutations</text>
<polyline fill="none" stroke="#1c2123" points="1040,-61.5 1275,-61.5 "/>
<text text-anchor="start" x="1048" y="-46.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">对mutations分组，分批</text>
<text text-anchor="start" x="1048" y="-31.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 并发的调用actionPessimisticRollback</text>
<text text-anchor="start" x="1048" y="-16.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> handleSignleBatch</text>
</g>
<!-- txn_committer_pessimisticRollbackMutations&#45;&gt;doActionOnMutations -->
<g id="edge9" class="edge">
<title>txn_committer_pessimisticRollbackMutations&#45;&gt;doActionOnMutations</title>
<path fill="none" stroke="#666666" d="M1004.3,-46.5C1012.62,-46.5 1021.15,-46.5 1029.72,-46.5"/>
<polygon fill="#666666" stroke="#666666" points="1029.79,-50 1039.79,-46.5 1029.79,-43 1029.79,-50"/>
</g>
<!-- actionPessimisticRollback_handleSingleBatch -->
<g id="node10" class="node">
<title>actionPessimisticRollback_handleSingleBatch</title>
<path fill="none" stroke="#1c2123" d="M1323,-12C1323,-12 1529,-12 1529,-12 1535,-12 1541,-18 1541,-24 1541,-24 1541,-69 1541,-69 1541,-75 1535,-81 1529,-81 1529,-81 1323,-81 1323,-81 1317,-81 1311,-75 1311,-69 1311,-69 1311,-24 1311,-24 1311,-18 1317,-12 1323,-12"/>
<text text-anchor="start" x="1319" y="-65.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">actionPessimisticRollback</text>
<polyline fill="none" stroke="#1c2123" points="1311,-58 1541,-58 "/>
<text text-anchor="start" x="1319" y="-42.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">handleSingleBatch</text>
<polyline fill="none" stroke="#1c2123" points="1311,-35 1541,-35 "/>
<text text-anchor="middle" x="1426" y="-19.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">发送PessimisticRollback请求给TiKV</text>
</g>
<!-- doActionOnMutations&#45;&gt;actionPessimisticRollback_handleSingleBatch -->
<g id="edge10" class="edge">
<title>doActionOnMutations&#45;&gt;actionPessimisticRollback_handleSingleBatch</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M1275,-46.5C1283.56,-46.5 1292.21,-46.5 1300.81,-46.5"/>
<polygon fill="green" stroke="green" points="1300.87,-50 1310.87,-46.5 1300.87,-43 1300.87,-50"/>
</g>
<!-- LockKeys -->
<g id="node11" class="node">
<title>LockKeys</title>
<path fill="none" stroke="#1c2123" d="M433.5,-0.5C433.5,-0.5 502.5,-0.5 502.5,-0.5 508.5,-0.5 514.5,-6.5 514.5,-12.5 514.5,-12.5 514.5,-34.5 514.5,-34.5 514.5,-40.5 508.5,-46.5 502.5,-46.5 502.5,-46.5 433.5,-46.5 433.5,-46.5 427.5,-46.5 421.5,-40.5 421.5,-34.5 421.5,-34.5 421.5,-12.5 421.5,-12.5 421.5,-6.5 427.5,-0.5 433.5,-0.5"/>
<text text-anchor="middle" x="468" y="-31.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">LockKeys</text>
<polyline fill="none" stroke="#1c2123" points="421.5,-23.5 514.5,-23.5 "/>
<text text-anchor="middle" x="468" y="-8.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">lockkeys失败</text>
</g>
<!-- asyncPessimisticRollback -->
<g id="node12" class="node">
<title>asyncPessimisticRollback</title>
<path fill="none" stroke="#1c2123" d="M763,-41.5C763,-41.5 629,-41.5 629,-41.5 623,-41.5 617,-35.5 617,-29.5 617,-29.5 617,-17.5 617,-17.5 617,-11.5 623,-5.5 629,-5.5 629,-5.5 763,-5.5 763,-5.5 769,-5.5 775,-11.5 775,-17.5 775,-17.5 775,-29.5 775,-29.5 775,-35.5 769,-41.5 763,-41.5"/>
<text text-anchor="middle" x="696" y="-19.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">asyncPessimisticRollback</text>
</g>
<!-- LockKeys&#45;&gt;asyncPessimisticRollback -->
<g id="edge11" class="edge">
<title>LockKeys&#45;&gt;asyncPessimisticRollback</title>
<path fill="none" stroke="#666666" d="M514.73,-23.5C541.15,-23.5 575.29,-23.5 606.73,-23.5"/>
<polygon fill="#666666" stroke="#666666" points="606.83,-27 616.83,-23.5 606.83,-20 606.83,-27"/>
</g>
<!-- asyncPessimisticRollback&#45;&gt;txn_committer_pessimisticRollbackMutations -->
<g id="edge12" class="edge">
<title>asyncPessimisticRollback&#45;&gt;txn_committer_pessimisticRollbackMutations</title>
<path fill="none" stroke="#666666" d="M775.23,-31.87C787.05,-33.13 799.38,-34.45 811.58,-35.76"/>
<polygon fill="#666666" stroke="#666666" points="811.48,-39.27 821.8,-36.85 812.23,-32.31 811.48,-39.27"/>
</g>
</g>
</svg>
