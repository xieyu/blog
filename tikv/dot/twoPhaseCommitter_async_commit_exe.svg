<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.1 (20210417.1919)
 -->
<!-- Title: async_commit_execute Pages: 1 -->
<svg width="1244pt" height="354pt"
 viewBox="0.00 0.00 1244.00 354.06" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 350.06)">
<title>async_commit_execute</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-350.06 1240,-350.06 1240,4 -4,4"/>
<g id="clust1" class="cluster">
<title>cluster_twoPhaseCommitter</title>
<path fill="none" stroke="slategrey" stroke-dasharray="5,2" d="M20,-17.06C20,-17.06 1216,-17.06 1216,-17.06 1222,-17.06 1228,-23.06 1228,-29.06 1228,-29.06 1228,-326.06 1228,-326.06 1228,-332.06 1222,-338.06 1216,-338.06 1216,-338.06 20,-338.06 20,-338.06 14,-338.06 8,-332.06 8,-326.06 8,-326.06 8,-29.06 8,-29.06 8,-23.06 14,-17.06 20,-17.06"/>
<text text-anchor="middle" x="618" y="-318.06" font-family="Times,serif" font-size="20.00">twoPhaseCommitter</text>
</g>
<!-- execute -->
<g id="node1" class="node">
<title>execute</title>
<path fill="none" stroke="#1c2123" d="M62,-118.06C62,-118.06 28,-118.06 28,-118.06 22,-118.06 16,-112.06 16,-106.06 16,-106.06 16,-94.06 16,-94.06 16,-88.06 22,-82.06 28,-82.06 28,-82.06 62,-82.06 62,-82.06 68,-82.06 74,-88.06 74,-94.06 74,-94.06 74,-106.06 74,-106.06 74,-112.06 68,-118.06 62,-118.06"/>
<text text-anchor="middle" x="45" y="-96.36" font-family="Times,serif" font-size="14.00" fill="#2f3638">execute</text>
</g>
<!-- GetTimestamp -->
<g id="node2" class="node">
<title>GetTimestamp</title>
<path fill="none" stroke="#1c2123" d="M563.5,-25.56C563.5,-25.56 754.5,-25.56 754.5,-25.56 760.5,-25.56 766.5,-31.56 766.5,-37.56 766.5,-37.56 766.5,-112.56 766.5,-112.56 766.5,-118.56 760.5,-124.56 754.5,-124.56 754.5,-124.56 563.5,-124.56 563.5,-124.56 557.5,-124.56 551.5,-118.56 551.5,-112.56 551.5,-112.56 551.5,-37.56 551.5,-37.56 551.5,-31.56 557.5,-25.56 563.5,-25.56"/>
<text text-anchor="middle" x="659" y="-109.36" font-family="Times,serif" font-size="14.00" fill="#2f3638">1. GetTimestamp</text>
<polyline fill="none" stroke="#1c2123" points="551.5,-101.56 766.5,-101.56 "/>
<text text-anchor="start" x="559.5" y="-86.36" font-family="Times,serif" font-size="14.00" fill="#2f3638">if needLinearizability</text>
<polyline fill="none" stroke="#1c2123" points="551.5,-78.56 766.5,-78.56 "/>
<text text-anchor="start" x="559.5" y="-63.36" font-family="Times,serif" font-size="14.00" fill="#2f3638">在prewrite前</text>
<text text-anchor="start" x="559.5" y="-48.36" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 获取minCommitTS</text>
<text text-anchor="start" x="559.5" y="-33.36" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 用保证async commit线性一致性.</text>
</g>
<!-- execute&#45;&gt;GetTimestamp -->
<g id="edge1" class="edge">
<title>execute&#45;&gt;GetTimestamp</title>
<path fill="none" stroke="#666666" d="M57.96,-81.78C69.27,-66.32 87.79,-45.26 110,-36.06 273.83,31.81 333.12,-13.42 509,-36.06 519.56,-37.42 530.44,-39.3 541.28,-41.5"/>
<polygon fill="#666666" stroke="#666666" points="540.71,-44.96 551.22,-43.61 542.16,-38.11 540.71,-44.96"/>
</g>
<!-- checkAsyncCommit -->
<g id="node3" class="node">
<title>checkAsyncCommit</title>
<path fill="none" stroke="#1c2123" d="M226,-81.06C226,-81.06 122,-81.06 122,-81.06 116,-81.06 110,-75.06 110,-69.06 110,-69.06 110,-57.06 110,-57.06 110,-51.06 116,-45.06 122,-45.06 122,-45.06 226,-45.06 226,-45.06 232,-45.06 238,-51.06 238,-57.06 238,-57.06 238,-69.06 238,-69.06 238,-75.06 232,-81.06 226,-81.06"/>
<text text-anchor="middle" x="174" y="-59.36" font-family="Times,serif" font-size="14.00" fill="#2f3638">checkAsyncCommit</text>
</g>
<!-- execute&#45;&gt;checkAsyncCommit -->
<g id="edge2" class="edge">
<title>execute&#45;&gt;checkAsyncCommit</title>
<path fill="none" stroke="#666666" d="M74.19,-91.85C82.41,-89.45 91.79,-86.72 101.42,-83.91"/>
<polygon fill="#666666" stroke="#666666" points="102.48,-87.25 111.1,-81.09 100.52,-80.53 102.48,-87.25"/>
</g>
<!-- setAsyncCommit -->
<g id="node4" class="node">
<title>setAsyncCommit</title>
<path fill="none" stroke="#1c2123" d="M435.5,-81.06C435.5,-81.06 347.5,-81.06 347.5,-81.06 341.5,-81.06 335.5,-75.06 335.5,-69.06 335.5,-69.06 335.5,-57.06 335.5,-57.06 335.5,-51.06 341.5,-45.06 347.5,-45.06 347.5,-45.06 435.5,-45.06 435.5,-45.06 441.5,-45.06 447.5,-51.06 447.5,-57.06 447.5,-57.06 447.5,-69.06 447.5,-69.06 447.5,-75.06 441.5,-81.06 435.5,-81.06"/>
<text text-anchor="middle" x="391.5" y="-59.36" font-family="Times,serif" font-size="14.00" fill="#2f3638">setAsyncCommit</text>
</g>
<!-- execute&#45;&gt;setAsyncCommit -->
<g id="edge3" class="edge">
<title>execute&#45;&gt;setAsyncCommit</title>
<path fill="none" stroke="#666666" d="M74.07,-99.68C111.55,-98.92 179.96,-96.68 238,-90.06 266.78,-86.77 298.35,-81.47 325.26,-76.43"/>
<polygon fill="#666666" stroke="#666666" points="326.15,-79.82 335.33,-74.52 324.85,-72.95 326.15,-79.82"/>
</g>
<!-- prewriteMutations -->
<g id="node5" class="node">
<title>prewriteMutations</title>
<path fill="none" stroke="#1c2123" d="M127.5,-132.06C127.5,-132.06 220.5,-132.06 220.5,-132.06 226.5,-132.06 232.5,-138.06 232.5,-144.06 232.5,-144.06 232.5,-156.06 232.5,-156.06 232.5,-162.06 226.5,-168.06 220.5,-168.06 220.5,-168.06 127.5,-168.06 127.5,-168.06 121.5,-168.06 115.5,-162.06 115.5,-156.06 115.5,-156.06 115.5,-144.06 115.5,-144.06 115.5,-138.06 121.5,-132.06 127.5,-132.06"/>
<text text-anchor="middle" x="174" y="-146.36" font-family="Times,serif" font-size="14.00" fill="#2f3638">prewriteMutations</text>
</g>
<!-- execute&#45;&gt;prewriteMutations -->
<g id="edge4" class="edge">
<title>execute&#45;&gt;prewriteMutations</title>
<path fill="none" stroke="#666666" d="M74.19,-111.15C86.89,-116.16 102.37,-122.25 117.27,-128.11"/>
<polygon fill="#666666" stroke="#666666" points="116.35,-131.52 126.94,-131.92 118.91,-125 116.35,-131.52"/>
</g>
<!-- go_commitMutations -->
<g id="node6" class="node">
<title>go_commitMutations</title>
<path fill="none" stroke="#1c2123" d="M286,-223.06C286,-223.06 497,-223.06 497,-223.06 503,-223.06 509,-229.06 509,-235.06 509,-235.06 509,-287.06 509,-287.06 509,-293.06 503,-299.06 497,-299.06 497,-299.06 286,-299.06 286,-299.06 280,-299.06 274,-293.06 274,-287.06 274,-287.06 274,-235.06 274,-235.06 274,-229.06 280,-223.06 286,-223.06"/>
<text text-anchor="middle" x="391.5" y="-283.86" font-family="Times,serif" font-size="14.00" fill="#2f3638">4. commitMutations</text>
<polyline fill="none" stroke="#1c2123" points="274,-276.06 509,-276.06 "/>
<text text-anchor="start" x="282" y="-260.86" font-family="Times,serif" font-size="14.00" fill="#2f3638">新起一个go routine 执行</text>
<text text-anchor="start" x="282" y="-245.86" font-family="Times,serif" font-size="14.00" fill="#2f3638"> commitMutations</text>
<text text-anchor="middle" x="391.5" y="-230.86" font-family="Times,serif" font-size="14.00" fill="#2f3638"> client不必等待primary key 提交成功</text>
</g>
<!-- execute&#45;&gt;go_commitMutations -->
<g id="edge5" class="edge">
<title>execute&#45;&gt;go_commitMutations</title>
<path fill="none" stroke="#666666" d="M56.4,-118.2C67.48,-135.97 86.64,-162.56 110,-178.06 155.92,-208.52 213.31,-228.07 264.19,-240.48"/>
<polygon fill="#666666" stroke="#666666" points="263.4,-243.89 273.94,-242.8 265.02,-237.08 263.4,-243.89"/>
</g>
<!-- minCommitTS -->
<g id="node8" class="node">
<title>minCommitTS</title>
<path fill="#feed9b" stroke="#f7e495" d="M821,-127.06C821,-127.06 954,-127.06 954,-127.06 960,-127.06 966,-133.06 966,-139.06 966,-139.06 966,-191.06 966,-191.06 966,-197.06 960,-203.06 954,-203.06 954,-203.06 821,-203.06 821,-203.06 815,-203.06 809,-197.06 809,-191.06 809,-191.06 809,-139.06 809,-139.06 809,-133.06 815,-127.06 821,-127.06"/>
<text text-anchor="start" x="817" y="-187.86" font-family="Times,serif" font-size="14.00" fill="#40575d">minCommitTS</text>
<polyline fill="none" stroke="#f7e495" points="809,-180.06 966,-180.06 "/>
<text text-anchor="start" x="817" y="-164.86" font-family="Times,serif" font-size="14.00" fill="#40575d">成员变量minCommitTS</text>
<text text-anchor="start" x="817" y="-149.86" font-family="Times,serif" font-size="14.00" fill="#40575d"> 带了mu lock</text>
<text text-anchor="start" x="817" y="-134.86" font-family="Times,serif" font-size="14.00" fill="#40575d"> 可以并发的更新</text>
</g>
<!-- GetTimestamp&#45;&gt;minCommitTS -->
<g id="edge15" class="edge">
<title>GetTimestamp&#45;&gt;minCommitTS</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M766.62,-117.42C777.62,-121.79 788.71,-126.2 799.46,-130.47"/>
<polygon fill="green" stroke="green" points="798.23,-133.75 808.82,-134.19 800.82,-127.24 798.23,-133.75"/>
</g>
<!-- checkAsyncCommit&#45;&gt;setAsyncCommit -->
<g id="edge6" class="edge">
<title>checkAsyncCommit&#45;&gt;setAsyncCommit</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M238.2,-63.06C265.51,-63.06 297.46,-63.06 325.02,-63.06"/>
<polygon fill="green" stroke="green" points="325.35,-66.56 335.35,-63.06 325.35,-59.56 325.35,-66.56"/>
</g>
<!-- setAsyncCommit&#45;&gt;GetTimestamp -->
<g id="edge7" class="edge">
<title>setAsyncCommit&#45;&gt;GetTimestamp</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M447.51,-65.54C474.7,-66.77 508.6,-68.3 541.2,-69.78"/>
<polygon fill="green" stroke="green" points="541.12,-73.28 551.26,-70.23 541.43,-66.28 541.12,-73.28"/>
</g>
<!-- prewriteMutations&#45;&gt;go_commitMutations -->
<g id="edge16" class="edge">
<title>prewriteMutations&#45;&gt;go_commitMutations</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M200.25,-168.29C219.79,-181.93 247.84,-200.48 274,-214.06 276.95,-215.59 279.97,-217.11 283.02,-218.6"/>
<polygon fill="green" stroke="green" points="281.78,-221.89 292.31,-223.03 284.79,-215.57 281.78,-221.89"/>
</g>
<!-- prewriteMutations&#45;&gt;minCommitTS -->
<g id="edge9" class="edge">
<title>prewriteMutations&#45;&gt;minCommitTS</title>
<path fill="none" stroke="#666666" d="M211.16,-132.03C229.49,-123.87 252.4,-115.16 274,-111.06 376.61,-91.57 408.75,-81.77 509,-111.06 527.22,-116.38 527.03,-127.94 545,-134.06 641.3,-166.83 671.71,-144.71 773,-154.06 781.36,-154.83 790.06,-155.65 798.77,-156.47"/>
<polygon fill="#666666" stroke="#666666" points="798.68,-159.98 808.97,-157.45 799.35,-153.01 798.68,-159.98"/>
</g>
<!-- actionPrewrite_handleSingleBatch -->
<g id="node10" class="node">
<title>actionPrewrite_handleSingleBatch</title>
<path fill="none" stroke="#1c2123" d="M323,-120.06C323,-120.06 460,-120.06 460,-120.06 466,-120.06 472,-126.06 472,-132.06 472,-132.06 472,-192.06 472,-192.06 472,-198.06 466,-204.06 460,-204.06 460,-204.06 323,-204.06 323,-204.06 317,-204.06 311,-198.06 311,-192.06 311,-192.06 311,-132.06 311,-132.06 311,-126.06 317,-120.06 323,-120.06"/>
<text text-anchor="start" x="319" y="-188.86" font-family="Times,serif" font-size="14.00" fill="#2f3638">actionPrewrite</text>
<polyline fill="none" stroke="#1c2123" points="311,-181.06 472,-181.06 "/>
<text text-anchor="start" x="319" y="-165.86" font-family="Times,serif" font-size="14.00" fill="#2f3638">handleSingleBatch</text>
<polyline fill="none" stroke="#1c2123" points="311,-158.06 472,-158.06 "/>
<text text-anchor="start" x="319" y="-142.86" font-family="Times,serif" font-size="14.00" fill="#2f3638">向TikV发送prewrite请求</text>
<text text-anchor="start" x="319" y="-127.86" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 处理conflict, regionError</text>
</g>
<!-- prewriteMutations&#45;&gt;actionPrewrite_handleSingleBatch -->
<g id="edge10" class="edge">
<title>prewriteMutations&#45;&gt;actionPrewrite_handleSingleBatch</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M232.75,-153.27C253.6,-154.43 277.66,-155.77 300.61,-157.05"/>
<polygon fill="green" stroke="green" points="300.54,-160.55 310.72,-157.61 300.93,-153.56 300.54,-160.55"/>
</g>
<!-- commitMutations -->
<g id="node7" class="node">
<title>commitMutations</title>
<path fill="none" stroke="#1c2123" d="M704.5,-299.06C704.5,-299.06 613.5,-299.06 613.5,-299.06 607.5,-299.06 601.5,-293.06 601.5,-287.06 601.5,-287.06 601.5,-275.06 601.5,-275.06 601.5,-269.06 607.5,-263.06 613.5,-263.06 613.5,-263.06 704.5,-263.06 704.5,-263.06 710.5,-263.06 716.5,-269.06 716.5,-275.06 716.5,-275.06 716.5,-287.06 716.5,-287.06 716.5,-293.06 710.5,-299.06 704.5,-299.06"/>
<text text-anchor="middle" x="659" y="-277.36" font-family="Times,serif" font-size="14.00" fill="#2f3638">commitMutations</text>
</g>
<!-- go_commitMutations&#45;&gt;commitMutations -->
<g id="edge8" class="edge">
<title>go_commitMutations&#45;&gt;commitMutations</title>
<path fill="none" stroke="#666666" d="M509.34,-269.86C537.34,-271.97 566.3,-274.15 591.14,-276.02"/>
<polygon fill="#666666" stroke="#666666" points="590.92,-279.51 601.15,-276.77 591.44,-272.53 590.92,-279.51"/>
</g>
<!-- buildPrewriteRequest -->
<g id="node9" class="node">
<title>buildPrewriteRequest</title>
<path fill="none" stroke="#1c2123" d="M1014,-173.06C1014,-173.06 1208,-173.06 1208,-173.06 1214,-173.06 1220,-179.06 1220,-185.06 1220,-185.06 1220,-245.06 1220,-245.06 1220,-251.06 1214,-257.06 1208,-257.06 1208,-257.06 1014,-257.06 1014,-257.06 1008,-257.06 1002,-251.06 1002,-245.06 1002,-245.06 1002,-185.06 1002,-185.06 1002,-179.06 1008,-173.06 1014,-173.06"/>
<text text-anchor="middle" x="1111" y="-241.86" font-family="Times,serif" font-size="14.00" fill="#2f3638">2. buildPrewriteRequest</text>
<polyline fill="none" stroke="#1c2123" points="1002,-234.06 1220,-234.06 "/>
<text text-anchor="start" x="1010" y="-218.86" font-family="Times,serif" font-size="14.00" fill="#2f3638">minCommitTS = c.forUpdateTS + 1</text>
<polyline fill="none" stroke="#1c2123" points="1002,-211.06 1220,-211.06 "/>
<text text-anchor="start" x="1010" y="-195.86" font-family="Times,serif" font-size="14.00" fill="#2f3638">minCommitTS = c.startTS + 1</text>
<text text-anchor="start" x="1010" y="-180.86" font-family="Times,serif" font-size="14.00" fill="#2f3638"> MaxCommitTs = c.maxCommitTS</text>
</g>
<!-- minCommitTS&#45;&gt;buildPrewriteRequest -->
<g id="edge12" class="edge">
<title>minCommitTS&#45;&gt;buildPrewriteRequest</title>
<path fill="none" stroke="#666666" d="M966.28,-182.61C974.61,-184.5 983.22,-186.44 991.89,-188.39"/>
<polygon fill="#666666" stroke="#666666" points="991.16,-191.82 1001.69,-190.61 992.7,-184.99 991.16,-191.82"/>
</g>
<!-- actionPrewrite_handleSingleBatch&#45;&gt;buildPrewriteRequest -->
<g id="edge11" class="edge">
<title>actionPrewrite_handleSingleBatch&#45;&gt;buildPrewriteRequest</title>
<path fill="none" stroke="#666666" d="M472.21,-196.52C484.61,-202.2 497.21,-208.17 509,-214.06 525.37,-222.24 527.28,-229.47 545,-234.06 626.28,-255.12 851.28,-239.54 991.59,-226.89"/>
<polygon fill="#666666" stroke="#666666" points="992.32,-230.34 1001.97,-225.95 991.69,-223.37 992.32,-230.34"/>
</g>
<!-- prewriteResp -->
<g id="node11" class="node">
<title>prewriteResp</title>
<path fill="none" stroke="#1c2123" d="M557,-163.56C557,-163.56 761,-163.56 761,-163.56 767,-163.56 773,-169.56 773,-175.56 773,-175.56 773,-212.56 773,-212.56 773,-218.56 767,-224.56 761,-224.56 761,-224.56 557,-224.56 557,-224.56 551,-224.56 545,-218.56 545,-212.56 545,-212.56 545,-175.56 545,-175.56 545,-169.56 551,-163.56 557,-163.56"/>
<text text-anchor="middle" x="659" y="-209.36" font-family="Times,serif" font-size="14.00" fill="#2f3638">3. prewriteResp</text>
<polyline fill="none" stroke="#1c2123" points="545,-201.56 773,-201.56 "/>
<text text-anchor="start" x="553" y="-186.36" font-family="Times,serif" font-size="14.00" fill="#2f3638">TiKV resp中带了minCommitTS</text>
<text text-anchor="start" x="553" y="-171.36" font-family="Times,serif" font-size="14.00" fill="#2f3638"> commiter更新自己的minCommitTS</text>
</g>
<!-- actionPrewrite_handleSingleBatch&#45;&gt;prewriteResp -->
<g id="edge13" class="edge">
<title>actionPrewrite_handleSingleBatch&#45;&gt;prewriteResp</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M472.16,-171.66C491.81,-174.03 513.31,-176.62 534.5,-179.17"/>
<polygon fill="green" stroke="green" points="534.19,-182.66 544.53,-180.38 535.03,-175.71 534.19,-182.66"/>
</g>
<!-- prewriteResp&#45;&gt;minCommitTS -->
<g id="edge14" class="edge">
<title>prewriteResp&#45;&gt;minCommitTS</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M773.25,-179.56C781.82,-178.46 790.39,-177.36 798.76,-176.29"/>
<polygon fill="green" stroke="green" points="799.39,-179.74 808.87,-175 798.5,-172.79 799.39,-179.74"/>
</g>
</g>
</svg>
