<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.0 (20210316.0004)
 -->
<!-- Title: delete_write Pages: 1 -->
<svg width="1505pt" height="421pt"
 viewBox="0.00 0.00 1505.00 420.90" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 416.9)">
<title>delete_write</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-416.9 1501,-416.9 1501,4 -4,4"/>
<!-- delete_write -->
<g id="node1" class="node">
<title>delete_write</title>
<path fill="none" stroke="#1c2123" d="M1485,-309C1485,-309 1426,-309 1426,-309 1420,-309 1414,-303 1414,-297 1414,-297 1414,-285 1414,-285 1414,-279 1420,-273 1426,-273 1426,-273 1485,-273 1485,-273 1491,-273 1497,-279 1497,-285 1497,-285 1497,-297 1497,-297 1497,-303 1491,-309 1485,-309"/>
<text text-anchor="middle" x="1455.5" y="-287.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">delete_write</text>
</g>
<!-- collapse_prev_rollback -->
<g id="node2" class="node">
<title>collapse_prev_rollback</title>
<path fill="none" stroke="#1c2123" d="M1205,-260.5C1205,-260.5 1366,-260.5 1366,-260.5 1372,-260.5 1378,-266.5 1378,-272.5 1378,-272.5 1378,-309.5 1378,-309.5 1378,-315.5 1372,-321.5 1366,-321.5 1366,-321.5 1205,-321.5 1205,-321.5 1199,-321.5 1193,-315.5 1193,-309.5 1193,-309.5 1193,-272.5 1193,-272.5 1193,-266.5 1199,-260.5 1205,-260.5"/>
<text text-anchor="middle" x="1285.5" y="-306.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">collapse_prev_rollback</text>
<polyline fill="none" stroke="#1c2123" points="1193,-298.5 1378,-298.5 "/>
<text text-anchor="start" x="1201" y="-283.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">删掉WriteType为RollBack</text>
<text text-anchor="start" x="1201" y="-268.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 且!is_protected的write record</text>
</g>
<!-- collapse_prev_rollback&#45;&gt;delete_write -->
<g id="edge1" class="edge">
<title>collapse_prev_rollback&#45;&gt;delete_write</title>
<path fill="none" stroke="#666666" d="M1378.36,-291C1386.99,-291 1395.51,-291 1403.55,-291"/>
<polygon fill="#666666" stroke="#666666" points="1403.81,-294.5 1413.81,-291 1403.81,-287.5 1403.81,-294.5"/>
</g>
<!-- CheckSecondaryLocks_process_write -->
<g id="node3" class="node">
<title>CheckSecondaryLocks_process_write</title>
<path fill="none" stroke="#1c2123" d="M754,-329.5C754,-329.5 954,-329.5 954,-329.5 960,-329.5 966,-335.5 966,-341.5 966,-341.5 966,-378.5 966,-378.5 966,-384.5 960,-390.5 954,-390.5 954,-390.5 754,-390.5 754,-390.5 748,-390.5 742,-384.5 742,-378.5 742,-378.5 742,-341.5 742,-341.5 742,-335.5 748,-329.5 754,-329.5"/>
<text text-anchor="start" x="750" y="-375.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">CheckSecondaryLocks::process_write</text>
<polyline fill="none" stroke="#1c2123" points="742,-367.5 966,-367.5 "/>
<text text-anchor="start" x="750" y="-352.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">check secondary lock of an</text>
<text text-anchor="start" x="750" y="-337.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> aysnc commit transaction</text>
</g>
<!-- CheckSecondaryLocks_process_write&#45;&gt;collapse_prev_rollback -->
<g id="edge2" class="edge">
<title>CheckSecondaryLocks_process_write&#45;&gt;collapse_prev_rollback</title>
<path fill="none" stroke="#666666" d="M966.24,-361.21C1023.79,-359.78 1094.81,-354.79 1157,-341 1173.98,-337.23 1191.66,-331.54 1208.27,-325.32"/>
<polygon fill="#666666" stroke="#666666" points="1209.83,-328.47 1217.9,-321.61 1207.31,-321.94 1209.83,-328.47"/>
</g>
<!-- get_txn_commit_record -->
<g id="node12" class="node">
<title>get_txn_commit_record</title>
<path fill="none" stroke="#1c2123" d="M1145,-332C1145,-332 1021,-332 1021,-332 1015,-332 1009,-326 1009,-320 1009,-320 1009,-308 1009,-308 1009,-302 1015,-296 1021,-296 1021,-296 1145,-296 1145,-296 1151,-296 1157,-302 1157,-308 1157,-308 1157,-320 1157,-320 1157,-326 1151,-332 1145,-332"/>
<text text-anchor="middle" x="1083" y="-310.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">get_txn_commit_record</text>
</g>
<!-- CheckSecondaryLocks_process_write&#45;&gt;get_txn_commit_record -->
<g id="edge15" class="edge">
<title>CheckSecondaryLocks_process_write&#45;&gt;get_txn_commit_record</title>
<path fill="none" stroke="#666666" d="M966.17,-337.47C977.15,-335.25 988.16,-333.02 998.79,-330.86"/>
<polygon fill="#666666" stroke="#666666" points="999.75,-334.24 1008.85,-328.82 998.36,-327.38 999.75,-334.24"/>
</g>
<!-- rollback_lock -->
<g id="node4" class="node">
<title>rollback_lock</title>
<path fill="none" stroke="#1c2123" d="M781.5,-167C781.5,-167 926.5,-167 926.5,-167 932.5,-167 938.5,-173 938.5,-179 938.5,-179 938.5,-231 938.5,-231 938.5,-237 932.5,-243 926.5,-243 926.5,-243 781.5,-243 781.5,-243 775.5,-243 769.5,-237 769.5,-231 769.5,-231 769.5,-179 769.5,-179 769.5,-173 775.5,-167 781.5,-167"/>
<text text-anchor="middle" x="854" y="-227.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">rollback_lock</text>
<polyline fill="none" stroke="#1c2123" points="769.5,-220 938.5,-220 "/>
<text text-anchor="start" x="777.5" y="-204.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">根据参数collapse_rollback</text>
<text text-anchor="start" x="777.5" y="-189.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 来决定是否要调用</text>
<text text-anchor="start" x="777.5" y="-174.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> collapse_prev_rollback</text>
</g>
<!-- rollback_lock&#45;&gt;collapse_prev_rollback -->
<g id="edge3" class="edge">
<title>rollback_lock&#45;&gt;collapse_prev_rollback</title>
<path fill="none" stroke="#666666" d="M938.58,-221.73C1008.52,-235.74 1108.57,-255.77 1183.09,-270.69"/>
<polygon fill="#666666" stroke="#666666" points="1182.48,-274.14 1192.97,-272.67 1183.85,-267.28 1182.48,-274.14"/>
</g>
<!-- check_txn_status_missing_lock -->
<g id="node5" class="node">
<title>check_txn_status_missing_lock</title>
<path fill="none" stroke="#1c2123" d="M747,-262C747,-262 961,-262 961,-262 967,-262 973,-268 973,-274 973,-274 973,-296 973,-296 973,-302 967,-308 961,-308 961,-308 747,-308 747,-308 741,-308 735,-302 735,-296 735,-296 735,-274 735,-274 735,-268 741,-262 747,-262"/>
<text text-anchor="middle" x="854" y="-292.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">check_txn_status_missing_lock</text>
<polyline fill="none" stroke="#1c2123" points="735,-285 973,-285 "/>
<text text-anchor="middle" x="854" y="-269.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">如果获取的TxnCommitRecord为None</text>
</g>
<!-- check_txn_status_missing_lock&#45;&gt;collapse_prev_rollback -->
<g id="edge4" class="edge">
<title>check_txn_status_missing_lock&#45;&gt;collapse_prev_rollback</title>
<path fill="none" stroke="#666666" d="M973.34,-285.11C1029.07,-285.33 1096.45,-285.85 1157,-287 1165.36,-287.16 1174.02,-287.36 1182.71,-287.58"/>
<polygon fill="#666666" stroke="#666666" points="1182.83,-291.09 1192.92,-287.85 1183.02,-284.09 1182.83,-291.09"/>
</g>
<!-- check_txn_status_missing_lock&#45;&gt;get_txn_commit_record -->
<g id="edge17" class="edge">
<title>check_txn_status_missing_lock&#45;&gt;get_txn_commit_record</title>
<path fill="none" stroke="#666666" d="M973.15,-300.09C981.81,-301.2 990.43,-302.3 998.81,-303.37"/>
<polygon fill="#666666" stroke="#666666" points="998.54,-306.87 1008.9,-304.66 999.42,-299.92 998.54,-306.87"/>
</g>
<!-- cleanup -->
<g id="node6" class="node">
<title>cleanup</title>
<path fill="none" stroke="#1c2123" d="M598,-282C598,-282 563,-282 563,-282 557,-282 551,-276 551,-270 551,-270 551,-258 551,-258 551,-252 557,-246 563,-246 563,-246 598,-246 598,-246 604,-246 610,-252 610,-258 610,-258 610,-270 610,-270 610,-276 604,-282 598,-282"/>
<text text-anchor="middle" x="580.5" y="-260.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">cleanup</text>
</g>
<!-- cleanup&#45;&gt;rollback_lock -->
<g id="edge6" class="edge">
<title>cleanup&#45;&gt;rollback_lock</title>
<path fill="none" stroke="#666666" d="M610.04,-257.8C645.28,-250.14 706.98,-236.73 759.38,-225.35"/>
<polygon fill="#666666" stroke="#666666" points="760.35,-228.71 769.38,-223.17 758.87,-221.87 760.35,-228.71"/>
</g>
<!-- cleanup&#45;&gt;check_txn_status_missing_lock -->
<g id="edge5" class="edge">
<title>cleanup&#45;&gt;check_txn_status_missing_lock</title>
<path fill="none" stroke="#666666" d="M610.04,-266.21C637.77,-268.35 681.87,-271.76 724.94,-275.09"/>
<polygon fill="#666666" stroke="#666666" points="724.74,-278.59 734.98,-275.87 725.28,-271.61 724.74,-278.59"/>
</g>
<!-- CheckTxnStatus_process_write -->
<g id="node7" class="node">
<title>CheckTxnStatus_process_write</title>
<path fill="none" stroke="#1c2123" d="M205,-0.5C205,-0.5 414,-0.5 414,-0.5 420,-0.5 426,-6.5 426,-12.5 426,-12.5 426,-87.5 426,-87.5 426,-93.5 420,-99.5 414,-99.5 414,-99.5 205,-99.5 205,-99.5 199,-99.5 193,-93.5 193,-87.5 193,-87.5 193,-12.5 193,-12.5 193,-6.5 199,-0.5 205,-0.5"/>
<text text-anchor="middle" x="309.5" y="-84.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">CheckTxnStatus::process_write</text>
<polyline fill="none" stroke="#1c2123" points="193,-76.5 426,-76.5 "/>
<text text-anchor="start" x="201" y="-61.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Check the status of a transaction</text>
<text text-anchor="start" x="201" y="-46.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> this is usually invoked by a transaction</text>
<text text-anchor="start" x="201" y="-31.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> that meets another transaction&#39;s lock</text>
<polyline fill="none" stroke="#1c2123" points="193,-23.5 426,-23.5 "/>
<text text-anchor="start" x="201" y="-8.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">读取primary lock</text>
</g>
<!-- check_txn_status_lock_exists -->
<g id="node8" class="node">
<title>check_txn_status_lock_exists</title>
<path fill="none" stroke="#1c2123" d="M474,-45.5C474,-45.5 687,-45.5 687,-45.5 693,-45.5 699,-51.5 699,-57.5 699,-57.5 699,-132.5 699,-132.5 699,-138.5 693,-144.5 687,-144.5 687,-144.5 474,-144.5 474,-144.5 468,-144.5 462,-138.5 462,-132.5 462,-132.5 462,-57.5 462,-57.5 462,-51.5 468,-45.5 474,-45.5"/>
<text text-anchor="middle" x="580.5" y="-129.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">check_txn_status_lock_exists</text>
<polyline fill="none" stroke="#1c2123" points="462,-121.5 699,-121.5 "/>
<text text-anchor="start" x="470" y="-106.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">check whether there&#39;s an overlapped</text>
<text text-anchor="start" x="470" y="-91.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> write rercord and then perform rollback</text>
<polyline fill="none" stroke="#1c2123" points="462,-83.5 699,-83.5 "/>
<text text-anchor="start" x="470" y="-68.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">检查lock的ttl，如果过期了</text>
<text text-anchor="start" x="470" y="-53.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 清理掉这个key</text>
</g>
<!-- CheckTxnStatus_process_write&#45;&gt;check_txn_status_lock_exists -->
<g id="edge7" class="edge">
<title>CheckTxnStatus_process_write&#45;&gt;check_txn_status_lock_exists</title>
<path fill="none" stroke="#666666" d="M426.14,-69.35C434.64,-70.77 443.23,-72.2 451.79,-73.64"/>
<polygon fill="#666666" stroke="#666666" points="451.38,-77.12 461.82,-75.31 452.53,-70.21 451.38,-77.12"/>
</g>
<!-- check_txn_status_lock_exists&#45;&gt;rollback_lock -->
<g id="edge8" class="edge">
<title>check_txn_status_lock_exists&#45;&gt;rollback_lock</title>
<path fill="none" stroke="#666666" d="M699,-142.61C719.33,-150.84 740.2,-159.3 759.77,-167.23"/>
<polygon fill="#666666" stroke="#666666" points="758.68,-170.56 769.26,-171.07 761.31,-164.07 758.68,-170.56"/>
</g>
<!-- ResolveLock_process_write -->
<g id="node9" class="node">
<title>ResolveLock_process_write</title>
<path fill="none" stroke="#1c2123" d="M217.5,-252.5C217.5,-252.5 401.5,-252.5 401.5,-252.5 407.5,-252.5 413.5,-258.5 413.5,-264.5 413.5,-264.5 413.5,-339.5 413.5,-339.5 413.5,-345.5 407.5,-351.5 401.5,-351.5 401.5,-351.5 217.5,-351.5 217.5,-351.5 211.5,-351.5 205.5,-345.5 205.5,-339.5 205.5,-339.5 205.5,-264.5 205.5,-264.5 205.5,-258.5 211.5,-252.5 217.5,-252.5"/>
<text text-anchor="middle" x="309.5" y="-336.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">ResolveLock::process_write</text>
<polyline fill="none" stroke="#1c2123" points="205.5,-328.5 413.5,-328.5 "/>
<text text-anchor="start" x="213.5" y="-313.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">清理已经commit/abort</text>
<text text-anchor="start" x="213.5" y="-298.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 事务遗留的</text>
<text text-anchor="start" x="213.5" y="-283.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> not&#45;yet&#45;committed key</text>
<polyline fill="none" stroke="#1c2123" points="205.5,-275.5 413.5,-275.5 "/>
<text text-anchor="start" x="213.5" y="-260.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">对于abort的事务的key做rollback</text>
</g>
<!-- ResolveLock_process_write&#45;&gt;cleanup -->
<g id="edge9" class="edge">
<title>ResolveLock_process_write&#45;&gt;cleanup</title>
<path fill="none" stroke="#666666" d="M413.73,-287.42C458.25,-281.13 507.61,-274.16 540.8,-269.47"/>
<polygon fill="#666666" stroke="#666666" points="541.56,-272.89 550.97,-268.03 540.58,-265.96 541.56,-272.89"/>
</g>
<!-- Rollback_process_write -->
<g id="node10" class="node">
<title>Rollback_process_write</title>
<path fill="none" stroke="#1c2123" d="M212.5,-119C212.5,-119 406.5,-119 406.5,-119 412.5,-119 418.5,-125 418.5,-131 418.5,-131 418.5,-221 418.5,-221 418.5,-227 412.5,-233 406.5,-233 406.5,-233 212.5,-233 212.5,-233 206.5,-233 200.5,-227 200.5,-221 200.5,-221 200.5,-131 200.5,-131 200.5,-125 206.5,-119 212.5,-119"/>
<text text-anchor="middle" x="309.5" y="-217.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">Rollback::process_write</text>
<polyline fill="none" stroke="#1c2123" points="200.5,-210 418.5,-210 "/>
<text text-anchor="start" x="208.5" y="-194.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">遍历self.keys</text>
<text text-anchor="start" x="208.5" y="-179.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 对于每一个key call cleanup</text>
<polyline fill="none" stroke="#1c2123" points="200.5,-172 418.5,-172 "/>
<text text-anchor="start" x="208.5" y="-156.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">Rollback is called only if</text>
<text text-anchor="start" x="208.5" y="-141.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> the transaction is know to fail</text>
<text text-anchor="start" x="208.5" y="-126.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 后续会调用collapse_prev_rollback</text>
</g>
<!-- Rollback_process_write&#45;&gt;cleanup -->
<g id="edge10" class="edge">
<title>Rollback_process_write&#45;&gt;cleanup</title>
<path fill="none" stroke="#666666" d="M418.75,-211.41C462.09,-225.59 509.22,-241.01 541.16,-251.46"/>
<polygon fill="#666666" stroke="#666666" points="540.39,-254.89 550.98,-254.67 542.56,-248.23 540.39,-254.89"/>
</g>
<!-- Command_process_write -->
<g id="node11" class="node">
<title>Command_process_write</title>
<path fill="none" stroke="#1c2123" d="M12,-221C12,-221 145,-221 145,-221 151,-221 157,-227 157,-233 157,-233 157,-245 157,-245 157,-251 151,-257 145,-257 145,-257 12,-257 12,-257 6,-257 0,-251 0,-245 0,-245 0,-233 0,-233 0,-227 6,-221 12,-221"/>
<text text-anchor="middle" x="78.5" y="-235.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Command::process_write</text>
</g>
<!-- Command_process_write&#45;&gt;CheckSecondaryLocks_process_write -->
<g id="edge11" class="edge">
<title>Command_process_write&#45;&gt;CheckSecondaryLocks_process_write</title>
<path fill="none" stroke="#666666" d="M89.53,-257.02C106.51,-285.43 143.93,-339.63 193,-361 368,-437.21 594.71,-413.82 731.73,-388.18"/>
<polygon fill="#666666" stroke="#666666" points="732.68,-391.56 741.85,-386.25 731.37,-384.68 732.68,-391.56"/>
</g>
<!-- Command_process_write&#45;&gt;CheckTxnStatus_process_write -->
<g id="edge12" class="edge">
<title>Command_process_write&#45;&gt;CheckTxnStatus_process_write</title>
<path fill="none" stroke="#666666" d="M92.01,-220.65C111.21,-193.53 150.25,-142.36 193,-109 194.56,-107.78 196.16,-106.57 197.78,-105.38"/>
<polygon fill="#666666" stroke="#666666" points="199.9,-108.16 206.06,-99.54 195.87,-102.44 199.9,-108.16"/>
</g>
<!-- Command_process_write&#45;&gt;ResolveLock_process_write -->
<g id="edge13" class="edge">
<title>Command_process_write&#45;&gt;ResolveLock_process_write</title>
<path fill="none" stroke="#666666" d="M145.12,-257.05C160.81,-261.37 178.01,-266.1 195.17,-270.82"/>
<polygon fill="#666666" stroke="#666666" points="194.69,-274.32 205.26,-273.6 196.54,-267.57 194.69,-274.32"/>
</g>
<!-- Command_process_write&#45;&gt;Rollback_process_write -->
<g id="edge14" class="edge">
<title>Command_process_write&#45;&gt;Rollback_process_write</title>
<path fill="none" stroke="#666666" d="M145.12,-220.95C159.46,-217 175.06,-212.71 190.74,-208.4"/>
<polygon fill="#666666" stroke="#666666" points="191.78,-211.74 200.5,-205.71 189.93,-204.99 191.78,-211.74"/>
</g>
<!-- get_txn_commit_record&#45;&gt;collapse_prev_rollback -->
<g id="edge16" class="edge">
<title>get_txn_commit_record&#45;&gt;collapse_prev_rollback</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M1157.24,-305.6C1165.52,-304.65 1174.07,-303.67 1182.63,-302.69"/>
<polygon fill="green" stroke="green" points="1183.14,-306.15 1192.67,-301.53 1182.34,-299.2 1183.14,-306.15"/>
</g>
</g>
</svg>
