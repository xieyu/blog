<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.0 (20210316.0004)
 -->
<!-- Title: future_wake_task Pages: 1 -->
<svg width="1601pt" height="327pt"
 viewBox="0.00 0.00 1601.00 327.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 323)">
<title>future_wake_task</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-323 1597,-323 1597,4 -4,4"/>
<!-- LOCAL -->
<g id="node1" class="node">
<title>LOCAL</title>
<path fill="#feed9b" stroke="#f7e495" d="M902,-24.5C902,-24.5 1150,-24.5 1150,-24.5 1156,-24.5 1162,-30.5 1162,-36.5 1162,-36.5 1162,-103.5 1162,-103.5 1162,-109.5 1156,-115.5 1150,-115.5 1150,-115.5 902,-115.5 902,-115.5 896,-115.5 890,-109.5 890,-103.5 890,-103.5 890,-36.5 890,-36.5 890,-30.5 896,-24.5 902,-24.5"/>
<text text-anchor="start" x="898" y="-100.3" font-family="Times,serif" font-size="14.00" fill="#40575d">LOCAL</text>
<polyline fill="none" stroke="#f7e495" points="890,-92.5 1162,-92.5 "/>
<text text-anchor="start" x="898" y="-77.3" font-family="Times,serif" font-size="14.00" fill="#40575d">线程局部变量, 指向本地queue</text>
<text text-anchor="start" x="898" y="-62.3" font-family="Times,serif" font-size="14.00" fill="#40575d"> thread_local!</text>
<text text-anchor="start" x="898" y="-47.3" font-family="Times,serif" font-size="14.00" fill="#40575d"> static LOCAL: Cell&lt;*mut Local&lt;TaskCell&gt;&gt;</text>
<text text-anchor="start" x="898" y="-32.3" font-family="Times,serif" font-size="14.00" fill="#40575d"> = Cell::new(std::ptr::null_mut());</text>
</g>
<!-- Local -->
<g id="node2" class="node">
<title>Local</title>
<path fill="none" stroke="#1c2123" d="M1210,-138C1210,-138 1370,-138 1370,-138 1376,-138 1382,-144 1382,-150 1382,-150 1382,-218 1382,-218 1382,-224 1376,-230 1370,-230 1370,-230 1210,-230 1210,-230 1204,-230 1198,-224 1198,-218 1198,-218 1198,-150 1198,-150 1198,-144 1204,-138 1210,-138"/>
<text text-anchor="middle" x="1290" y="-214.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">Local</text>
<polyline fill="none" stroke="#1c2123" points="1198,-207 1382,-207 "/>
<text text-anchor="start" x="1206" y="-191.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">id: usize,</text>
<polyline fill="none" stroke="#1c2123" points="1198,-184 1382,-184 "/>
<text text-anchor="start" x="1206" y="-168.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">local_queue: LocalQueue&lt;T&gt;,</text>
<polyline fill="none" stroke="#1c2123" points="1198,-161 1382,-161 "/>
<text text-anchor="start" x="1206" y="-145.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">core: Arc&lt;QueueCore&lt;T&gt;&gt;,</text>
</g>
<!-- LOCAL&#45;&gt;Local -->
<g id="edge1" class="edge">
<title>LOCAL&#45;&gt;Local</title>
<path fill="none" stroke="#666666" d="M1131.68,-115.55C1150.33,-123.66 1169.73,-132.11 1188.28,-140.17"/>
<polygon fill="#666666" stroke="#666666" points="1187.03,-143.45 1197.59,-144.23 1189.82,-137.03 1187.03,-143.45"/>
</g>
<!-- local_spawn_remote -->
<g id="node7" class="node">
<title>local_spawn_remote</title>
<path fill="none" stroke="#1c2123" d="M1432.5,-169.5C1432.5,-169.5 1578.5,-169.5 1578.5,-169.5 1584.5,-169.5 1590.5,-175.5 1590.5,-181.5 1590.5,-181.5 1590.5,-218.5 1590.5,-218.5 1590.5,-224.5 1584.5,-230.5 1578.5,-230.5 1578.5,-230.5 1432.5,-230.5 1432.5,-230.5 1426.5,-230.5 1420.5,-224.5 1420.5,-218.5 1420.5,-218.5 1420.5,-181.5 1420.5,-181.5 1420.5,-175.5 1426.5,-169.5 1432.5,-169.5"/>
<text text-anchor="middle" x="1505.5" y="-215.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Local::spawn_remote</text>
<polyline fill="none" stroke="#1c2123" points="1420.5,-207.5 1590.5,-207.5 "/>
<text text-anchor="start" x="1428.5" y="-192.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">将task加入到remote queue</text>
<text text-anchor="start" x="1428.5" y="-177.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> self.core.push(self.id, t)</text>
</g>
<!-- Local&#45;&gt;local_spawn_remote -->
<g id="edge9" class="edge">
<title>Local&#45;&gt;local_spawn_remote</title>
<path fill="none" stroke="#666666" d="M1382.16,-190.83C1391.48,-191.53 1400.97,-192.24 1410.32,-192.94"/>
<polygon fill="#666666" stroke="#666666" points="1410.17,-196.44 1420.41,-193.7 1410.7,-189.46 1410.17,-196.44"/>
</g>
<!-- local_spawn -->
<g id="node8" class="node">
<title>local_spawn</title>
<path fill="none" stroke="#1c2123" d="M1430,-257.5C1430,-257.5 1581,-257.5 1581,-257.5 1587,-257.5 1593,-263.5 1593,-269.5 1593,-269.5 1593,-306.5 1593,-306.5 1593,-312.5 1587,-318.5 1581,-318.5 1581,-318.5 1430,-318.5 1430,-318.5 1424,-318.5 1418,-312.5 1418,-306.5 1418,-306.5 1418,-269.5 1418,-269.5 1418,-263.5 1424,-257.5 1430,-257.5"/>
<text text-anchor="middle" x="1505.5" y="-303.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Local::spawn</text>
<polyline fill="none" stroke="#1c2123" points="1418,-295.5 1593,-295.5 "/>
<text text-anchor="start" x="1426" y="-280.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">将task加入到local_queue中</text>
<text text-anchor="start" x="1426" y="-265.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> self.local_queue.push(t)</text>
</g>
<!-- Local&#45;&gt;local_spawn -->
<g id="edge10" class="edge">
<title>Local&#45;&gt;local_spawn</title>
<path fill="none" stroke="#666666" d="M1382.16,-228.41C1398.93,-236.58 1416.23,-245 1432.34,-252.85"/>
<polygon fill="#666666" stroke="#666666" points="1431.16,-256.17 1441.68,-257.4 1434.22,-249.87 1431.16,-256.17"/>
</g>
<!-- wake_task -->
<g id="node3" class="node">
<title>wake_task</title>
<path fill="none" stroke="#1c2123" d="M476.5,-168C476.5,-168 590.5,-168 590.5,-168 596.5,-168 602.5,-174 602.5,-180 602.5,-180 602.5,-202 602.5,-202 602.5,-208 596.5,-214 590.5,-214 590.5,-214 476.5,-214 476.5,-214 470.5,-214 464.5,-208 464.5,-202 464.5,-202 464.5,-180 464.5,-180 464.5,-174 470.5,-168 476.5,-168"/>
<text text-anchor="middle" x="533.5" y="-198.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">wake_task</text>
<polyline fill="none" stroke="#1c2123" points="464.5,-191 602.5,-191 "/>
<text text-anchor="start" x="472.5" y="-175.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">将task重新放入队列</text>
</g>
<!-- LOCAL_with -->
<g id="node4" class="node">
<title>LOCAL_with</title>
<path fill="none" stroke="#1c2123" d="M719,-66C719,-66 821,-66 821,-66 827,-66 833,-72 833,-78 833,-78 833,-100 833,-100 833,-106 827,-112 821,-112 821,-112 719,-112 719,-112 713,-112 707,-106 707,-100 707,-100 707,-78 707,-78 707,-72 713,-66 719,-66"/>
<text text-anchor="middle" x="770" y="-96.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">LOCAL.with</text>
<polyline fill="none" stroke="#1c2123" points="707,-89 833,-89 "/>
<text text-anchor="start" x="715" y="-73.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">获取local queue ptr</text>
</g>
<!-- wake_task&#45;&gt;LOCAL_with -->
<g id="edge2" class="edge">
<title>wake_task&#45;&gt;LOCAL_with</title>
<path fill="none" stroke="#666666" d="M602.76,-171.72C618.72,-166.04 635.33,-159.12 650,-151 667.97,-141.05 668.26,-132.36 686,-122 689.69,-119.85 693.55,-117.77 697.5,-115.79"/>
<polygon fill="#666666" stroke="#666666" points="699.32,-118.8 706.83,-111.32 696.3,-112.48 699.32,-118.8"/>
</g>
<!-- out_of_polling -->
<g id="node5" class="node">
<title>out_of_polling</title>
<path fill="none" stroke="#1c2123" d="M698,-131.5C698,-131.5 842,-131.5 842,-131.5 848,-131.5 854,-137.5 854,-143.5 854,-143.5 854,-180.5 854,-180.5 854,-186.5 848,-192.5 842,-192.5 842,-192.5 698,-192.5 698,-192.5 692,-192.5 686,-186.5 686,-180.5 686,-180.5 686,-143.5 686,-143.5 686,-137.5 692,-131.5 698,-131.5"/>
<text text-anchor="middle" x="770" y="-177.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">out_of_polling</text>
<polyline fill="none" stroke="#1c2123" points="686,-169.5 854,-169.5 "/>
<text text-anchor="start" x="694" y="-154.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">如果LOCAL指针为空就</text>
<text text-anchor="start" x="694" y="-139.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 使用remote 全队列spawn</text>
</g>
<!-- wake_task&#45;&gt;out_of_polling -->
<g id="edge3" class="edge">
<title>wake_task&#45;&gt;out_of_polling</title>
<path fill="none" stroke="#666666" d="M602.64,-182.57C625.46,-179.75 651.31,-176.55 675.71,-173.54"/>
<polygon fill="#666666" stroke="#666666" points="676.21,-177 685.71,-172.3 675.35,-170.05 676.21,-177"/>
</g>
<!-- remote_spawn -->
<g id="node6" class="node">
<title>remote_spawn</title>
<path fill="none" stroke="#1c2123" d="M957,-149.5C957,-149.5 1095,-149.5 1095,-149.5 1101,-149.5 1107,-155.5 1107,-161.5 1107,-161.5 1107,-198.5 1107,-198.5 1107,-204.5 1101,-210.5 1095,-210.5 1095,-210.5 957,-210.5 957,-210.5 951,-210.5 945,-204.5 945,-198.5 945,-198.5 945,-161.5 945,-161.5 945,-155.5 951,-149.5 957,-149.5"/>
<text text-anchor="middle" x="1026" y="-195.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">remote.spawn</text>
<polyline fill="none" stroke="#1c2123" points="945,-187.5 1107,-187.5 "/>
<text text-anchor="start" x="953" y="-172.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">将task放到remote队列中</text>
<text text-anchor="start" x="953" y="-157.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> self.core.push(0, t)</text>
</g>
<!-- wake_task&#45;&gt;remote_spawn -->
<g id="edge4" class="edge">
<title>wake_task&#45;&gt;remote_spawn</title>
<path fill="none" stroke="#666666" d="M602.69,-197.01C628.74,-199.02 658.72,-201.01 686,-202 760.62,-204.71 779.49,-206.77 854,-202 880.24,-200.32 908.6,-197.2 934.55,-193.83"/>
<polygon fill="#666666" stroke="#666666" points="935.29,-197.26 944.74,-192.48 934.37,-190.32 935.29,-197.26"/>
</g>
<!-- wake_task&#45;&gt;local_spawn_remote -->
<g id="edge5" class="edge">
<title>wake_task&#45;&gt;local_spawn_remote</title>
<path fill="none" stroke="#666666" d="M602.85,-205.21C628.78,-210.06 658.64,-215.02 686,-218 993.65,-251.57 1076.19,-286.5 1382,-239 1391.33,-237.55 1400.92,-235.52 1410.43,-233.13"/>
<polygon fill="#666666" stroke="#666666" points="1411.53,-236.46 1420.3,-230.52 1409.74,-229.69 1411.53,-236.46"/>
</g>
<!-- wake_task&#45;&gt;local_spawn -->
<g id="edge6" class="edge">
<title>wake_task&#45;&gt;local_spawn</title>
<path fill="none" stroke="#666666" d="M593.79,-214.07C621.44,-224.02 655.01,-234.96 686,-242 941.4,-300.01 1252.56,-298.39 1407.34,-292.89"/>
<polygon fill="#666666" stroke="#666666" points="1407.9,-296.37 1417.76,-292.51 1407.64,-289.38 1407.9,-296.37"/>
</g>
<!-- LOCAL_with&#45;&gt;LOCAL -->
<g id="edge8" class="edge">
<title>LOCAL_with&#45;&gt;LOCAL</title>
<path fill="none" stroke="#666666" d="M833.14,-84.35C847.49,-83.28 863.35,-82.09 879.62,-80.87"/>
<polygon fill="#666666" stroke="#666666" points="880.09,-84.35 889.8,-80.11 879.57,-77.37 880.09,-84.35"/>
</g>
<!-- out_of_polling&#45;&gt;remote_spawn -->
<g id="edge7" class="edge">
<title>out_of_polling&#45;&gt;remote_spawn</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M854.17,-167.89C879.84,-169.71 908.24,-171.73 934.39,-173.58"/>
<polygon fill="green" stroke="green" points="934.45,-177.09 944.67,-174.31 934.94,-170.11 934.45,-177.09"/>
</g>
<!-- Scope_new -->
<g id="node9" class="node">
<title>Scope_new</title>
<path fill="none" stroke="#1c2123" d="M188,-0.5C188,-0.5 369,-0.5 369,-0.5 375,-0.5 381,-6.5 381,-12.5 381,-12.5 381,-57.5 381,-57.5 381,-63.5 375,-69.5 369,-69.5 369,-69.5 188,-69.5 188,-69.5 182,-69.5 176,-63.5 176,-57.5 176,-57.5 176,-12.5 176,-12.5 176,-6.5 182,-0.5 188,-0.5"/>
<text text-anchor="middle" x="278.5" y="-54.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Scope::new</text>
<polyline fill="none" stroke="#1c2123" points="176,-46.5 381,-46.5 "/>
<text text-anchor="start" x="184" y="-31.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">设置Local指针</text>
<polyline fill="none" stroke="#1c2123" points="176,-23.5 381,-23.5 "/>
<text text-anchor="start" x="184" y="-8.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">LOCAL.with(|c| c.set(l)); Scope(l)</text>
</g>
<!-- Scope_new&#45;&gt;LOCAL -->
<g id="edge15" class="edge">
<title>Scope_new&#45;&gt;LOCAL</title>
<path fill="none" stroke="#666666" d="M381.15,-32.45C496.12,-30.53 688.86,-30.22 854,-44 862.39,-44.7 870.99,-45.56 879.66,-46.53"/>
<polygon fill="#666666" stroke="#666666" points="879.51,-50.04 889.85,-47.73 880.33,-43.09 879.51,-50.04"/>
</g>
<!-- Scope_drop -->
<g id="node10" class="node">
<title>Scope_drop</title>
<path fill="none" stroke="#1c2123" d="M429,-80.5C429,-80.5 638,-80.5 638,-80.5 644,-80.5 650,-86.5 650,-92.5 650,-92.5 650,-129.5 650,-129.5 650,-135.5 644,-141.5 638,-141.5 638,-141.5 429,-141.5 429,-141.5 423,-141.5 417,-135.5 417,-129.5 417,-129.5 417,-92.5 417,-92.5 417,-86.5 423,-80.5 429,-80.5"/>
<text text-anchor="middle" x="533.5" y="-126.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Scope::drop</text>
<polyline fill="none" stroke="#1c2123" points="417,-118.5 650,-118.5 "/>
<text text-anchor="start" x="425" y="-103.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">将LOCAL设置为null LOCAL.with(|c|</text>
<text text-anchor="start" x="425" y="-88.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> c.set(std::ptr::null_mut()));</text>
</g>
<!-- Scope_drop&#45;&gt;LOCAL -->
<g id="edge16" class="edge">
<title>Scope_drop&#45;&gt;LOCAL</title>
<path fill="none" stroke="#666666" d="M602.87,-80.46C628.42,-70.58 658.03,-60.92 686,-56 748.92,-44.93 819.38,-45.76 879.69,-50.38"/>
<polygon fill="#666666" stroke="#666666" points="879.42,-53.87 889.67,-51.19 879.98,-46.89 879.42,-53.87"/>
</g>
<!-- Scope_drop&#45;&gt;out_of_polling -->
<g id="edge17" class="edge">
<title>Scope_drop&#45;&gt;out_of_polling</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M650.03,-136.13C658.67,-138.01 667.33,-139.89 675.81,-141.73"/>
<polygon fill="green" stroke="green" points="675.15,-145.17 685.67,-143.88 676.64,-138.33 675.15,-145.17"/>
</g>
<!-- future_runner_handle -->
<g id="node11" class="node">
<title>future_runner_handle</title>
<path fill="none" stroke="#1c2123" d="M12,-93C12,-93 128,-93 128,-93 134,-93 140,-99 140,-105 140,-105 140,-117 140,-117 140,-123 134,-129 128,-129 128,-129 12,-129 12,-129 6,-129 0,-123 0,-117 0,-117 0,-105 0,-105 0,-99 6,-93 12,-93"/>
<text text-anchor="middle" x="70" y="-107.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">future::Runner::handle</text>
</g>
<!-- future_runner_handle&#45;&gt;Scope_new -->
<g id="edge11" class="edge">
<title>future_runner_handle&#45;&gt;Scope_new</title>
<path fill="none" stroke="#666666" d="M119.94,-92.99C136.26,-86.98 155.12,-80.04 173.99,-73.1"/>
<polygon fill="#666666" stroke="#666666" points="175.36,-76.32 183.54,-69.58 172.95,-69.75 175.36,-76.32"/>
</g>
<!-- future_runner_handle&#45;&gt;Scope_drop -->
<g id="edge12" class="edge">
<title>future_runner_handle&#45;&gt;Scope_drop</title>
<path fill="none" stroke="#666666" d="M140.09,-111C210.36,-111 320.81,-111 406.65,-111"/>
<polygon fill="#666666" stroke="#666666" points="406.73,-114.5 416.73,-111 406.73,-107.5 406.73,-114.5"/>
</g>
<!-- task_future_poll -->
<g id="node12" class="node">
<title>task_future_poll</title>
<path fill="none" stroke="#1c2123" d="M223.5,-143C223.5,-143 333.5,-143 333.5,-143 339.5,-143 345.5,-149 345.5,-155 345.5,-155 345.5,-207 345.5,-207 345.5,-213 339.5,-219 333.5,-219 333.5,-219 223.5,-219 223.5,-219 217.5,-219 211.5,-213 211.5,-207 211.5,-207 211.5,-155 211.5,-155 211.5,-149 217.5,-143 223.5,-143"/>
<text text-anchor="middle" x="278.5" y="-203.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">task.future.poll</text>
<polyline fill="none" stroke="#1c2123" points="211.5,-196 345.5,-196 "/>
<text text-anchor="start" x="219.5" y="-180.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">调用ctx.wake_xxx</text>
<text text-anchor="start" x="219.5" y="-165.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 将自己加入队列中</text>
<text text-anchor="start" x="219.5" y="-150.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 等下次重新poll</text>
</g>
<!-- future_runner_handle&#45;&gt;task_future_poll -->
<g id="edge13" class="edge">
<title>future_runner_handle&#45;&gt;task_future_poll</title>
<path fill="none" stroke="#666666" d="M124.18,-129.03C147.7,-137 175.8,-146.53 201.48,-155.23"/>
<polygon fill="#666666" stroke="#666666" points="200.6,-158.63 211.19,-158.52 202.84,-152 200.6,-158.63"/>
</g>
<!-- task_future_poll&#45;&gt;wake_task -->
<g id="edge14" class="edge">
<title>task_future_poll&#45;&gt;wake_task</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M345.64,-183.61C378.82,-184.93 419.24,-186.52 453.99,-187.9"/>
<polygon fill="green" stroke="green" points="453.97,-191.4 464.1,-188.3 454.24,-184.4 453.97,-191.4"/>
</g>
</g>
</svg>
