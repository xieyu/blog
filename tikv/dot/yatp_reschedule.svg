<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.47.0 (20210316.0004)
 -->
<!-- Title: reschedule Pages: 1 -->
<svg width="1527pt" height="397pt"
 viewBox="0.00 0.00 1527.00 397.23" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 393.23)">
<title>reschedule</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-393.23 1523,-393.23 1523,4 -4,4"/>
<!-- NEED_RESCHEDULE -->
<g id="node1" class="node">
<title>NEED_RESCHEDULE</title>
<path fill="#feed9b" stroke="#f7e495" d="M1113,-312C1113,-312 1275,-312 1275,-312 1281,-312 1287,-318 1287,-324 1287,-324 1287,-346 1287,-346 1287,-352 1281,-358 1275,-358 1275,-358 1113,-358 1113,-358 1107,-358 1101,-352 1101,-346 1101,-346 1101,-324 1101,-324 1101,-318 1107,-312 1113,-312"/>
<text text-anchor="middle" x="1194" y="-342.8" font-family="Times,serif" font-size="14.00" fill="#40575d">NEED_RESCHEDULE</text>
<polyline fill="none" stroke="#f7e495" points="1101,-335 1287,-335 "/>
<text text-anchor="start" x="1109" y="-319.8" font-family="Times,serif" font-size="14.00" fill="#40575d">Cell&lt;bool&gt; = Cell::new(false);</text>
</g>
<!-- wake_task -->
<g id="node7" class="node">
<title>wake_task</title>
<path fill="none" stroke="#1c2123" d="M1346,-202C1346,-202 1507,-202 1507,-202 1513,-202 1519,-208 1519,-214 1519,-214 1519,-266 1519,-266 1519,-272 1513,-278 1507,-278 1507,-278 1346,-278 1346,-278 1340,-278 1334,-272 1334,-266 1334,-266 1334,-214 1334,-214 1334,-208 1340,-202 1346,-202"/>
<text text-anchor="middle" x="1426.5" y="-262.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">wake_task</text>
<polyline fill="none" stroke="#1c2123" points="1334,-255 1519,-255 "/>
<text text-anchor="start" x="1342" y="-239.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">wake_task(Cow::Owned(task),</text>
<text text-anchor="start" x="1342" y="-224.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> need_reschedule);</text>
<text text-anchor="start" x="1342" y="-209.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 并返回false</text>
</g>
<!-- NEED_RESCHEDULE&#45;&gt;wake_task -->
<g id="edge16" class="edge">
<title>NEED_RESCHEDULE&#45;&gt;wake_task</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M1272.85,-311.93C1281.06,-309.09 1289.24,-306.1 1297,-303 1312.19,-296.93 1328.07,-289.82 1343.27,-282.6"/>
<polygon fill="green" stroke="green" points="1345.14,-285.59 1352.64,-278.1 1342.11,-279.28 1345.14,-285.59"/>
</g>
<!-- Reschedule -->
<g id="node2" class="node">
<title>Reschedule</title>
<path fill="none" stroke="#1c2123" d="M513,-276C513,-276 586,-276 586,-276 592,-276 598,-282 598,-288 598,-288 598,-310 598,-310 598,-316 592,-322 586,-322 586,-322 513,-322 513,-322 507,-322 501,-316 501,-310 501,-310 501,-288 501,-288 501,-282 507,-276 513,-276"/>
<text text-anchor="middle" x="549.5" y="-306.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">Reschedule</text>
<polyline fill="none" stroke="#1c2123" points="501,-299 598,-299 "/>
<text text-anchor="middle" x="549.5" y="-283.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">first_poll: bool</text>
</g>
<!-- poll -->
<g id="node3" class="node">
<title>poll</title>
<path fill="none" stroke="#1c2123" d="M189,-190C189,-190 447,-190 447,-190 453,-190 459,-196 459,-202 459,-202 459,-292 459,-292 459,-298 453,-304 447,-304 447,-304 189,-304 189,-304 183,-304 177,-298 177,-292 177,-292 177,-202 177,-202 177,-196 183,-190 189,-190"/>
<text text-anchor="middle" x="318" y="-288.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">Reschedule::poll</text>
<polyline fill="none" stroke="#1c2123" points="177,-281 459,-281 "/>
<text text-anchor="start" x="185" y="-265.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">first_poll 将first_poll设置为false</text>
<text text-anchor="start" x="185" y="-250.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 让后将NEED_RESCHEDULE thread local var</text>
<text text-anchor="start" x="185" y="-235.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 设置为true</text>
<text text-anchor="start" x="185" y="-220.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 调用wake_by_ref 唤醒自己</text>
<polyline fill="none" stroke="#1c2123" points="177,-213 459,-213 "/>
<text text-anchor="start" x="185" y="-197.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">第二次poll返回Poll::Ready</text>
</g>
<!-- poll&#45;&gt;NEED_RESCHEDULE -->
<g id="edge1" class="edge">
<title>poll&#45;&gt;NEED_RESCHEDULE</title>
<path fill="none" stroke="#666666" d="M459.18,-247C488.68,-247 519.61,-247 548.5,-247 548.5,-247 548.5,-247 982,-247 1036.46,-247 1040.61,-282.33 1091,-303 1095.66,-304.91 1100.47,-306.77 1105.36,-308.58"/>
<polygon fill="#666666" stroke="#666666" points="1104.23,-311.89 1114.82,-311.98 1106.59,-305.31 1104.23,-311.89"/>
</g>
<!-- poll&#45;&gt;Reschedule -->
<g id="edge2" class="edge">
<title>poll&#45;&gt;Reschedule</title>
<path fill="none" stroke="#666666" d="M459.11,-278.75C470.06,-281.23 480.68,-283.63 490.55,-285.87"/>
<polygon fill="#666666" stroke="#666666" points="490.02,-289.34 500.54,-288.13 491.56,-282.51 490.02,-289.34"/>
</g>
<!-- wake_by_ref -->
<g id="node4" class="node">
<title>wake_by_ref</title>
<path fill="none" stroke="#1c2123" d="M508,-141C508,-141 591,-141 591,-141 597,-141 603,-147 603,-153 603,-153 603,-165 603,-165 603,-171 597,-177 591,-177 591,-177 508,-177 508,-177 502,-177 496,-171 496,-165 496,-165 496,-153 496,-153 496,-147 502,-141 508,-141"/>
<text text-anchor="middle" x="549.5" y="-155.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">ctx.wake_by_ref</text>
</g>
<!-- poll&#45;&gt;wake_by_ref -->
<g id="edge3" class="edge">
<title>poll&#45;&gt;wake_by_ref</title>
<path fill="none" stroke="#666666" d="M459.11,-193.28C470.57,-188.88 481.67,-184.63 491.93,-180.69"/>
<polygon fill="#666666" stroke="#666666" points="493.41,-183.87 501.49,-177.03 490.9,-177.34 493.41,-183.87"/>
</g>
<!-- wake_impl -->
<g id="node5" class="node">
<title>wake_impl</title>
<path fill="none" stroke="#1c2123" d="M683,-119.5C683,-119.5 859,-119.5 859,-119.5 865,-119.5 871,-125.5 871,-131.5 871,-131.5 871,-168.5 871,-168.5 871,-174.5 865,-180.5 859,-180.5 859,-180.5 683,-180.5 683,-180.5 677,-180.5 671,-174.5 671,-168.5 671,-168.5 671,-131.5 671,-131.5 671,-125.5 677,-119.5 683,-119.5"/>
<text text-anchor="middle" x="771" y="-165.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">wake_impl</text>
<polyline fill="none" stroke="#1c2123" points="671,-157.5 871,-157.5 "/>
<text text-anchor="start" x="679" y="-142.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">此时task出于POLLING状态</text>
<text text-anchor="start" x="679" y="-127.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> wake_impl状态改为NOTIFIED</text>
</g>
<!-- wake_by_ref&#45;&gt;wake_impl -->
<g id="edge4" class="edge">
<title>wake_by_ref&#45;&gt;wake_impl</title>
<path fill="none" stroke="#666666" d="M603.08,-156.84C620.44,-156.13 640.44,-155.31 660.44,-154.49"/>
<polygon fill="#666666" stroke="#666666" points="660.72,-157.98 670.57,-154.08 660.43,-150.99 660.72,-157.98"/>
</g>
<!-- check_Notified -->
<g id="node8" class="node">
<title>check_Notified</title>
<path fill="none" stroke="#1c2123" d="M920,-131.5C920,-131.5 1042,-131.5 1042,-131.5 1048,-131.5 1054,-137.5 1054,-143.5 1054,-143.5 1054,-172.5 1054,-172.5 1054,-178.5 1048,-184.5 1042,-184.5 1042,-184.5 920,-184.5 920,-184.5 914,-184.5 908,-178.5 908,-172.5 908,-172.5 908,-143.5 908,-143.5 908,-137.5 914,-131.5 920,-131.5"/>
<text text-anchor="start" x="916" y="-169.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">task.future.poll 结束后</text>
<text text-anchor="start" x="916" y="-154.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 检查task状态</text>
<text text-anchor="start" x="916" y="-139.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 是否为NOTIFIED</text>
</g>
<!-- wake_impl&#45;&gt;check_Notified -->
<g id="edge9" class="edge">
<title>wake_impl&#45;&gt;check_Notified</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M871.13,-153.81C880,-154.15 888.92,-154.5 897.63,-154.83"/>
<polygon fill="green" stroke="green" points="897.62,-158.33 907.74,-155.22 897.89,-151.34 897.62,-158.33"/>
</g>
<!-- handle -->
<g id="node6" class="node">
<title>handle</title>
<path fill="none" stroke="#1c2123" d="M12,-302C12,-302 128,-302 128,-302 134,-302 140,-308 140,-314 140,-314 140,-336 140,-336 140,-342 134,-348 128,-348 128,-348 12,-348 12,-348 6,-348 0,-342 0,-336 0,-336 0,-314 0,-314 0,-308 6,-302 12,-302"/>
<text text-anchor="middle" x="70" y="-332.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">future::Runner::handle</text>
<polyline fill="none" stroke="#1c2123" points="0,-325 140,-325 "/>
<text text-anchor="start" x="8" y="-309.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">处理一个async task</text>
</g>
<!-- handle&#45;&gt;NEED_RESCHEDULE -->
<g id="edge5" class="edge">
<title>handle&#45;&gt;NEED_RESCHEDULE</title>
<path fill="none" stroke="#666666" d="M140.25,-336.25C189.43,-343.28 257.09,-351 317,-351 317,-351 317,-351 982,-351 1017.53,-351 1056.32,-348.72 1090.85,-345.88"/>
<polygon fill="#666666" stroke="#666666" points="1091.27,-349.35 1100.94,-345.02 1090.68,-342.38 1091.27,-349.35"/>
</g>
<!-- handle&#45;&gt;poll -->
<g id="edge6" class="edge">
<title>handle&#45;&gt;poll</title>
<path fill="none" stroke="#666666" d="M140.18,-303.07C148.83,-300.32 157.92,-297.44 167.23,-294.49"/>
<polygon fill="#666666" stroke="#666666" points="168.52,-297.75 176.99,-291.39 166.4,-291.08 168.52,-297.75"/>
</g>
<!-- handle&#45;&gt;wake_task -->
<g id="edge7" class="edge">
<title>handle&#45;&gt;wake_task</title>
<path fill="none" stroke="#666666" d="M126.6,-348.11C175.77,-366.44 249.92,-389 317,-389 317,-389 317,-389 1195,-389 1241.28,-389 1256.23,-389.92 1297,-368 1333.98,-348.12 1367.3,-314.22 1390.74,-286.31"/>
<polygon fill="#666666" stroke="#666666" points="1393.73,-288.18 1397.38,-278.23 1388.33,-283.73 1393.73,-288.18"/>
</g>
<!-- handle&#45;&gt;check_Notified -->
<g id="edge8" class="edge">
<title>handle&#45;&gt;check_Notified</title>
<path fill="none" stroke="#666666" d="M81.59,-301.71C110.28,-242.52 195.58,-91 317,-91 317,-91 317,-91 772,-91 823.21,-91 878.25,-109.63 918.84,-127.24"/>
<polygon fill="#666666" stroke="#666666" points="917.49,-130.47 928.05,-131.33 920.33,-124.07 917.49,-130.47"/>
</g>
<!-- check_Notified&#45;&gt;NEED_RESCHEDULE -->
<g id="edge11" class="edge">
<title>check_Notified&#45;&gt;NEED_RESCHEDULE</title>
<path fill="none" stroke="#666666" d="M1025.24,-184.82C1042.41,-197.48 1060.91,-214 1073,-233 1090.24,-260.1 1068.89,-279.7 1091,-303 1091.77,-303.81 1092.55,-304.6 1093.36,-305.36"/>
<polygon fill="#666666" stroke="#666666" points="1091.14,-308.07 1101.08,-311.75 1095.6,-302.68 1091.14,-308.07"/>
</g>
<!-- check_Notified&#45;&gt;poll -->
<g id="edge10" class="edge">
<title>check_Notified&#45;&gt;poll</title>
<path fill="none" stroke="#666666" d="M907.75,-181.21C895.58,-184.55 883,-187.64 871,-190 851.43,-193.85 626.16,-216.57 469.53,-232.14"/>
<polygon fill="#666666" stroke="#666666" points="468.92,-228.68 459.31,-233.16 469.61,-235.65 468.92,-228.68"/>
<text text-anchor="middle" x="637" y="-219.8" font-family="Times,serif" font-size="14.00">repoll</text>
</g>
<!-- check_Notified&#45;&gt;wake_task -->
<g id="edge12" class="edge">
<title>check_Notified&#45;&gt;wake_task</title>
<path fill="none" stroke="#666666" d="M1054.27,-154.37C1118.95,-152.99 1215.82,-155.57 1297,-177 1315.14,-181.79 1333.76,-189.23 1351,-197.35"/>
<polygon fill="#666666" stroke="#666666" points="1349.9,-200.71 1360.42,-201.92 1352.95,-194.41 1349.9,-200.71"/>
</g>
<!-- need_preempt -->
<g id="node9" class="node">
<title>need_preempt</title>
<path fill="none" stroke="#1c2123" d="M1108.5,-0.5C1108.5,-0.5 1279.5,-0.5 1279.5,-0.5 1285.5,-0.5 1291.5,-6.5 1291.5,-12.5 1291.5,-12.5 1291.5,-117.5 1291.5,-117.5 1291.5,-123.5 1285.5,-129.5 1279.5,-129.5 1279.5,-129.5 1108.5,-129.5 1108.5,-129.5 1102.5,-129.5 1096.5,-123.5 1096.5,-117.5 1096.5,-117.5 1096.5,-12.5 1096.5,-12.5 1096.5,-6.5 1102.5,-0.5 1108.5,-0.5"/>
<text text-anchor="middle" x="1194" y="-114.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">need_preempt</text>
<polyline fill="none" stroke="#1c2123" points="1096.5,-106.5 1291.5,-106.5 "/>
<text text-anchor="start" x="1104.5" y="-91.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">Returns wheter there</text>
<text text-anchor="start" x="1104.5" y="-76.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> are preemtive task to run</text>
<polyline fill="none" stroke="#1c2123" points="1096.5,-68.5 1291.5,-68.5 "/>
<text text-anchor="start" x="1104.5" y="-53.3" font-family="Times,serif" font-size="14.00" fill="#2f3638">只有在队列中还有其他task时</text>
<text text-anchor="start" x="1104.5" y="-38.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 采用调wake_task</text>
<text text-anchor="start" x="1104.5" y="-23.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 如果队列为空</text>
<text text-anchor="start" x="1104.5" y="-8.3" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 直接在循环中repoll这个task</text>
</g>
<!-- check_Notified&#45;&gt;need_preempt -->
<g id="edge13" class="edge">
<title>check_Notified&#45;&gt;need_preempt</title>
<path fill="none" stroke="#666666" d="M1042.18,-131.47C1056.2,-125.29 1071.54,-118.53 1086.9,-111.76"/>
<polygon fill="#666666" stroke="#666666" points="1088.71,-114.79 1096.45,-107.55 1085.89,-108.38 1088.71,-114.79"/>
</g>
<!-- repoll_times -->
<g id="node10" class="node">
<title>repoll_times</title>
<path fill="none" stroke="#1c2123" d="M1103,-187C1103,-187 1285,-187 1285,-187 1291,-187 1297,-193 1297,-199 1297,-199 1297,-281 1297,-281 1297,-287 1291,-293 1285,-293 1285,-293 1103,-293 1103,-293 1097,-293 1091,-287 1091,-281 1091,-281 1091,-199 1091,-199 1091,-193 1097,-187 1103,-187"/>
<text text-anchor="middle" x="1194" y="-277.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">repoll_times</text>
<polyline fill="none" stroke="#1c2123" points="1091,-270 1297,-270 "/>
<text text-anchor="start" x="1099" y="-254.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">每次repoll, repoll_times会+1</text>
<text text-anchor="start" x="1099" y="-239.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 超过了repoll_limit, 且调度队列</text>
<text text-anchor="start" x="1099" y="-224.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 中有其他任务</text>
<text text-anchor="start" x="1099" y="-209.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 就调用wake_task</text>
<text text-anchor="start" x="1099" y="-194.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 把自己放到调度队列中</text>
</g>
<!-- check_Notified&#45;&gt;repoll_times -->
<g id="edge14" class="edge">
<title>check_Notified&#45;&gt;repoll_times</title>
<path fill="none" stroke="#666666" d="M1050.21,-184.51C1060.27,-188.42 1070.85,-192.53 1081.51,-196.67"/>
<polygon fill="#666666" stroke="#666666" points="1080.29,-199.95 1090.88,-200.31 1082.83,-193.43 1080.29,-199.95"/>
</g>
<!-- need_preempt&#45;&gt;wake_task -->
<g id="edge17" class="edge">
<title>need_preempt&#45;&gt;wake_task</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M1291.63,-126.31C1299.98,-132.14 1308.21,-138.09 1316,-144 1336.71,-159.71 1358.44,-178.29 1377.04,-194.89"/>
<polygon fill="green" stroke="green" points="1375.03,-197.79 1384.81,-201.87 1379.71,-192.59 1375.03,-197.79"/>
</g>
<!-- has_tasks_or_pull -->
<g id="node11" class="node">
<title>has_tasks_or_pull</title>
<path fill="none" stroke="#1c2123" d="M1348,-27C1348,-27 1505,-27 1505,-27 1511,-27 1517,-33 1517,-39 1517,-39 1517,-91 1517,-91 1517,-97 1511,-103 1505,-103 1505,-103 1348,-103 1348,-103 1342,-103 1336,-97 1336,-91 1336,-91 1336,-39 1336,-39 1336,-33 1342,-27 1348,-27"/>
<text text-anchor="middle" x="1426.5" y="-87.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">has_tasks_or_pull</text>
<polyline fill="none" stroke="#1c2123" points="1336,-80 1517,-80 "/>
<text text-anchor="start" x="1344" y="-64.8" font-family="Times,serif" font-size="14.00" fill="#2f3638">如果local queue中有task</text>
<text text-anchor="start" x="1344" y="-49.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 返回true, 否则从全局queue</text>
<text text-anchor="start" x="1344" y="-34.8" font-family="Times,serif" font-size="14.00" fill="#2f3638"> 中拉取任务</text>
</g>
<!-- need_preempt&#45;&gt;has_tasks_or_pull -->
<g id="edge15" class="edge">
<title>need_preempt&#45;&gt;has_tasks_or_pull</title>
<path fill="none" stroke="#666666" d="M1291.75,-65C1302.98,-65 1314.44,-65 1325.71,-65"/>
<polygon fill="#666666" stroke="#666666" points="1325.98,-68.5 1335.98,-65 1325.98,-61.5 1325.98,-68.5"/>
</g>
<!-- repoll_times&#45;&gt;wake_task -->
<g id="edge18" class="edge">
<title>repoll_times&#45;&gt;wake_task</title>
<path fill="none" stroke="green" stroke-dasharray="5,2" d="M1297.11,-240C1306.03,-240 1315.06,-240 1323.98,-240"/>
<polygon fill="green" stroke="green" points="1323.99,-243.5 1333.99,-240 1323.99,-236.5 1323.99,-243.5"/>
</g>
</g>
</svg>
